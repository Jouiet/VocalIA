# VocalIA Production Deployment - ALL SERVICES
# Session 250.75 - Full Production Stack
#
# Services:
# - db-api (3013): Database API, Auth, Tenants, HITL
# - voice-api (3004): Voice AI Response Generation
# - grok-realtime (3007): WebSocket Voice Streaming
# - telephony (3009): Twilio PSTN Bridge
#
# Routes (all via api.vocalia.ma — no extra DNS needed):
# - api.vocalia.ma/api/auth/* → db-api (priority 100)
# - api.vocalia.ma/api/hitl/* → db-api
# - api.vocalia.ma/api/kb/* → db-api
# - api.vocalia.ma/api/tenants/* → db-api
# - api.vocalia.ma/api/logs → db-api
# - api.vocalia.ma/api/catalog/* → db-api
# - api.vocalia.ma/realtime/* → grok-realtime (priority 90)
# - api.vocalia.ma/telephony/* → telephony (priority 80)
# - api.vocalia.ma/* → voice-api (priority 50)
# Subdomain aliases (optional, need DNS A records at NindoHost):
# - ws.vocalia.ma → grok-realtime
# - tel.vocalia.ma → telephony
#
# Deploy: docker-compose -f docker-compose.production.yml up -d

services:
  # ═══════════════════════════════════════════════════════════════
  # DB API - Authentication, Tenants, HITL (CRITICAL)
  # Routes: /api/auth/*, /api/hitl/*, /api/kb/*, /api/tenants/*, /api/logs, /api/catalog/*
  # ═══════════════════════════════════════════════════════════════
  vocalia-db-api:
    image: node:20-alpine
    container_name: vocalia-db-api
    restart: unless-stopped
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3013
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REFRESH_TOKEN=${GOOGLE_REFRESH_TOKEN}
    command: >
      sh -c "
        apk add --no-cache git curl &&
        git clone --depth 1 https://github.com/Jouiet/VoicalAI.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        mkdir -p data &&
        echo '{\"spreadsheetId\":\"1USAmFgxpXh9yvtAFxvg0_CpmWVop1pOTmxALEE8M4PM\",\"sheets\":{\"tenants\":\"tenants\",\"sessions\":\"sessions\",\"logs\":\"logs\",\"users\":\"users\"}}' > data/google-sheets-config.json &&
        echo '{\"type\":\"authorized_user\",\"client_id\":\"'\"$$GOOGLE_CLIENT_ID\"'\",\"client_secret\":\"'\"$$GOOGLE_CLIENT_SECRET\"'\",\"refresh_token\":\"'\"$$GOOGLE_REFRESH_TOKEN\"'\"}' > data/google-oauth-tokens.json &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        node core/db-api.cjs
      "
    ports:
      - "3013:3013"
    labels:
      - "traefik.enable=true"
      # Route all DB API paths to this service
      - "traefik.http.routers.vocalia-db.rule=Host(`api.vocalia.ma`) && (PathPrefix(`/api/auth`) || PathPrefix(`/api/hitl`) || PathPrefix(`/api/kb`) || PathPrefix(`/api/tenants`) || PathPrefix(`/api/logs`) || PathPrefix(`/api/catalog`) || PathPrefix(`/api/db`))"
      - "traefik.http.routers.vocalia-db.entrypoints=websecure"
      - "traefik.http.routers.vocalia-db.tls=true"
      - "traefik.http.routers.vocalia-db.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-db.priority=100"
      - "traefik.http.services.vocalia-db.loadbalancer.server.port=3013"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3013/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # VOICE API - AI Response Generation (Grok, Gemini, ElevenLabs)
  # Routes: api.vocalia.ma/* (default, lower priority)
  # ═══════════════════════════════════════════════════════════════
  vocalia-api:
    image: node:20-alpine
    container_name: vocalia-api
    restart: unless-stopped
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3004
      - XAI_API_KEY=${XAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - GA4_MEASUREMENT_ID=${GA4_MEASUREMENT_ID}
      - GA4_API_SECRET=${GA4_API_SECRET}
    command: >
      sh -c "
        apk add --no-cache git curl &&
        git clone --depth 1 https://github.com/Jouiet/VoicalAI.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        node core/voice-api-resilient.cjs --server --port=3004
      "
    ports:
      - "3004:3004"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vocalia-api.rule=Host(`api.vocalia.ma`)"
      - "traefik.http.routers.vocalia-api.entrypoints=websecure"
      - "traefik.http.routers.vocalia-api.tls=true"
      - "traefik.http.routers.vocalia-api.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-api.priority=50"
      - "traefik.http.services.vocalia-api.loadbalancer.server.port=3004"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # GROK REALTIME - WebSocket Voice Streaming
  # Routes: api.vocalia.ma/realtime/* (primary) + ws.vocalia.ma (alias, needs DNS)
  # ═══════════════════════════════════════════════════════════════
  vocalia-realtime:
    image: node:20-alpine
    container_name: vocalia-realtime
    restart: unless-stopped
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3007
      - XAI_API_KEY=${XAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    command: >
      sh -c "
        apk add --no-cache git curl &&
        git clone --depth 1 https://github.com/Jouiet/VoicalAI.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        node core/grok-voice-realtime.cjs --server --port=3007
      "
    ports:
      - "3007:3007"
    labels:
      - "traefik.enable=true"
      # Path-based routing via api.vocalia.ma (no extra DNS needed)
      - "traefik.http.routers.vocalia-realtime.rule=Host(`api.vocalia.ma`) && PathPrefix(`/realtime`)"
      - "traefik.http.routers.vocalia-realtime.entrypoints=websecure"
      - "traefik.http.routers.vocalia-realtime.tls=true"
      - "traefik.http.routers.vocalia-realtime.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-realtime.priority=90"
      - "traefik.http.routers.vocalia-realtime.middlewares=strip-realtime"
      - "traefik.http.middlewares.strip-realtime.stripprefix.prefixes=/realtime"
      # Subdomain alias (works if ws.vocalia.ma DNS is configured)
      - "traefik.http.routers.vocalia-ws.rule=Host(`ws.vocalia.ma`)"
      - "traefik.http.routers.vocalia-ws.entrypoints=websecure"
      - "traefik.http.routers.vocalia-ws.tls=true"
      - "traefik.http.routers.vocalia-ws.tls.certresolver=mytlschallenge"
      - "traefik.http.services.vocalia-ws.loadbalancer.server.port=3007"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik

  # ═══════════════════════════════════════════════════════════════
  # TELEPHONY - Twilio PSTN Bridge
  # Routes: api.vocalia.ma/telephony/* (primary) + tel.vocalia.ma (alias, needs DNS)
  # ═══════════════════════════════════════════════════════════════
  vocalia-telephony:
    image: node:20-alpine
    container_name: vocalia-telephony
    restart: unless-stopped
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3009
      - XAI_API_KEY=${XAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REFRESH_TOKEN=${GOOGLE_REFRESH_TOKEN}
      - GA4_MEASUREMENT_ID=${GA4_MEASUREMENT_ID}
      - GA4_API_SECRET=${GA4_API_SECRET}
    command: >
      sh -c "
        apk add --no-cache git curl &&
        git clone --depth 1 https://github.com/Jouiet/VoicalAI.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        node telephony/voice-telephony-bridge.cjs
      "
    ports:
      - "3009:3009"
    labels:
      - "traefik.enable=true"
      # Path-based routing via api.vocalia.ma (no extra DNS needed)
      - "traefik.http.routers.vocalia-telephony.rule=Host(`api.vocalia.ma`) && PathPrefix(`/telephony`)"
      - "traefik.http.routers.vocalia-telephony.entrypoints=websecure"
      - "traefik.http.routers.vocalia-telephony.tls=true"
      - "traefik.http.routers.vocalia-telephony.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-telephony.priority=80"
      - "traefik.http.routers.vocalia-telephony.middlewares=strip-telephony"
      - "traefik.http.middlewares.strip-telephony.stripprefix.prefixes=/telephony"
      # Subdomain alias (works if tel.vocalia.ma DNS is configured)
      - "traefik.http.routers.vocalia-tel.rule=Host(`tel.vocalia.ma`)"
      - "traefik.http.routers.vocalia-tel.entrypoints=websecure"
      - "traefik.http.routers.vocalia-tel.tls=true"
      - "traefik.http.routers.vocalia-tel.tls.certresolver=mytlschallenge"
      - "traefik.http.services.vocalia-tel.loadbalancer.server.port=3009"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  traefik:
    name: root_default
    external: true
