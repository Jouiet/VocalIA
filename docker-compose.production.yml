# VocalIA Production Deployment - Full Stack with Profiles
# Session 250.178 - 4 core + 4 optional (profiles)
#
# CORE (always run):
# - db-api (3013): Database API, Auth, Tenants, HITL
# - voice-api (3004): Voice AI Response Generation
# - grok-realtime (3007): WebSocket Voice Streaming
# - telephony (3009): Twilio PSTN Bridge
#
# OPTIONAL (via --profile):
# - oauth-gateway (3010): OAuth 2.0 flows [profile: integrations]
# - webhook-router (3011): Inbound webhooks [profile: integrations]
# - hitl-video (3012): Video Studio HITL + Kling/Veo generation [profile: video]
# - mcp-server (3015): 203 MCP tools [profile: mcp]
#
# Routes (all via api.vocalia.ma — no extra DNS needed):
# - api.vocalia.ma/api/auth/* → db-api (priority 100)
# - api.vocalia.ma/api/hitl/* → db-api
# - api.vocalia.ma/api/kb/* → db-api
# - api.vocalia.ma/api/tenants/* → db-api
# - api.vocalia.ma/api/logs → db-api
# - api.vocalia.ma/api/catalog/* → db-api
# - api.vocalia.ma/oauth/* → oauth-gateway (priority 95) [profile: integrations]
# - api.vocalia.ma/webhook/* → webhook-router (priority 93) [profile: integrations]
# - api.vocalia.ma/hitl/* → hitl-video (priority 92) [profile: video]
# - api.vocalia.ma/realtime/* → grok-realtime (priority 90)
# - api.vocalia.ma/mcp → mcp-server (priority 85) [profile: mcp]
# - api.vocalia.ma/telephony/* → telephony (priority 80)
# - api.vocalia.ma/* → voice-api (priority 50)
# Subdomain aliases (optional, need DNS A records at NindoHost):
# - ws.vocalia.ma → grok-realtime
# - tel.vocalia.ma → telephony
#
# Volumes: vocalia-data persists quotas, HITL, conversations, metrics, audit logs, client credentials
#
# Deploy:
#   docker-compose -f docker-compose.production.yml up -d                              # Core only (4 services)
#   docker-compose -f docker-compose.production.yml --profile integrations up -d        # + OAuth + Webhooks
#   docker-compose -f docker-compose.production.yml --profile video up -d               # + Video Studio HITL
#   docker-compose -f docker-compose.production.yml --profile mcp up -d                 # + MCP Server
#   docker-compose -f docker-compose.production.yml --profile integrations --profile video --profile mcp up -d  # All 8

services:
  # ═══════════════════════════════════════════════════════════════
  # DB API - Authentication, Tenants, HITL (CRITICAL)
  # Routes: /api/auth/*, /api/hitl/*, /api/kb/*, /api/tenants/*, /api/logs, /api/catalog/*
  # ═══════════════════════════════════════════════════════════════
  vocalia-db-api:
    image: node:22-alpine
    container_name: vocalia-db-api
    restart: unless-stopped
    working_dir: /app
    volumes:
      - vocalia-data:/vocalia-data
    environment:
      - NODE_ENV=production
      - PORT=3013
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REFRESH_TOKEN=${GOOGLE_REFRESH_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
      - VOCALIA_VAULT_KEY=${VOCALIA_VAULT_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_PRICE_STARTER=${STRIPE_PRICE_STARTER:-}
      - STRIPE_PRICE_PRO=${STRIPE_PRICE_PRO:-}
      - STRIPE_PRICE_ECOMMERCE=${STRIPE_PRICE_ECOMMERCE:-}
      - STRIPE_PRICE_EXPERT_CLONE=${STRIPE_PRICE_EXPERT_CLONE:-}
      - STRIPE_PRICE_TELEPHONY=${STRIPE_PRICE_TELEPHONY:-}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM:-noreply@vocalia.ma}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_NOTIFICATION_CHANNEL=${SLACK_NOTIFICATION_CHANNEL:-}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        mkdir -p /vocalia-data/metrics /vocalia-data/voice/hitl-pending /vocalia-data/audit /vocalia-data/clients /vocalia-data/logs/analytics &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data clients logs 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        ln -sf /vocalia-data/clients clients &&
        ln -sf /vocalia-data/logs logs &&
        mkdir -p data logs/analytics &&
        echo '{\"spreadsheetId\":\"1USAmFgxpXh9yvtAFxvg0_CpmWVop1pOTmxALEE8M4PM\",\"sheets\":{\"tenants\":\"tenants\",\"sessions\":\"sessions\",\"logs\":\"logs\",\"users\":\"users\"}}' > data/google-sheets-config.json &&
        echo '{\"type\":\"authorized_user\",\"client_id\":\"'\"$$GOOGLE_CLIENT_ID\"'\",\"client_secret\":\"'\"$$GOOGLE_CLIENT_SECRET\"'\",\"refresh_token\":\"'\"$$GOOGLE_REFRESH_TOKEN\"'\"}' > data/google-oauth-tokens.json &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node core/db-api.cjs
      "
    expose:
      - "3013"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Route all DB API paths to this service
      - "traefik.http.routers.vocalia-db.rule=Host(`api.vocalia.ma`) && (PathPrefix(`/api/auth`) || PathPrefix(`/api/hitl`) || PathPrefix(`/api/kb`) || PathPrefix(`/api/tenants`) || PathPrefix(`/api/logs`) || PathPrefix(`/api/catalog`) || PathPrefix(`/api/db`) || PathPrefix(`/api/telephony`) || PathPrefix(`/api/recommendations`) || PathPrefix(`/api/leads`) || PathPrefix(`/api/cart-recovery`) || PathPrefix(`/api/promo`) || PathPrefix(`/api/quota`) || PathPrefix(`/api/ucp`) || PathPrefix(`/api/health`) || PathPrefix(`/api/billing`))"
      - "traefik.http.routers.vocalia-db.entrypoints=websecure"
      - "traefik.http.routers.vocalia-db.tls=true"
      - "traefik.http.routers.vocalia-db.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-db.priority=100"
      - "traefik.http.services.vocalia-db.loadbalancer.server.port=3013"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3013/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # VOICE API - AI Response Generation (Grok, Gemini, ElevenLabs)
  # Routes: api.vocalia.ma/* (default, lower priority)
  # ═══════════════════════════════════════════════════════════════
  vocalia-api:
    image: node:22-alpine
    container_name: vocalia-api
    restart: unless-stopped
    working_dir: /app
    volumes:
      - vocalia-data:/vocalia-data
    environment:
      - NODE_ENV=production
      - PORT=3004
      - XAI_API_KEY=${XAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      - GA4_MEASUREMENT_ID=${GA4_MEASUREMENT_ID}
      - GA4_API_SECRET=${GA4_API_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - VOCALIA_VAULT_KEY=${VOCALIA_VAULT_KEY}
      - VOCALIA_INTERNAL_KEY=${VOCALIA_INTERNAL_KEY:-}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_NOTIFICATION_CHANNEL=${SLACK_NOTIFICATION_CHANNEL:-}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        mkdir -p /vocalia-data/metrics /vocalia-data/voice /vocalia-data/clients /vocalia-data/logs/analytics &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data clients logs 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        ln -sf /vocalia-data/clients clients &&
        ln -sf /vocalia-data/logs logs &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node core/voice-api-resilient.cjs --server --port=3004
      "
    expose:
      - "3004"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vocalia-api.rule=Host(`api.vocalia.ma`)"
      - "traefik.http.routers.vocalia-api.entrypoints=websecure"
      - "traefik.http.routers.vocalia-api.tls=true"
      - "traefik.http.routers.vocalia-api.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-api.priority=50"
      - "traefik.http.services.vocalia-api.loadbalancer.server.port=3004"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # GROK REALTIME - WebSocket Voice Streaming
  # Routes: api.vocalia.ma/realtime/* (primary) + ws.vocalia.ma (alias, needs DNS)
  # ═══════════════════════════════════════════════════════════════
  vocalia-realtime:
    image: node:22-alpine
    container_name: vocalia-realtime
    restart: unless-stopped
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3007
      - XAI_API_KEY=${XAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app &&
        exec su-exec node node core/grok-voice-realtime.cjs --server --port=3007
      "
    expose:
      - "3007"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Path-based routing via api.vocalia.ma (no extra DNS needed)
      - "traefik.http.routers.vocalia-realtime.rule=Host(`api.vocalia.ma`) && PathPrefix(`/realtime`)"
      - "traefik.http.routers.vocalia-realtime.entrypoints=websecure"
      - "traefik.http.routers.vocalia-realtime.tls=true"
      - "traefik.http.routers.vocalia-realtime.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-realtime.priority=90"
      - "traefik.http.routers.vocalia-realtime.middlewares=strip-realtime"
      - "traefik.http.middlewares.strip-realtime.stripprefix.prefixes=/realtime"
      # Subdomain alias (works if ws.vocalia.ma DNS is configured)
      - "traefik.http.routers.vocalia-ws.rule=Host(`ws.vocalia.ma`)"
      - "traefik.http.routers.vocalia-ws.entrypoints=websecure"
      - "traefik.http.routers.vocalia-ws.tls=true"
      - "traefik.http.routers.vocalia-ws.tls.certresolver=mytlschallenge"
      - "traefik.http.services.vocalia-ws.loadbalancer.server.port=3007"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # TELEPHONY - Twilio PSTN Bridge
  # Routes: api.vocalia.ma/telephony/* (primary) + tel.vocalia.ma (alias, needs DNS)
  # ═══════════════════════════════════════════════════════════════
  vocalia-telephony:
    image: node:22-alpine
    container_name: vocalia-telephony
    restart: unless-stopped
    working_dir: /app
    volumes:
      - vocalia-data:/vocalia-data
    environment:
      - NODE_ENV=production
      - PORT=3009
      - XAI_API_KEY=${XAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REFRESH_TOKEN=${GOOGLE_REFRESH_TOKEN}
      - GA4_MEASUREMENT_ID=${GA4_MEASUREMENT_ID}
      - GA4_API_SECRET=${GA4_API_SECRET}
      - VOCALIA_VAULT_KEY=${VOCALIA_VAULT_KEY}
      - VOCALIA_VAULT_KEY=${VOCALIA_VAULT_KEY}
      - VOCALIA_INTERNAL_KEY=${VOCALIA_INTERNAL_KEY:-}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        mkdir -p /vocalia-data/voice/hitl-pending &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node telephony/voice-telephony-bridge.cjs
      "
    expose:
      - "3009"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Path-based routing via api.vocalia.ma (no extra DNS needed)
      - "traefik.http.routers.vocalia-telephony.rule=Host(`api.vocalia.ma`) && PathPrefix(`/telephony`)"
      - "traefik.http.routers.vocalia-telephony.entrypoints=websecure"
      - "traefik.http.routers.vocalia-telephony.tls=true"
      - "traefik.http.routers.vocalia-telephony.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-telephony.priority=80"
      - "traefik.http.routers.vocalia-telephony.middlewares=strip-telephony"
      - "traefik.http.routers.vocalia-telephony.middlewares=strip-telephony"
      - "traefik.http.middlewares.strip-telephony.stripprefix.prefixes=/telephony"
      # WhatsApp Webhook Routing (Session 250.216: SOTA Pattern #2)
      - "traefik.http.routers.vocalia-whatsapp.rule=Host(`api.vocalia.ma`) && PathPrefix(`/whatsapp`)"
      - "traefik.http.routers.vocalia-whatsapp.entrypoints=websecure"
      - "traefik.http.routers.vocalia-whatsapp.tls=true"
      - "traefik.http.routers.vocalia-whatsapp.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-whatsapp.priority=90"
      - "traefik.http.services.vocalia-whatsapp.loadbalancer.server.port=3009"
      # Subdomain alias (works if tel.vocalia.ma DNS is configured)
      - "traefik.http.routers.vocalia-tel.rule=Host(`tel.vocalia.ma`)"
      - "traefik.http.routers.vocalia-tel.entrypoints=websecure"
      - "traefik.http.routers.vocalia-tel.tls=true"
      - "traefik.http.routers.vocalia-tel.tls.certresolver=mytlschallenge"
      - "traefik.http.services.vocalia-tel.loadbalancer.server.port=3009"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # OAUTH GATEWAY - OAuth 2.0 Flows (HubSpot, Shopify, Google, Stripe, Zoho)
  # Routes: api.vocalia.ma/oauth/*
  # Profile: integrations (not started by default)
  # ═══════════════════════════════════════════════════════════════
  vocalia-oauth:
    image: node:22-alpine
    container_name: vocalia-oauth
    restart: unless-stopped
    working_dir: /app
    profiles: ["integrations"]
    volumes:
      - vocalia-data:/vocalia-data
    environment:
      - NODE_ENV=production
      - OAUTH_PORT=3010
      - OAUTH_BASE_URL=https://api.vocalia.ma
      - GOOGLE_CLIENT_ID=${GOOGLE_SSO_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_SSO_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - SLACK_CLIENT_ID=${SLACK_CLIENT_ID:-}
      - SLACK_CLIENT_SECRET=${SLACK_CLIENT_SECRET:-}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node core/OAuthGateway.cjs --start
      "
    expose:
      - "3010"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Routes: /oauth/start/:provider, /oauth/callback/:provider, /oauth/login/:provider, /oauth/login/callback/:provider, /oauth/providers
      - "traefik.http.routers.vocalia-oauth.rule=Host(`api.vocalia.ma`) && PathPrefix(`/oauth`)"
      - "traefik.http.routers.vocalia-oauth.entrypoints=websecure"
      - "traefik.http.routers.vocalia-oauth.tls=true"
      - "traefik.http.routers.vocalia-oauth.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-oauth.priority=95"
      - "traefik.http.services.vocalia-oauth.loadbalancer.server.port=3010"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # WEBHOOK ROUTER - Inbound Webhooks (HubSpot, Shopify, Stripe, Klaviyo, Google)
  # Routes: api.vocalia.ma/webhook/*
  # Profile: integrations (not started by default)
  # ═══════════════════════════════════════════════════════════════
  vocalia-webhooks:
    image: node:22-alpine
    container_name: vocalia-webhooks
    restart: unless-stopped
    working_dir: /app
    profiles: ["integrations"]
    volumes:
      - vocalia-data:/vocalia-data
    environment:
      - NODE_ENV=production
      - WEBHOOK_PORT=3011
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_PRICE_STARTER=${STRIPE_PRICE_STARTER:-}
      - STRIPE_PRICE_PRO=${STRIPE_PRICE_PRO:-}
      - STRIPE_PRICE_ECOMMERCE=${STRIPE_PRICE_ECOMMERCE:-}
      - STRIPE_PRICE_EXPERT_CLONE=${STRIPE_PRICE_EXPERT_CLONE:-}
      - STRIPE_PRICE_TELEPHONY=${STRIPE_PRICE_TELEPHONY:-}
      - VOCALIA_VAULT_KEY=${VOCALIA_VAULT_KEY}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node core/WebhookRouter.cjs --start
      "
    expose:
      - "3011"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      # Internal routes: /webhook/:provider, /webhook/handlers, /webhook/events/:tenantId
      - "traefik.http.routers.vocalia-webhooks.rule=Host(`api.vocalia.ma`) && PathPrefix(`/webhook`)"
      - "traefik.http.routers.vocalia-webhooks.entrypoints=websecure"
      - "traefik.http.routers.vocalia-webhooks.tls=true"
      - "traefik.http.routers.vocalia-webhooks.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-webhooks.priority=93"
      - "traefik.http.services.vocalia-webhooks.loadbalancer.server.port=3011"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # HITL VIDEO STUDIO - Approval Workflow + Kling/Veo Generation
  # Routes: api.vocalia.ma/hitl/*
  # Profile: video (not started by default)
  # Requires: Python3 + PyJWT (Kling auth) + google-auth (Veo auth)
  # ═══════════════════════════════════════════════════════════════
  vocalia-hitl:
    image: node:22-alpine
    container_name: vocalia-hitl
    restart: unless-stopped
    working_dir: /app
    profiles: ["video"]
    volumes:
      - vocalia-data:/vocalia-data
      - ./vocalia-veo-key.json:/secrets/vocalia-veo-key.json:ro
    environment:
      - NODE_ENV=production
      - REMOTION_HITL_PORT=3012
      - KLING_ACCESS_KEY=${KLING_ACCESS_KEY}
      - KLING_SECRET_KEY=${KLING_SECRET_KEY}
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_CLOUD_REGION=${GOOGLE_CLOUD_REGION:-us-central1}
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/vocalia-veo-key.json
    command: >
      sh -c "
        apk add --no-cache git curl su-exec python3 py3-pip &&
        pip3 install --break-system-packages PyJWT requests python-dotenv google-auth google-cloud-storage 2>/dev/null || true &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app &&
        rm -rf data 2>/dev/null || true &&
        ln -sf /vocalia-data data &&
        mkdir -p data/remotion-hitl/outputs &&
        npm install --production --ignore-scripts 2>/dev/null || true &&
        chown -R node:node /app /vocalia-data &&
        exec su-exec node node core/remotion-hitl.cjs --server
      "
    expose:
      - "3012"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vocalia-hitl.rule=Host(`api.vocalia.ma`) && PathPrefix(`/hitl`)"
      - "traefik.http.routers.vocalia-hitl.entrypoints=websecure"
      - "traefik.http.routers.vocalia-hitl.tls=true"
      - "traefik.http.routers.vocalia-hitl.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-hitl.priority=92"
      - "traefik.http.routers.vocalia-hitl.middlewares=strip-hitl"
      - "traefik.http.middlewares.strip-hitl.stripprefix.prefixes=/hitl"
      - "traefik.http.services.vocalia-hitl.loadbalancer.server.port=3012"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════
  # MCP SERVER - 203 Tools + 6 Resources + 8 Prompts (TypeScript)
  # Routes: api.vocalia.ma/mcp
  # Profile: mcp (not started by default)
  # ═══════════════════════════════════════════════════════════════
  vocalia-mcp:
    image: node:22-alpine
    container_name: vocalia-mcp
    restart: unless-stopped
    working_dir: /app/mcp-server
    profiles: ["mcp"]
    environment:
      - NODE_ENV=production
      - MCP_PORT=3015
      - MCP_TRANSPORT=streamable-http
      - VOCALIA_API_URL=http://vocalia-api:3004
      - VOCALIA_TELEPHONY_URL=http://vocalia-telephony:3009
      - VOCALIA_API_KEY=${VOCALIA_API_KEY:-}
    command: >
      sh -c "
        apk add --no-cache git curl su-exec &&
        git clone --depth 1 https://github.com/Jouiet/VocalIA.git /app 2>/dev/null || (cd /app && git pull) &&
        cd /app/mcp-server &&
        npm install --ignore-scripts 2>/dev/null || true &&
        npx tsc &&
        chown -R node:node /app &&
        exec su-exec node node dist/index.js
      "
    expose:
      - "3015"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vocalia-mcp.rule=Host(`api.vocalia.ma`) && PathPrefix(`/mcp`)"
      - "traefik.http.routers.vocalia-mcp.entrypoints=websecure"
      - "traefik.http.routers.vocalia-mcp.tls=true"
      - "traefik.http.routers.vocalia-mcp.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.vocalia-mcp.priority=85"
      - "traefik.http.services.vocalia-mcp.loadbalancer.server.port=3015"
      - "traefik.docker.network=root_default"
    networks:
      - default
      - traefik
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3015/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  vocalia-data:
    name: vocalia-data
    external: true

networks:
  traefik:
    name: root_default
    external: true
