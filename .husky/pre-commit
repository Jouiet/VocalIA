#!/bin/sh

# VocalIA Pre-commit Hook (Optimized)
# Runs tests only when code files change, skips for docs-only

echo "ğŸ” Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any code files are staged (not just docs/markdown)
CODE_CHANGED=$(echo "$STAGED_FILES" | grep -E '\.(js|cjs|ts|json)$' | grep -v 'package-lock.json' | grep -v 'translation_qa_report.json' || true)

if [ -n "$CODE_CHANGED" ]; then
  echo "ğŸ“‹ Code changes detected, running tests..."
  npm test || exit 1
else
  echo "ğŸ“ Documentation-only changes, skipping tests"
fi

# Always check JSON validity for critical files
echo "ğŸ“„ Checking JSON files..."
for f in package.json telephony/knowledge_base.json; do
  if echo "$STAGED_FILES" | grep -q "$f"; then
    node -e "JSON.parse(require('fs').readFileSync('$f'))" || exit 1
  fi
done

echo "âœ… All pre-commit checks passed!"
