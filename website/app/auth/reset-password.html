<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Réinitialiser le mot de passe - VocalIA</title>
  <meta name="description" content="Créez un nouveau mot de passe VocalIA">

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KL1QZYZRE8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KL1QZYZRE8');
  </script>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <link href="/public/css/style.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

  <!-- i18n -->
  <script src="/src/lib/i18n.js"></script>

  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .input-focus:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .strength-bar {
      transition: width 0.3s ease, background-color 0.3s ease;
    }
  </style>
</head>
<body class="min-h-screen bg-zinc-50 dark:bg-[#050505] flex items-center justify-center p-4">

  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-8">
      <a href="/" class="inline-flex items-center gap-2">
        <img src="/public/images/logo.webp" alt="VocalIA" class="w-12 h-12 rounded-xl object-contain">
        <span class="text-2xl font-bold text-zinc-900 dark:text-white">VocalIA</span>
      </a>
    </div>

    <!-- Card -->
    <div class="bg-white dark:bg-white/[0.06] rounded-2xl shadow-xl border border-zinc-200 dark:border-white/[0.08] p-8">
      <!-- Invalid Token View -->
      <div id="invalid-view" class="hidden">
        <div class="text-center">
          <div class="w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mx-auto mb-4">
            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600 dark:text-red-400"></i>
          </div>
          <h2 class="text-2xl font-bold text-zinc-900 dark:text-white mb-2" data-i18n="auth.invalid_token_title">
            Lien invalide
          </h2>
          <p class="text-zinc-600 dark:text-zinc-400 mb-6" data-i18n="auth.invalid_token_message">
            Ce lien de réinitialisation est invalide ou a expiré. Veuillez demander un nouveau lien.
          </p>
          <a
            href="forgot-password.html"
            class="inline-flex items-center gap-2 py-2.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors"
          >
            <span data-i18n="auth.request_new_link">Demander un nouveau lien</span>
            <i data-lucide="arrow-right" class="w-4 h-4"></i>
          </a>
        </div>
      </div>

      <!-- Reset Form View -->
      <div id="reset-view">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mx-auto mb-4">
            <i data-lucide="lock" class="w-8 h-8 text-indigo-600 dark:text-indigo-400"></i>
          </div>
          <h1 class="text-2xl font-bold text-zinc-900 dark:text-white" data-i18n="auth.reset_title">
            Nouveau mot de passe
          </h1>
          <p class="text-zinc-600 dark:text-zinc-400 mt-2" data-i18n="auth.reset_subtitle">
            Créez un nouveau mot de passe sécurisé
          </p>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="hidden mb-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800">
          <div class="flex items-center gap-2 text-red-700 dark:text-red-300">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span id="error-message" class="text-sm"></span>
          </div>
        </div>

        <form id="reset-form" class="space-y-5">
          <!-- New Password -->
          <div>
            <label for="password" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5" data-i18n="auth.new_password">
              Nouveau mot de passe
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 rtl:left-auto rtl:right-0 pl-3 rtl:pr-3 flex items-center pointer-events-none">
                <i data-lucide="lock" class="w-5 h-5 text-zinc-400"></i>
              </div>
              <input
                type="password"
                id="password"
                name="password"
                required
                autocomplete="new-password"
                minlength="8"
                class="input-focus block w-full pl-10 rtl:pl-3 rtl:pr-10 pr-10 py-2.5 border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-900 dark:text-white placeholder-zinc-400 focus:outline-none focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                placeholder="••••••••"
              >
              <button
                type="button"
                id="toggle-password"
                class="absolute inset-y-0 right-0 rtl:right-auto rtl:left-0 pr-3 rtl:pl-3 flex items-center"
              >
                <i data-lucide="eye" class="w-5 h-5 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300"></i>
              </button>
            </div>

            <!-- Password Strength -->
            <div class="mt-2">
              <div class="h-1.5 w-full bg-zinc-200 dark:bg-white/[0.06] rounded-full overflow-hidden">
                <div id="strength-bar" class="strength-bar h-full w-0 bg-zinc-400 rounded-full"></div>
              </div>
              <p id="strength-text" class="text-xs text-zinc-500 mt-1"></p>
            </div>
          </div>

          <!-- Confirm Password -->
          <div>
            <label for="confirm-password" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5" data-i18n="auth.confirm_password">
              Confirmer le mot de passe
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 rtl:left-auto rtl:right-0 pl-3 rtl:pr-3 flex items-center pointer-events-none">
                <i data-lucide="lock" class="w-5 h-5 text-zinc-400"></i>
              </div>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                required
                autocomplete="new-password"
                minlength="8"
                class="input-focus block w-full pl-10 rtl:pl-3 rtl:pr-10 pr-10 py-2.5 border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-900 dark:text-white placeholder-zinc-400 focus:outline-none focus:border-indigo-500 dark:focus:border-indigo-400 transition-colors"
                placeholder="••••••••"
              >
              <button
                type="button"
                id="toggle-confirm"
                class="absolute inset-y-0 right-0 rtl:right-auto rtl:left-0 pr-3 rtl:pl-3 flex items-center"
              >
                <i data-lucide="eye" class="w-5 h-5 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300"></i>
              </button>
            </div>
            <p id="match-error" class="hidden text-xs text-red-500 mt-1" data-i18n="auth.passwords_not_match">
              Les mots de passe ne correspondent pas
            </p>
          </div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full py-2.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span data-i18n="auth.reset_password_button">Réinitialiser le mot de passe</span>
            <i data-lucide="check" class="w-4 h-4"></i>
          </button>
        </form>
      </div>

      <!-- Success View -->
      <div id="success-view" class="hidden">
        <div class="text-center">
          <div class="w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-4">
            <i data-lucide="check-circle" class="w-8 h-8 text-green-600 dark:text-green-400"></i>
          </div>
          <h2 class="text-2xl font-bold text-zinc-900 dark:text-white mb-2" data-i18n="auth.reset_success_title">
            Mot de passe modifié !
          </h2>
          <p class="text-zinc-600 dark:text-zinc-400 mb-6" data-i18n="auth.reset_success_message">
            Votre mot de passe a été modifié avec succès. Vous pouvez maintenant vous connecter.
          </p>
          <a
            href="login.html"
            class="inline-flex items-center gap-2 py-2.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors"
          >
            <span data-i18n="auth.go_to_login">Se connecter</span>
            <i data-lucide="arrow-right" class="w-4 h-4"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Language Switcher -->
    <div class="flex justify-center gap-2 mt-6">
      <button data-action="switchLang" data-params="fr" class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">FR</button>
      <span class="text-zinc-300">|</span>
      <button data-action="switchLang" data-params="en" class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">EN</button>
      <span class="text-zinc-300">|</span>
      <button data-action="switchLang" data-params="es" class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">ES</button>
      <span class="text-zinc-300">|</span>
      <button data-action="switchLang" data-params="ar" dir="rtl" class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">عربي</button>
      <span class="text-zinc-300">|</span>
      <button data-action="switchLang" data-params="ary" class="text-sm text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">دارجة</button>
    </div>
  </div>

  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import toast from '/src/lib/toast.js';

    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    // Initialize Lucide icons
    lucide.createIcons();

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    const resetView = document.getElementById('reset-view');
    const invalidView = document.getElementById('invalid-view');
    const successView = document.getElementById('success-view');
    const form = document.getElementById('reset-form');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm-password');
    const submitBtn = document.getElementById('submit-btn');
    const errorAlert = document.getElementById('error-alert');
    const errorMessage = document.getElementById('error-message');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    const matchError = document.getElementById('match-error');

    // Check if token exists
    if (!token) {
      resetView.classList.add('hidden');
      invalidView.classList.remove('hidden');
      lucide.createIcons();
    }

    // Password strength checker
    function checkStrength(password) {
      let score = 0;
      if (password.length >= 8) score++;
      if (password.length >= 12) score++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
      if (/\d/.test(password)) score++;
      if (/[^a-zA-Z0-9]/.test(password)) score++;
      return score;
    }

    function updateStrengthIndicator(password) {
      const score = checkStrength(password);
      const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-lime-500', 'bg-green-500'];
      const t = window.VocaliaI18n?.t || ((k, fb) => fb);
      const labels = [
        t('signup.password_very_weak', 'Très faible'),
        t('signup.password_weak', 'Faible'),
        t('signup.password_medium', 'Moyen'),
        t('signup.password_strong', 'Fort'),
        t('signup.password_very_strong', 'Très fort')
      ];
      const widths = ['20%', '40%', '60%', '80%', '100%'];

      strengthBar.className = `strength-bar h-full rounded-full ${colors[score - 1] || 'bg-zinc-400'}`;
      strengthBar.style.width = password ? widths[score - 1] || '0%' : '0%';
      strengthText.textContent = password ? labels[score - 1] || '' : '';
    }

    passwordInput.addEventListener('input', () => {
      updateStrengthIndicator(passwordInput.value);
      checkMatch();
    });

    confirmInput.addEventListener('input', checkMatch);

    function checkMatch() {
      if (confirmInput.value && passwordInput.value !== confirmInput.value) {
        matchError.classList.remove('hidden');
        confirmInput.classList.add('border-red-500');
      } else {
        matchError.classList.add('hidden');
        confirmInput.classList.remove('border-red-500');
      }
    }

    // Toggle password visibility
    function setupToggle(toggleBtn, input) {
      toggleBtn.addEventListener('click', () => {
        const type = input.type === 'password' ? 'text' : 'password';
        input.type = type;
        const icon = toggleBtn.querySelector('i');
        icon.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
        lucide.createIcons();
      });
    }

    setupToggle(document.getElementById('toggle-password'), passwordInput);
    setupToggle(document.getElementById('toggle-confirm'), confirmInput);

    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.remove('hidden');
      lucide.createIcons();
    }

    function hideError() {
      errorAlert.classList.add('hidden');
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitBtn.innerHTML = `
          <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Traitement...</span>
        `;
      } else {
        submitBtn.innerHTML = `
          <span data-i18n="auth.reset_password_button">Réinitialiser le mot de passe</span>
          <i data-lucide="check" class="w-4 h-4"></i>
        `;
        lucide.createIcons();
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;

      if (password !== confirmPassword) {
        showError('Les mots de passe ne correspondent pas');
        return;
      }

      if (checkStrength(password) < 3) {
        showError('Veuillez choisir un mot de passe plus fort');
        return;
      }

      setLoading(true);

      try {
        await auth.resetPassword(token, password);
        resetView.classList.add('hidden');
        successView.classList.remove('hidden');
        lucide.createIcons();
      } catch (error) {
        console.error('Reset error:', error);
        if (error.code === 'INVALID_TOKEN' || error.code === 'TOKEN_EXPIRED') {
          resetView.classList.add('hidden');
          invalidView.classList.remove('hidden');
        } else {
          showError(error.message || 'Une erreur est survenue');
        }
        setLoading(false);
        lucide.createIcons();
      }
    });

    // Language switcher
    document.querySelectorAll('[data-action="switchLang"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-params');
        localStorage.setItem('vocalia_lang', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = ['ar', 'ary'].includes(lang) ? 'rtl' : 'ltr';
      });
    });

    if (token) passwordInput.focus();
  </script>
</body>
</html>
