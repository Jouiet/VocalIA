<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Logs Système - VocalIA Admin</title>

  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="/public/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
  <script src="/src/lib/i18n.js"></script>
  <script src="/app/components/app-components.js" defer></script>
  <style>
    .sidebar { width: 260px; }
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 40; }
      .sidebar.open { transform: translateX(0); }
    }
  </style>
</head>
<body class="min-h-screen bg-zinc-50 dark:bg-[#050505]">

  <!-- Admin Sidebar (component) -->
  <div data-app-component="admin-sidebar"></div>

  <main class="lg:ml-[260px] rtl:lg:ml-0 rtl:lg:mr-[260px] min-h-screen">
    <header class="sticky top-0 z-20 bg-white/80 dark:bg-white/[0.06] backdrop-blur-sm border-b border-zinc-200 dark:border-white/[0.08] px-4 lg:px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="menu-toggle" class="lg:hidden p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <div>
            <h1 class="text-xl lg:text-2xl font-bold text-zinc-900 dark:text-white" data-i18n="admin.logs.title">Logs Système</h1>
            <p class="text-zinc-600 dark:text-zinc-400" data-i18n="admin.logs.subtitle">Activité et événements en temps réel</p>
          </div>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="auto-refresh" checked class="w-4 h-4 text-indigo-600 border-zinc-300 rounded focus:ring-indigo-500">
              <span class="text-sm text-zinc-600 dark:text-zinc-400">Auto-refresh</span>
            </label>
            <button id="export-btn" class="inline-flex items-center gap-2 px-4 py-2 border border-zinc-300 dark:border-white/[0.08] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg hover:bg-zinc-50 dark:hover:bg-white/[0.08] transition-colors">
              <i data-lucide="download" class="w-4 h-4"></i>
              Exporter
            </button>
          </div>
        </div>
      </header>

      <div class="px-6 py-6">
        <!-- Filters -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 mb-6 hover:shadow-lg transition-all duration-200">
          <div class="flex flex-wrap items-center gap-4">
            <div>
              <label class="block text-xs text-zinc-500 mb-1">Niveau</label>
              <select id="filter-level" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-700 dark:text-zinc-200">
                <option value="">Tous</option>
                <option value="error">Error</option>
                <option value="warn">Warning</option>
                <option value="info">Info</option>
                <option value="debug">Debug</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-zinc-500 mb-1">Service</label>
              <select id="filter-service" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-700 dark:text-zinc-200">
                <option value="" data-i18n="common.all">Tous</option>
                <option value="voice-api" data-i18n="admin.services.voice">Assistant Vocal</option>
                <option value="grok" data-i18n="admin.services.realtime">Communication Temps Réel</option>
                <option value="telephony" data-i18n="admin.services.telephony">Téléphonie</option>
                <option value="auth" data-i18n="admin.logs.auth">Authentification</option>
                <option value="db" data-i18n="admin.services.database">Base de Données</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-zinc-500 mb-1">Période</label>
              <select id="filter-period" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-700 dark:text-zinc-200">
                <option value="1h">Dernière heure</option>
                <option value="24h" selected>24 heures</option>
                <option value="7d">7 jours</option>
                <option value="30d">30 jours</option>
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-xs text-zinc-500 mb-1">Recherche</label>
              <input type="text" id="filter-search" placeholder="Rechercher dans les logs..." class="w-full px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg bg-white dark:bg-white/[0.06] text-zinc-700 dark:text-zinc-200">
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-red-600" id="stat-errors">0</p>
                <p class="text-sm text-zinc-500">Errors</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-amber-600" id="stat-warnings">0</p>
                <p class="text-sm text-zinc-500">Warnings</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-blue-600" id="stat-info">0</p>
                <p class="text-sm text-zinc-500">Info</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-zinc-100 dark:bg-white/[0.06] flex items-center justify-center">
                <i data-lucide="terminal" class="w-5 h-5 text-zinc-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="stat-total">0</p>
                <p class="text-sm text-zinc-500">Total</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs List -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] overflow-hidden hover:shadow-lg transition-all duration-200">
          <div id="logs-container" class="divide-y divide-zinc-200 dark:divide-white/[0.08] max-h-[600px] overflow-y-auto font-mono text-sm">
            <!-- Logs will be rendered here -->
          </div>
        </div>
      </div>
    </main>

  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import api from '/src/lib/api-client.js';
    import toast from '/src/lib/toast.js';

    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    // Initialize Lucide icons
    lucide.createIcons();

    // Theme init
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }

    if (!auth.requireRole('admin')) {
      throw new Error('Not authorized');
    }

    const user = auth.getCurrentUser();
    if (user) {
      document.getElementById('admin-name').textContent = user.name || 'Admin';
      document.getElementById('admin-email').textContent = user.email || '';
      document.getElementById('admin-initials').textContent = (user.name || 'A').split(' ').map(n => n[0]).join('').toUpperCase();
    }

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.logout();
      window.location.href = '/app/auth/login.html';
    });

    const logsContainer = document.getElementById('logs-container');
    let refreshInterval = null;
    let allLogs = [];

    // Load logs from API
    async function loadLogs() {
      try {
        const result = await api.logs.list();
        allLogs = (result.data || []).map(log => ({
          timestamp: log.timestamp || log.created_at,
          level: log.level || 'info',
          service: log.service || 'system',
          message: log.message || '',
          details: log.details || null
        }));
        filterLogs();
      } catch (error) {
        console.error('Failed to load logs:', error);
        // Show empty state
        allLogs = [];
        renderLogs([]);
        toast.error('Erreur lors du chargement des logs');
      }
    }

    // Load on page load
    loadLogs();

    function getLevelColor(level) {
      return {
        error: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
        warn: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
        info: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
        debug: 'bg-zinc-100 text-zinc-800 dark:bg-white/[0.06] dark:text-zinc-300'
      }[level] || 'bg-zinc-100 text-zinc-800';
    }

    function renderLogs(logs) {
      logsContainer.innerHTML = logs.map(log => `
        <div class="p-3 hover:bg-zinc-50 dark:hover:bg-white/[0.08]/50 cursor-pointer" onclick="this.querySelector('.details').classList.toggle('hidden')">
          <div class="flex items-start gap-3">
            <span class="text-xs text-zinc-400 whitespace-nowrap">${new Date(log.timestamp).toLocaleTimeString()}</span>
            <span class="px-1.5 py-0.5 text-xs rounded ${getLevelColor(log.level)} uppercase font-medium">${log.level}</span>
            <span class="px-1.5 py-0.5 text-xs bg-zinc-100 dark:bg-white/[0.06] text-zinc-600 dark:text-zinc-400 rounded">${log.service}</span>
            <span class="text-zinc-700 dark:text-zinc-300 flex-1">${log.message}</span>
          </div>
          ${log.details ? `
            <div class="details hidden mt-2 ml-[140px] text-xs text-zinc-500 bg-zinc-50 dark:bg-[#050505] p-2 rounded">
              <pre>${JSON.stringify(log.details, null, 2)}</pre>
            </div>
          ` : ''}
        </div>
      `).join('');

      // Update stats
      document.getElementById('stat-errors').textContent = logs.filter(l => l.level === 'error').length;
      document.getElementById('stat-warnings').textContent = logs.filter(l => l.level === 'warn').length;
      document.getElementById('stat-info').textContent = logs.filter(l => l.level === 'info').length;
      document.getElementById('stat-total').textContent = logs.length;
    }

    function filterLogs() {
      const level = document.getElementById('filter-level').value;
      const service = document.getElementById('filter-service').value;
      const period = document.getElementById('filter-period').value;
      const search = document.getElementById('filter-search').value.toLowerCase();

      let filtered = allLogs;

      if (period) {
        const now = Date.now();
        const ms = { '1h': 3600000, '24h': 86400000, '7d': 604800000, '30d': 2592000000 }[period] || 86400000;
        filtered = filtered.filter(l => {
          const t = new Date(l.timestamp || l.created_at || l.date).getTime();
          return t > now - ms;
        });
      }
      if (level) {
        filtered = filtered.filter(l => l.level === level);
      }
      if (service) {
        filtered = filtered.filter(l => l.service === service);
      }
      if (search) {
        filtered = filtered.filter(l => l.message.toLowerCase().includes(search));
      }

      renderLogs(filtered);
    }

    // Filter listeners
    document.getElementById('filter-level').addEventListener('change', filterLogs);
    document.getElementById('filter-service').addEventListener('change', filterLogs);
    document.getElementById('filter-period').addEventListener('change', filterLogs);
    document.getElementById('filter-search').addEventListener('input', filterLogs);

    // Auto-refresh
    document.getElementById('auto-refresh').addEventListener('change', (e) => {
      if (e.target.checked) {
        refreshInterval = setInterval(async () => {
          await loadLogs();
          toast.info('Logs actualisés');
        }, 10000);
      } else {
        clearInterval(refreshInterval);
      }
    });

    // Export button
    document.getElementById('export-btn').addEventListener('click', () => {
      if (allLogs.length === 0) {
        toast.error('Aucun log à exporter');
        return;
      }
      const dataStr = JSON.stringify(allLogs, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vocalia-logs-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast.success('Logs exportés en JSON');
    });
  </script>
</body>
</html>
