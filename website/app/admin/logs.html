<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Logs Système - VocalIA Admin</title>

  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="/public/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
  <script src="/src/lib/i18n.js"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 min-h-screen">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col">
      <div class="p-4 border-b border-slate-700">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
            <i data-lucide="mic" class="w-5 h-5 text-white"></i>
          </div>
          <span class="text-xl font-bold">VocalIA</span>
          <span class="text-xs px-1.5 py-0.5 bg-amber-500 text-amber-900 rounded font-medium">Admin</span>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1">
        <a href="index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span data-i18n="admin.nav.dashboard">Dashboard</span>
        </a>
        <a href="tenants.html" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="building-2" class="w-5 h-5"></i>
          <span data-i18n="admin.nav.tenants">Tenants</span>
        </a>
        <a href="users.html" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="users" class="w-5 h-5"></i>
          <span data-i18n="admin.nav.users">Utilisateurs</span>
        </a>
        <a href="logs.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-slate-800 text-white">
          <i data-lucide="scroll-text" class="w-5 h-5"></i>
          <span data-i18n="admin.nav.logs">Logs</span>
        </a>
        <a href="hitl.html" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white">
          <i data-lucide="check-circle" class="w-5 h-5"></i>
          <span data-i18n="admin.nav.hitl">HITL</span>
        </a>
        <div class="pt-4 mt-4 border-t border-slate-700">
          <a href="/app/client/" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span data-i18n="admin.nav.back_client">Retour client</span>
          </a>
        </div>
      </nav>

      <div class="p-4 border-t border-slate-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center">
            <span id="admin-initials" class="font-medium">--</span>
          </div>
          <div class="flex-1 min-w-0">
            <p id="admin-name" class="text-sm font-medium truncate">Admin</p>
            <p id="admin-email" class="text-xs text-slate-400 truncate"></p>
          </div>
          <button id="logout-btn" class="p-2 rounded-lg hover:bg-slate-800">
            <i data-lucide="log-out" class="w-5 h-5 text-slate-400"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto">
      <header class="sticky top-0 z-10 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Logs Système</h1>
            <p class="text-slate-600 dark:text-slate-400">Activité et événements en temps réel</p>
          </div>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="auto-refresh" checked class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
              <span class="text-sm text-slate-600 dark:text-slate-400">Auto-refresh</span>
            </label>
            <button id="export-btn" class="inline-flex items-center gap-2 px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
              <i data-lucide="download" class="w-4 h-4"></i>
              Exporter
            </button>
          </div>
        </div>
      </header>

      <div class="px-6 py-6">
        <!-- Filters -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div>
              <label class="block text-xs text-slate-500 mb-1">Niveau</label>
              <select id="filter-level" class="px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                <option value="">Tous</option>
                <option value="error">Error</option>
                <option value="warn">Warning</option>
                <option value="info">Info</option>
                <option value="debug">Debug</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Service</label>
              <select id="filter-service" class="px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                <option value="">Tous</option>
                <option value="voice-api">Voice API</option>
                <option value="grok">Grok Realtime</option>
                <option value="telephony">Telephony</option>
                <option value="auth">Auth</option>
                <option value="db">Database</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Période</label>
              <select id="filter-period" class="px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                <option value="1h">Dernière heure</option>
                <option value="24h" selected>24 heures</option>
                <option value="7d">7 jours</option>
                <option value="30d">30 jours</option>
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-xs text-slate-500 mb-1">Recherche</label>
              <input type="text" id="filter-search" placeholder="Rechercher dans les logs..." class="w-full px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-red-600" id="stat-errors">0</p>
                <p class="text-sm text-slate-500">Errors</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-amber-600" id="stat-warnings">0</p>
                <p class="text-sm text-slate-500">Warnings</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-blue-600" id="stat-info">0</p>
                <p class="text-sm text-slate-500">Info</p>
              </div>
            </div>
          </div>
          <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
                <i data-lucide="terminal" class="w-5 h-5 text-slate-600"></i>
              </div>
              <div>
                <p class="text-2xl font-bold text-slate-900 dark:text-white" id="stat-total">0</p>
                <p class="text-sm text-slate-500">Total</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs List -->
        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div id="logs-container" class="divide-y divide-slate-200 dark:divide-slate-700 max-h-[600px] overflow-y-auto font-mono text-sm">
            <!-- Logs will be rendered here -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import api from '/src/lib/api-client.js';
    import toast from '/src/lib/toast.js';

    lucide.createIcons();

    if (!auth.requireRole('admin')) {
      throw new Error('Not authorized');
    }

    const user = auth.getCurrentUser();
    if (user) {
      document.getElementById('admin-name').textContent = user.name || 'Admin';
      document.getElementById('admin-email').textContent = user.email || '';
      document.getElementById('admin-initials').textContent = (user.name || 'A').split(' ').map(n => n[0]).join('').toUpperCase();
    }

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.logout();
      window.location.href = '/app/auth/login.html';
    });

    const logsContainer = document.getElementById('logs-container');
    let refreshInterval = null;
    let allLogs = [];

    // Load logs from API
    async function loadLogs() {
      try {
        const result = await api.logs.list();
        allLogs = (result.data || []).map(log => ({
          timestamp: log.timestamp || log.created_at,
          level: log.level || 'info',
          service: log.service || 'system',
          message: log.message || '',
          details: log.details || null
        }));
        filterLogs();
      } catch (error) {
        console.error('Failed to load logs:', error);
        // Show empty state
        allLogs = [];
        renderLogs([]);
        toast.error('Erreur lors du chargement des logs');
      }
    }

    // Load on page load
    loadLogs();

    function getLevelColor(level) {
      return {
        error: 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
        warn: 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
        info: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
        debug: 'bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300'
      }[level] || 'bg-slate-100 text-slate-800';
    }

    function renderLogs(logs) {
      logsContainer.innerHTML = logs.map(log => `
        <div class="p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer" onclick="this.querySelector('.details').classList.toggle('hidden')">
          <div class="flex items-start gap-3">
            <span class="text-xs text-slate-400 whitespace-nowrap">${new Date(log.timestamp).toLocaleTimeString()}</span>
            <span class="px-1.5 py-0.5 text-xs rounded ${getLevelColor(log.level)} uppercase font-medium">${log.level}</span>
            <span class="px-1.5 py-0.5 text-xs bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded">${log.service}</span>
            <span class="text-slate-700 dark:text-slate-300 flex-1">${log.message}</span>
          </div>
          ${log.details ? `
            <div class="details hidden mt-2 ml-[140px] text-xs text-slate-500 bg-slate-50 dark:bg-slate-900 p-2 rounded">
              <pre>${JSON.stringify(log.details, null, 2)}</pre>
            </div>
          ` : ''}
        </div>
      `).join('');

      // Update stats
      document.getElementById('stat-errors').textContent = logs.filter(l => l.level === 'error').length;
      document.getElementById('stat-warnings').textContent = logs.filter(l => l.level === 'warn').length;
      document.getElementById('stat-info').textContent = logs.filter(l => l.level === 'info').length;
      document.getElementById('stat-total').textContent = logs.length;
    }

    function filterLogs() {
      const level = document.getElementById('filter-level').value;
      const service = document.getElementById('filter-service').value;
      const search = document.getElementById('filter-search').value.toLowerCase();

      let filtered = allLogs;

      if (level) {
        filtered = filtered.filter(l => l.level === level);
      }
      if (service) {
        filtered = filtered.filter(l => l.service === service);
      }
      if (search) {
        filtered = filtered.filter(l => l.message.toLowerCase().includes(search));
      }

      renderLogs(filtered);
    }

    // Filter listeners
    document.getElementById('filter-level').addEventListener('change', filterLogs);
    document.getElementById('filter-service').addEventListener('change', filterLogs);
    document.getElementById('filter-period').addEventListener('change', filterLogs);
    document.getElementById('filter-search').addEventListener('input', filterLogs);

    // Auto-refresh
    document.getElementById('auto-refresh').addEventListener('change', (e) => {
      if (e.target.checked) {
        refreshInterval = setInterval(async () => {
          await loadLogs();
          toast.info('Logs actualisés');
        }, 10000);
      } else {
        clearInterval(refreshInterval);
      }
    });

    // Export button
    document.getElementById('export-btn').addEventListener('click', () => {
      if (allLogs.length === 0) {
        toast.error('Aucun log à exporter');
        return;
      }
      const dataStr = JSON.stringify(allLogs, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vocalia-logs-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast.success('Logs exportés en JSON');
    });
  </script>
</body>
</html>
