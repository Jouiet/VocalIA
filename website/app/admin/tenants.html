<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.vocalia.ma https://www.google-analytics.com; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Gestion Tenants - VocalIA Admin</title>

  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/src/lib/dark-mode-init.js"></script>
  <link href="/public/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js" integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM" crossorigin="anonymous"></script>
  <script src="/src/lib/i18n.js"></script>
  <script src="/src/lib/escape-html.js"></script>
  <script src="/app/components/app-components.js" defer></script>
</head>
<body class="min-h-screen bg-zinc-50 dark:bg-[#050505]">

  <!-- Admin Sidebar (component) -->
  <div data-app-component="admin-sidebar"></div>

  <main class="lg:ml-[260px] rtl:lg:ml-0 rtl:lg:mr-[260px] min-h-screen">
    <header class="sticky top-0 z-20 bg-white/80 dark:bg-white/[0.06] backdrop-blur-sm border-b border-zinc-200 dark:border-white/[0.08] px-4 lg:px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="menu-toggle" class="lg:hidden p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <div>
            <h1 class="text-xl lg:text-2xl font-bold text-zinc-900 dark:text-white" data-i18n="admin.tenants.title">Gestion des Tenants</h1>
            <p class="text-zinc-600 dark:text-zinc-400 hidden sm:block" data-i18n="admin.tenants.subtitle">Gérez les clients et leurs abonnements</p>
          </div>
        </div>
          <button id="new-tenant-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
            <i data-lucide="plus" class="w-5 h-5"></i>
            Nouveau tenant
          </button>
        </div>
      </header>

      <div class="px-6 py-6">
        <!-- Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <p class="text-sm text-zinc-500">Total tenants</p>
            <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="stat-total">--</p>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <p class="text-sm text-zinc-500">Actifs</p>
            <p class="text-2xl font-bold text-green-600" id="stat-active">--</p>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <p class="text-sm text-zinc-500">En essai</p>
            <p class="text-2xl font-bold text-amber-600" id="stat-trial">--</p>
          </div>
          <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4 hover:shadow-lg transition-all duration-200">
            <p class="text-sm text-zinc-500">MRR Total</p>
            <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="stat-mrr">--</p>
          </div>
        </div>

        <!-- Tenants Table -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
          <div id="tenants-table"></div>
        </div>
      </div>
    </main>

  <!-- Tenant Detail Modal -->
  <div id="tenant-modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50" onclick="closeTenantModal()"></div>
    <div class="absolute inset-y-0 right-0 w-full max-w-lg bg-white dark:bg-white/[0.06] shadow-xl overflow-auto">
      <div class="sticky top-0 bg-white dark:bg-white/[0.06] border-b border-zinc-200 dark:border-white/[0.08] px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-zinc-900 dark:text-white" id="modal-title">Détails du tenant</h2>
        <button onclick="closeTenantModal()" class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-white/[0.06]">
          <i data-lucide="x" class="w-5 h-5 text-zinc-400"></i>
        </button>
      </div>
      <div id="tenant-modal-content" class="p-6">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import api from '/src/lib/api-client.js';
    import DataTable from '/src/lib/data-table.js';
    import toast from '/src/lib/toast.js';
    import modal from '/src/lib/modal.js';

    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    lucide.createIcons();


    if (!auth.requireRole('admin')) {
      throw new Error('Not authorized');
    }

    // Wait for sidebar component to be injected before accessing its elements
    function initSidebar() {
      const user = auth.getCurrentUser();
      if (user) {
        const nameEl = document.getElementById('admin-name');
        const emailEl = document.getElementById('admin-email');
        const initialsEl = document.getElementById('admin-initials');
        if (nameEl) nameEl.textContent = user.name || 'Admin';
        if (emailEl) emailEl.textContent = user.email || '';
        if (initialsEl) initialsEl.textContent = (user.name || 'A').split(' ').map(n => n[0]).join('').toUpperCase();
      }
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await auth.logout();
          window.location.href = '/app/auth/login.html';
        });
      }
    }
    if (document.getElementById('admin-name')) {
      initSidebar();
    } else {
      document.addEventListener('app-components:loaded', initSidebar, { once: true });
    }

    // Store tenants data for impersonation
    let tenants = [];

    // Initialize table
    const tenantsTable = new DataTable('#tenants-table', {
      columns: [
        { key: 'name', label: VocaliaI18n.t('admin.tenants.name'), sortable: true },
        { key: 'email', label: VocaliaI18n.t('admin.tenants.email'), sortable: true },
        { key: 'plan', label: VocaliaI18n.t('admin.tenants.plan'), type: 'badge',
          badgeColors: {
            'enterprise': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
            'business': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
            'starter': 'bg-zinc-100 text-zinc-800 dark:bg-white/[0.06] dark:text-zinc-300',
            'trial': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300'
          }
        },
        { key: 'status', label: VocaliaI18n.t('admin.tenants.status'), type: 'badge',
          badgeColors: {
            'active': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
            'trial': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
            'suspended': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
            'cancelled': 'bg-zinc-100 text-zinc-800 dark:bg-white/[0.06] dark:text-zinc-300'
          }
        },
        { key: 'calls_count', label: VocaliaI18n.t('admin.tenants.calls'), sortable: true },
        { key: 'created_at', label: VocaliaI18n.t('admin.tenants.registered'), type: 'date', sortable: true },
        { key: 'actions', label: '',
          render: (val, row) => `
            <div class="flex items-center gap-1">
              <button onclick="showTenant('${row.id}')" class="p-1 rounded hover:bg-zinc-100 dark:hover:bg-white/[0.06]" title="Voir">
                <svg class="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <button onclick="impersonateTenant('${row.id}')" class="p-1 rounded hover:bg-zinc-100 dark:hover:bg-white/[0.06]" title="Impersonate">
                <svg class="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
              </button>
            </div>
          `
        }
      ],
      pageSize: 25,
      searchPlaceholder: VocaliaI18n.t('admin.tenants.search'),
      emptyMessage: VocaliaI18n.t('admin.tenants.empty'),
      onRowClick: (row) => showTenant(row.id)
    });

    // Load tenants
    async function loadTenants() {
      tenantsTable.setLoading(true);
      try {
        const result = await api.tenants.list();
        const data = result.data || result || [];

        tenants = data; // Store for impersonation
        tenantsTable.setData(data);

        // Stats
        document.getElementById('stat-total').textContent = data.length;
        document.getElementById('stat-active').textContent = data.filter(t => t.status === 'active').length;
        document.getElementById('stat-trial').textContent = data.filter(t => t.status === 'trial').length;

        const mrr = data.reduce((sum, t) => {
          const prices = { starter: 49, pro: 99, ecommerce: 99, expert_clone: 149, telephony: 199, trial: 0 };
          return sum + (prices[t.plan] || 99);
        }, 0);
        document.getElementById('stat-mrr').textContent = mrr.toLocaleString() + '€';

      } catch (error) {
        console.error('Failed to load tenants:', error);
        toast.error(VocaliaI18n.t('admin.tenants.load_error'));
      }
    }

    loadTenants();

    // Show tenant details
    window.showTenant = async (id) => {
      const modalEl = document.getElementById('tenant-modal');
      const content = document.getElementById('tenant-modal-content');

      modalEl.classList.remove('hidden');

      try {
        const tenant = await api.tenants.get(id);

        const voiceNames = {
          fr: { female: 'Sarah', male: 'Abdel' },
          en: { female: 'Rachel', male: 'Adam' },
          es: { female: 'Domi', male: 'Juan Carlos' },
          ar: { female: 'Bill', male: 'Amr' },
          ary: { female: 'Ghizlane', male: 'Jawad' }
        };
        const voiceLang = tenant.voice_language || 'fr';
        const voiceGender = tenant.voice_gender || 'female';
        const voiceName = voiceNames[voiceLang]?.[voiceGender] || 'Sarah';

        content.innerHTML = `
          <div class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-zinc-500">Nom</p>
                <p class="font-medium text-zinc-900 dark:text-white">${escapeHtml(tenant.name) || '-'}</p>
              </div>
              <div>
                <p class="text-sm text-zinc-500">Email</p>
                <p class="font-medium text-zinc-900 dark:text-white">${escapeHtml(tenant.email) || '-'}</p>
              </div>
              <div>
                <p class="text-sm text-zinc-500">Plan</p>
                <p class="font-medium text-zinc-900 dark:text-white capitalize">${tenant.plan || 'trial'}</p>
              </div>
              <div>
                <p class="text-sm text-zinc-500">Statut</p>
                <p class="font-medium text-zinc-900 dark:text-white capitalize">${tenant.status || 'active'}</p>
              </div>
              <div>
                <p class="text-sm text-zinc-500">Persona</p>
                <p class="font-medium text-zinc-900 dark:text-white">${escapeHtml(tenant.active_persona || tenant.persona || 'AGENCY')}</p>
              </div>
              <div>
                <p class="text-sm text-zinc-500">Créé le</p>
                <p class="font-medium text-zinc-900 dark:text-white">${tenant.created_at ? new Date(tenant.created_at).toLocaleDateString() : '-'}</p>
              </div>
            </div>

            <!-- Voice Configuration Section -->
            <div class="pt-4 border-t border-zinc-200 dark:border-white/[0.08]">
              <h4 class="font-medium text-zinc-900 dark:text-white mb-3">Configuration Voix</h4>
              <div class="grid grid-cols-3 gap-4 bg-zinc-50 dark:bg-white/[0.02] rounded-lg p-4">
                <div>
                  <p class="text-xs text-zinc-500 mb-1">${VocaliaI18n.t('admin.tenants.language')}</p>
                  <p class="font-medium text-zinc-900 dark:text-white">${voiceLang.toUpperCase()}</p>
                </div>
                <div>
                  <p class="text-xs text-zinc-500 mb-1">${VocaliaI18n.t('admin.tenants.gender')}</p>
                  <p class="font-medium text-zinc-900 dark:text-white capitalize">${voiceGender === 'male' ? VocaliaI18n.t('admin.tenants.male') : VocaliaI18n.t('admin.tenants.female')}</p>
                </div>
                <div>
                  <p class="text-xs text-zinc-500 mb-1">${VocaliaI18n.t('admin.tenants.voice')}</p>
                  <p class="font-medium text-indigo-600 dark:text-indigo-400">${voiceName}</p>
                </div>
              </div>
              <button onclick="changeVoice('${id}')" class="mt-3 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                ${VocaliaI18n.t('admin.tenants.change_voice')} →
              </button>
            </div>

            <div class="pt-4 border-t border-zinc-200 dark:border-white/[0.08]">
              <h4 class="font-medium text-zinc-900 dark:text-white mb-3">Actions</h4>
              <div class="flex flex-wrap gap-2">
                <button onclick="changePlan('${id}')" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg hover:bg-zinc-50 dark:hover:bg-white/[0.06]">
                  Changer de plan
                </button>
                <button onclick="changePersona('${id}')" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] rounded-lg hover:bg-zinc-50 dark:hover:bg-white/[0.06]">
                  Changer persona
                </button>
                <button onclick="suspendTenant('${id}')" class="px-3 py-1.5 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                  Suspendre
                </button>
                <button onclick="impersonateTenant('${id}')" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  Impersonate
                </button>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        content.innerHTML = `<p class="text-red-500">${VocaliaI18n.t('admin.load_error')}</p>`;
      }

      lucide.createIcons();
    };

    window.closeTenantModal = () => {
      document.getElementById('tenant-modal').classList.add('hidden');
    };

    window.impersonateTenant = async (id) => {
      const confirmed = await modal.confirm(
        VocaliaI18n.t('admin.tenants.impersonate_confirm'),
        { title: 'Impersonate', confirmText: VocaliaI18n.t('common.continue') }
      );

      if (confirmed) {
        // Store impersonation context - admin sees client dashboard as tenant
        const tenant = tenants.find(t => t.id === id);
        if (tenant) {
          localStorage.setItem('vocalia_impersonate_tenant', JSON.stringify({
            id: tenant.id,
            name: tenant.name || tenant.company,
            impersonated_at: new Date().toISOString(),
            admin_id: auth.getCurrentUser()?.id
          }));
          toast.success(`Impersonation de ${tenant.name || tenant.company}`);
          window.location.href = '/app/client/';
        } else {
          toast.error(VocaliaI18n.t('admin.tenants.not_found'));
        }
      }
    };

    window.changePlan = async (id) => {
      const plan = await modal.prompt(VocaliaI18n.t('admin.tenants.new_plan_prompt'), {
        title: VocaliaI18n.t('admin.tenants.change_plan'),
        defaultValue: 'business'
      });

      if (plan && ['starter', 'business', 'enterprise'].includes(plan)) {
        try {
          await api.tenants.update(id, { plan });
          toast.success(VocaliaI18n.t('admin.tenants.plan_updated'));
          loadTenants();
          closeTenantModal();
        } catch (error) {
          toast.error(VocaliaI18n.t('admin.tenants.update_error'));
        }
      }
    };

    window.changeVoice = async (id) => {
      const lang = await modal.prompt(VocaliaI18n.t('admin.tenants.lang_prompt'), {
        title: VocaliaI18n.t('admin.tenants.change_voice'),
        defaultValue: 'fr'
      });

      if (!lang || !['fr', 'en', 'es', 'ar', 'ary'].includes(lang)) {
        if (lang) toast.error(VocaliaI18n.t('admin.tenants.invalid_lang'));
        return;
      }

      const gender = await modal.prompt(VocaliaI18n.t('admin.tenants.gender_prompt'), {
        title: VocaliaI18n.t('admin.tenants.change_voice'),
        defaultValue: 'female'
      });

      if (!gender || !['male', 'female'].includes(gender)) {
        if (gender) toast.error(VocaliaI18n.t('admin.tenants.invalid_gender'));
        return;
      }

      try {
        await api.tenants.update(id, { voice_language: lang, voice_gender: gender });
        toast.success(VocaliaI18n.t('admin.tenants.voice_updated'));
        showTenant(id); // Refresh modal
        loadTenants();
      } catch (error) {
        toast.error(VocaliaI18n.t('admin.tenants.update_error'));
      }
    };

    window.changePersona = async (id) => {
      const personas = [
        'AGENCY', 'DENTAL', 'PROPERTY', 'CONTRACTOR',
        'UNIVERSAL_ECOMMERCE', 'UNIVERSAL_SME', 'RETAILER', 'RESTAURATEUR',
        'DOCTOR', 'NOTARY', 'CONSULTANT', 'IT_SERVICES', 'TRAVEL_AGENT',
        'INSURER', 'RECRUITER', 'HEALER', 'COUNSELOR'
      ];

      const persona = await modal.prompt(VocaliaI18n.t('admin.tenants.persona_prompt'), {
        title: VocaliaI18n.t('admin.tenants.change_persona'),
        defaultValue: 'AGENCY'
      });

      if (!persona) return;

      const upperPersona = persona.toUpperCase();
      if (!personas.includes(upperPersona)) {
        toast.error(VocaliaI18n.t('admin.tenants.invalid_persona'));
        return;
      }

      try {
        await api.tenants.update(id, { active_persona: upperPersona });
        toast.success(`Persona ${upperPersona} activé`);
        showTenant(id);
        loadTenants();
      } catch (error) {
        toast.error(VocaliaI18n.t('admin.tenants.update_error'));
      }
    };

    window.suspendTenant = async (id) => {
      const confirmed = await modal.confirm(
        VocaliaI18n.t('admin.tenants.suspend_confirm'),
        { title: VocaliaI18n.t('admin.tenants.suspend_title'), confirmText: VocaliaI18n.t('admin.tenants.suspend_btn'), danger: true }
      );

      if (confirmed) {
        try {
          await api.tenants.update(id, { status: 'suspended' });
          toast.success(VocaliaI18n.t('admin.tenants.suspended'));
          loadTenants();
          closeTenantModal();
        } catch (error) {
          toast.error(VocaliaI18n.t('admin.tenants.suspend_error'));
        }
      }
    };

    // New tenant button
    document.getElementById('new-tenant-btn').addEventListener('click', async () => {
      const name = await modal.prompt(VocaliaI18n.t('admin.tenants.name_prompt'), { title: VocaliaI18n.t('admin.tenants.new_tenant') });
      if (!name) return;

      const email = await modal.prompt(VocaliaI18n.t('admin.tenants.email_prompt'), { title: VocaliaI18n.t('admin.tenants.new_tenant') });
      if (!email) return;

      try {
        await api.tenants.create({ name, email, plan: 'trial', status: 'trial' });
        toast.success(VocaliaI18n.t('admin.tenants.created'));
        loadTenants();
      } catch (error) {
        toast.error(VocaliaI18n.t('admin.tenants.create_error'));
      }
    });
  </script>
</body>
</html>
