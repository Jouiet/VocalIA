<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.vocalia.ma https://www.google-analytics.com; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Int√©grations - VocalIA</title>

  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/src/lib/dark-mode-init.js"></script>
  <link href="/public/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js" integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM" crossorigin="anonymous"></script>
  <script src="/src/lib/i18n.js"></script>
  <script src="/src/lib/escape-html.js"></script>
</head>
<body class="bg-zinc-50 dark:bg-[#050505] min-h-screen">
  <!-- Sidebar Component -->
  <div data-app-component="sidebar"></div>

  <!-- Main Content -->
  <main class="lg:ml-[260px] rtl:lg:ml-0 rtl:lg:mr-[260px] min-h-screen overflow-auto">
      <header class="sticky top-0 z-10 bg-white/80 dark:bg-white/[0.06] backdrop-blur-sm border-b border-zinc-200 dark:border-white/[0.08] px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <button id="menu-toggle" class="lg:hidden p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg mr-2">
              <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div>
            <h1 class="text-2xl font-bold text-zinc-900 dark:text-white" data-i18n="integrations.title">Int√©grations</h1>
            <p class="text-zinc-600 dark:text-zinc-400" data-i18n="integrations.subtitle">Connectez vos outils et services</p>
          </div>
            </div>
        </div>
      </header>

      <div class="px-6 py-6 space-y-8">
        <!-- Platform Showcase Banner -->
        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h2 class="text-2xl font-bold" data-i18n="integrations.platform_power">√âcosyst√®me d'Int√©grations</h2>
              <p class="text-emerald-100 mt-1" data-i18n="integrations.platform_desc">Connectez votre assistant vocal √† vos outils m√©tier</p>
            </div>
            <div class="flex gap-6">
              <div class="text-center">
                <p class="text-4xl font-bold" id="mcp-tools-count">203</p>
                <p class="text-emerald-200 text-sm" data-i18n="integrations.mcp_tools_label">MCP Tools</p>
              </div>
              <div class="text-center">
                <p class="text-4xl font-bold">31+</p>
                <p class="text-emerald-200 text-sm" data-i18n="integrations.native_label">Int√©grations</p>
              </div>
              <div class="text-center">
                <p class="text-4xl font-bold">7000+</p>
                <p class="text-emerald-200 text-sm" data-i18n="integrations.zapier_label">Apps via Zapier</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Webhook Health Dashboard -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4">Webhook Health</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <p class="text-xs text-zinc-500 uppercase tracking-wider">Uptime</p>
              </div>
              <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="webhook-uptime">--</p>
              <p class="text-xs text-green-500 mt-1">30 derniers jours</p>
            </div>
            <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="send" class="w-4 h-4 text-zinc-400"></i>
                <p class="text-xs text-zinc-500 uppercase tracking-wider">Delivered</p>
              </div>
              <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="webhook-delivered">--</p>
              <p class="text-xs text-zinc-500 mt-1">Ce mois</p>
            </div>
            <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="alert-circle" class="w-4 h-4 text-zinc-400"></i>
                <p class="text-xs text-zinc-500 uppercase tracking-wider">Failed</p>
              </div>
              <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="webhook-failed">0</p>
              <p class="text-xs text-zinc-500 mt-1">Ce mois</p>
            </div>
            <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-4">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="zap" class="w-4 h-4 text-zinc-400"></i>
                <p class="text-xs text-zinc-500 uppercase tracking-wider">Avg Latency</p>
              </div>
              <p class="text-2xl font-bold text-zinc-900 dark:text-white" id="webhook-latency">--</p>
              <p class="text-xs text-zinc-500 mt-1">ms</p>
            </div>
          </div>
        </section>

        <!-- Connected Integrations -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4" data-i18n="integrations.connected">Connect√©es</h2>
          <div id="connected-integrations" class="space-y-3">
            <!-- Empty State (Phase 4.1 - Professional Empty States) -->
            <div id="empty-state-connected" class="flex flex-col items-center justify-center py-12 px-6 bg-white dark:bg-white/[0.06] rounded-xl border border-dashed border-zinc-300 dark:border-white/[0.08]">
              <div class="w-16 h-16 rounded-full bg-zinc-100 dark:bg-white/[0.06] flex items-center justify-center mb-4">
                <i data-lucide="plug-zap" class="w-8 h-8 text-zinc-400"></i>
              </div>
              <h3 class="text-lg font-semibold text-zinc-900 dark:text-white mb-2" data-i18n="integrations.empty_title">Aucune int√©gration connect√©e</h3>
              <p class="text-zinc-500 text-center max-w-md mb-6" data-i18n="integrations.empty_desc">Connectez vos outils CRM, e-commerce et support pour automatiser vos workflows avec l'assistant vocal.</p>
              <a href="#crm-section" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span data-i18n="integrations.add_first">Ajouter votre premi√®re int√©gration</span>
              </a>
            </div>
          </div>
        </section>

        <!-- CRM -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4">CRM</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="hubspot">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                  <span class="text-2xl">üü†</span>
                </div>
                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded hidden" data-status>Connect√©</span>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">HubSpot</h3>
              <p class="text-sm text-zinc-500 mt-1">Synchronisez vos contacts et deals</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="pipedrive">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                  <span class="text-2xl">üü¢</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Pipedrive</h3>
              <p class="text-sm text-zinc-500 mt-1">G√©rez votre pipeline de ventes</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="zoho">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                  <span class="text-2xl">üî¥</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Zoho CRM</h3>
              <p class="text-sm text-zinc-500 mt-1">Int√©gration compl√®te Zoho</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>
          </div>
        </section>

        <!-- E-commerce -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4">E-commerce</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="shopify">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-lime-100 dark:bg-lime-900/30 flex items-center justify-center">
                  <span class="text-2xl">üõçÔ∏è</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Shopify</h3>
              <p class="text-sm text-zinc-500 mt-1">Commandes et produits</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="woocommerce">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                  <span class="text-2xl">üõí</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">WooCommerce</h3>
              <p class="text-sm text-zinc-500 mt-1">Plugin WordPress</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="prestashop">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center">
                  <span class="text-2xl">üè™</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">PrestaShop</h3>
              <p class="text-sm text-zinc-500 mt-1">E-commerce open source</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>
          </div>
        </section>

        <!-- Messagerie -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4" data-i18n="integrations.messaging">Messagerie</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="slack">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                  <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zm1.271 0a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313z" fill="#E01E5A"/><path d="M8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zm0 1.271a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312z" fill="#36C5F0"/><path d="M18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zm-1.27 0a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.163 0a2.528 2.528 0 0 1 2.523 2.522v6.312z" fill="#2EB67D"/><path d="M15.163 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.163 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zm0-1.27a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.315A2.528 2.528 0 0 1 24 15.163a2.528 2.528 0 0 1-2.522 2.523h-6.315z" fill="#ECB22E"/></svg>
                </div>
                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded hidden" data-status>Connect√©</span>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Slack</h3>
              <p class="text-sm text-zinc-500 mt-1" data-i18n="integrations.slack_desc">Bot IA dans vos canaux Slack</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>
          </div>
        </section>

        <!-- Calendrier -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4">Calendrier</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="google-calendar">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                  <span class="text-2xl">üìÖ</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Google Calendar</h3>
              <p class="text-sm text-zinc-500 mt-1">Planification RDV</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="calendly">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                  <span class="text-2xl">üóìÔ∏è</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Calendly</h3>
              <p class="text-sm text-zinc-500 mt-1">Prise de RDV automatique</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>
          </div>
        </section>

        <!-- Automation -->
        <section>
          <h2 class="text-sm font-medium text-zinc-500 uppercase tracking-wider mb-4">Automatisation</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="zapier">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                  <span class="text-2xl">‚ö°</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Zapier</h3>
              <p class="text-sm text-zinc-500 mt-1">+7000 applications</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="make">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center">
                  <span class="text-2xl">üîÆ</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">Make</h3>
              <p class="text-sm text-zinc-500 mt-1">Workflows visuels</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>

            <div class="integration-card bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-5 hover:shadow-lg transition-all duration-200" data-integration="n8n">
              <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center">
                  <span class="text-2xl">üîß</span>
                </div>
              </div>
              <h3 class="font-semibold text-zinc-900 dark:text-white">n8n</h3>
              <p class="text-sm text-zinc-500 mt-1">Open source automation</p>
              <button class="mt-4 w-full py-2 px-4 bg-zinc-100 dark:bg-white/[0.06] hover:bg-zinc-200 dark:hover:bg-white/[0.1] text-zinc-700 dark:text-zinc-200 font-medium rounded-lg transition-colors text-sm">
                Connecter
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>

  <script src="/app/components/app-components.js" defer></script>
  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import api from '/src/lib/api-client.js';
    import toast from '/src/lib/toast.js';
    import modal from '/src/lib/modal.js';


    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    // Initialize Lucide icons
    lucide.createIcons();

    if (!auth.requireAuth()) {
      throw new Error('Not authenticated');
    }

    const user = auth.getCurrentUser();
    if (user) {
      document.getElementById('user-name').textContent = user.name || VocaliaI18n.t('dashboard.common.user_default');
      document.getElementById('user-email').textContent = user.email || '';
      document.getElementById('user-avatar').textContent = (user.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
    }

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.logout();
      window.location.href = '/app/auth/login.html';
    });

    // Integration metadata
    const INTEGRATIONS_META = {
      'hubspot': { name: 'HubSpot', icon: 'üü†', category: 'CRM' },
      'pipedrive': { name: 'Pipedrive', icon: 'üü¢', category: 'CRM' },
      'zoho': { name: 'Zoho CRM', icon: 'üî¥', category: 'CRM' },
      'shopify': { name: 'Shopify', icon: 'üõçÔ∏è', category: 'E-commerce' },
      'woocommerce': { name: 'WooCommerce', icon: 'üõí', category: 'E-commerce' },
      'prestashop': { name: 'PrestaShop', icon: 'üè™', category: 'E-commerce' },
      'google-calendar': { name: 'Google Calendar', icon: 'üìÖ', category: 'Calendrier' },
      'calendly': { name: 'Calendly', icon: 'üóìÔ∏è', category: 'Calendrier' },
      'zapier': { name: 'Zapier', icon: '‚ö°', category: 'Automatisation' },
      'make': { name: 'Make', icon: 'üîÆ', category: 'Automatisation' },
      'n8n': { name: 'n8n', icon: 'üîß', category: 'Automatisation' },
      'slack': { name: 'Slack', icon: 'üí¨', category: 'Messagerie' }
    };

    let connectedIntegrations = [];

    // Load connected integrations
    async function loadIntegrations() {
      try {
        const tenantId = auth.getTenantId() || user?.tenant_id;
        if (!tenantId) {
          renderConnectedIntegrations([]);
          return;
        }
        connectedIntegrations = await api.integrations.list(tenantId);
        renderConnectedIntegrations(connectedIntegrations);
        updateCardStates();
      } catch (error) {
        console.error('Failed to load integrations:', error);
        renderConnectedIntegrations([]);
      }
    }

    // Render connected integrations section
    function renderConnectedIntegrations(integrations) {
      const container = document.getElementById('connected-integrations');
      if (!integrations || integrations.length === 0) {
        container.innerHTML = `<p class="text-zinc-500 text-sm">${VocaliaI18n.t('dashboard.integrations_page.no_integrations')}</p>`;
        return;
      }

      container.innerHTML = integrations.map(i => {
        const meta = INTEGRATIONS_META[i.name] || { name: i.name, icon: 'üîó', category: 'Autre' };
        const lastSync = i.last_sync_at ? new Date(i.last_sync_at) : null;
        const syncAgo = lastSync ? Math.round((Date.now() - lastSync) / 60000) : null;
        const syncLabel = syncAgo !== null ? (syncAgo < 1 ? 'just now' : syncAgo < 60 ? syncAgo + 'min ago' : Math.round(syncAgo / 60) + 'h ago') : '';
        const isHealthy = i.status === 'active' || !i.status;
        return `
          <div class="flex items-center justify-between p-4 bg-white dark:bg-white/[0.06] rounded-xl border border-green-200 dark:border-green-800 hover:shadow-md transition-shadow">
            <div class="flex items-center gap-3">
              <div class="relative">
                <span class="text-2xl">${meta.icon}</span>
                <span class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full ${isHealthy ? 'bg-green-500' : 'bg-amber-500'} border-2 border-white dark:border-zinc-900"></span>
              </div>
              <div>
                <p class="font-medium text-zinc-900 dark:text-white">${escapeHtml(meta.name)}</p>
                <div class="flex items-center gap-3 text-xs text-zinc-500">
                  <span>${VocaliaI18n.t('dashboard.integrations_page.connected_on').replace('{{date}}', new Date(i.connected_at).toLocaleDateString())}</span>
                  ${syncLabel ? '<span class="text-green-500">' + escapeHtml(syncLabel) + '</span>' : ''}
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="testIntegration('${escapeHtml(i.name)}')" class="px-3 py-1.5 text-sm border border-zinc-300 dark:border-white/[0.08] text-zinc-600 dark:text-zinc-300 rounded-lg hover:bg-zinc-50 dark:hover:bg-white/[0.06]" title="Test connection">
                <i data-lucide="activity" class="w-4 h-4 inline"></i>
              </button>
              <button onclick="disconnectIntegration('${escapeHtml(i.name)}')" class="px-3 py-1.5 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                ${VocaliaI18n.t('dashboard.common.disconnect')}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update card button states based on connection status
    function updateCardStates() {
      document.querySelectorAll('.integration-card').forEach(card => {
        const integrationName = card.dataset.integration;
        const btn = card.querySelector('button');
        const status = card.querySelector('[data-status]');
        const isConnected = connectedIntegrations.some(i => i.name === integrationName);

        if (isConnected) {
          btn.textContent = VocaliaI18n.t('dashboard.common.disconnect');
          btn.classList.remove('bg-zinc-100', 'dark:bg-white/[0.06]', 'text-zinc-700', 'dark:text-zinc-200');
          btn.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-700', 'dark:text-red-300');
          if (status) status.classList.remove('hidden');
        } else {
          btn.textContent = VocaliaI18n.t('dashboard.common.connect');
          btn.classList.add('bg-zinc-100', 'dark:bg-white/[0.06]', 'text-zinc-700', 'dark:text-zinc-200');
          btn.classList.remove('bg-red-100', 'dark:bg-red-900/30', 'text-red-700', 'dark:text-red-300');
          if (status) status.classList.add('hidden');
        }
      });
    }

    // Disconnect integration
    window.disconnectIntegration = async (name) => {
      const meta = INTEGRATIONS_META[name] || { name };
      const confirmed = await modal.confirm(
        VocaliaI18n.t('dashboard.integrations_page.disconnect_confirm').replace('{{name}}', meta.name),
        { title: VocaliaI18n.t('dashboard.integrations_page.disconnect_title'), confirmText: VocaliaI18n.t('dashboard.common.disconnect'), danger: true }
      );

      if (confirmed) {
        try {
          const tenantId = auth.getTenantId() || user?.tenant_id;
          await api.integrations.disconnect(tenantId, name);
          toast.success(VocaliaI18n.t('dashboard.integrations_page.disconnected').replace('{{name}}', meta.name));
          await loadIntegrations();
        } catch (error) {
          toast.error(VocaliaI18n.t('dashboard.common.disconnect_error'));
        }
      }
    };

    // Load webhook health stats
    async function loadWebhookHealth() {
      try {
        const tenantId = auth.getTenantId() || user?.tenant_id;
        if (!tenantId) return;
        const stats = await api.get(`/tenants/${tenantId}/webhooks/health`).catch(() => null);
        if (stats) {
          document.getElementById('webhook-uptime').textContent = (stats.uptime_pct || 0).toFixed(1) + '%';
          document.getElementById('webhook-delivered').textContent = (stats.delivered || 0).toLocaleString();
          document.getElementById('webhook-failed').textContent = (stats.failed || 0).toLocaleString();
          document.getElementById('webhook-latency').textContent = (stats.avg_latency_ms || 0).toFixed(0);
        }
      } catch (e) {
        // Graceful fallback ‚Äî show defaults
      }
    }

    // Test integration connectivity
    window.testIntegration = async (name) => {
      const meta = INTEGRATIONS_META[name] || { name };
      toast.info(VocaliaI18n.t('dashboard.integrations_page.test_connection').replace('{{name}}', meta.name));
      try {
        const tenantId = auth.getTenantId() || user?.tenant_id;
        const result = await api.get(`/tenants/${tenantId}/integrations/${name}/test`);
        if (result.success) {
          toast.success(VocaliaI18n.t('dashboard.integrations_page.test_ok').replace('{{name}}', meta.name).replace('{{latency}}', result.latency_ms || 0));
        } else {
          toast.warning(`${meta.name} ‚Äî ${result.error || 'test failed'}`);
        }
      } catch (error) {
        toast.error(VocaliaI18n.t('dashboard.integrations_page.test_error').replace('{{name}}', meta.name));
      }
    };

    // B20 fix: Handle ?connected= param from OAuth callback redirect
    const urlParams = new URLSearchParams(window.location.search);
    const justConnected = urlParams.get('connected');
    if (justConnected) {
      const tenantId = auth.getTenantId() || user?.tenant_id;
      if (tenantId) {
        try {
          await api.integrations.connect(tenantId, { name: justConnected, status: 'active' });
          toast.success(`${(INTEGRATIONS_META[justConnected] || { name: justConnected }).name} connect√© avec succ√®s`);
        } catch (e) { /* silent ‚Äî may already be connected */ }
      }
      // Clean URL
      window.history.replaceState({}, '', window.location.pathname);
    }

    // Load integrations on page load
    loadIntegrations();
    loadWebhookHealth();

    // Integration card click handlers
    document.querySelectorAll('.integration-card button').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const card = btn.closest('.integration-card');
        const integrationName = card.dataset.integration;
        const meta = INTEGRATIONS_META[integrationName] || { name: integrationName };
        const isConnected = connectedIntegrations.some(i => i.name === integrationName);

        if (isConnected) {
          await window.disconnectIntegration(integrationName);
        } else if (integrationName === 'slack') {
          const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3010' : 'https://api.vocalia.ma';
          const tid = auth.getTenantId() || user?.tenant_id;
          window.location.href = `${baseUrl}/oauth/start/slack?tenantId=${encodeURIComponent(tid)}`;
          return;
        } else {
          const loading = modal.loading(VocaliaI18n.t('integrations.connecting').replace('{name}', meta.name));
          try {
            const tenantId = auth.getTenantId() || user?.tenant_id;
            await api.integrations.connect(tenantId, { name: integrationName, status: 'active' });
            loading.close();
            toast.success(`${meta.name} connect√© avec succ√®s`);
            await loadIntegrations();
          } catch (error) {
            loading.close();
            toast.error('Erreur lors de la connexion');
          }
        }
      });
    });
  </script>
</body>
</html>
