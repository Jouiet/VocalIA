<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Dashboard - VocalIA</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <link href="/public/css/style.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- i18n -->
  <script src="/src/lib/i18n.js"></script>

  <!-- GSAP Animations (counters) -->
  <script src="/src/lib/gsap-animations.js"></script>

  <style>
    .sidebar { width: 260px; }
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 40; }
      .sidebar.open { transform: translateX(0); }
    }
    /* Stat card accent borders */
    .stat-accent { position: relative; overflow: hidden; }
    .stat-accent::before {
      content: ''; position: absolute; top: 0; left: 0;
      width: 3px; height: 100%;
    }
    [dir="rtl"] .stat-accent::before { left: auto; right: 0; }
    .stat-accent-blue::before { background: linear-gradient(180deg, #6366f1, #3b82f6); }
    .stat-accent-purple::before { background: linear-gradient(180deg, #8b5cf6, #a855f7); }
    .stat-accent-green::before { background: linear-gradient(180deg, #10b981, #22c55e); }
    .stat-accent-amber::before { background: linear-gradient(180deg, #f59e0b, #f97316); }
    /* Subtle glow on hover */
    .stat-accent:hover { box-shadow: 0 0 20px rgba(99, 102, 241, 0.08); }
    /* Live indicator */
    @keyframes livePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: livePulse 2s ease-in-out infinite; }
    /* AI Score ring animation */
    @keyframes scoreRingDraw { from { stroke-dashoffset: 326.73; } }
    .score-ring-animated { animation: scoreRingDraw 1.5s ease-out forwards; }
    /* Heatmap cell */
    .heatmap-cell { width: 28px; height: 28px; border-radius: 4px; transition: all 0.15s; cursor: default; }
    .heatmap-cell:hover { transform: scale(1.3); z-index: 10; box-shadow: 0 0 8px rgba(99,102,241,0.4); }
    /* Funnel bar animation */
    @keyframes funnelGrow { from { width: 0; } }
    .funnel-bar { animation: funnelGrow 1s ease-out forwards; }
    /* Glassmorphism panel */
    .glass-panel { background: rgba(255,255,255,0.6); backdrop-filter: blur(12px); }
    .dark .glass-panel { background: rgba(255,255,255,0.04); }
  </style>
</head>
<body class="min-h-screen bg-zinc-50 dark:bg-[#050505]">

  <!-- Sidebar Component -->
  <div data-app-component="sidebar"></div>

  <!-- Main Content -->
  <main class="lg:ml-[260px] rtl:lg:ml-0 rtl:lg:mr-[260px] min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-20 bg-white/80 dark:bg-white/[0.06] backdrop-blur border-b border-zinc-200 dark:border-white/[0.08]">
      <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
          <button id="menu-toggle" class="lg:hidden p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <h1 class="text-xl font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.title">Tableau de bord</h1>
        </div>
        <div class="flex items-center gap-2">
          <button class="p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="bell" class="w-5 h-5"></i>
          </button>
          <button id="theme-toggle" class="p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <div class="p-4 lg:p-6 space-y-6">

      <!-- Welcome Banner -->
      <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 rounded-2xl p-6 text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_50%,rgba(255,255,255,0.08),transparent_70%)]"></div>
        <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold" id="welcome-message">Bienvenue !</h2>
            <p class="mt-1 opacity-80" data-i18n="dashboard.header.subtitle">Voici un aperçu de votre activité Voice AI</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="live-dot"></div>
            <span class="text-sm font-medium opacity-90" data-i18n="dashboard.header.status">Système opérationnel</span>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Calls -->
        <div class="stat-accent stat-accent-blue bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <i data-lucide="phone-call" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
            </div>
            <span id="trend-calls" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-calls" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.calls">Appels ce mois</p>
        </div>

        <!-- Minutes Used -->
        <div class="stat-accent stat-accent-purple bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
              <i data-lucide="clock" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
            </div>
            <span id="trend-minutes" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-minutes" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.minutes">Minutes utilisées</p>
        </div>

        <!-- Avg Duration -->
        <div class="stat-accent stat-accent-green bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <i data-lucide="timer" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
            </div>
            <span id="trend-duration" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-duration" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.avg_duration">Durée moyenne</p>
        </div>

        <!-- Languages -->
        <div class="stat-accent stat-accent-amber bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
              <i data-lucide="languages" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
            </div>
            <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400">5 langues</span>
          </div>
          <p id="stat-languages" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.top_language">Langue principale</p>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Call Volume Chart -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
          <h3 class="font-semibold text-zinc-900 dark:text-white mb-4" data-i18n="dashboard.charts.call_volume">Volume d'appels (7 jours)</h3>
          <div class="h-64">
            <canvas id="callVolumeChart"></canvas>
          </div>
        </div>

        <!-- Language Distribution -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
          <h3 class="font-semibold text-zinc-900 dark:text-white mb-4" data-i18n="dashboard.charts.languages">Distribution des langues</h3>
          <div class="h-64 flex items-center justify-center">
            <canvas id="languageChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Performance Insights -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="activity" class="w-4 h-4 text-indigo-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.peak_hour">Heure de pointe</span>
          </div>
          <p id="insight-peak" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.peak_desc">Plus d'appels reçus</p>
        </div>
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.engagement">Engagement</span>
          </div>
          <p id="insight-engagement" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.engagement_desc">Sessions &gt; 2 min</p>
        </div>
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="globe" class="w-4 h-4 text-emerald-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.languages_used">Langues actives</span>
          </div>
          <p id="insight-langs" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.langs_desc">Langues utilisées ce mois</p>
        </div>
      </div>

      <!-- Voice AI Performance Score -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="brain" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.ai_performance.title">Performance IA Vocale</h3>
          </div>
          <span class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full" data-i18n="dashboard.ai_performance.period">Ce mois</span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <!-- AI Score Gauge -->
          <div class="flex flex-col items-center justify-center">
            <div class="relative w-32 h-32">
              <svg viewBox="0 0 120 120" class="w-full h-full -rotate-90">
                <circle cx="60" cy="60" r="52" fill="none" stroke="currentColor" stroke-width="8" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="ai-score-ring" cx="60" cy="60" r="52" fill="none" stroke="url(#scoreGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73" />
                <defs>
                  <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#6366f1" />
                    <stop offset="100%" stop-color="#a855f7" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="ai-score-value" class="text-3xl font-bold text-zinc-900 dark:text-white">--</span>
                <span class="text-xs text-zinc-500">/ 100</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.ai_performance.score">Score IA</p>
          </div>
          <!-- Metric Bars -->
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.response_time">Temps de réponse</span>
                <span id="metric-response-time" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-response-time" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.resolution">Taux de résolution</span>
                <span id="metric-resolution" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-resolution" class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.satisfaction">Satisfaction</span>
                <span id="metric-satisfaction" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-satisfaction" class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <!-- Conversion Funnel -->
          <div class="lg:col-span-2">
            <h4 class="text-sm font-medium text-zinc-600 dark:text-zinc-400 mb-3" data-i18n="dashboard.ai_performance.funnel_title">Entonnoir de Conversion</h4>
            <div class="space-y-2">
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0">Widget</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-widget" class="h-full bg-gradient-to-r from-indigo-500/80 to-indigo-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0">Conversations</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-conversations" class="h-full bg-gradient-to-r from-purple-500/80 to-purple-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0" data-i18n="dashboard.ai_performance.qualified">Qualifiés</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-qualified" class="h-full bg-gradient-to-r from-emerald-500/80 to-emerald-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0" data-i18n="dashboard.ai_performance.converted">Convertis</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-converted" class="h-full bg-gradient-to-r from-amber-500/80 to-amber-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Heatmap -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="flame" class="w-5 h-5 text-orange-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.heatmap.title">Activité vocale (7 jours)</h3>
          </div>
          <div class="flex items-center gap-2 text-xs text-zinc-500">
            <span data-i18n="dashboard.heatmap.low">Faible</span>
            <div class="flex gap-0.5">
              <div class="w-3 h-3 rounded-sm bg-indigo-100 dark:bg-indigo-900/20"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-300 dark:bg-indigo-700/50"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-500"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-700 dark:bg-indigo-400"></div>
            </div>
            <span data-i18n="dashboard.heatmap.high">Fort</span>
          </div>
        </div>
        <div id="activity-heatmap" class="overflow-x-auto"></div>
      </div>

      <!-- Quota Usage -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="pie-chart" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.quota.title">Utilisation du forfait</h3>
          </div>
          <span id="quota-plan-badge" class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full">--</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <!-- Sessions quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-sessions-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaSessionGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaSessionGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#6366f1" />
                    <stop offset="100%" stop-color="#818cf8" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-sessions-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.sessions">Sessions</p>
            <p id="quota-sessions-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
          <!-- Calls quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-calls-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaCallGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaCallGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#8b5cf6" />
                    <stop offset="100%" stop-color="#a78bfa" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-calls-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.calls">Appels</p>
            <p id="quota-calls-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
          <!-- KB Entries quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-kb-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaKbGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaKbGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#10b981" />
                    <stop offset="100%" stop-color="#34d399" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-kb-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.kb_entries">Base de connaissances</p>
            <p id="quota-kb-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
        </div>
      </div>

      <!-- ROI Summary -->
      <div class="bg-gradient-to-r from-[#050505] to-[#050505] rounded-xl p-6 text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,rgba(99,102,241,0.15),transparent_60%)]"></div>
        <div class="relative grid grid-cols-1 sm:grid-cols-4 gap-6">
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.cost">Coût mensuel</p>
            <p id="roi-cost" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.leads">Leads générés</p>
            <p id="roi-leads" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.cost_per_lead">Coût par lead</p>
            <p id="roi-cpl" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.estimated_value">Valeur estimée</p>
            <p id="roi-value" class="text-2xl font-bold mt-1 text-emerald-400">--</p>
          </div>
        </div>
      </div>

      <!-- System Intelligence -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="cpu" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.system.title">Intelligence Vocale</h3>
          </div>
          <div class="flex items-center gap-2">
            <span class="live-dot"></span>
            <span class="text-xs text-zinc-500" data-i18n="dashboard.system.active">Actif</span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- AI Engine -->
          <div class="p-4 rounded-xl border border-indigo-200 dark:border-indigo-500/20 bg-indigo-50/50 dark:bg-indigo-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                <i data-lucide="brain" class="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i>
              </div>
              <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider" data-i18n="dashboard.system.engine">Moteur IA</span>
            </div>
            <p class="font-bold text-zinc-900 dark:text-white">5 Providers</p>
            <p class="text-xs text-zinc-500 mt-1">Grok → Gemini → Claude → Atlas → Local</p>
            <div class="flex gap-1 mt-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
            </div>
          </div>
          <!-- Languages -->
          <div class="p-4 rounded-xl border border-purple-200 dark:border-purple-500/20 bg-purple-50/50 dark:bg-purple-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                <i data-lucide="globe" class="w-4 h-4 text-purple-600 dark:text-purple-400"></i>
              </div>
              <span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider" data-i18n="dashboard.system.languages">Langues</span>
            </div>
            <p class="font-bold text-zinc-900 dark:text-white">5 Langues</p>
            <div class="flex flex-wrap gap-1.5 mt-2">
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">FR</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">EN</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">ES</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]" dir="rtl">AR</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">Darija</span>
            </div>
          </div>
          <!-- Capabilities -->
          <div class="p-4 rounded-xl border border-emerald-200 dark:border-emerald-500/20 bg-emerald-50/50 dark:bg-emerald-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                <i data-lucide="sparkles" class="w-4 h-4 text-emerald-600 dark:text-emerald-400"></i>
              </div>
              <span class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider" data-i18n="dashboard.system.capabilities">Capacités</span>
            </div>
            <div class="space-y-1.5">
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="mic" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.stt">Reconnaissance vocale</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="volume-2" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.tts">Synthèse vocale</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="message-square" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.nlp">Compréhension naturelle</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="shield-check" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.multi_tenant">Isolation multi-tenant</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Calls -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
        <div class="p-5 border-b border-zinc-200 dark:border-white/[0.08] flex items-center justify-between">
          <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.calls.recent">Appels récents</h3>
          <a href="calls.html" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-i18n="dashboard.calls.view_all">Voir tout →</a>
        </div>
        <div id="recent-calls" class="divide-y divide-zinc-200 dark:divide-white/[0.08]">
          <div class="p-5 text-center text-zinc-500">
            <i data-lucide="loader-2" class="w-6 h-6 mx-auto animate-spin mb-2"></i>
            <p data-i18n="dashboard.loading">Chargement...</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="/app/components/app-components.js" defer></script>
  <!-- Scripts -->
  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import { api } from '/src/lib/api-client.js';
    import toast from '/src/lib/toast.js';

    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    // Initialize Lucide icons
    lucide.createIcons();

    // Check authentication
    if (!auth.requireAuth()) {
      // Will redirect to login
    }

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuToggle = document.getElementById('menu-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const logoutBtn = document.getElementById('logout-btn');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const welcomeMessage = document.getElementById('welcome-message');

    // Mobile menu toggle
    menuToggle?.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('hidden');
    });

    sidebarOverlay?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.add('hidden');
    });

    // Theme toggle
    themeToggle?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    // Initialize theme
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }

    // Logout
    logoutBtn?.addEventListener('click', async () => {
      await auth.logout();
      toast.success('Déconnexion réussie');
      window.location.href = '/app/auth/login.html';
    });

    // Load user info
    const user = auth.getCurrentUser();
    if (user) {
      userAvatar.textContent = (user.name || user.email).charAt(0).toUpperCase();
      userName.textContent = user.name || user.email.split('@')[0];
      userEmail.textContent = user.email;
      const t = window.VocaliaI18n?.t || ((k, fb) => fb);
      const name = user.name || user.email.split('@')[0];
      welcomeMessage.textContent = t('dashboard.header.welcome', `Bienvenue, ${name}.`).replace('{{name}}', name);
    }

    // Animated stat counter (Phase 2.1 - Data Showcase)
    function animateStatCounter(elementId, targetValue, duration = 1500) {
      const el = document.getElementById(elementId);
      if (!el || targetValue <= 0) {
        if (el) el.textContent = targetValue.toLocaleString();
        return;
      }

      const startTime = Date.now();
      const tick = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 3); // Ease out cubic
        const value = Math.round(targetValue * ease);
        el.textContent = value.toLocaleString();

        if (progress < 1) {
          requestAnimationFrame(tick);
        } else {
          el.textContent = targetValue.toLocaleString();
        }
      };
      tick();
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const tenantId = auth.getTenantId();
        const sessions = await api.sessions.getByTenant(tenantId);
        const data = sessions.data || [];

        // Current month data
        const now = new Date();
        const thisMonth = data.filter(s => {
          const d = new Date(s.created_at || s.timestamp);
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });

        // Previous month data for comparison
        const lastMonth = data.filter(s => {
          const d = new Date(s.created_at || s.timestamp);
          const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
          const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
          return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
        });

        // Calculate stats
        const totalCalls = thisMonth.length;
        const totalMinutes = thisMonth.reduce((sum, s) => sum + (parseInt(s.duration_sec) || 0), 0) / 60;
        const avgDuration = totalCalls > 0 ? Math.round(totalMinutes / totalCalls * 60) : 0;

        // Calculate trends (compare to last month)
        const lastMonthCalls = lastMonth.length;
        const lastMonthMinutes = lastMonth.reduce((sum, s) => sum + (parseInt(s.duration_sec) || 0), 0) / 60;
        const lastMonthAvgDuration = lastMonthCalls > 0 ? Math.round(lastMonthMinutes / lastMonthCalls * 60) : 0;

        // Language distribution
        const langCounts = {};
        thisMonth.forEach(s => {
          const lang = (s.lang || s.language || 'fr').toLowerCase();
          langCounts[lang] = (langCounts[lang] || 0) + 1;
        });
        const topLang = Object.entries(langCounts).sort((a, b) => b[1] - a[1])[0];

        // Update stats with animated counters (Phase 2.1)
        animateStatCounter('stat-calls', totalCalls);
        animateStatCounter('stat-minutes', Math.round(totalMinutes));
        document.getElementById('stat-duration').textContent = avgDuration > 0 ? `${Math.floor(avgDuration / 60)}:${String(avgDuration % 60).padStart(2, '0')}` : '--:--';
        document.getElementById('stat-languages').textContent = topLang ? topLang[0].toUpperCase() : 'FR';

        // Update trends with real data
        updateTrend('trend-calls', totalCalls, lastMonthCalls);
        updateTrend('trend-minutes', totalMinutes, lastMonthMinutes);
        updateTrend('trend-duration', avgDuration, lastMonthAvgDuration);

        // Compute performance insights from real data
        computeInsights(thisMonth, langCounts);

        // Render recent calls
        renderRecentCalls(data.slice(-5).reverse());

        // Initialize charts with real data
        initCharts(data, langCounts);

        // Voice AI Performance metrics
        renderAIPerformance(thisMonth);

        // Conversion funnel
        renderConversionFunnel(data, thisMonth);

        // Activity heatmap (7 days)
        renderActivityHeatmap(data);

        // ROI summary
        renderROISummary(thisMonth);

        // Quota usage
        renderQuotaUsage(tenantId);

      } catch (error) {
        console.error('Dashboard load error:', error);
        toast.error('Erreur de chargement des données');
      }
    }

    // Compute performance insights from real session data
    function computeInsights(sessions, langCounts) {
      // Peak hour
      const hourCounts = {};
      sessions.forEach(s => {
        const h = new Date(s.created_at || s.timestamp).getHours();
        hourCounts[h] = (hourCounts[h] || 0) + 1;
      });
      const peakEntry = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0];
      const peakEl = document.getElementById('insight-peak');
      if (peakEl) peakEl.textContent = peakEntry ? `${peakEntry[0]}h00` : '--';

      // Engagement: sessions > 120s
      const engaged = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 120).length;
      const engRate = sessions.length > 0 ? Math.round((engaged / sessions.length) * 100) : 0;
      const engEl = document.getElementById('insight-engagement');
      if (engEl) engEl.textContent = sessions.length > 0 ? `${engRate}%` : '--';

      // Active languages count
      const activeLangs = Object.keys(langCounts).length;
      const langsEl = document.getElementById('insight-langs');
      if (langsEl) langsEl.textContent = activeLangs > 0 ? `${activeLangs}/5` : '--';
    }

    // Calculate and display trend
    function updateTrend(elementId, current, previous) {
      const el = document.getElementById(elementId);
      if (!el) return;

      if (previous === 0 && current === 0) {
        el.textContent = '--';
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500';
        return;
      }

      const change = previous > 0 ? Math.round(((current - previous) / previous) * 100) : (current > 0 ? 100 : 0);

      if (change > 0) {
        el.textContent = `+${change}%`;
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';
      } else if (change < 0) {
        el.textContent = `${change}%`;
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
      } else {
        el.textContent = '0%';
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500';
      }
    }

    function renderRecentCalls(calls) {
      const container = document.getElementById('recent-calls');

      if (calls.length === 0) {
        container.innerHTML = `
          <div class="p-5 text-center text-zinc-500">
            <i data-lucide="phone-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p>Aucun appel récent</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = '';
      calls.forEach(call => {
        const row = document.createElement('div');
        row.className = 'p-4 flex items-center gap-4 hover:bg-zinc-50 dark:hover:bg-white/[0.04] transition-colors';

        const avatar = document.createElement('div');
        avatar.className = 'w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center flex-shrink-0';
        avatar.innerHTML = '<i data-lucide="phone" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>';

        const info = document.createElement('div');
        info.className = 'flex-1 min-w-0';
        const nameP = document.createElement('p');
        nameP.className = 'font-medium text-zinc-900 dark:text-white truncate';
        nameP.textContent = call.persona || 'Agent IA';
        const metaP = document.createElement('p');
        metaP.className = 'text-sm text-zinc-500';
        const dur = Math.round((call.duration_sec || 0) / 60);
        const lang = (call.lang || 'fr').toUpperCase();
        metaP.textContent = `${dur} min \u2022 ${lang}`;
        info.appendChild(nameP);
        info.appendChild(metaP);

        const badge = document.createElement('span');
        badge.className = 'px-2.5 py-1 text-xs font-medium rounded-full bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 flex-shrink-0';
        badge.textContent = 'Terminé';

        row.appendChild(avatar);
        row.appendChild(info);
        row.appendChild(badge);
        container.appendChild(row);
      });

      lucide.createIcons();
    }

    function initCharts(sessions, langCounts = {}) {
      // Call Volume Chart - group by last 7 days
      const callCtx = document.getElementById('callVolumeChart')?.getContext('2d');
      if (callCtx) {
        const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const last7Days = [];
        const callsByDay = [];

        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          last7Days.push(days[d.getDay()]);

          const count = sessions.filter(s => {
            const sd = new Date(s.created_at || s.timestamp);
            return sd.toDateString() === d.toDateString();
          }).length;
          callsByDay.push(count);
        }

        // Create gradient for bar chart
        const barGradient = callCtx.createLinearGradient(0, 0, 0, callCtx.canvas.height);
        barGradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
        barGradient.addColorStop(1, 'rgba(139, 92, 246, 0.6)');

        new Chart(callCtx, {
          type: 'bar',
          data: {
            labels: last7Days,
            datasets: [{
              label: 'Appels',
              data: callsByDay,
              backgroundColor: barGradient,
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                cornerRadius: 8,
                padding: 10,
                titleFont: { family: 'Inter, sans-serif', weight: '600' },
                bodyFont: { family: 'Inter, sans-serif' }
              }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.08)' }, ticks: { font: { family: 'Inter' } } },
              x: { grid: { display: false }, ticks: { font: { family: 'Inter' } } }
            }
          }
        });
      }

      // Language Chart - use real data
      const langCtx = document.getElementById('languageChart')?.getContext('2d');
      if (langCtx) {
        const langLabels = { fr: 'Français', en: 'English', ar: 'العربية', es: 'Español', ary: 'Darija' };
        const langColors = {
          fr: 'rgba(99, 102, 241, 0.8)',
          en: 'rgba(168, 85, 247, 0.8)',
          ar: 'rgba(236, 72, 153, 0.8)',
          es: 'rgba(34, 197, 94, 0.8)',
          ary: 'rgba(251, 146, 60, 0.8)'
        };

        const sortedLangs = Object.entries(langCounts).sort((a, b) => b[1] - a[1]);
        const labels = sortedLangs.length > 0
          ? sortedLangs.map(([code]) => langLabels[code] || code.toUpperCase())
          : ['Aucune donnée'];
        const data = sortedLangs.length > 0
          ? sortedLangs.map(([, count]) => count)
          : [1];
        const colors = sortedLangs.length > 0
          ? sortedLangs.map(([code]) => langColors[code] || 'rgba(107, 114, 128, 0.8)')
          : ['rgba(107, 114, 128, 0.3)'];

        new Chart(langCtx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: colors,
              borderWidth: 0,
              hoverOffset: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              legend: {
                position: 'right',
                labels: { usePointStyle: true, padding: 16, font: { family: 'Inter, sans-serif' } }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                cornerRadius: 8,
                padding: 10
              }
            }
          }
        });
      }
    }

    // Voice AI Performance: gauge, metrics, score
    function renderAIPerformance(sessions) {
      if (sessions.length === 0) return;

      // Response time: derive from session latency data or avg duration proxy
      const avgDurSec = sessions.reduce((s, x) => s + (parseInt(x.duration_sec) || 0), 0) / sessions.length;
      const responseScore = Math.min(100, Math.round(Math.max(0, 100 - (avgDurSec / 5)))); // shorter = better
      const latencies = sessions.filter(s => s.latency_ms).map(s => parseInt(s.latency_ms));
      const responseTimeMs = latencies.length > 0
        ? Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length)
        : Math.round(Math.min(2000, Math.max(400, avgDurSec * 15))); // proxy: shorter sessions = faster API

      // Resolution rate: sessions that lasted > 30s are considered "resolved"
      const resolved = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 30).length;
      const resolutionRate = Math.round((resolved / sessions.length) * 100);

      // Satisfaction: sessions > 60s with no escalation = satisfied
      const satisfied = sessions.filter(s => {
        const dur = parseInt(s.duration_sec) || 0;
        return dur > 60 && !s.escalated;
      }).length;
      const satisfactionRate = sessions.length > 0 ? Math.round((satisfied / sessions.length) * 100) : 0;

      // Composite AI score (weighted)
      const aiScore = Math.round(responseScore * 0.3 + resolutionRate * 0.4 + satisfactionRate * 0.3);

      // Update gauge ring
      const ring = document.getElementById('ai-score-ring');
      if (ring) {
        const circumference = 326.73;
        const offset = circumference - (circumference * aiScore / 100);
        ring.style.strokeDashoffset = offset;
        ring.classList.add('score-ring-animated');
      }

      // Update score number
      const scoreEl = document.getElementById('ai-score-value');
      if (scoreEl) animateStatCounter('ai-score-value', aiScore);

      // Update metric bars
      document.getElementById('metric-response-time').textContent = `${responseTimeMs}ms`;
      document.getElementById('bar-response-time').style.width = `${Math.min(100, Math.round((2000 - responseTimeMs) / 20))}%`;

      document.getElementById('metric-resolution').textContent = `${resolutionRate}%`;
      document.getElementById('bar-resolution').style.width = `${resolutionRate}%`;

      document.getElementById('metric-satisfaction').textContent = `${satisfactionRate}%`;
      document.getElementById('bar-satisfaction').style.width = `${satisfactionRate}%`;
    }

    // Conversion funnel from session data
    function renderConversionFunnel(allSessions, thisMonth) {
      const total = thisMonth.length || 1;
      const conversations = thisMonth.filter(s => (parseInt(s.duration_sec) || 0) > 10).length;
      const qualified = thisMonth.filter(s => (parseInt(s.duration_sec) || 0) > 60 || s.lead_score > 50).length;
      const converted = thisMonth.filter(s => s.status === 'converted' || s.booking_confirmed || (parseInt(s.duration_sec) || 0) > 180).length;

      const steps = [
        { id: 'funnel-widget', value: total, pct: 100 },
        { id: 'funnel-conversations', value: conversations, pct: Math.round((conversations / total) * 100) },
        { id: 'funnel-qualified', value: qualified, pct: Math.round((qualified / total) * 100) },
        { id: 'funnel-converted', value: converted, pct: Math.round((converted / total) * 100) }
      ];

      steps.forEach(step => {
        const el = document.getElementById(step.id);
        if (el) {
          const width = Math.max(step.pct, 8); // min 8% for visibility
          el.style.width = `${width}%`;
          el.querySelector('span').textContent = `${step.value} (${step.pct}%)`;
        }
      });
    }

    // Activity heatmap: 7 days × 24 hours
    function renderActivityHeatmap(sessions) {
      const container = document.getElementById('activity-heatmap');
      if (!container) return;

      const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
      const hours = Array.from({ length: 24 }, (_, i) => i);

      // Build 7-day grid from last 7 days of data
      const grid = Array.from({ length: 7 }, () => new Array(24).fill(0));
      const now = new Date();

      sessions.forEach(s => {
        const d = new Date(s.created_at || s.timestamp);
        const daysAgo = Math.floor((now - d) / 86400000);
        if (daysAgo >= 0 && daysAgo < 7) {
          const dayIdx = 6 - daysAgo; // 0 = oldest, 6 = today
          const hour = d.getHours();
          grid[dayIdx][hour]++;
        }
      });

      // Find max for color scaling
      const maxVal = Math.max(1, ...grid.flat());

      // Build table
      const table = document.createElement('div');
      table.className = 'inline-flex flex-col gap-1';

      // Hour labels row
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center gap-1';
      headerRow.innerHTML = '<div class="w-10"></div>'; // spacer for day labels
      hours.forEach(h => {
        if (h % 3 === 0) {
          const lbl = document.createElement('div');
          lbl.className = 'text-[10px] text-zinc-400 text-center';
          lbl.style.width = '28px';
          lbl.textContent = `${h}h`;
          headerRow.appendChild(lbl);
        } else {
          const spacer = document.createElement('div');
          spacer.style.width = '28px';
          headerRow.appendChild(spacer);
        }
      });
      table.appendChild(headerRow);

      // Day rows
      grid.forEach((dayData, dayIdx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-1';

        const dayLabel = document.createElement('div');
        dayLabel.className = 'w-10 text-xs text-zinc-500 text-right pr-2';
        const targetDate = new Date(now);
        targetDate.setDate(targetDate.getDate() - (6 - dayIdx));
        dayLabel.textContent = days[targetDate.getDay() === 0 ? 6 : targetDate.getDay() - 1];
        row.appendChild(dayLabel);

        dayData.forEach((count, hourIdx) => {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          const intensity = count / maxVal;

          if (count === 0) {
            cell.style.background = 'var(--hm-empty, rgba(99,102,241,0.06))';
          } else if (intensity < 0.25) {
            cell.style.background = 'rgba(99,102,241,0.15)';
          } else if (intensity < 0.5) {
            cell.style.background = 'rgba(99,102,241,0.35)';
          } else if (intensity < 0.75) {
            cell.style.background = 'rgba(99,102,241,0.6)';
          } else {
            cell.style.background = 'rgba(99,102,241,0.9)';
          }

          cell.title = `${days[targetDate.getDay() === 0 ? 6 : targetDate.getDay() - 1]} ${hourIdx}h: ${count} appel${count !== 1 ? 's' : ''}`;
          row.appendChild(cell);
        });

        table.appendChild(row);
      });

      container.innerHTML = '';
      container.appendChild(table);
    }

    // ROI Summary calculation
    function renderROISummary(sessions) {
      const totalMinutes = sessions.reduce((s, x) => s + (parseInt(x.duration_sec) || 0), 0) / 60;
      const costPerMin = 0.10; // EUR per minute (telephony rate)
      const planPrices = { starter: 49, pro: 99, ecommerce: 99, telephony: 199 };
      const tenantPlan = user?.plan || 'starter';
      const monthlyCost = (planPrices[tenantPlan] || 49) + (totalMinutes * costPerMin);

      const leads = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 60 || s.lead_score > 50).length;
      const costPerLead = leads > 0 ? monthlyCost / leads : 0;
      const estimatedValue = leads * 150; // avg lead value EUR

      const currency = document.documentElement.lang === 'fr' ? '\u20AC' : '$';

      document.getElementById('roi-cost').textContent = `${Math.round(monthlyCost)}${currency}`;
      document.getElementById('roi-leads').textContent = leads.toString();
      document.getElementById('roi-cpl').textContent = leads > 0 ? `${Math.round(costPerLead)}${currency}` : '--';
      document.getElementById('roi-value').textContent = `${estimatedValue.toLocaleString()}${currency}`;
    }

    // Quota usage — fetch tenant quota from API
    async function renderQuotaUsage(tenantId) {
      try {
        const tenant = await api.tenants.get(tenantId);
        if (!tenant) return;

        const planNames = { starter: 'Starter', pro: 'Pro', ecommerce: 'E-commerce', telephony: 'Telephony' };
        const planBadge = document.getElementById('quota-plan-badge');
        if (planBadge) planBadge.textContent = planNames[tenant.plan] || tenant.plan || 'Starter';

        const quotaItems = [
          { ringId: 'quota-sessions-ring', pctId: 'quota-sessions-pct', detailId: 'quota-sessions-detail', current: tenant.sessions_current || 0, limit: tenant.sessions_limit || 500 },
          { ringId: 'quota-calls-ring', pctId: 'quota-calls-pct', detailId: 'quota-calls-detail', current: tenant.calls_current || 0, limit: tenant.calls_limit || 200 },
          { ringId: 'quota-kb-ring', pctId: 'quota-kb-pct', detailId: 'quota-kb-detail', current: tenant.kb_entries_current || 0, limit: tenant.kb_entries_limit || 100 }
        ];

        const circumference = 251.33;
        quotaItems.forEach(q => {
          const pct = q.limit > 0 ? Math.min(100, Math.round((q.current / q.limit) * 100)) : 0;
          const offset = circumference - (circumference * pct / 100);

          const ring = document.getElementById(q.ringId);
          if (ring) {
            ring.style.strokeDashoffset = offset;
            ring.style.transition = 'stroke-dashoffset 1.2s ease-out';
          }

          const pctEl = document.getElementById(q.pctId);
          if (pctEl) pctEl.textContent = `${pct}%`;

          const detailEl = document.getElementById(q.detailId);
          if (detailEl) detailEl.textContent = `${q.current.toLocaleString()} / ${q.limit.toLocaleString()}`;

          // Color warning if > 80%
          if (pct > 80 && ring) {
            ring.style.stroke = pct > 95 ? '#ef4444' : '#f59e0b';
          }
        });
      } catch (e) {
        console.error('Quota load error:', e);
      }
    }

    // Load data
    loadDashboard();
  </script>
</body>
</html>
