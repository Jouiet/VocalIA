<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.vocalia.ma https://www.google-analytics.com; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Dashboard - VocalIA</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon/favicon-16x16.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Dark Mode (before CSS to prevent FOUC) -->
  <script src="/src/lib/dark-mode-init.js"></script>

  <!-- Tailwind CSS -->
  <link href="/public/css/style.css" rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js" integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM" crossorigin="anonymous"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4" crossorigin="anonymous"></script>

  <!-- i18n -->
  <script src="/src/lib/i18n.js"></script>

  <!-- GSAP Animations (counters) -->
  <script src="/src/lib/gsap-animations.js"></script>

  <style>
    /* Stat card accent borders */
    .stat-accent { position: relative; overflow: hidden; }
    .stat-accent::before {
      content: ''; position: absolute; top: 0; left: 0;
      width: 3px; height: 100%;
    }
    [dir="rtl"] .stat-accent::before { left: auto; right: 0; }
    .stat-accent-blue::before { background: linear-gradient(180deg, #6366f1, #3b82f6); }
    .stat-accent-purple::before { background: linear-gradient(180deg, #8b5cf6, #a855f7); }
    .stat-accent-green::before { background: linear-gradient(180deg, #10b981, #22c55e); }
    .stat-accent-amber::before { background: linear-gradient(180deg, #f59e0b, #f97316); }
    /* Subtle glow on hover */
    .stat-accent:hover { box-shadow: 0 0 20px rgba(99, 102, 241, 0.08); }
    /* Live indicator */
    @keyframes livePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: livePulse 2s ease-in-out infinite; }
    /* AI Score ring animation */
    @keyframes scoreRingDraw { from { stroke-dashoffset: 326.73; } }
    .score-ring-animated { animation: scoreRingDraw 1.5s ease-out forwards; }
    /* Heatmap cell */
    .heatmap-cell { width: 28px; height: 28px; border-radius: 4px; transition: all 0.15s; cursor: default; }
    .heatmap-cell:hover { transform: scale(1.3); z-index: 10; box-shadow: 0 0 8px rgba(99,102,241,0.4); }
    /* Funnel bar animation */
    @keyframes funnelGrow { from { width: 0; } }
    .funnel-bar { animation: funnelGrow 1s ease-out forwards; }
    /* Glassmorphism panel */
    .glass-panel { background: rgba(255,255,255,0.6); backdrop-filter: blur(12px); }
    .dark .glass-panel { background: rgba(255,255,255,0.04); }
    /* Sparkline mini-charts */
    .sparkline-canvas { width: 100%; height: 24px; margin-top: 8px; border-radius: 4px; }

    /* === Dashboard Visual Polish (250.253) === */

    /* Ambient glow on stat cards — color-matched per accent */
    .dark .stat-accent-blue:hover { box-shadow: 0 0 24px rgba(99, 102, 241, 0.12), 0 0 48px rgba(59, 130, 246, 0.06); }
    .dark .stat-accent-purple:hover { box-shadow: 0 0 24px rgba(139, 92, 246, 0.12), 0 0 48px rgba(168, 85, 247, 0.06); }
    .dark .stat-accent-green:hover { box-shadow: 0 0 24px rgba(16, 185, 129, 0.12), 0 0 48px rgba(34, 197, 94, 0.06); }
    .dark .stat-accent-amber:hover { box-shadow: 0 0 24px rgba(245, 158, 11, 0.12), 0 0 48px rgba(249, 115, 22, 0.06); }

    /* Micro-interactions — card lift on hover */
    .stat-accent { transition: transform 0.2s ease, box-shadow 0.3s ease; }
    .stat-accent:hover { transform: translateY(-2px) scale(1.01); }

    /* Gradient mesh welcome banner */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .welcome-gradient {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 25%, #6366f1 50%, #8b5cf6 75%, #4f46e5 100%);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
    }

    /* Refined dark mode — deeper backgrounds with subtle noise */
    .dark .glass-panel {
      background: rgba(255,255,255,0.03);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }

    /* Progress bar shimmer */
    @keyframes barShimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .bar-shimmer {
      background-size: 200% 100%;
      animation: barShimmer 3s ease-in-out infinite;
    }

    /* Score ring pulse on load */
    @keyframes ringPulse {
      0%, 100% { filter: drop-shadow(0 0 0px transparent); }
      50% { filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.3)); }
    }
    .score-ring-animated { animation: scoreRingDraw 1.5s ease-out forwards, ringPulse 3s ease-in-out 1.5s 1; }

    /* Empty state skeleton pulse */
    @keyframes skeletonPulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }
    .skeleton-pulse {
      background: linear-gradient(90deg, transparent 25%, rgba(99,102,241,0.08) 50%, transparent 75%);
      background-size: 200% 100%;
      animation: barShimmer 2s ease-in-out infinite;
      border-radius: 4px;
      min-height: 1.5em;
    }
    .dark .skeleton-pulse {
      background: linear-gradient(90deg, transparent 25%, rgba(99,102,241,0.12) 50%, transparent 75%);
      background-size: 200% 100%;
    }

    /* Pipeline step hover glow */
    .dark [class*="border-indigo-500/20"]:hover { box-shadow: 0 0 16px rgba(99,102,241,0.15); }
    .dark [class*="border-emerald-500/20"]:hover { box-shadow: 0 0 16px rgba(16,185,129,0.15); }
    .dark [class*="border-purple-500/20"]:hover { box-shadow: 0 0 16px rgba(139,92,246,0.15); }

    /* Fallback chain connector animation */
    .fallback-chain-item { transition: transform 0.2s ease, box-shadow 0.3s ease; }
    .fallback-chain-item:hover { transform: translateY(-1px); }
  </style>
</head>
<body class="min-h-screen bg-zinc-50 dark:bg-black">

  <!-- Sidebar Component -->
  <div data-app-component="sidebar"></div>

  <!-- Main Content -->
  <main class="lg:ml-[260px] rtl:lg:ml-0 rtl:lg:mr-[260px] min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-20 bg-white/80 dark:bg-white/[0.06] backdrop-blur border-b border-zinc-200 dark:border-white/[0.08]">
      <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
          <button id="menu-toggle" class="lg:hidden p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <h1 class="text-xl font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.title">Tableau de bord</h1>
        </div>
        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-1.5 text-xs text-zinc-400">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
            <span id="last-updated">--</span>
          </div>
          <button class="p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="bell" class="w-5 h-5"></i>
          </button>
          <button id="theme-toggle" class="p-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-white/[0.06] rounded-lg">
            <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <div class="p-4 lg:p-6 space-y-6">

      <!-- Welcome Banner -->
      <div class="welcome-gradient rounded-2xl p-6 text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_50%,rgba(255,255,255,0.1),transparent_70%)]"></div>
        <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold" id="welcome-message">Bienvenue !</h2>
            <p class="mt-1 opacity-80" data-i18n="dashboard.header.subtitle">Voici un aperçu de votre activité Voice AI</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="live-dot"></div>
            <span class="text-sm font-medium opacity-90" data-i18n="dashboard.header.status">Système opérationnel</span>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Total Calls -->
        <div class="stat-accent stat-accent-blue bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <i data-lucide="phone-call" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
            </div>
            <span id="trend-calls" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-calls" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.calls">Appels ce mois</p>
          <canvas class="sparkline-canvas" id="sparkline-calls" width="160" height="24"></canvas>
        </div>

        <!-- Minutes Used -->
        <div class="stat-accent stat-accent-purple bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
              <i data-lucide="clock" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
            </div>
            <span id="trend-minutes" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-minutes" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.minutes">Minutes utilisées</p>
          <canvas class="sparkline-canvas" id="sparkline-minutes" width="160" height="24"></canvas>
        </div>

        <!-- Avg Duration -->
        <div class="stat-accent stat-accent-green bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <i data-lucide="timer" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
            </div>
            <span id="trend-duration" class="text-xs font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500">--</span>
          </div>
          <p id="stat-duration" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.avg_duration">Durée moyenne</p>
          <canvas class="sparkline-canvas" id="sparkline-duration" width="160" height="24"></canvas>
        </div>

        <!-- Languages -->
        <div class="stat-accent stat-accent-amber bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-300">
          <div class="flex items-center justify-between">
            <div class="p-2 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
              <i data-lucide="languages" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
            </div>
            <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400">5 langues</span>
          </div>
          <p id="stat-languages" class="mt-3 text-3xl font-bold text-zinc-900 dark:text-white tracking-tight">--</p>
          <p class="text-sm text-zinc-500 mt-0.5" data-i18n="dashboard.stats.top_language">Langue principale</p>
          <canvas class="sparkline-canvas" id="sparkline-langs" width="160" height="24"></canvas>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Call Volume Chart -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
          <h3 class="font-semibold text-zinc-900 dark:text-white mb-4" data-i18n="dashboard.charts.call_volume">Volume d'appels (7 jours)</h3>
          <div class="h-64">
            <canvas id="callVolumeChart"></canvas>
          </div>
        </div>

        <!-- Language Distribution -->
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
          <h3 class="font-semibold text-zinc-900 dark:text-white mb-4" data-i18n="dashboard.charts.languages">Distribution des langues</h3>
          <div class="h-64 flex items-center justify-center">
            <canvas id="languageChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Performance Insights -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="activity" class="w-4 h-4 text-indigo-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.peak_hour">Heure de pointe</span>
          </div>
          <p id="insight-peak" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.peak_desc">Plus d'appels reçus</p>
        </div>
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.engagement">Engagement</span>
          </div>
          <p id="insight-engagement" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.engagement_desc">Sessions &gt; 2 min</p>
        </div>
        <div class="bg-white dark:bg-white/[0.06] rounded-xl p-5 border border-zinc-200 dark:border-white/[0.08]">
          <div class="flex items-center gap-2 mb-3">
            <i data-lucide="globe" class="w-4 h-4 text-emerald-500"></i>
            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.insights.languages_used">Langues actives</span>
          </div>
          <p id="insight-langs" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
          <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.insights.langs_desc">Langues utilisées ce mois</p>
        </div>
      </div>

      <!-- Voice AI Performance Score -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="brain" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.ai_performance.title">Performance IA Vocale</h3>
          </div>
          <span class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full" data-i18n="dashboard.ai_performance.period">Ce mois</span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <!-- AI Score Gauge -->
          <div class="flex flex-col items-center justify-center">
            <div class="relative w-32 h-32">
              <svg viewBox="0 0 120 120" class="w-full h-full -rotate-90">
                <circle cx="60" cy="60" r="52" fill="none" stroke="currentColor" stroke-width="8" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="ai-score-ring" cx="60" cy="60" r="52" fill="none" stroke="url(#scoreGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73" />
                <defs>
                  <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#6366f1" />
                    <stop offset="100%" stop-color="#a855f7" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="ai-score-value" class="text-3xl font-bold text-zinc-900 dark:text-white">--</span>
                <span class="text-xs text-zinc-500">/ 100</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.ai_performance.score">Score IA</p>
          </div>
          <!-- Metric Bars -->
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.response_time">Temps de réponse</span>
                <span id="metric-response-time" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-response-time" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.resolution">Taux de résolution</span>
                <span id="metric-resolution" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-resolution" class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-zinc-500" data-i18n="dashboard.ai_performance.satisfaction">Satisfaction</span>
                <span id="metric-satisfaction" class="font-medium text-zinc-900 dark:text-white">--</span>
              </div>
              <div class="w-full h-2 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
                <div id="bar-satisfaction" class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <!-- Conversion Funnel -->
          <div class="lg:col-span-2">
            <h4 class="text-sm font-medium text-zinc-600 dark:text-zinc-400 mb-3" data-i18n="dashboard.ai_performance.funnel_title">Entonnoir de Conversion</h4>
            <div class="space-y-2">
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0">Widget</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-widget" class="h-full bg-gradient-to-r from-indigo-500/80 to-indigo-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0">Conversations</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-conversations" class="h-full bg-gradient-to-r from-purple-500/80 to-purple-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0" data-i18n="dashboard.ai_performance.qualified">Qualifiés</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-qualified" class="h-full bg-gradient-to-r from-emerald-500/80 to-emerald-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-24 text-right text-xs text-zinc-500 flex-shrink-0" data-i18n="dashboard.ai_performance.converted">Convertis</div>
                <div class="flex-1 h-8 bg-zinc-100 dark:bg-white/[0.04] rounded-lg overflow-hidden relative">
                  <div id="funnel-converted" class="h-full bg-gradient-to-r from-amber-500/80 to-amber-400/60 rounded-lg flex items-center px-3 funnel-bar" style="width: 0%">
                    <span class="text-xs font-medium text-white whitespace-nowrap">--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Heatmap -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="flame" class="w-5 h-5 text-orange-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.heatmap.title">Activité vocale (7 jours)</h3>
          </div>
          <div class="flex items-center gap-2 text-xs text-zinc-500">
            <span data-i18n="dashboard.heatmap.low">Faible</span>
            <div class="flex gap-0.5">
              <div class="w-3 h-3 rounded-sm bg-indigo-100 dark:bg-indigo-900/20"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-300 dark:bg-indigo-700/50"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-500"></div>
              <div class="w-3 h-3 rounded-sm bg-indigo-700 dark:bg-indigo-400"></div>
            </div>
            <span data-i18n="dashboard.heatmap.high">Fort</span>
          </div>
        </div>
        <div id="activity-heatmap" class="overflow-x-auto"></div>
      </div>

      <!-- Quota Usage -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="pie-chart" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.quota.title">Utilisation du forfait</h3>
          </div>
          <span id="quota-plan-badge" class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full">--</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <!-- Sessions quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-sessions-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaSessionGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaSessionGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#6366f1" />
                    <stop offset="100%" stop-color="#818cf8" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-sessions-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.sessions">Sessions</p>
            <p id="quota-sessions-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
          <!-- Calls quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-calls-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaCallGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaCallGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#8b5cf6" />
                    <stop offset="100%" stop-color="#a78bfa" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-calls-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.calls">Appels</p>
            <p id="quota-calls-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
          <!-- KB Entries quota -->
          <div class="flex flex-col items-center">
            <div class="relative w-24 h-24">
              <svg viewBox="0 0 100 100" class="w-full h-full -rotate-90">
                <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="6" class="text-zinc-200 dark:text-white/[0.08]" />
                <circle id="quota-kb-ring" cx="50" cy="50" r="40" fill="none" stroke="url(#quotaKbGrad)" stroke-width="6" stroke-linecap="round" stroke-dasharray="251.33" stroke-dashoffset="251.33" />
                <defs>
                  <linearGradient id="quotaKbGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#10b981" />
                    <stop offset="100%" stop-color="#34d399" />
                  </linearGradient>
                </defs>
              </svg>
              <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="quota-kb-pct" class="text-lg font-bold text-zinc-900 dark:text-white">--%</span>
              </div>
            </div>
            <p class="mt-2 text-sm font-medium text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.quota.kb_entries">Base de connaissances</p>
            <p id="quota-kb-detail" class="text-xs text-zinc-500 mt-0.5">-- / --</p>
          </div>
        </div>
      </div>

      <!-- ROI Summary -->
      <div class="bg-gradient-to-br from-zinc-950 to-black rounded-xl p-6 text-white relative overflow-hidden border border-white/[0.06]">
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,rgba(99,102,241,0.18),transparent_60%)]"></div>
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_left,rgba(139,92,246,0.08),transparent_60%)]"></div>
        <div class="relative grid grid-cols-1 sm:grid-cols-4 gap-6">
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.cost">Coût mensuel</p>
            <p id="roi-cost" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.leads">Leads générés</p>
            <p id="roi-leads" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.cost_per_lead">Coût par lead</p>
            <p id="roi-cpl" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div>
            <p class="text-zinc-400 text-sm" data-i18n="dashboard.roi.estimated_value">Valeur estimée</p>
            <p id="roi-value" class="text-2xl font-bold mt-1 text-emerald-400">--</p>
          </div>
        </div>
      </div>

      <!-- Intelligence Summary — Data Driven (250.260) -->
      <div id="insights-panel" class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="scan-eye" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.insights.title">Intelligence Analytique</h3>
          </div>
          <span id="insights-status" class="text-xs text-zinc-400">--</span>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- KB Health -->
          <div class="p-4 rounded-xl border border-indigo-200 dark:border-indigo-500/20 bg-indigo-50/50 dark:bg-indigo-900/10">
            <div class="flex items-center gap-2 mb-2">
              <div class="p-1.5 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                <i data-lucide="database" class="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i>
              </div>
              <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider" data-i18n="dashboard.insights.kb_health">Sant&eacute; KB</span>
            </div>
            <p id="insights-kb-score" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
            <p id="insights-kb-level" class="text-xs text-zinc-500 mt-1">--</p>
            <div class="mt-2 h-1.5 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
              <div id="insights-kb-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-700" style="width: 0%"></div>
            </div>
          </div>
          <!-- Drift Alignment -->
          <div class="p-4 rounded-xl border border-emerald-200 dark:border-emerald-500/20 bg-emerald-50/50 dark:bg-emerald-900/10">
            <div class="flex items-center gap-2 mb-2">
              <div class="p-1.5 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                <i data-lucide="compass" class="w-4 h-4 text-emerald-600 dark:text-emerald-400"></i>
              </div>
              <span class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider" data-i18n="dashboard.insights.alignment">Alignement</span>
            </div>
            <p id="insights-drift-score" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
            <p id="insights-drift-label" class="text-xs text-zinc-500 mt-1">--</p>
            <div class="mt-2 h-1.5 bg-zinc-200 dark:bg-white/[0.08] rounded-full overflow-hidden">
              <div id="insights-drift-bar" class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full transition-all duration-700" style="width: 0%"></div>
            </div>
          </div>
          <!-- Cross-Sell Opportunities -->
          <div class="p-4 rounded-xl border border-purple-200 dark:border-purple-500/20 bg-purple-50/50 dark:bg-purple-900/10">
            <div class="flex items-center gap-2 mb-2">
              <div class="p-1.5 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                <i data-lucide="git-branch" class="w-4 h-4 text-purple-600 dark:text-purple-400"></i>
              </div>
              <span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider" data-i18n="dashboard.insights.cross_sell">Cross-sell</span>
            </div>
            <p id="insights-crosssell-count" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
            <div id="insights-crosssell-top" class="mt-2 space-y-1"></div>
          </div>
          <!-- Smart Alerts -->
          <div class="p-4 rounded-xl border border-amber-200 dark:border-amber-500/20 bg-amber-50/50 dark:bg-amber-900/10">
            <div class="flex items-center gap-2 mb-2">
              <div class="p-1.5 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <i data-lucide="bell-ring" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
              </div>
              <span class="text-xs font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider" data-i18n="dashboard.insights.alerts">Alertes</span>
            </div>
            <div id="insights-alerts" class="space-y-2">
              <div class="h-3 skeleton-pulse"></div>
              <div class="h-3 w-3/4 skeleton-pulse"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SOTA Engine Pipeline (T1-T7) -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="workflow" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.engine.title">Moteur IA SOTA</h3>
          </div>
          <div class="flex items-center gap-2">
            <span class="live-dot"></span>
            <span class="text-xs text-zinc-500" data-i18n="dashboard.engine.active">7 modules actifs</span>
          </div>
        </div>

        <!-- 7-Stage Pipeline Flow -->
        <div class="flex flex-wrap items-center justify-center gap-2 mb-6">
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-500/20">
            <i data-lucide="route" class="w-3.5 h-3.5 text-indigo-500"></i>
            <span class="text-xs font-semibold text-indigo-700 dark:text-indigo-300" data-i18n="dashboard.engine.t1">Routage</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-500/20">
            <i data-lucide="shield-check" class="w-3.5 h-3.5 text-emerald-500"></i>
            <span class="text-xs font-semibold text-emerald-700 dark:text-emerald-300" data-i18n="dashboard.engine.t2">Qualit&eacute;</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/20">
            <i data-lucide="layers" class="w-3.5 h-3.5 text-blue-500"></i>
            <span class="text-xs font-semibold text-blue-700 dark:text-blue-300" data-i18n="dashboard.engine.t3">Contexte</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-500/20">
            <i data-lucide="refresh-cw" class="w-3.5 h-3.5 text-amber-500"></i>
            <span class="text-xs font-semibold text-amber-700 dark:text-amber-300" data-i18n="dashboard.engine.t4">Retry</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-500/20">
            <i data-lucide="user-check" class="w-3.5 h-3.5 text-purple-500"></i>
            <span class="text-xs font-semibold text-purple-700 dark:text-purple-300" data-i18n="dashboard.engine.t5">Profil</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-500/20">
            <i data-lucide="coins" class="w-3.5 h-3.5 text-rose-500"></i>
            <span class="text-xs font-semibold text-rose-700 dark:text-rose-300" data-i18n="dashboard.engine.t6">Budget</span>
          </div>
          <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-zinc-300 dark:text-zinc-600 hidden sm:block"></i>
          <div class="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-teal-50 dark:bg-teal-900/20 border border-teal-200 dark:border-teal-500/20">
            <i data-lucide="database" class="w-3.5 h-3.5 text-teal-500"></i>
            <span class="text-xs font-semibold text-teal-700 dark:text-teal-300" data-i18n="dashboard.engine.t7">RAG</span>
          </div>
        </div>

        <!-- Engine Metrics Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
          <!-- Provider Resilience -->
          <div class="p-4 rounded-xl bg-zinc-50 dark:bg-white/[0.03] border border-zinc-100 dark:border-white/[0.06]">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="server" class="w-4 h-4 text-indigo-500"></i>
              <span class="text-xs font-medium text-zinc-500" data-i18n="dashboard.engine.providers">Fournisseurs IA</span>
            </div>
            <p class="text-2xl font-bold text-zinc-900 dark:text-white">5</p>
            <div class="flex gap-1 mt-2">
              <span class="w-2 h-2 rounded-full bg-indigo-500" title="Grok"></span>
              <span class="w-2 h-2 rounded-full bg-emerald-500" title="Gemini"></span>
              <span class="w-2 h-2 rounded-full bg-amber-500" title="Claude"></span>
              <span class="w-2 h-2 rounded-full bg-purple-500" title="Atlas"></span>
              <span class="w-2 h-2 rounded-full bg-blue-500" title="Local"></span>
            </div>
          </div>
          <!-- Quality Gate -->
          <div class="p-4 rounded-xl bg-zinc-50 dark:bg-white/[0.03] border border-zinc-100 dark:border-white/[0.06]">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>
              <span class="text-xs font-medium text-zinc-500" data-i18n="dashboard.engine.quality">Contr&ocirc;le qualit&eacute;</span>
            </div>
            <p id="engine-quality-score" class="text-2xl font-bold text-zinc-900 dark:text-white">5</p>
            <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.engine.quality_checks">v&eacute;rifications par r&eacute;ponse</p>
          </div>
          <!-- Avg Response Time -->
          <div class="p-4 rounded-xl bg-zinc-50 dark:bg-white/[0.03] border border-zinc-100 dark:border-white/[0.06]">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
              <span class="text-xs font-medium text-zinc-500" data-i18n="dashboard.engine.latency">Latence IA</span>
            </div>
            <p id="engine-avg-latency" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
            <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.engine.latency_unit">ms en moyenne</p>
          </div>
          <!-- Token Budget -->
          <div class="p-4 rounded-xl bg-zinc-50 dark:bg-white/[0.03] border border-zinc-100 dark:border-white/[0.06]">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="coins" class="w-4 h-4 text-rose-500"></i>
              <span class="text-xs font-medium text-zinc-500" data-i18n="dashboard.engine.tokens">Budget tokens</span>
            </div>
            <p id="engine-token-usage" class="text-2xl font-bold text-zinc-900 dark:text-white">--</p>
            <div class="w-full h-1.5 bg-zinc-200 dark:bg-white/[0.08] rounded-full mt-2 overflow-hidden">
              <div id="engine-token-bar" class="h-full bg-gradient-to-r from-rose-500 to-pink-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- 5-Level Fallback Chain -->
        <div class="mt-5 p-4 rounded-xl bg-zinc-50 dark:bg-white/[0.03] border border-zinc-100 dark:border-white/[0.06]">
          <p class="text-xs font-medium text-zinc-500 mb-3" data-i18n="dashboard.engine.fallback_chain">Cha&icirc;ne de redondance intelligente</p>
          <div class="flex items-center gap-2 flex-wrap">
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
              <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
              <span class="text-xs font-medium text-indigo-700 dark:text-indigo-300">Grok</span>
            </div>
            <i data-lucide="arrow-right" class="w-3 h-3 text-zinc-300 dark:text-zinc-600"></i>
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
              <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
              <span class="text-xs font-medium text-emerald-700 dark:text-emerald-300">Gemini</span>
            </div>
            <i data-lucide="arrow-right" class="w-3 h-3 text-zinc-300 dark:text-zinc-600"></i>
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
              <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
              <span class="text-xs font-medium text-amber-700 dark:text-amber-300">Claude</span>
            </div>
            <i data-lucide="arrow-right" class="w-3 h-3 text-zinc-300 dark:text-zinc-600"></i>
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
              <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
              <span class="text-xs font-medium text-purple-700 dark:text-purple-300">Atlas</span>
            </div>
            <i data-lucide="arrow-right" class="w-3 h-3 text-zinc-300 dark:text-zinc-600"></i>
            <div class="flex items-center gap-1.5 px-2.5 py-1.5 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
              <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
              <span class="text-xs font-medium text-blue-700 dark:text-blue-300">Local</span>
            </div>
          </div>
        </div>
      </div>

      <!-- System Intelligence -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-2">
            <i data-lucide="cpu" class="w-5 h-5 text-indigo-500"></i>
            <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.system.title">Intelligence Vocale</h3>
          </div>
          <div class="flex items-center gap-2">
            <span class="live-dot"></span>
            <span class="text-xs text-zinc-500" data-i18n="dashboard.system.active">Actif</span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- AI Engine -->
          <div class="p-4 rounded-xl border border-indigo-200 dark:border-indigo-500/20 bg-indigo-50/50 dark:bg-indigo-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                <i data-lucide="brain" class="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i>
              </div>
              <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider" data-i18n="dashboard.system.engine">Moteur IA</span>
            </div>
            <div class="flex items-center gap-2">
              <p class="font-bold text-zinc-900 dark:text-white" data-i18n="dashboard.system.high_availability">Haute Disponibilit&eacute;</p>
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            </div>
            <p class="text-xs text-zinc-500 mt-1" data-i18n="dashboard.system.redundancy_levels">5 niveaux de redondance</p>
            <span class="inline-block mt-2 text-xs font-medium px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full" data-i18n="dashboard.system.status_operational">Op&eacute;rationnel</span>
          </div>
          <!-- Languages -->
          <div class="p-4 rounded-xl border border-purple-200 dark:border-purple-500/20 bg-purple-50/50 dark:bg-purple-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                <i data-lucide="globe" class="w-4 h-4 text-purple-600 dark:text-purple-400"></i>
              </div>
              <span class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider" data-i18n="dashboard.system.languages">Langues</span>
            </div>
            <p class="font-bold text-zinc-900 dark:text-white">5 Langues</p>
            <div class="flex flex-wrap gap-1.5 mt-2">
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">FR</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">EN</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">ES</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]" dir="rtl">AR</span>
              <span class="px-2 py-0.5 text-xs font-medium bg-white dark:bg-white/[0.08] rounded-full text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-white/[0.08]">Darija</span>
            </div>
          </div>
          <!-- Capabilities -->
          <div class="p-4 rounded-xl border border-emerald-200 dark:border-emerald-500/20 bg-emerald-50/50 dark:bg-emerald-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                <i data-lucide="sparkles" class="w-4 h-4 text-emerald-600 dark:text-emerald-400"></i>
              </div>
              <span class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider" data-i18n="dashboard.system.capabilities">Capacit&eacute;s</span>
            </div>
            <div class="space-y-1.5">
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="mic" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.stt">Reconnaissance vocale</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="volume-2" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.tts">Synth&egrave;se vocale</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="message-square" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.nlp">Compr&eacute;hension naturelle</span>
              </div>
              <div class="flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-400">
                <i data-lucide="shield-check" class="w-3 h-3 text-emerald-500"></i>
                <span data-i18n="dashboard.system.multi_tenant">Donn&eacute;es 100% isol&eacute;es</span>
              </div>
            </div>
          </div>
          <!-- Memory & Learning -->
          <div class="p-4 rounded-xl border border-amber-200 dark:border-amber-500/20 bg-amber-50/50 dark:bg-amber-900/10">
            <div class="flex items-center gap-2 mb-3">
              <div class="p-1.5 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <i data-lucide="brain-circuit" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
              </div>
              <span class="text-xs font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider" data-i18n="dashboard.system.memory">M&eacute;moire IA</span>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-xs text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.system.facts_learned">Faits appris</span>
                <span id="memory-facts-count" class="text-xs font-bold text-zinc-900 dark:text-white font-mono">--</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.system.kb_entries">Entr&eacute;es KB</span>
                <span id="memory-kb-count" class="text-xs font-bold text-zinc-900 dark:text-white font-mono">--</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-zinc-600 dark:text-zinc-400" data-i18n="dashboard.system.flywheel">Am&eacute;lioration continue</span>
                <div class="flex items-center gap-1.5">
                  <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                  <span class="text-xs font-medium text-emerald-600 dark:text-emerald-400" data-i18n="dashboard.system.flywheel_active">Actif</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Calls -->
      <div class="bg-white dark:bg-white/[0.06] rounded-xl border border-zinc-200 dark:border-white/[0.08] hover:shadow-lg transition-all duration-200">
        <div class="p-5 border-b border-zinc-200 dark:border-white/[0.08] flex items-center justify-between">
          <h3 class="font-semibold text-zinc-900 dark:text-white" data-i18n="dashboard.calls.recent">Appels récents</h3>
          <a href="calls.html" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-i18n="dashboard.calls.view_all">Voir tout →</a>
        </div>
        <div id="recent-calls" class="divide-y divide-zinc-200 dark:divide-white/[0.08]">
          <div class="p-5 space-y-3">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full skeleton-pulse"></div>
              <div class="flex-1 space-y-2">
                <div class="h-3 w-3/4 skeleton-pulse"></div>
                <div class="h-2 w-1/2 skeleton-pulse"></div>
              </div>
              <div class="h-3 w-16 skeleton-pulse"></div>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full skeleton-pulse"></div>
              <div class="flex-1 space-y-2">
                <div class="h-3 w-2/3 skeleton-pulse"></div>
                <div class="h-2 w-2/5 skeleton-pulse"></div>
              </div>
              <div class="h-3 w-16 skeleton-pulse"></div>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full skeleton-pulse"></div>
              <div class="flex-1 space-y-2">
                <div class="h-3 w-4/5 skeleton-pulse"></div>
                <div class="h-2 w-1/3 skeleton-pulse"></div>
              </div>
              <div class="h-3 w-16 skeleton-pulse"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="/src/lib/components.js" defer></script>
  <!-- Scripts -->
  <script type="module">
    import auth from '/src/lib/auth-client.js';
    import { api } from '/src/lib/api-client.js';
    import toast from '/src/lib/toast.js';

    // Initialize i18n (RTL support for AR/ARY)
    if (window.VocaliaI18n) {
      await VocaliaI18n.initI18n();
      VocaliaI18n.translatePage();
    }

    // Initialize Lucide icons
    lucide.createIcons();

    // Check authentication
    if (!auth.requireAuth()) {
      // Will redirect to login
    }

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuToggle = document.getElementById('menu-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const logoutBtn = document.getElementById('logout-btn');
    const userAvatar = document.getElementById('user-avatar');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const welcomeMessage = document.getElementById('welcome-message');

    // Mobile menu toggle
    menuToggle?.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('hidden');
    });

    sidebarOverlay?.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.add('hidden');
    });

    // Theme toggle
    themeToggle?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('vocalia_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    // Logout
    logoutBtn?.addEventListener('click', async () => {
      await auth.logout();
      toast.success(VocaliaI18n.t('dashboard.common.logout_success'));
      window.location.href = '/app/auth/login.html';
    });

    // Load user info
    const user = auth.getCurrentUser();
    if (user) {
      userAvatar.textContent = (user.name || user.email).charAt(0).toUpperCase();
      userName.textContent = user.name || user.email.split('@')[0];
      userEmail.textContent = user.email;
      const t = window.VocaliaI18n?.t || ((k, fb) => fb);
      const name = user.name || user.email.split('@')[0];
      welcomeMessage.textContent = t('dashboard.header.welcome', { name }) || `Bienvenue, ${name}.`;
    }

    // Animated stat counter (Phase 2.1 - Data Showcase)
    function animateStatCounter(elementId, targetValue, duration = 1500) {
      const el = document.getElementById(elementId);
      if (!el || targetValue <= 0) {
        if (el) el.textContent = targetValue.toLocaleString();
        return;
      }

      const startTime = Date.now();
      const tick = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 3); // Ease out cubic
        const value = Math.round(targetValue * ease);
        el.textContent = value.toLocaleString();

        if (progress < 1) {
          requestAnimationFrame(tick);
        } else {
          el.textContent = targetValue.toLocaleString();
        }
      };
      tick();
    }

    // Sparkline mini-chart renderer
    function drawSparkline(canvasId, data, color = '#6366f1') {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !data || data.length < 2) return;
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.width / dpr;
      const h = canvas.height / dpr;
      const max = Math.max(...data, 1);
      const min = Math.min(...data, 0);
      const range = max - min || 1;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.scale(dpr, dpr);

      // Filled area
      ctx.beginPath();
      data.forEach((v, i) => {
        const x = (i / (data.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 4) - 2;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.closePath();
      const grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, color + '25');
      grad.addColorStop(1, color + '05');
      ctx.fillStyle = grad;
      ctx.fill();

      // Line
      ctx.beginPath();
      data.forEach((v, i) => {
        const x = (i / (data.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 4) - 2;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.stroke();

      // End dot
      const lastX = w;
      const lastY = h - ((data[data.length - 1] - min) / range) * (h - 4) - 2;
      ctx.beginPath();
      ctx.arc(lastX, lastY, 2, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();

      ctx.restore();
    }

    // Compute 7-day sparkline data from sessions
    function computeSparklineData(sessions, extractor = () => 1) {
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dayStr = d.toDateString();
        const daySessions = sessions.filter(s =>
          new Date(s.created_at || s.timestamp).toDateString() === dayStr
        );
        days.push(daySessions.reduce((sum, s) => sum + extractor(s), 0));
      }
      return days;
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        const tenantId = auth.getTenantId();
        const sessions = await api.sessions.getByTenant(tenantId);
        const data = sessions.data || [];

        // Current month data
        const now = new Date();
        const thisMonth = data.filter(s => {
          const d = new Date(s.created_at || s.timestamp);
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });

        // Previous month data for comparison
        const lastMonth = data.filter(s => {
          const d = new Date(s.created_at || s.timestamp);
          const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
          const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
          return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
        });

        // Calculate stats
        const totalCalls = thisMonth.length;
        const totalMinutes = thisMonth.reduce((sum, s) => sum + (parseInt(s.duration_sec) || 0), 0) / 60;
        const avgDuration = totalCalls > 0 ? Math.round(totalMinutes / totalCalls * 60) : 0;

        // Calculate trends (compare to last month)
        const lastMonthCalls = lastMonth.length;
        const lastMonthMinutes = lastMonth.reduce((sum, s) => sum + (parseInt(s.duration_sec) || 0), 0) / 60;
        const lastMonthAvgDuration = lastMonthCalls > 0 ? Math.round(lastMonthMinutes / lastMonthCalls * 60) : 0;

        // Language distribution
        const langCounts = {};
        thisMonth.forEach(s => {
          const lang = (s.lang || s.language || 'fr').toLowerCase();
          langCounts[lang] = (langCounts[lang] || 0) + 1;
        });
        const topLang = Object.entries(langCounts).sort((a, b) => b[1] - a[1])[0];

        // Update stats with animated counters (Phase 2.1)
        animateStatCounter('stat-calls', totalCalls);
        animateStatCounter('stat-minutes', Math.round(totalMinutes));
        document.getElementById('stat-duration').textContent = avgDuration > 0 ? `${Math.floor(avgDuration / 60)}:${String(avgDuration % 60).padStart(2, '0')}` : '--:--';
        document.getElementById('stat-languages').textContent = topLang ? topLang[0].toUpperCase() : 'FR';

        // Update trends with real data
        updateTrend('trend-calls', totalCalls, lastMonthCalls);
        updateTrend('trend-minutes', totalMinutes, lastMonthMinutes);
        updateTrend('trend-duration', avgDuration, lastMonthAvgDuration);

        // Compute performance insights from real data
        computeInsights(thisMonth, langCounts);

        // Render recent calls
        renderRecentCalls(data.slice(-5).reverse());

        // Initialize charts with real data
        initCharts(data, langCounts);

        // Sparklines (7-day trends)
        const callsByDay = computeSparklineData(data, () => 1);
        const minutesByDay = computeSparklineData(data, s => (parseInt(s.duration_sec) || 0) / 60);
        const durationByDay = computeSparklineData(data, s => parseInt(s.duration_sec) || 0);
        const langsByDay = computeSparklineData(data, s => {
          const lang = (s.lang || s.language || 'fr').toLowerCase();
          return lang !== 'fr' ? 1 : 0;
        });
        drawSparkline('sparkline-calls', callsByDay, '#6366f1');
        drawSparkline('sparkline-minutes', minutesByDay, '#8b5cf6');
        drawSparkline('sparkline-duration', durationByDay, '#10b981');
        drawSparkline('sparkline-langs', langsByDay, '#f59e0b');

        // Voice AI Performance metrics
        renderAIPerformance(thisMonth);

        // Conversion funnel
        renderConversionFunnel(data, thisMonth);

        // Activity heatmap (7 days)
        renderActivityHeatmap(data);

        // ROI summary
        renderROISummary(thisMonth);

        // SOTA Engine metrics
        renderEngineMetrics(thisMonth, tenantId);

        // Quota usage
        renderQuotaUsage(tenantId);

        // Intelligence Summary (Data Driven — 250.260)
        renderInsightsSummary(tenantId);

      } catch (error) {
        console.error('Dashboard load error:', error);
        toast.error(VocaliaI18n.t('dashboard.common.data_load_error'));
      }
    }

    // Compute performance insights from real session data
    function computeInsights(sessions, langCounts) {
      // Peak hour
      const hourCounts = {};
      sessions.forEach(s => {
        const h = new Date(s.created_at || s.timestamp).getHours();
        hourCounts[h] = (hourCounts[h] || 0) + 1;
      });
      const peakEntry = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0];
      const peakEl = document.getElementById('insight-peak');
      if (peakEl) peakEl.textContent = peakEntry ? `${peakEntry[0]}h00` : '--';

      // Engagement: sessions > 120s
      const engaged = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 120).length;
      const engRate = sessions.length > 0 ? Math.round((engaged / sessions.length) * 100) : 0;
      const engEl = document.getElementById('insight-engagement');
      if (engEl) engEl.textContent = sessions.length > 0 ? `${engRate}%` : '--';

      // Active languages count
      const activeLangs = Object.keys(langCounts).length;
      const langsEl = document.getElementById('insight-langs');
      if (langsEl) langsEl.textContent = activeLangs > 0 ? `${activeLangs}/5` : '--';
    }

    // Calculate and display trend
    function updateTrend(elementId, current, previous) {
      const el = document.getElementById(elementId);
      if (!el) return;

      if (previous === 0 && current === 0) {
        el.textContent = '--';
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500';
        return;
      }

      const change = previous > 0 ? Math.round(((current - previous) / previous) * 100) : (current > 0 ? 100 : 0);

      if (change > 0) {
        el.textContent = `+${change}%`;
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';
      } else if (change < 0) {
        el.textContent = `${change}%`;
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
      } else {
        el.textContent = '0%';
        el.className = 'text-sm font-medium px-2 py-0.5 rounded-full bg-zinc-100 dark:bg-white/[0.06] text-zinc-500';
      }
    }

    function renderRecentCalls(calls) {
      const container = document.getElementById('recent-calls');

      if (calls.length === 0) {
        container.innerHTML = `
          <div class="p-5 text-center text-zinc-500">
            <i data-lucide="phone-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p>Aucun appel récent</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = '';
      calls.forEach(call => {
        const row = document.createElement('div');
        row.className = 'p-4 flex items-center gap-4 hover:bg-zinc-50 dark:hover:bg-white/[0.04] transition-colors';

        const avatar = document.createElement('div');
        avatar.className = 'w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center flex-shrink-0';
        avatar.innerHTML = '<i data-lucide="phone" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>';

        const info = document.createElement('div');
        info.className = 'flex-1 min-w-0';
        const nameP = document.createElement('p');
        nameP.className = 'font-medium text-zinc-900 dark:text-white truncate';
        nameP.textContent = call.persona || 'Agent IA';
        const metaP = document.createElement('p');
        metaP.className = 'text-sm text-zinc-500';
        const dur = Math.round((call.duration_sec || 0) / 60);
        const lang = (call.lang || 'fr').toUpperCase();
        metaP.textContent = `${dur} min \u2022 ${lang}`;
        info.appendChild(nameP);
        info.appendChild(metaP);

        const badge = document.createElement('span');
        badge.className = 'px-2.5 py-1 text-xs font-medium rounded-full bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 flex-shrink-0';
        badge.textContent = VocaliaI18n.t('common.completed');

        row.appendChild(avatar);
        row.appendChild(info);
        row.appendChild(badge);
        container.appendChild(row);
      });

      lucide.createIcons();
    }

    function initCharts(sessions, langCounts = {}) {
      // Call Volume Chart - group by last 7 days
      const callCtx = document.getElementById('callVolumeChart')?.getContext('2d');
      if (callCtx) {
        const locale = document.documentElement.lang || 'fr';
        const last7Days = [];
        const callsByDay = [];

        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          last7Days.push(d.toLocaleDateString(locale, { weekday: 'short' }));

          const count = sessions.filter(s => {
            const sd = new Date(s.created_at || s.timestamp);
            return sd.toDateString() === d.toDateString();
          }).length;
          callsByDay.push(count);
        }

        // Create gradient for bar chart
        const barGradient = callCtx.createLinearGradient(0, 0, 0, callCtx.canvas.height);
        barGradient.addColorStop(0, 'rgba(99, 102, 241, 0.9)');
        barGradient.addColorStop(1, 'rgba(139, 92, 246, 0.6)');

        new Chart(callCtx, {
          type: 'bar',
          data: {
            labels: last7Days,
            datasets: [{
              label: 'Appels',
              data: callsByDay,
              backgroundColor: barGradient,
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                cornerRadius: 8,
                padding: 10,
                titleFont: { family: 'Inter, sans-serif', weight: '600' },
                bodyFont: { family: 'Inter, sans-serif' }
              }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.08)' }, ticks: { font: { family: 'Inter' } } },
              x: { grid: { display: false }, ticks: { font: { family: 'Inter' } } }
            }
          }
        });
      }

      // Language Chart - use real data
      const langCtx = document.getElementById('languageChart')?.getContext('2d');
      if (langCtx) {
        const langLabels = { fr: 'Français', en: 'English', ar: 'العربية', es: 'Español', ary: 'Darija' };
        const langColors = {
          fr: 'rgba(99, 102, 241, 0.8)',
          en: 'rgba(168, 85, 247, 0.8)',
          ar: 'rgba(236, 72, 153, 0.8)',
          es: 'rgba(34, 197, 94, 0.8)',
          ary: 'rgba(251, 146, 60, 0.8)'
        };

        const sortedLangs = Object.entries(langCounts).sort((a, b) => b[1] - a[1]);
        const labels = sortedLangs.length > 0
          ? sortedLangs.map(([code]) => langLabels[code] || code.toUpperCase())
          : [window.VocaliaI18n ? VocaliaI18n.t('dashboard.analytics_page.no_data') || 'Aucune donnée' : 'Aucune donnée'];
        const data = sortedLangs.length > 0
          ? sortedLangs.map(([, count]) => count)
          : [1];
        const colors = sortedLangs.length > 0
          ? sortedLangs.map(([code]) => langColors[code] || 'rgba(107, 114, 128, 0.8)')
          : ['rgba(107, 114, 128, 0.3)'];

        new Chart(langCtx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data,
              backgroundColor: colors,
              borderWidth: 0,
              hoverOffset: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              legend: {
                position: 'right',
                labels: { usePointStyle: true, padding: 16, font: { family: 'Inter, sans-serif' } }
              },
              tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                cornerRadius: 8,
                padding: 10
              }
            }
          }
        });
      }
    }

    // Voice AI Performance: gauge, metrics, score
    function renderAIPerformance(sessions) {
      if (sessions.length === 0) return;

      // Response time: derive from session latency data or avg duration proxy
      const avgDurSec = sessions.reduce((s, x) => s + (parseInt(x.duration_sec) || 0), 0) / sessions.length;
      const responseScore = Math.min(100, Math.round(Math.max(0, 100 - (avgDurSec / 5)))); // shorter = better
      const latencies = sessions.filter(s => s.latency_ms).map(s => parseInt(s.latency_ms));
      const responseTimeMs = latencies.length > 0
        ? Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length)
        : Math.round(Math.min(2000, Math.max(400, avgDurSec * 15))); // proxy: shorter sessions = faster API

      // Resolution rate: sessions that lasted > 30s are considered "resolved"
      const resolved = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 30).length;
      const resolutionRate = Math.round((resolved / sessions.length) * 100);

      // Satisfaction: sessions > 60s with no escalation = satisfied
      const satisfied = sessions.filter(s => {
        const dur = parseInt(s.duration_sec) || 0;
        return dur > 60 && !s.escalated;
      }).length;
      const satisfactionRate = sessions.length > 0 ? Math.round((satisfied / sessions.length) * 100) : 0;

      // Composite AI score (weighted)
      const aiScore = Math.round(responseScore * 0.3 + resolutionRate * 0.4 + satisfactionRate * 0.3);

      // Update gauge ring
      const ring = document.getElementById('ai-score-ring');
      if (ring) {
        const circumference = 326.73;
        const offset = circumference - (circumference * aiScore / 100);
        ring.style.strokeDashoffset = offset;
        ring.classList.add('score-ring-animated');
      }

      // Update score number
      const scoreEl = document.getElementById('ai-score-value');
      if (scoreEl) animateStatCounter('ai-score-value', aiScore);

      // Update metric bars
      document.getElementById('metric-response-time').textContent = `${responseTimeMs}ms`;
      document.getElementById('bar-response-time').style.width = `${Math.min(100, Math.round((2000 - responseTimeMs) / 20))}%`;

      document.getElementById('metric-resolution').textContent = `${resolutionRate}%`;
      document.getElementById('bar-resolution').style.width = `${resolutionRate}%`;

      document.getElementById('metric-satisfaction').textContent = `${satisfactionRate}%`;
      document.getElementById('bar-satisfaction').style.width = `${satisfactionRate}%`;
    }

    // Conversion funnel from session data
    function renderConversionFunnel(allSessions, thisMonth) {
      const total = thisMonth.length || 1;
      const conversations = thisMonth.filter(s => (parseInt(s.duration_sec) || 0) > 10).length;
      const qualified = thisMonth.filter(s => (parseInt(s.duration_sec) || 0) > 60 || s.lead_score > 50).length;
      const converted = thisMonth.filter(s => s.status === 'converted' || s.booking_confirmed || (parseInt(s.duration_sec) || 0) > 180).length;

      const steps = [
        { id: 'funnel-widget', value: total, pct: 100 },
        { id: 'funnel-conversations', value: conversations, pct: Math.round((conversations / total) * 100) },
        { id: 'funnel-qualified', value: qualified, pct: Math.round((qualified / total) * 100) },
        { id: 'funnel-converted', value: converted, pct: Math.round((converted / total) * 100) }
      ];

      steps.forEach(step => {
        const el = document.getElementById(step.id);
        if (el) {
          const width = Math.max(step.pct, 8); // min 8% for visibility
          el.style.width = `${width}%`;
          el.querySelector('span').textContent = `${step.value} (${step.pct}%)`;
        }
      });
    }

    // Activity heatmap: 7 days × 24 hours
    function renderActivityHeatmap(sessions) {
      const container = document.getElementById('activity-heatmap');
      if (!container) return;

      const locale = document.documentElement.lang || 'fr';
      const hours = Array.from({ length: 24 }, (_, i) => i);

      // Build 7-day grid from last 7 days of data
      const grid = Array.from({ length: 7 }, () => new Array(24).fill(0));
      const now = new Date();

      sessions.forEach(s => {
        const d = new Date(s.created_at || s.timestamp);
        const daysAgo = Math.floor((now - d) / 86400000);
        if (daysAgo >= 0 && daysAgo < 7) {
          const dayIdx = 6 - daysAgo; // 0 = oldest, 6 = today
          const hour = d.getHours();
          grid[dayIdx][hour]++;
        }
      });

      // Find max for color scaling
      const maxVal = Math.max(1, ...grid.flat());

      // Build table
      const table = document.createElement('div');
      table.className = 'inline-flex flex-col gap-1';

      // Hour labels row
      const headerRow = document.createElement('div');
      headerRow.className = 'flex items-center gap-1';
      headerRow.innerHTML = '<div class="w-10"></div>'; // spacer for day labels
      hours.forEach(h => {
        if (h % 3 === 0) {
          const lbl = document.createElement('div');
          lbl.className = 'text-[10px] text-zinc-400 text-center';
          lbl.style.width = '28px';
          lbl.textContent = `${h}h`;
          headerRow.appendChild(lbl);
        } else {
          const spacer = document.createElement('div');
          spacer.style.width = '28px';
          headerRow.appendChild(spacer);
        }
      });
      table.appendChild(headerRow);

      // Day rows
      grid.forEach((dayData, dayIdx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-1';

        const dayLabel = document.createElement('div');
        dayLabel.className = 'w-10 text-xs text-zinc-500 text-right pr-2';
        const targetDate = new Date(now);
        targetDate.setDate(targetDate.getDate() - (6 - dayIdx));
        dayLabel.textContent = targetDate.toLocaleDateString(locale, { weekday: 'short' });
        row.appendChild(dayLabel);

        dayData.forEach((count, hourIdx) => {
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          const intensity = count / maxVal;

          if (count === 0) {
            cell.style.background = 'var(--hm-empty, rgba(99,102,241,0.06))';
          } else if (intensity < 0.25) {
            cell.style.background = 'rgba(99,102,241,0.15)';
          } else if (intensity < 0.5) {
            cell.style.background = 'rgba(99,102,241,0.35)';
          } else if (intensity < 0.75) {
            cell.style.background = 'rgba(99,102,241,0.6)';
          } else {
            cell.style.background = 'rgba(99,102,241,0.9)';
          }

          cell.title = `${days[targetDate.getDay() === 0 ? 6 : targetDate.getDay() - 1]} ${hourIdx}h: ${count} appel${count !== 1 ? 's' : ''}`;
          row.appendChild(cell);
        });

        table.appendChild(row);
      });

      container.innerHTML = '';
      container.appendChild(table);
    }

    // SOTA Engine metrics — compute from session data
    function renderEngineMetrics(sessions, tenantId) {
      // Average latency from sessions that have latency data
      const withLatency = sessions.filter(s => s.avg_latency_ms > 0);
      if (withLatency.length > 0) {
        const avgLat = Math.round(withLatency.reduce((sum, s) => sum + s.avg_latency_ms, 0) / withLatency.length);
        const el = document.getElementById('engine-avg-latency');
        if (el) el.textContent = `${avgLat}ms`;
      } else {
        const el = document.getElementById('engine-avg-latency');
        if (el) el.textContent = '<2s';
      }

      // Token budget — try to fetch from API
      api.request(`/api/tenants/${tenantId}/usage`).then(usage => {
        if (!usage) return;
        const tokenEl = document.getElementById('engine-token-usage');
        const tokenBar = document.getElementById('engine-token-bar');
        if (tokenEl && usage.tokens_used !== undefined) {
          const used = usage.tokens_used || 0;
          const limit = usage.tokens_limit || 500000;
          const pct = Math.min(100, Math.round((used / limit) * 100));
          const formatted = used >= 1000000 ? (used / 1000000).toFixed(1) + 'M' : used >= 1000 ? (used / 1000).toFixed(1) + 'K' : String(used);
          tokenEl.textContent = `${formatted}`;
          if (tokenBar) tokenBar.style.width = `${pct}%`;
        } else {
          if (tokenEl) tokenEl.textContent = '0';
        }
      }).catch(() => {
        const tokenEl = document.getElementById('engine-token-usage');
        if (tokenEl) tokenEl.textContent = '0';
      });
    }

    // ROI Summary calculation
    function renderROISummary(sessions) {
      const totalMinutes = sessions.reduce((s, x) => s + (parseInt(x.duration_sec) || 0), 0) / 60;
      const costPerMin = 0.24; // EUR per minute (telephony rate)
      const planPrices = { starter: 49, pro: 99, ecommerce: 99, expert_clone: 149, telephony: 199 };
      const tenantPlan = user?.plan || 'starter';
      const monthlyCost = (planPrices[tenantPlan] || 49) + (totalMinutes * costPerMin);

      const leads = sessions.filter(s => (parseInt(s.duration_sec) || 0) > 60 || s.lead_score > 50).length;
      const costPerLead = leads > 0 ? monthlyCost / leads : 0;
      const estimatedValue = leads * 150; // avg lead value EUR

      const currency = document.documentElement.lang === 'fr' ? '\u20AC' : '$';

      document.getElementById('roi-cost').textContent = `${Math.round(monthlyCost)}${currency}`;
      document.getElementById('roi-leads').textContent = leads.toString();
      document.getElementById('roi-cpl').textContent = leads > 0 ? `${Math.round(costPerLead)}${currency}` : '--';
      document.getElementById('roi-value').textContent = `${estimatedValue.toLocaleString()}${currency}`;
    }

    // Quota usage — fetch tenant quota from API
    async function renderQuotaUsage(tenantId) {
      try {
        const tenant = await api.tenants.get(tenantId);
        if (!tenant) return;

        const planNames = { starter: 'Starter', pro: 'Pro', ecommerce: 'E-commerce', expert_clone: 'Expert Clone', telephony: 'Telephony' };
        const planBadge = document.getElementById('quota-plan-badge');
        if (planBadge) planBadge.textContent = planNames[tenant.plan] || tenant.plan || 'Starter';

        const quotaItems = [
          { ringId: 'quota-sessions-ring', pctId: 'quota-sessions-pct', detailId: 'quota-sessions-detail', current: tenant.sessions_current || 0, limit: tenant.sessions_limit || 500 },
          { ringId: 'quota-calls-ring', pctId: 'quota-calls-pct', detailId: 'quota-calls-detail', current: tenant.calls_current || 0, limit: tenant.calls_limit || 200 },
          { ringId: 'quota-kb-ring', pctId: 'quota-kb-pct', detailId: 'quota-kb-detail', current: tenant.kb_entries_current || 0, limit: tenant.kb_entries_limit || 100 }
        ];

        const circumference = 251.33;
        quotaItems.forEach(q => {
          const pct = q.limit > 0 ? Math.min(100, Math.round((q.current / q.limit) * 100)) : 0;
          const offset = circumference - (circumference * pct / 100);

          const ring = document.getElementById(q.ringId);
          if (ring) {
            ring.style.strokeDashoffset = offset;
            ring.style.transition = 'stroke-dashoffset 1.2s ease-out';
          }

          const pctEl = document.getElementById(q.pctId);
          if (pctEl) pctEl.textContent = `${pct}%`;

          const detailEl = document.getElementById(q.detailId);
          if (detailEl) detailEl.textContent = `${q.current.toLocaleString()} / ${q.limit.toLocaleString()}`;

          // Color warning if > 80%
          if (pct > 80 && ring) {
            ring.style.stroke = pct > 95 ? '#ef4444' : '#f59e0b';
          }
        });
      } catch (e) {
        console.error('Quota load error:', e);
      }
    }

    // Update "last updated" timestamp
    function updateTimestamp() {
      const el = document.getElementById('last-updated');
      if (el) {
        const now = new Date();
        el.textContent = now.toLocaleTimeString(document.documentElement.lang || 'fr', { hour: '2-digit', minute: '2-digit' });
      }
    }

    // Intelligence Summary — fetch aggregated insights (250.260)
    async function renderInsightsSummary(tenantId) {
      try {
        const data = await api.request(`/api/tenants/${tenantId}/insights`);
        if (!data || data.error) {
          document.getElementById('insights-status').textContent = 'Indisponible';
          return;
        }

        // KB Health
        const kbScore = data.kb?.score ?? 0;
        const kbLevel = data.kb?.level || '--';
        document.getElementById('insights-kb-score').textContent = `${kbScore}/100`;
        document.getElementById('insights-kb-level').textContent = `${data.kb?.entries ?? 0} entr\u00e9es \u2022 ${kbLevel}`;
        document.getElementById('insights-kb-bar').style.width = `${Math.min(100, kbScore)}%`;

        // Drift Alignment
        const driftScore = data.drift?.score ?? 0;
        const alignment = data.drift?.alignment || '--';
        document.getElementById('insights-drift-score').textContent = `${driftScore}%`;
        document.getElementById('insights-drift-label').textContent = alignment;
        document.getElementById('insights-drift-bar').style.width = `${Math.min(100, driftScore)}%`;
        const driftBar = document.getElementById('insights-drift-bar');
        if (driftScore < 50) {
          driftBar.className = driftBar.className.replace('from-emerald-500 to-teal-500', 'from-red-500 to-orange-500');
        } else if (driftScore < 75) {
          driftBar.className = driftBar.className.replace('from-emerald-500 to-teal-500', 'from-amber-500 to-yellow-500');
        }

        // Cross-sell
        const pairsCount = data.cross_sell?.pairs_count ?? 0;
        document.getElementById('insights-crosssell-count').textContent = `${pairsCount} paire${pairsCount !== 1 ? 's' : ''}`;
        const topPairsEl = document.getElementById('insights-crosssell-top');
        const topPairs = (data.cross_sell?.top_pairs || []).slice(0, 3);
        topPairsEl.innerHTML = topPairs.length > 0
          ? topPairs.map(p => `<div class="flex items-center gap-1.5 text-xs text-zinc-600 dark:text-zinc-400"><i data-lucide="arrow-right" class="w-3 h-3 text-purple-500 flex-shrink-0"></i><span class="truncate">${p.pair || p.items?.join(' + ') || '--'}</span></div>`).join('')
          : '<p class="text-xs text-zinc-400">Aucune donn\u00e9e</p>';

        // Smart Alerts
        const alertsEl = document.getElementById('insights-alerts');
        const alerts = data.alerts || [];
        if (alerts.length === 0) {
          alertsEl.innerHTML = '<div class="flex items-center gap-1.5 text-xs text-emerald-600 dark:text-emerald-400"><i data-lucide="check-circle" class="w-3 h-3"></i><span>Tout est en ordre</span></div>';
        } else {
          const icons = { critical: 'alert-triangle', warning: 'alert-circle', info: 'info' };
          const colors = { critical: 'text-red-500', warning: 'text-amber-500', info: 'text-blue-500' };
          alertsEl.innerHTML = alerts.slice(0, 3).map(a =>
            `<div class="flex items-start gap-1.5 text-xs ${colors[a.level] || 'text-zinc-500'}"><i data-lucide="${icons[a.level] || 'info'}" class="w-3 h-3 flex-shrink-0 mt-0.5"></i><span>${a.message}</span></div>`
          ).join('');
        }

        // Status timestamp
        document.getElementById('insights-status').textContent = new Date(data.timestamp).toLocaleTimeString(document.documentElement.lang || 'fr', { hour: '2-digit', minute: '2-digit' });

        // Re-init lucide for newly injected icons
        lucide.createIcons();
      } catch (e) {
        console.error('Insights load error:', e);
        document.getElementById('insights-status').textContent = 'Erreur';
      }
    }

    // Load data + auto-refresh every 60s
    loadDashboard().then(updateTimestamp);
    setInterval(() => { loadDashboard().then(updateTimestamp); }, 60000);
  </script>
</body>
</html>
