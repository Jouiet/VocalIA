<!-- VocalIA NLP Operator â€” Session 250.218 -->
<!-- Natural language analytics chat for dashboard pages -->

<style>
  #nlp-operator-fab {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 50;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 24px rgba(79,70,229,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  [dir="rtl"] #nlp-operator-fab { right: auto; left: 1.5rem; }
  #nlp-operator-fab:hover { transform: scale(1.08); box-shadow: 0 6px 32px rgba(79,70,229,0.5); }
  #nlp-operator-fab svg { width: 24px; height: 24px; }

  #nlp-operator-panel {
    position: fixed;
    bottom: 5.5rem;
    right: 1.5rem;
    z-index: 50;
    width: 380px;
    max-height: 500px;
    border-radius: 1rem;
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 8px 40px rgba(0,0,0,0.12);
    display: none;
    flex-direction: column;
    overflow: hidden;
  }
  [dir="rtl"] #nlp-operator-panel { right: auto; left: 1.5rem; }
  @media (prefers-color-scheme: dark) {
    #nlp-operator-panel {
      background: rgba(20,20,25,0.96);
      border-color: rgba(255,255,255,0.08);
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }
  }
  .dark #nlp-operator-panel {
    background: rgba(20,20,25,0.96);
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 8px 40px rgba(0,0,0,0.4);
  }
  #nlp-operator-panel.nlp-open { display: flex; }

  .nlp-header {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .dark .nlp-header { border-color: rgba(255,255,255,0.08); }
  .nlp-header-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #18181b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .dark .nlp-header-title { color: #fafafa; }
  .nlp-header-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;
    flex-shrink: 0;
  }
  .nlp-close-btn {
    background: none;
    border: none;
    color: #71717a;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    display: flex;
  }
  .nlp-close-btn:hover { background: rgba(0,0,0,0.06); }
  .dark .nlp-close-btn:hover { background: rgba(255,255,255,0.06); }

  .nlp-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    min-height: 200px;
    max-height: 340px;
  }

  .nlp-msg {
    max-width: 85%;
    padding: 0.5rem 0.75rem;
    border-radius: 0.75rem;
    font-size: 0.8125rem;
    line-height: 1.5;
    word-break: break-word;
  }
  .nlp-msg-user {
    align-self: flex-end;
    background: #4f46e5;
    color: white;
    border-bottom-right-radius: 0.25rem;
  }
  [dir="rtl"] .nlp-msg-user { border-bottom-right-radius: 0.75rem; border-bottom-left-radius: 0.25rem; }
  .nlp-msg-ai {
    align-self: flex-start;
    background: rgba(0,0,0,0.04);
    color: #27272a;
  }
  .dark .nlp-msg-ai { background: rgba(255,255,255,0.06); color: #e4e4e7; }

  .nlp-thinking {
    align-self: flex-start;
    display: flex;
    gap: 4px;
    padding: 0.625rem 0.75rem;
  }
  .nlp-thinking span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #a1a1aa;
    animation: nlpPulse 1.4s ease-in-out infinite;
  }
  .nlp-thinking span:nth-child(2) { animation-delay: 0.2s; }
  .nlp-thinking span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes nlpPulse {
    0%, 100% { opacity: 0.3; transform: scale(0.85); }
    50% { opacity: 1; transform: scale(1); }
  }

  .nlp-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding: 0 1rem 0.625rem;
    flex-shrink: 0;
  }
  .nlp-suggestion-btn {
    font-size: 0.75rem;
    padding: 0.375rem 0.625rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(79,70,229,0.2);
    background: rgba(79,70,229,0.05);
    color: #4f46e5;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1.3;
  }
  .dark .nlp-suggestion-btn { border-color: rgba(129,120,255,0.2); background: rgba(99,102,241,0.1); color: #a5b4fc; }
  .nlp-suggestion-btn:hover { background: rgba(79,70,229,0.12); }

  .nlp-input-area {
    padding: 0.625rem 1rem;
    border-top: 1px solid rgba(0,0,0,0.06);
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  .dark .nlp-input-area { border-color: rgba(255,255,255,0.08); }
  .nlp-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    background: transparent;
    color: #18181b;
    outline: none;
    resize: none;
    font-family: inherit;
  }
  .dark .nlp-input { border-color: rgba(255,255,255,0.1); color: #fafafa; }
  .nlp-input::placeholder { color: #a1a1aa; }
  .nlp-input:focus { border-color: #6366f1; }
  .nlp-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 0.5rem;
    background: #4f46e5;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  .nlp-send-btn:hover { background: #4338ca; }
  .nlp-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .nlp-send-btn svg { width: 16px; height: 16px; }

  @media (max-width: 480px) {
    #nlp-operator-panel { width: calc(100vw - 2rem); right: 1rem; }
    [dir="rtl"] #nlp-operator-panel { right: auto; left: 1rem; }
  }
</style>

<!-- FAB Button -->
<button id="nlp-operator-fab" aria-label="Assistant VocalIA" title="Assistant VocalIA">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22z"/></svg>
</button>

<!-- Chat Panel -->
<div id="nlp-operator-panel">
  <div class="nlp-header">
    <div class="nlp-header-title">
      <span class="nlp-header-dot"></span>
      <span data-i18n="nlp.title">Assistant VocalIA</span>
    </div>
    <button class="nlp-close-btn" id="nlp-close-btn" aria-label="Fermer">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
  </div>

  <div class="nlp-messages" id="nlp-messages">
    <div class="nlp-msg nlp-msg-ai" data-i18n="nlp.welcome">Bonjour ! Posez-moi une question sur vos performances, vos statistiques ou votre forfait.</div>
  </div>

  <div class="nlp-suggestions" id="nlp-suggestions">
    <button class="nlp-suggestion-btn" data-i18n="nlp.suggestion_1">Comment vont mes performances ?</button>
    <button class="nlp-suggestion-btn" data-i18n="nlp.suggestion_2">Quel est mon taux de conversion ?</button>
    <button class="nlp-suggestion-btn" data-i18n="nlp.suggestion_3">Combien de minutes ai-je utilisees ?</button>
    <button class="nlp-suggestion-btn" data-i18n="nlp.suggestion_4">Quelles ameliorations recommandez-vous ?</button>
  </div>

  <div class="nlp-input-area">
    <input type="text" class="nlp-input" id="nlp-input" data-i18n-placeholder="nlp.placeholder" placeholder="Posez votre question..." maxlength="500" autocomplete="off">
    <button class="nlp-send-btn" id="nlp-send-btn" aria-label="Envoyer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4z"/><path d="M22 2 11 13"/></svg>
    </button>
  </div>
</div>

<script>
(function() {
  'use strict';

  var fab = document.getElementById('nlp-operator-fab');
  var panel = document.getElementById('nlp-operator-panel');
  var closeBtn = document.getElementById('nlp-close-btn');
  var messagesEl = document.getElementById('nlp-messages');
  var suggestionsEl = document.getElementById('nlp-suggestions');
  var inputEl = document.getElementById('nlp-input');
  var sendBtn = document.getElementById('nlp-send-btn');
  var isLoading = false;

  function getApiBase() {
    var h = window.location.hostname;
    return (h === 'localhost' || h === '127.0.0.1')
      ? 'http://localhost:3013/api'
      : 'https://api.vocalia.ma/api';
  }

  function getLang() {
    if (window.VocaliaI18n && window.VocaliaI18n.currentLang) return window.VocaliaI18n.currentLang;
    return document.documentElement.lang || 'fr';
  }

  function getToken() {
    try {
      var stored = localStorage.getItem('vocalia_auth');
      if (stored) {
        var parsed = JSON.parse(stored);
        return parsed.accessToken || parsed.token || '';
      }
    } catch (_) {}
    return '';
  }

  function togglePanel() {
    panel.classList.toggle('nlp-open');
    if (panel.classList.contains('nlp-open')) inputEl.focus();
  }

  fab.addEventListener('click', togglePanel);
  closeBtn.addEventListener('click', togglePanel);

  function addMessage(text, role) {
    var div = document.createElement('div');
    div.className = 'nlp-msg ' + (role === 'user' ? 'nlp-msg-user' : 'nlp-msg-ai');
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function showThinking() {
    var div = document.createElement('div');
    div.className = 'nlp-thinking';
    div.id = 'nlp-thinking';
    div.innerHTML = '<span></span><span></span><span></span>';
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function hideThinking() {
    var el = document.getElementById('nlp-thinking');
    if (el) el.remove();
  }

  async function sendQuestion(question) {
    if (isLoading || !question.trim()) return;
    isLoading = true;
    sendBtn.disabled = true;

    // Hide suggestions after first interaction
    suggestionsEl.style.display = 'none';

    addMessage(question, 'user');
    inputEl.value = '';
    showThinking();

    try {
      var token = getToken();
      var resp = await fetch(getApiBase() + '/nlp-operator', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token ? 'Bearer ' + token : ''
        },
        body: JSON.stringify({ question: question, language: getLang() })
      });

      hideThinking();

      if (resp.status === 401) {
        addMessage(window.VocaliaI18n ? window.VocaliaI18n.t('nlp.auth_required') : 'Veuillez vous connecter pour utiliser l\'assistant.', 'ai');
      } else if (resp.status === 429) {
        addMessage(window.VocaliaI18n ? window.VocaliaI18n.t('nlp.rate_limited') : 'Trop de questions. Attendez un moment.', 'ai');
      } else {
        var data = await resp.json();
        addMessage(data.response || data.error || 'Erreur inconnue', 'ai');
      }
    } catch (e) {
      hideThinking();
      addMessage(window.VocaliaI18n ? window.VocaliaI18n.t('nlp.error') : 'Erreur de connexion. Veuillez reessayer.', 'ai');
    }

    isLoading = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }

  sendBtn.addEventListener('click', function() { sendQuestion(inputEl.value); });
  inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendQuestion(inputEl.value);
    }
  });

  // Suggestion buttons
  suggestionsEl.addEventListener('click', function(e) {
    var btn = e.target.closest('.nlp-suggestion-btn');
    if (btn) sendQuestion(btn.textContent);
  });
})();
</script>
