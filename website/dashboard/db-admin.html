<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VocalIA - Database Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading { opacity: 0.5; pointer-events: none; }
    .badge { @apply px-2 py-1 rounded text-xs font-medium; }
    .badge-active { @apply bg-green-100 text-green-800; }
    .badge-inactive { @apply bg-red-100 text-red-800; }
    .badge-free { @apply bg-gray-100 text-gray-800; }
    .badge-pro { @apply bg-blue-100 text-blue-800; }
    .badge-enterprise { @apply bg-purple-100 text-purple-800; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="/dashboard/admin.html" class="text-gray-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </a>
        <h1 class="text-xl font-bold">Database Admin</h1>
        <span id="health-status" class="px-2 py-1 rounded text-xs bg-gray-700">Checking...</span>
      </div>
      <div class="flex items-center gap-4">
        <a href="https://docs.google.com/spreadsheets/d/1USAmFgxpXh9yvtAFxvg0_CpmWVop1pOTmxALEE8M4PM/edit"
           target="_blank"
           class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
          Google Sheets
        </a>
        <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">
          Refresh
        </button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="border-b border-gray-700">
    <nav class="flex px-6">
      <button onclick="switchTab('tenants')" data-tab="tenants" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-400">
        Tenants
      </button>
      <button onclick="switchTab('sessions')" data-tab="sessions" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
        Sessions
      </button>
      <button onclick="switchTab('users')" data-tab="users" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
        Users
      </button>
      <button onclick="switchTab('logs')" data-tab="logs" class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
        Logs
      </button>
    </nav>
  </div>

  <!-- Stats -->
  <div class="px-6 py-4 grid grid-cols-4 gap-4">
    <div class="bg-gray-800 rounded-lg p-4">
      <div class="text-gray-400 text-sm">Tenants</div>
      <div id="stat-tenants" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
      <div class="text-gray-400 text-sm">Sessions</div>
      <div id="stat-sessions" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
      <div class="text-gray-400 text-sm">Users</div>
      <div id="stat-users" class="text-2xl font-bold">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
      <div class="text-gray-400 text-sm">Total MRR</div>
      <div id="stat-mrr" class="text-2xl font-bold text-green-400">-</div>
    </div>
  </div>

  <!-- Content -->
  <main class="px-6 py-4">
    <!-- Tenants Tab -->
    <div id="tab-tenants" class="tab-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Tenants</h2>
        <button onclick="showCreateModal('tenants')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm">
          + Add Tenant
        </button>
      </div>
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Email</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Plan</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">MRR</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Actions</th>
            </tr>
          </thead>
          <tbody id="tenants-table" class="divide-y divide-gray-700">
            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div id="tab-sessions" class="tab-content hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Voice Sessions</h2>
      </div>
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Tenant</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Calls</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Duration</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Cost</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Persona</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Timestamp</th>
            </tr>
          </thead>
          <tbody id="sessions-table" class="divide-y divide-gray-700">
            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Users</h2>
        <button onclick="showCreateModal('users')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm">
          + Add User
        </button>
      </div>
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Email</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Role</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Tenant</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Last Login</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Actions</th>
            </tr>
          </thead>
          <tbody id="users-table" class="divide-y divide-gray-700">
            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="tab-logs" class="tab-content hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">System Logs</h2>
        <select id="log-filter" onchange="filterLogs()" class="bg-gray-700 rounded px-3 py-2 text-sm">
          <option value="">All Levels</option>
          <option value="error">Errors</option>
          <option value="warn">Warnings</option>
          <option value="info">Info</option>
        </select>
      </div>
      <div class="bg-gray-800 rounded-lg overflow-hidden max-h-[600px] overflow-y-auto">
        <table class="w-full">
          <thead class="bg-gray-700 sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Timestamp</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Level</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Service</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-400">Message</th>
            </tr>
          </thead>
          <tbody id="logs-table" class="divide-y divide-gray-700">
            <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Create/Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
      <h3 id="modal-title" class="text-lg font-semibold mb-4">Create Record</h3>
      <form id="modal-form" onsubmit="submitForm(event)">
        <div id="modal-fields" class="space-y-4">
          <!-- Dynamic fields -->
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { db } from '/src/lib/db-client.js';
    window.db = db;

    // Data cache
    let data = {
      tenants: [],
      sessions: [],
      users: [],
      logs: []
    };

    let currentTab = 'tenants';
    let editingId = null;
    let editingSheet = null;

    // Initialize
    async function init() {
      await checkHealth();
      await refreshData();
    }

    // Health check
    async function checkHealth() {
      try {
        const health = await db.health();
        const el = document.getElementById('health-status');
        el.textContent = health.status === 'ok' ? 'Connected' : 'Error';
        el.className = health.status === 'ok'
          ? 'px-2 py-1 rounded text-xs bg-green-600'
          : 'px-2 py-1 rounded text-xs bg-red-600';
      } catch (e) {
        document.getElementById('health-status').textContent = 'Offline';
        document.getElementById('health-status').className = 'px-2 py-1 rounded text-xs bg-red-600';
      }
    }

    // Refresh all data
    window.refreshData = async function() {
      try {
        document.body.classList.add('loading');

        data.tenants = await db.tenants.list();
        data.sessions = await db.sessions.list();
        data.users = await db.users.list();
        data.logs = await db.logs.list();

        updateStats();
        renderTable(currentTab);
      } catch (e) {
        console.error('Error loading data:', e);
        alert('Error loading data: ' + e.message);
      } finally {
        document.body.classList.remove('loading');
      }
    };

    // Update stats
    function updateStats() {
      document.getElementById('stat-tenants').textContent = data.tenants.length;
      document.getElementById('stat-sessions').textContent = data.sessions.length;
      document.getElementById('stat-users').textContent = data.users.length;

      const mrr = data.tenants.reduce((sum, t) => sum + (parseFloat(t.mrr) || 0), 0);
      document.getElementById('stat-mrr').textContent = '$' + mrr.toFixed(0);
    }

    // Switch tab
    window.switchTab = function(tab) {
      currentTab = tab;

      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      document.querySelector(`[data-tab="${tab}"]`).classList.add('border-blue-500', 'text-blue-400');
      document.querySelector(`[data-tab="${tab}"]`).classList.remove('border-transparent', 'text-gray-400');

      // Show/hide content
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');

      renderTable(tab);
    };

    // Render table
    function renderTable(sheet) {
      const tbody = document.getElementById(`${sheet}-table`);
      const records = data[sheet];

      if (!records || records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">No records</td></tr>`;
        return;
      }

      switch (sheet) {
        case 'tenants':
          tbody.innerHTML = records.map(r => `
            <tr class="hover:bg-gray-700/50">
              <td class="px-4 py-3 text-sm font-mono text-gray-400">${r.id || '-'}</td>
              <td class="px-4 py-3 text-sm font-medium">${r.name || '-'}</td>
              <td class="px-4 py-3 text-sm text-gray-300">${r.email || '-'}</td>
              <td class="px-4 py-3"><span class="badge badge-${r.plan || 'free'}">${r.plan || 'free'}</span></td>
              <td class="px-4 py-3 text-sm text-green-400">$${r.mrr || 0}</td>
              <td class="px-4 py-3"><span class="badge badge-${r.status || 'active'}">${r.status || 'active'}</span></td>
              <td class="px-4 py-3">
                <button onclick="editRecord('tenants', '${r.id}')" class="text-blue-400 hover:text-blue-300 text-sm mr-2">Edit</button>
                <button onclick="deleteRecord('tenants', '${r.id}')" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
              </td>
            </tr>
          `).join('');
          break;

        case 'sessions':
          tbody.innerHTML = records.map(r => `
            <tr class="hover:bg-gray-700/50">
              <td class="px-4 py-3 text-sm font-mono text-gray-400">${r.id || '-'}</td>
              <td class="px-4 py-3 text-sm">${r.tenant_id || '-'}</td>
              <td class="px-4 py-3 text-sm">${r.calls || 0}</td>
              <td class="px-4 py-3 text-sm">${r.duration_sec || 0}s</td>
              <td class="px-4 py-3 text-sm text-green-400">$${parseFloat(r.cost_usd || 0).toFixed(3)}</td>
              <td class="px-4 py-3 text-sm">${r.persona || '-'}</td>
              <td class="px-4 py-3 text-sm text-gray-400">${r.timestamp ? new Date(r.timestamp).toLocaleString() : '-'}</td>
            </tr>
          `).join('');
          break;

        case 'users':
          tbody.innerHTML = records.map(r => `
            <tr class="hover:bg-gray-700/50">
              <td class="px-4 py-3 text-sm font-mono text-gray-400">${r.id || '-'}</td>
              <td class="px-4 py-3 text-sm">${r.email || '-'}</td>
              <td class="px-4 py-3"><span class="badge ${r.role === 'admin' ? 'badge-enterprise' : 'badge-free'}">${r.role || 'user'}</span></td>
              <td class="px-4 py-3 text-sm">${r.tenant_id || '-'}</td>
              <td class="px-4 py-3 text-sm text-gray-400">${r.last_login ? new Date(r.last_login).toLocaleString() : 'Never'}</td>
              <td class="px-4 py-3">
                <button onclick="editRecord('users', '${r.id}')" class="text-blue-400 hover:text-blue-300 text-sm mr-2">Edit</button>
                <button onclick="deleteRecord('users', '${r.id}')" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
              </td>
            </tr>
          `).join('');
          break;

        case 'logs':
          const filter = document.getElementById('log-filter').value;
          const filtered = filter ? records.filter(r => r.level === filter) : records;
          tbody.innerHTML = filtered.slice(0, 100).map(r => `
            <tr class="hover:bg-gray-700/50">
              <td class="px-4 py-3 text-sm text-gray-400">${r.timestamp ? new Date(r.timestamp).toLocaleString() : '-'}</td>
              <td class="px-4 py-3">
                <span class="badge ${r.level === 'error' ? 'bg-red-600' : r.level === 'warn' ? 'bg-yellow-600' : 'bg-blue-600'}">${r.level}</span>
              </td>
              <td class="px-4 py-3 text-sm">${r.service || '-'}</td>
              <td class="px-4 py-3 text-sm">${r.message || '-'}</td>
            </tr>
          `).join('');
          break;
      }
    }

    window.filterLogs = () => renderTable('logs');

    // Modal functions
    const formFields = {
      tenants: ['name', 'email', 'phone', 'plan', 'mrr', 'status'],
      users: ['email', 'password_hash', 'role', 'tenant_id']
    };

    window.showCreateModal = function(sheet) {
      editingId = null;
      editingSheet = sheet;
      document.getElementById('modal-title').textContent = 'Create ' + sheet.slice(0, -1);

      const fields = formFields[sheet] || [];
      document.getElementById('modal-fields').innerHTML = fields.map(f => `
        <div>
          <label class="block text-sm text-gray-400 mb-1">${f}</label>
          <input name="${f}" type="${f.includes('password') ? 'password' : 'text'}"
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm"
                 ${['name', 'email'].includes(f) ? 'required' : ''}>
        </div>
      `).join('');

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
    };

    window.editRecord = function(sheet, id) {
      const record = data[sheet].find(r => r.id === id);
      if (!record) return;

      editingId = id;
      editingSheet = sheet;
      document.getElementById('modal-title').textContent = 'Edit ' + sheet.slice(0, -1);

      const fields = formFields[sheet] || [];
      document.getElementById('modal-fields').innerHTML = fields.map(f => `
        <div>
          <label class="block text-sm text-gray-400 mb-1">${f}</label>
          <input name="${f}" type="${f.includes('password') ? 'password' : 'text'}"
                 class="w-full bg-gray-700 rounded px-3 py-2 text-sm"
                 value="${record[f] || ''}">
        </div>
      `).join('');

      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
    };

    window.closeModal = function() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
      document.getElementById('modal-form').reset();
    };

    window.submitForm = async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      try {
        if (editingId) {
          await db[editingSheet].update(editingId, data);
        } else {
          await db[editingSheet].create(data);
        }
        closeModal();
        await refreshData();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.deleteRecord = async function(sheet, id) {
      if (!confirm('Delete this record?')) return;

      try {
        await db[sheet].delete(id);
        await refreshData();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // Init
    init();
  </script>
</body>
</html>
