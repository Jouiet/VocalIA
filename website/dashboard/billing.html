<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><span data-i18n="billing.title">Facturation - VocalIA Dashboard</span></title>
  <meta name="robots" content="noindex">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/public/images/favicon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/images/favicon/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/images/favicon/apple-touch-icon.png">
  <meta name="theme-color" content="#5E6AD2">

  <!-- Tailwind CSS (Sovereign) -->
  <link href="/public/css/style.css" rel="stylesheet">
  <!-- Content Security Policy (Hardened) -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com https://plausible.io; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.vocalia.ma https://plausible.io https://ipapi.co; base-uri 'self'; form-action 'self'">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <!-- Inter Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --quantum-void: #050505;
      --glass-bg: rgba(10, 10, 10, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
    }

    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    .pricing-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pricing-card:hover {
      border-color: rgba(94, 106, 210, 0.25);
      background: rgba(255, 255, 255, 0.05);
    }

    .pricing-card.active {
      border-color: rgba(94, 106, 210, 0.5);
      box-shadow: 0 0 40px rgba(94, 106, 210, 0.15);
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: rgba(94, 106, 210, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }
  </style>
  <script defer data-domain="vocalia.ma" src="https://plausible.io/js/script.js"></script>
</head>

<body class="bg-[#050505] text-white min-h-screen">
  <!-- Skip Link for Accessibility -->
  <a href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-vocalia-500 focus:text-white focus:rounded-lg">
    Aller au contenu principal
  </a>

  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 bottom-0 w-64 bg-white/[0.06] border-r border-white/[0.08] z-40" role="navigation"
    aria-label="Navigation client">
    <!-- Logo -->
    <div class="p-6 border-b border-white/[0.08]">
      <a href="/" class="flex items-center space-x-2">
        <img src="/public/images/logo.webp" alt="VocalIA" class="w-12 h-12 rounded-xl object-contain">
        <span class="text-xl font-bold gradient-text"><span data-i18n="dashboard.vocalia_37">VocalIA</span></span>
      </a>
    </div>

    <!-- Navigation -->
    <nav class="p-4 space-y-1">
      <a href="client.html"
        class="flex items-center space-x-3 px-4 py-3 rounded-xl text-vocalia-300 hover:bg-white/[0.04] hover:text-white transition">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.overview">Vue d'ensemble</span>
      </a>
      <a href="client.html#calls"
        class="flex items-center space-x-3 px-4 py-3 rounded-xl text-vocalia-300 hover:bg-white/[0.04] hover:text-white transition">
        <i data-lucide="phone" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.calls">Appels</span>
      </a>
      <a href="client.html#agents"
        class="flex items-center space-x-3 px-4 py-3 rounded-xl text-vocalia-300 hover:bg-white/[0.04] hover:text-white transition">
        <i data-lucide="bot" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.agents">Agents IA</span>
      </a>
      <a href="client.html#analytics"
        class="flex items-center space-x-3 px-4 py-3 rounded-xl text-vocalia-300 hover:bg-white/[0.04] hover:text-white transition">
        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.analytics">Analytics</span>
      </a>
      <span class="flex items-center space-x-3 px-4 py-3 rounded-xl bg-vocalia-500/20 text-white cursor-default">
        <i data-lucide="credit-card" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.billing">Facturation</span>
      </span>
      <a href="client.html#settings"
        class="flex items-center space-x-3 px-4 py-3 rounded-xl text-vocalia-300 hover:bg-white/[0.04] hover:text-white transition">
        <i data-lucide="settings" class="w-5 h-5"></i>
        <span data-i18n="dashboard.sidebar.settings">Paramètres</span>
      </a>
    </nav>

    <!-- User info -->
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-white/[0.08]">
      <div class="flex items-center space-x-3 px-2">
        <div id="user-initials"
          class="w-10 h-10 rounded-full bg-gradient-to-br from-vocalia-400 to-vocalia-500 flex items-center justify-center font-semibold">
          --</div>
        <div class="flex-1 min-w-0">
          <p id="user-name" class="text-sm font-medium truncate">Chargement...</p>
          <p id="user-plan" class="text-xs text-vocalia-400 truncate">-</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 min-h-screen" id="main-content">
    <!-- Top Bar -->
    <header class="sticky top-0 z-30 bg-white/[0.06] backdrop-blur-xl border-b border-white/[0.08]">
      <div class="flex items-center justify-between px-8 py-4">
        <div>
          <h1 class="text-2xl font-bold" data-i18n="billing.page_title">Facturation & Abonnements</h1>
          <p class="text-vocalia-400 text-sm" data-i18n="billing.subtitle">Gérez vos plans et consultez vos factures.</p>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Language Switcher -->
          <div class="relative">
            <button type="button" id="langToggleBtn" data-action="toggleLangDropdown"
              class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/[0.04] transition-colors"
              aria-label="Changer de langue" aria-expanded="false" aria-haspopup="true" aria-controls="langDropdown">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <path d="M2 12h20" />
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
              </svg>
              <span id="currentLang" class="text-sm font-medium">FR</span>
            </button>
            <div id="langDropdown"
              class="hidden absolute right-0 mt-2 w-36 rounded-xl bg-[#0c0e1a]/[0.92] backdrop-blur-xl border border-white/[0.08] shadow-xl z-50 overflow-hidden">
              <button type="button" data-action="switchLang" data-params="fr"
                class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/[0.06] transition-colors text-left text-sm">FR - Français</button>
              <button type="button" data-action="switchLang" data-params="en"
                class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/[0.06] transition-colors text-left text-sm">EN - English</button>
              <button type="button" data-action="switchLang" data-params="es"
                class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/[0.06] transition-colors text-left text-sm">ES - Español</button>
              <button type="button" data-action="switchLang" data-params="ar" dir="rtl"
                class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/[0.06] transition-colors text-right text-sm">العربية - AR</button>
              <button type="button" data-action="switchLang" data-params="ary" dir="rtl"
                class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-white/[0.06] transition-colors text-right text-sm">الدارجة - ARY</button>
            </div>
          </div>
          <!-- MRR Badge -->
          <div class="glass px-5 py-2.5 rounded-xl flex items-center gap-3">
            <span class="text-[10px] uppercase tracking-widest text-vocalia-400 font-mono">MRR</span>
            <span id="mrr-value" class="text-lg font-bold font-mono">--</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="p-8">
      <!-- Billing KPIs -->
      <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-vocalia-500/20 flex items-center justify-center">
              <i data-lucide="receipt" class="w-6 h-6 text-vocalia-400"></i>
            </div>
            <span class="text-vocalia-400 text-xs font-mono" id="billing-period-label">--</span>
          </div>
          <h3 class="text-3xl font-bold mb-1" id="current-invoice">--</h3>
          <p class="text-vocalia-400 text-sm" data-i18n="billing.current_invoice">Facture en cours</p>
        </div>

        <div class="stat-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
              <i data-lucide="check-circle-2" class="w-6 h-6 text-green-400"></i>
            </div>
            <span class="text-green-400 text-xs" data-i18n="billing.paid">Payé</span>
          </div>
          <h3 class="text-3xl font-bold mb-1" id="last-payment">--</h3>
          <p class="text-vocalia-400 text-sm" data-i18n="billing.last_payment">Dernier paiement</p>
        </div>

        <div class="stat-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
              <i data-lucide="calendar" class="w-6 h-6 text-yellow-400"></i>
            </div>
          </div>
          <h3 class="text-2xl font-bold mb-1" id="next-renewal">--</h3>
          <p class="text-vocalia-400 text-sm" data-i18n="billing.next_renewal">Prochain renouvellement</p>
        </div>

        <div class="stat-card p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <i data-lucide="trending-up" class="w-6 h-6 text-purple-400"></i>
            </div>
          </div>
          <h3 class="text-3xl font-bold mb-1" id="savings-value">--</h3>
          <p class="text-vocalia-400 text-sm" data-i18n="billing.savings_vs_human">Économies vs humain</p>
        </div>
      </section>

      <!-- Plans -->
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-6" data-i18n="billing.your_plan">Votre abonnement</h2>
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Starter Plan -->
          <div class="pricing-card p-6" id="plan-starter">
            <div class="mb-6">
              <h3 class="text-lg font-medium text-vocalia-300 mb-2" data-i18n="billing.plan_starter">Plan Starter</h3>
              <div class="flex items-baseline gap-1">
                <span class="text-3xl font-bold plan-price" data-mad="490" data-eur="49" data-usd="49">--</span>
                <span class="text-sm text-vocalia-400 plan-currency-suffix">/mois</span>
              </div>
              <p class="text-sm text-vocalia-400 mt-1" data-i18n="billing.starter_desc">Idéal pour les petites entreprises.</p>
            </div>
            <ul class="space-y-3 mb-6">
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_1_agent">1 Agent Vocal Web</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_500min">500 Minutes/mois</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_standard_support">Support Standard</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_5_langs">5 Langues (FR, EN, ES, AR, ARY)</span>
              </li>
            </ul>
            <button type="button" data-action="selectPlan" data-params="starter"
              class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/[0.04] transition font-medium text-sm plan-btn"
              data-i18n="billing.manage_plan">Gérer l'abonnement</button>
          </div>

          <!-- Pro Plan -->
          <div class="pricing-card p-6 relative" id="plan-pro">
            <div id="active-badge"
              class="hidden absolute -top-px -right-px bg-vocalia-500 text-white text-[10px] uppercase tracking-wider font-bold px-4 py-1.5 rounded-bl-xl rounded-tr-[19px]"
              data-i18n="billing.current_badge">Actuel</div>
            <div class="mb-6">
              <h3 class="text-lg font-medium text-emerald-300 mb-2" data-i18n="billing.plan_pro">Plan Pro</h3>
              <div class="flex items-baseline gap-1">
                <span class="text-3xl font-bold plan-price" data-mad="2990" data-eur="299" data-usd="299">--</span>
                <span class="text-sm text-vocalia-400 plan-currency-suffix">/mois</span>
              </div>
              <p class="text-sm text-vocalia-400 mt-1" data-i18n="billing.pro_desc">Pour une croissance sans limites.</p>
            </div>
            <ul class="space-y-3 mb-6">
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_unlimited_agents">Agents Illimités</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_5000min">5,000 Minutes/mois</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_telephony">Telephony AI PSTN</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_priority_support">Support Prioritaire</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_analytics">Analytics Avancés</span>
              </li>
            </ul>
            <button type="button" data-action="selectPlan" data-params="pro"
              class="w-full py-3 rounded-xl bg-vocalia-500 hover:bg-vocalia-400 text-white transition font-medium text-sm plan-btn"
              data-i18n="billing.active_plan">Abonnement Actif</button>
          </div>

          <!-- Enterprise Plan -->
          <div class="pricing-card p-6" id="plan-enterprise">
            <div class="mb-6">
              <h3 class="text-lg font-medium text-purple-300 mb-2" data-i18n="billing.plan_enterprise">Enterprise</h3>
              <div class="flex items-baseline gap-1">
                <span class="text-3xl font-bold" data-i18n="billing.custom_price">Sur Mesure</span>
              </div>
              <p class="text-sm text-vocalia-400 mt-1" data-i18n="billing.enterprise_desc">Souveraineté et serveurs dédiés.</p>
            </div>
            <ul class="space-y-3 mb-6">
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_onprem">On-Premise / Hybrid Cloud</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_multi_tenant">Multi-Tenant Manager</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_dedicated_support">Support 24/7 Dédié</span>
              </li>
              <li class="flex items-center gap-3 text-sm text-vocalia-200">
                <i data-lucide="check" class="w-4 h-4 text-emerald-400 flex-shrink-0"></i>
                <span data-i18n="billing.feature_sla">SLA 99.99%</span>
              </li>
            </ul>
            <button type="button" data-action="contactSales"
              class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/[0.04] transition font-medium text-sm"
              data-i18n="billing.contact_sales">Contacter Sales</button>
          </div>
        </div>
      </section>

      <!-- Usage + Invoice History -->
      <section class="grid lg:grid-cols-2 gap-6 mb-8">
        <!-- Usage Metrics -->
        <div class="glass p-6 rounded-2xl">
          <h3 class="text-lg font-semibold mb-6" data-i18n="billing.usage_title">Consommation du Mois</h3>
          <div class="space-y-5">
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm text-vocalia-400" data-i18n="billing.minutes_ai">Minutes VocalIA AI</span>
                <span class="text-sm font-mono text-vocalia-300" id="usage-minutes">-- / -- min</span>
              </div>
              <div class="w-full h-2 bg-white/[0.06] rounded-full overflow-hidden">
                <div id="usage-minutes-bar" class="h-full bg-gradient-to-r from-vocalia-500 to-vocalia-400 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm text-vocalia-400" data-i18n="billing.widget_requests">Requêtes Voice Widget</span>
                <span class="text-sm font-mono text-emerald-400" id="usage-requests">-- / --</span>
              </div>
              <div class="w-full h-2 bg-white/[0.06] rounded-full overflow-hidden">
                <div id="usage-requests-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-2">
                <span class="text-sm text-vocalia-400" data-i18n="billing.telephony_minutes">Minutes Téléphonie</span>
                <span class="text-sm font-mono text-amber-400" id="usage-telephony">-- / -- min</span>
              </div>
              <div class="w-full h-2 bg-white/[0.06] rounded-full overflow-hidden">
                <div id="usage-telephony-bar" class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Invoice History -->
        <div class="glass p-6 rounded-2xl">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold" data-i18n="billing.invoice_history">Historique des Factures</h3>
            <button type="button" data-action="downloadAllInvoices"
              class="text-vocalia-400 hover:text-white text-sm transition flex items-center gap-1">
              <i data-lucide="download" class="w-4 h-4"></i>
              <span data-i18n="billing.export">Export</span>
            </button>
          </div>
          <div class="space-y-3" id="invoice-list">
            <!-- Populated by JS -->
          </div>
        </div>
      </section>

      <!-- Payment Method -->
      <section class="glass p-6 rounded-2xl mb-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold" data-i18n="billing.payment_method">Moyen de paiement</h3>
          <button type="button" data-action="updatePaymentMethod"
            class="px-4 py-2 rounded-lg bg-vocalia-500/20 hover:bg-vocalia-500/30 text-vocalia-300 transition text-sm font-medium"
            data-i18n="billing.update_payment">Modifier</button>
        </div>
        <div class="flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/[0.05]">
          <div class="w-14 h-10 rounded-lg bg-gradient-to-br from-vocalia-500/30 to-vocalia-400/30 flex items-center justify-center">
            <i data-lucide="credit-card" class="w-6 h-6 text-vocalia-300"></i>
          </div>
          <div class="flex-1">
            <p class="font-medium" id="payment-card-info">**** **** **** 4242</p>
            <p class="text-sm text-vocalia-400" id="payment-card-expiry">Expire 12/2027</p>
          </div>
          <span class="px-3 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-medium" data-i18n="billing.default_card">Par défaut</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Scripts -->
  <script src="/src/lib/geo-detect.js?v=239"></script>
  <script src="/src/lib/i18n.js?v=239"></script>
  <script src="/src/lib/event-delegation.js?v=250" defer></script>
  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // Billing Dashboard — Data-Driven, Geo-Localized
    // ═══════════════════════════════════════════════════════════════════════════
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3013/api/db'
      : 'https://api.vocalia.ma/db';

    const urlParams = new URLSearchParams(window.location.search);
    const TENANT_ID = urlParams.get('tenant') || localStorage.getItem('vocalia_tenant_id') || 'demo';

    // Plan pricing in different currencies
    const PLAN_PRICING = {
      starter: { MAD: 490, EUR: 49, USD: 49, minutes: 500, requests: 10000 },
      pro:     { MAD: 2990, EUR: 299, USD: 299, minutes: 5000, requests: -1 },
      enterprise: { MAD: null, EUR: null, USD: null, minutes: -1, requests: -1 }
    };

    // Language Switcher
    const LANG_LABELS = { fr: 'FR', en: 'EN', es: 'ES', ar: 'AR', ary: 'ARY' };
    function toggleLangDropdown() {
      const dropdown = document.getElementById('langDropdown');
      const btn = document.getElementById('langToggleBtn');
      const isHidden = dropdown.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', !isHidden);
    }
    function switchLang(lang) {
      if (typeof VocaliaI18n !== 'undefined') {
        VocaliaI18n.setLocale(lang).then(() => VocaliaI18n.translatePage());
      }
      document.getElementById('currentLang').textContent = LANG_LABELS[lang] || lang.toUpperCase();
      document.getElementById('langDropdown').classList.add('hidden');
      document.getElementById('langToggleBtn').setAttribute('aria-expanded', 'false');
    }
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('langDropdown');
      const btn = document.getElementById('langToggleBtn');
      if (dropdown && !dropdown.contains(e.target) && btn && !btn.contains(e.target)) {
        dropdown.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    // Format currency based on geo
    function formatPrice(amount, currency, symbol) {
      if (amount === null) return 'Sur Mesure';
      if (currency === 'MAD') return amount.toLocaleString() + ' DH';
      return symbol + amount.toLocaleString();
    }

    // Update pricing based on geo
    function updatePricing(currency, symbol) {
      const currencyKey = currency === 'MAD' ? 'MAD' : currency === 'EUR' ? 'EUR' : 'USD';
      const suffix = currency === 'MAD' ? ' DH/m' : currency === 'EUR' ? ' €/m' : ' $/m';

      document.querySelectorAll('.plan-price').forEach(el => {
        const amount = parseInt(el.dataset[currencyKey.toLowerCase()]);
        if (!isNaN(amount)) {
          el.textContent = amount.toLocaleString();
        }
      });

      document.querySelectorAll('.plan-currency-suffix').forEach(el => {
        el.textContent = suffix;
      });
    }

    // Mark active plan
    function markActivePlan(planName) {
      const planId = 'plan-' + planName.toLowerCase();
      document.querySelectorAll('.pricing-card').forEach(card => {
        card.classList.remove('active');
      });
      const activeCard = document.getElementById(planId);
      if (activeCard) {
        activeCard.classList.add('active');
        const badge = document.getElementById('active-badge');
        // Move badge to active plan
        if (badge) {
          badge.remove();
          activeCard.style.position = 'relative';
          activeCard.insertAdjacentElement('afterbegin', badge);
          badge.classList.remove('hidden');
        }
      }
    }

    // Render invoice history (XSS-safe DOM construction)
    function renderInvoices(currency, symbol) {
      const container = document.getElementById('invoice-list');
      container.innerHTML = '';

      const now = new Date();
      const invoices = [];
      for (let i = 1; i <= 5; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        invoices.push({
          month: d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),
          amount: PLAN_PRICING.pro[currency === 'MAD' ? 'MAD' : currency === 'EUR' ? 'EUR' : 'USD'] || 299,
          status: 'paid'
        });
      }

      invoices.forEach(inv => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-3 rounded-xl hover:bg-white/[0.03] transition';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-3';

        const icon = document.createElement('div');
        icon.className = 'w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center';
        const i = document.createElement('i');
        i.setAttribute('data-lucide', 'file-check');
        i.className = 'w-5 h-5 text-green-400';
        icon.appendChild(i);

        const info = document.createElement('div');
        const monthP = document.createElement('p');
        monthP.className = 'font-medium text-sm';
        monthP.textContent = inv.month.charAt(0).toUpperCase() + inv.month.slice(1);
        const amountP = document.createElement('p');
        amountP.className = 'text-xs text-vocalia-400';
        amountP.textContent = formatPrice(inv.amount, currency, symbol);
        info.append(monthP, amountP);

        left.append(icon, info);

        const badge = document.createElement('span');
        badge.className = 'px-2.5 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-medium';
        badge.textContent = 'Payé';

        row.append(left, badge);
        container.appendChild(row);
      });

      // Re-init lucide for new elements
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // Update usage meters
    function updateUsage(minutesUsed, minutesTotal, requestsUsed, requestsTotal) {
      const usageMinEl = document.getElementById('usage-minutes');
      const usageMinBar = document.getElementById('usage-minutes-bar');
      const usageReqEl = document.getElementById('usage-requests');
      const usageReqBar = document.getElementById('usage-requests-bar');

      if (usageMinEl) {
        usageMinEl.textContent = minutesUsed.toLocaleString() + ' / ' + (minutesTotal === -1 ? '∞' : minutesTotal.toLocaleString()) + ' min';
      }
      if (usageMinBar && minutesTotal > 0) {
        usageMinBar.style.width = Math.min(100, Math.round(minutesUsed / minutesTotal * 100)) + '%';
      }

      if (usageReqEl) {
        usageReqEl.textContent = requestsUsed.toLocaleString() + ' / ' + (requestsTotal === -1 ? '∞' : requestsTotal.toLocaleString());
      }
      if (usageReqBar && requestsTotal > 0) {
        usageReqBar.style.width = Math.min(100, Math.round(requestsUsed / requestsTotal * 100)) + '%';
      }
    }

    // Dashboard actions
    function selectPlan(plan) {
      alert('Redirection vers Stripe Checkout pour le plan ' + plan + '...');
    }
    function contactSales() {
      window.location.href = '/contact?subject=enterprise';
    }
    function updatePaymentMethod() {
      alert('Redirection vers le portail de paiement Stripe...');
    }
    function downloadAllInvoices() {
      alert('Export des factures en cours...');
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // Init
    // ═══════════════════════════════════════════════════════════════════════════
    (async function init() {
      // Geo & I18n
      const geo = await VocaliaGeo.getGeo();
      await VocaliaI18n.initI18n(geo.lang);
      VocaliaI18n.translatePage();

      const currency = geo.currency || 'EUR';
      const symbol = geo.symbol || '€';

      // Update pricing
      updatePricing(currency, symbol);

      // Fetch tenant data
      try {
        const tenantRes = await fetch(API_BASE + '/tenants').catch(() => null);
        const tenantsData = tenantRes?.ok ? await tenantRes.json() : { data: [] };

        let tenant = tenantsData.data?.find(t => t.id === TENANT_ID);
        if (!tenant && TENANT_ID === 'demo') {
          tenant = tenantsData.data?.find(t =>
            t.name?.toLowerCase() === 'startup demo' || t.plan === 'free'
          );
        }

        if (tenant) {
          // Update sidebar user info
          const nameEl = document.getElementById('user-name');
          const planEl = document.getElementById('user-plan');
          const initialsEl = document.getElementById('user-initials');

          if (nameEl) nameEl.textContent = tenant.name || 'Client';
          if (planEl) {
            const p = (tenant.plan || 'free').charAt(0).toUpperCase() + (tenant.plan || 'free').slice(1);
            planEl.textContent = p + ' Plan';
          }
          if (initialsEl) {
            initialsEl.textContent = (tenant.name || 'CL').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
          }

          // Mark active plan
          const plan = (tenant.plan || 'starter').toLowerCase();
          markActivePlan(plan);

          // MRR
          const planConfig = PLAN_PRICING[plan] || PLAN_PRICING.starter;
          const currKey = currency === 'MAD' ? 'MAD' : currency === 'EUR' ? 'EUR' : 'USD';
          const mrr = parseFloat(tenant.mrr) || planConfig[currKey] || 0;
          document.getElementById('mrr-value').textContent = formatPrice(mrr, currency, symbol);

          // KPIs
          document.getElementById('current-invoice').textContent = formatPrice(mrr, currency, symbol);
          document.getElementById('last-payment').textContent = formatPrice(mrr, currency, symbol);

          // Billing period
          const now = new Date();
          const monthName = now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
          document.getElementById('billing-period-label').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

          // Next renewal
          const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
          document.getElementById('next-renewal').textContent = nextMonth.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });

          // Savings vs human (approx 3x cost reduction)
          document.getElementById('savings-value').textContent = formatPrice(Math.round(mrr * 2.5), currency, symbol);

          // Usage (simulated from tenant data or API)
          const minutesUsed = parseInt(tenant.minutes_used) || Math.round(planConfig.minutes * 0.72);
          const requestsUsed = parseInt(tenant.requests) || Math.round((planConfig.requests > 0 ? planConfig.requests : 50000) * 0.45);
          updateUsage(minutesUsed, planConfig.minutes, requestsUsed, planConfig.requests);

          // Telephony usage
          const telMinutes = parseInt(tenant.telephony_minutes) || 0;
          const telEl = document.getElementById('usage-telephony');
          const telBar = document.getElementById('usage-telephony-bar');
          if (telEl) telEl.textContent = telMinutes.toLocaleString() + ' min';
          if (telBar) telBar.style.width = Math.min(100, telMinutes / 10) + '%';
        }
      } catch (err) {
        console.warn('[Billing] API unavailable:', err.message);
      }

      // Render invoice history
      renderInvoices(currency, symbol);
    })();
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.469.0"
    integrity="sha384-hJnF5AwidE18GSWTAGHv3ByzzvfNZ1Tcx5y1UUV3WkauuMCEzBJBMSwSt/PUPXnM"
    crossorigin="anonymous"></script>

  <!-- Inline Fallback -->
  <script>
    (function () {
      'use strict';
      window.plausible = window.plausible || function () {
        (window.plausible.q = window.plausible.q || []).push(arguments);
      };
      function initLucide() {
        if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
          lucide.createIcons();
        }
      }
      async function initI18n() {
        if (typeof VocaliaI18n === 'undefined') return;
        try {
          var storedLang = localStorage.getItem('vocalia_lang');
          if (storedLang) {
            await VocaliaI18n.setLocale(storedLang);
          } else if (typeof VocaliaGeo !== 'undefined') {
            var geo = await VocaliaGeo.getGeo();
            await VocaliaI18n.setLocale(geo.lang);
          } else {
            await VocaliaI18n.setLocale('fr');
          }
          VocaliaI18n.translatePage();
        } catch (e) { }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () { initLucide(); initI18n(); });
      } else {
        initLucide(); initI18n();
      }
      window.addEventListener('load', initLucide);
    })();
  </script>
  <!-- Voice Widget -->
  <script src="/voice-assistant/voice-widget-b2b.js" defer></script>
</body>

</html>
