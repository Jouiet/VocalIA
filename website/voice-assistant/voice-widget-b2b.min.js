/* VocalIA Widget v2.5.0 - 2026-02-08 */
!function(){"use strict";const e={SUPPORTED_LANGS:["fr","en","es","ar","ary"],DEFAULT_LANG:"fr",VOICE_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/respond":"https://api.vocalia.ma/respond",CONFIG_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/config":"https://api.vocalia.ma/config",SOCIAL_PROOF_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/social-proof":"https://api.vocalia.ma/social-proof",ECOMMERCE_MODE:!1,CATALOG_MODE:!0,EXIT_INTENT_ENABLED:!0,SOCIAL_PROOF_ENABLED:!0,AI_MODE:!0,CATALOG_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013/api/tenants":"https://api.vocalia.ma/api/tenants",MAX_CATALOG_ITEMS:4,SOCIAL_PROOF_DELAY:1e4,SOCIAL_PROOF_INTERVAL:25e3,SOCIAL_PROOF_DURATION:5e3,SOCIAL_PROOF_MAX_SHOWN:4,primaryColor:"#5E6AD2",primaryDark:"#4f46e5",accentColor:"#818cf8",darkBg:"#0f172a",API_TIMEOUT:15e3,EXIT_INTENT_DELAY:5e3,EXIT_INTENT_COOLDOWN:864e5,LANG_PATH:"/voice-assistant/lang/voice-{lang}.json",LOGO_PATH:"/public/images/logo.webp",AUTO_DETECT_LANGUAGES:{fr:"fr","fr-FR":"fr","fr-CA":"fr","fr-BE":"fr",en:"en","en-US":"en","en-GB":"en",es:"es","es-ES":"es",ar:"ar","ar-MA":"ary","ar-SA":"ar",ary:"ary"}},t={isOpen:!1,isListening:!1,currentLang:e.DEFAULT_LANG,langData:null,conversationHistory:[],tenantId:null,sessionId:`b2b_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,recognition:null,synthesis:window.speechSynthesis,conversationContext:{industry:null,need:null,stage:"discovery",lastTopic:null,attribution:{utm_source:null,utm_medium:null,utm_campaign:null,referrer:document.referrer||null},bookingFlow:{active:!1,step:null,data:{name:null,email:null,datetime:null,service:null}}},exitIntent:{shown:!1,dismissed:!1,pageLoadTime:Date.now(),lastScrollY:0,triggered:!1},socialProof:{messages:[],notificationsShown:0,intervalId:null,lastShownTime:0},bookingConfig:{url:null,phone:null,enabled:!1},availableSlotsCache:{slots:[],timestamp:0}},a="SpeechRecognition"in window||"webkitSpeechRecognition"in window,n="speechSynthesis"in window;async function i(a){const n=e.LANG_PATH.replace("{lang}",a);try{const e=await fetch(n);if(!e.ok)throw new Error(`Failed to load language: ${a}`);t.currentLang=a,t.langData=await e.json()}catch{if("fr"!==a)return i("fr");t.langData={meta:{rtl:!1,speechSynthesis:"fr-FR",speechRecognition:"fr-FR"},ui:{headerTitle:"VocalIA Assistant",headerSubtitleVoice:"Expert IA B2B",placeholder:"Posez votre question...",ariaOpenAssistant:"Ouvrir l'assistant vocal VocalIA",notifTitle:"Besoin d'aide ?",errorMessage:"DÃ©solÃ©, une erreur s'est produite."}}}}function o(e,t={}){"function"==typeof gtag&&gtag("event",e,{...t,agent_type:"b2b_specialized"})}navigator.userAgent.toLowerCase().includes("firefox"),/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let s=null;function r(e){return s?s.getElementById(e):document.getElementById(e)}function c(){t.isOpen=!t.isOpen;const e=r("va-panel");e&&e.classList.toggle("open",t.isOpen),t.isOpen?(o("widget_opened"),setTimeout(()=>{const e=r("va-input");e&&e.focus()},100),0===t.conversationHistory.length&&l(t.langData.ui.welcomeMessage||"Bonjour ! Comment puis-je vous aider aujourd'hui ?","assistant")):o("widget_closed")}function l(e,a="assistant"){const i=r("va-messages");if(!i)return;const o=document.createElement("div");o.className=`va-message ${a}`,o.innerHTML=`<div class="va-message-content">${d(e)}</div>`,i.appendChild(o),i.scrollTop=i.scrollHeight,t.conversationHistory.push({role:a,content:e}),"assistant"===a&&n&&function(e){if(!n)return;t.synthesis.cancel();const a=new SpeechSynthesisUtterance(e);a.lang=t.langData?.meta?.speechSynthesis||"fr-FR",a.onstart=()=>{const e=r("va-visualizer");e&&e.classList.add("active")},a.onend=()=>{const e=r("va-visualizer");e&&e.classList.remove("active")},t.synthesis.speak(a)}(e)}function d(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function g(){if("native"===t.sttMode&&t.recognition)if(t.isListening)t.recognition.stop();else{t.recognition.start(),t.isListening=!0;const e=r("va-mic"),a=r("va-visualizer");e&&e.classList.add("listening"),a&&a.classList.add("active"),o("voice_input_started",{mode:"native"})}else if("fallback"===t.sttMode)if(t.isListening){t.recordingTimeout&&clearTimeout(t.recordingTimeout),"recording"===t.mediaRecorder?.state&&t.mediaRecorder.stop(),t.isListening=!1;const e=r("va-mic"),a=r("va-visualizer");e&&e.classList.remove("listening"),a&&a.classList.remove("active")}else{!async function(){try{const a=await navigator.mediaDevices.getUserMedia({audio:!0});t.mediaRecorder=new MediaRecorder(a,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/ogg"}),t.audioChunks=[],t.mediaRecorder.ondataavailable=e=>{e.data.size>0&&t.audioChunks.push(e.data)},t.mediaRecorder.onstop=async()=>{a.getTracks().forEach(e=>e.stop());const n=new Blob(t.audioChunks,{type:t.mediaRecorder.mimeType});if(n.size<1e3)return;const i=e.VOICE_API_URL.replace("/respond","/stt");try{const e=await(await fetch(i,{method:"POST",headers:{"X-Language":t.currentLang},body:n,signal:AbortSignal.timeout(15e3)})).json();if(e.success&&e.text){const t=r("va-input");t&&(t.value=e.text),p(e.text,"voice")}}catch{}},t.mediaRecorder.start(),t.isListening=!0,t.recordingTimeout=setTimeout(()=>{if("recording"===t.mediaRecorder?.state){t.mediaRecorder.stop(),t.isListening=!1;const e=r("va-mic"),a=r("va-visualizer");e&&e.classList.remove("listening"),a&&a.classList.remove("active")}},1e4)}catch{t.isListening=!1;const e=r("va-mic");e&&e.classList.remove("listening")}}();const a=r("va-mic"),n=r("va-visualizer");a&&a.classList.add("listening"),n&&n.classList.add("active"),o("voice_input_started",{mode:"fallback"})}}async function p(a,n="text"){if(!a?.trim())return;l(a,"user");const i=r("va-input");i&&(i.value=""),o("message_sent",{input_method:n,length:a.length});const s=t.conversationContext.bookingFlow;if(s.active){const n=u(),i=await async function(e){const a=t.langData;if(!a?.booking)return null;const n=e.toLowerCase(),i=t.conversationContext.bookingFlow;if(a.booking.cancelKeywords&&a.booking.cancelKeywords.some(e=>n.includes(e)))return o("booking_cancelled",{step:i.step}),i.active=!1,i.step=null,i.data={name:null,email:null,datetime:null,service:a.booking.service},a.booking.messages.cancelled;if("name"===i.step){const t=e.trim();return t.length<2?a.booking.messages.askName:(i.data.name=t,i.step="email",a.booking.messages.askEmail.replace("{name}",t))}if("email"===i.step){const n=e.trim().toLowerCase();if(!function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(n))return a.booking.messages.invalidEmail;i.data.email=n,i.step="datetime";const o=await async function(){const e=Date.now();if(t.availableSlotsCache.slots.length>0&&e-t.availableSlotsCache.timestamp<3e5)return t.availableSlotsCache.slots;if(t.bookingConfig.url)try{const a=await(await fetch(t.bookingConfig.url+(t.bookingConfig.url.includes("?")?"&":"?")+"action=availability",{method:"GET",mode:"cors",signal:AbortSignal.timeout(5e3)})).json();if(a.success&&a.data?.slots){const n=t.langData?.meta?.speechSynthesis||"fr-FR",i=a.data.slots.slice(0,6).map(e=>{const t=new Date(e.start);return{date:t.toLocaleDateString(n,{weekday:"long",month:"long",day:"numeric"}),time:t.toLocaleTimeString(n,{hour:"numeric",minute:"2-digit"}),iso:e.start}});return t.availableSlotsCache={slots:i,timestamp:e},i}}catch{}const a=b();return t.availableSlotsCache={slots:a,timestamp:e},a}();if(0===o.length)return a.booking.messages.noSlots;let s=a.booking.messages.slotsIntro;return o.slice(0,3).forEach((e,t)=>{s+=a.booking.messages.slotFormat.replace("{index}",t+1).replace("{date}",e.date).replace("{time}",e.time)+"\n"}),s+=a.booking.messages.slotsOutro,s}if("datetime"===i.step){const e=t.availableSlotsCache.slots.length>0?t.availableSlotsCache.slots.slice(0,3):b();let s=null;if(a.booking.slotKeywords)for(const[t,i]of Object.entries(a.booking.slotKeywords))if(i.some(e=>n.includes(e))){s=e[parseInt(t)-1];break}return s?(i.data.datetime=s.iso,i.step="confirm",o("booking_slot_selected",{slot_date:s.date,slot_time:s.time}),a.booking.messages.confirmIntro+a.booking.messages.confirmName.replace("{name}",i.data.name)+"\n"+a.booking.messages.confirmEmail.replace("{email}",i.data.email)+"\n"+a.booking.messages.confirmDate.replace("{date}",s.date).replace("{time}",s.time)+a.booking.messages.confirmOutro):a.booking.messages.slotNotUnderstood}return"confirm"===i.step?a.booking.confirmKeywords&&a.booking.confirmKeywords.some(e=>n.includes(e))?(i.step="submitting",null):a.booking.messages.confirmPrompt:null}(a);if(m(n),"submitting"===s.step){const a=u(),n=await async function(){const a=t.langData,n=t.conversationContext.bookingFlow,i=function(){try{return{iana:Intl.DateTimeFormat().resolvedOptions().timeZone,offset:(new Date).getTimezoneOffset()}}catch{return{iana:null,offset:(new Date).getTimezoneOffset()}}}(),s=await async function(a){try{const n=new AbortController,i=setTimeout(()=>n.abort(),e.API_TIMEOUT),o=await fetch(e.VOICE_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},signal:n.signal,body:JSON.stringify({message:`[BOOKING] ${JSON.stringify(a)}`,language:t.currentLang,sessionId:t.sessionId,tenant_id:t.tenantId,widget_type:"B2B",booking_data:a,history:t.conversationHistory.slice(-6)})});clearTimeout(i);const s=await o.json();return{success:!!s.response,message:s.response||"Booking submitted"}}catch(e){return{success:!1,message:e.message}}}({name:n.data.name,email:n.data.email,datetime:n.data.datetime,service:n.data.service||a.booking?.service||"Consultation",notes:`Booking via B2B voice widget (${t.currentLang.toUpperCase()})`,timezone:i.iana||`UTC${i.offset>0?"-":"+"}${Math.abs(i.offset/60)}`});return n.active=!1,n.step=null,s.success?(o("booking_completed",{service:n.data.service,datetime:n.data.datetime}),a.booking?.messages?.success?.replace("{email}",n.data.email)||`Booking confirmed! Confirmation sent to ${n.data.email}.`):(o("booking_failed",{error:s.message}),a.booking?.messages?.failure?.replace("{message}",s.message)||"Sorry, the booking failed. Please try again.")}();m(a),n&&l(n,"assistant")}else i&&l(i,"assistant");return}t.bookingConfig.enabled&&function(e){const a=t.langData;if(a?.booking?.keywords)return a.booking.keywords.some(t=>e.toLowerCase().includes(t));const n={fr:["rendez-vous","rdv","rÃ©server","booking","prendre rdv","disponibilitÃ©","crÃ©neau","rÃ©servation"],en:["appointment","book","booking","schedule","reserve","availability","slot"],es:["cita","reservar","reserva","programar","disponibilidad","horario"],ar:["Ù…ÙˆØ¹Ø¯","Ø­Ø¬Ø²","Ø§Ø­Ø¬Ø²","Ù…ØªØ§Ø­","ÙˆÙ‚Øª"],ary:["Ù…ÙˆØ¹Ø¯","Ø­Ø¬Ø²","Ù†Ø­Ø¬Ø²","ÙˆÙ‚Øª","ÙƒØ±ÙŠÙ†ÙŠ","Ø±Ø¯ÙÙˆ"]};return(n[t.currentLang]||n.fr).some(t=>e.toLowerCase().includes(t))}(a)&&function(){if(!t.bookingConfig.enabled)return;const e=r("va-messages");if(!e)return;const a=document.createElement("div");a.className="va-message assistant";const n=document.createElement("div");n.className="va-message-content",n.style.cssText="padding:12px 16px;";const i={fr:{inline:"RÃ©server maintenant",online:"RÃ©server en ligne",call:"Appeler pour rÃ©server"},en:{inline:"Book now",online:"Book online",call:"Call to book"},es:{inline:"Reservar ahora",online:"Reservar en lÃ­nea",call:"Llamar para reservar"},ar:{inline:"Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†",online:"Ø§Ø­Ø¬Ø² Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª",call:"Ø§ØªØµÙ„ Ù„Ù„Ø­Ø¬Ø²"},ary:{inline:"Ø§Ø­Ø¬Ø² Ø¯Ø§Ø¨Ø§",online:"Ø§Ø­Ø¬Ø² Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",call:"Ø¹ÙŠØ· Ø¨Ø§Ø´ ØªØ­Ø¬Ø²"}},s=i[t.currentLang]||i.fr,c="display:inline-block;padding:8px 16px;border-radius:8px;text-decoration:none;font-size:13px;font-weight:600;margin:4px 4px 4px 0;transition:opacity 0.2s;cursor:pointer;",d=document.createElement("button");if(d.type="button",d.style.cssText=c+"background:#5E6AD2;color:white;border:none;",d.textContent=s.inline,d.addEventListener("click",()=>{!function(){const e=t.langData,a=t.conversationContext.bookingFlow;a.active=!0,a.step="name",a.data={name:null,email:null,datetime:null,service:e?.booking?.service||"Consultation"},l(e?.booking?.messages?.start||"Let's book an appointment. What is your name?","assistant"),o("booking_flow_started")}()}),n.appendChild(d),t.bookingConfig.url){const e=document.createElement("a");e.href=t.bookingConfig.url,e.target="_blank",e.rel="noopener noreferrer",e.style.cssText=c+"background:rgba(94,106,210,0.15);color:#818cf8;border:1px solid rgba(94,106,210,0.3);",e.textContent=s.online,n.appendChild(e)}if(t.bookingConfig.phone){const e=document.createElement("a");e.href=`tel:${t.bookingConfig.phone}`,e.style.cssText=c+"background:rgba(94,106,210,0.08);color:#a5b4fc;border:1px solid rgba(94,106,210,0.2);",e.textContent=s.call,n.appendChild(e)}a.appendChild(n),e.appendChild(a),e.scrollTop=e.scrollHeight,o("booking_cta_shown")}();const c=u();try{const n=new AbortController,i=setTimeout(()=>n.abort(),e.API_TIMEOUT),s=await fetch(e.VOICE_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},signal:n.signal,body:JSON.stringify({message:a,language:t.currentLang,sessionId:t.sessionId,tenant_id:t.tenantId,widget_type:"B2B",history:t.conversationHistory.slice(-6)})});clearTimeout(i),m(c);const g=await s.json();g.response?(l(g.response,"assistant"),g.a2ui&&function(a){if(!a||!a.html)return;const n=r("va-messages");if(!n)return;const i=document.createElement("div");if(i.className="va-message assistant va-a2ui-wrapper",a.css){const e=document.createElement("style");e.textContent=a.css,i.appendChild(e)}const s=document.createElement("div");s.className="va-message-content",s.innerHTML=a.html,i.appendChild(s),n.appendChild(i),n.scrollTop=n.scrollHeight,i.querySelectorAll("[data-a2ui-action]").forEach(n=>{n.addEventListener("click",()=>{!async function(a,n){if(o("a2ui_action",{action:a,type:n.type}),"select_slot"===a){const e=n.element.closest("[data-a2ui-component]");if(e){e.querySelectorAll(".va-a2ui-slot").forEach(e=>e.classList.remove("selected")),n.element.classList.add("selected");const t=e.querySelector('[data-a2ui-action="confirm_booking"]');t&&(t.disabled=!1)}return}if("close"===a)return void n.wrapper.remove();const i={},s=n.element.closest("[data-a2ui-component]");if("confirm_booking"===a&&s){const e=s.querySelector(".va-a2ui-slot.selected");i.slot=e?.dataset.slot}else if("submit_lead"===a&&s){const e=s.querySelector("form");e&&new FormData(e).forEach((e,t)=>{i[t]=e})}try{const n=await(await fetch(e.VOICE_API_URL.replace("/respond","/a2ui/action"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:a,data:i,sessionId:t.sessionId,tenant_id:t.tenantId,widget_type:"B2B"})})).json();n.message&&l(n.message,"assistant")}catch{}}(n.dataset.a2uiAction,{type:a.type,value:n.dataset.slot||n.dataset.productId||null,element:n,wrapper:i})})}),o("a2ui_rendered",{type:a.type})}(g.a2ui),g.catalog&&g.catalog.items&&g.catalog.items.length>0&&function(t,a){if(!e.CATALOG_MODE||!t||0===t.length)return;const n=r("va-messages");if(!n)return;const i=document.createElement("div");i.className="va-message assistant";const s=a?d(a):"";let c='<div class="va-message-content" style="max-width:100%;padding:10px 12px;">';s&&(c+=`<div class="va-catalog-header"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/><path d="M7 12h2v5H7zm4-3h2v8h-2zm4-3h2v11h-2z"/></svg>${s}</div>`),c+='<div class="va-service-cards">';const l=Math.min(t.length,e.MAX_CATALOG_ITEMS);for(let e=0;e<l;e++){const a=t[e],n=d(a.name||a.title||""),i=d(a.description||a.subtitle||""),o=d(a.price||a.pricing||""),s=a.image||a.images?.[0]||a.thumbnail||"";c+=`<div class="va-service-card" data-item-id="${d(a.id||"")}" data-index="${e}">`,c+=s?`<img class="va-service-card-img" src="${d(s)}" alt="${n}" loading="lazy" onerror="this.outerHTML='<div class=\\'va-service-card-img-placeholder\\'>ðŸ“‹</div>'"/>`:`<div class="va-service-card-img-placeholder">${a.icon||"ðŸ“‹"}</div>`,c+='<div class="va-service-card-body">',c+=`<div class="va-service-card-title">${n}</div>`,i&&(c+=`<div class="va-service-card-desc">${i}</div>`),o&&(c+=`<div class="va-service-card-price">${o}</div>`),c+=`<button class="va-service-card-cta">${d(a.cta||"En savoir plus")}</button>`,c+="</div></div>"}c+="</div></div>",i.innerHTML=c,n.appendChild(i),n.scrollTop=n.scrollHeight,i.querySelectorAll(".va-service-card").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.itemId,n=parseInt(e.dataset.index),i=t[n];i&&(o("service_card_click",{item_id:a,item_name:i.name||i.title}),p(i.name||i.title,"text"))})}),o("service_cards_displayed",{count:l,title:a||"catalog"})}(g.catalog.items,g.catalog.title)):l(t.langData?.ui?.errorMessage||"DÃ©solÃ©, une erreur s'est produite.","assistant")}catch(e){m(c),l("AbortError"===e.name?"La requÃªte a pris trop de temps. Veuillez rÃ©essayer.":"DÃ©solÃ©, je rencontre un problÃ¨me de connexion.","assistant")}}function u(){const e=r("va-messages");if(!e)return null;const t=`typing-${Date.now()}`,a=document.createElement("div");return a.id=t,a.className="va-message assistant",a.innerHTML='<div class="va-message-content" style="display:flex;gap:4px;padding:14px 18px;">\n            <span style="width:8px;height:8px;background:var(--va-accent);border-radius:50%;animation:vaTyping 1s infinite;"></span>\n            <span style="width:8px;height:8px;background:var(--va-accent);border-radius:50%;animation:vaTyping 1s infinite 0.2s;"></span>\n            <span style="width:8px;height:8px;background:var(--va-accent);border-radius:50%;animation:vaTyping 1s infinite 0.4s;"></span>\n        </div>\n        <style>@keyframes vaTyping { 0%, 60%, 100% { transform: translateY(0); opacity: 0.5; } 30% { transform: translateY(-4px); opacity: 1; } }</style>',e.appendChild(a),e.scrollTop=e.scrollHeight,t}function m(e){if(!e)return;const t=r(e);t&&t.remove()}function v(){t.exitIntent.triggered=!0,localStorage.setItem("vocalia_exit_intent",Date.now().toString()),t.isOpen||(c(),setTimeout(()=>{l(t.langData.ui.exitIntentMessage||"Attendez ! Avez-vous des questions avant de partir ?","assistant")},500)),o("exit_intent_triggered")}function h(){if(t.isOpen||0===t.socialProof.messages.length)return;const a="ar"===t.currentLang||"ary"===t.currentLang,n=t.socialProof.messages[t.socialProof.notificationsShown%t.socialProof.messages.length],i=document.createElement("div");i.className="va-b2b-social-proof";const c=`va-b2b-sp-${Date.now()}`;i.id=c;const l=document.createElement("style");l.textContent=`\n            .va-b2b-social-proof {\n                position: fixed; bottom: 100px; ${a?"left":"right"}: 25px;\n                max-width: 280px; background: linear-gradient(145deg, #1e2642, #191e35);\n                border: 1px solid rgba(94, 106, 210, 0.25); border-radius: 12px;\n                padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n                z-index: 99997; font-family: Inter, -apple-system, sans-serif;\n                animation: vaB2bSlideIn 0.4s ease, vaB2bFadeOut 0.3s ease ${e.SOCIAL_PROOF_DURATION-300}ms forwards;\n                ${a?"direction: rtl;":""}\n            }\n            @keyframes vaB2bSlideIn {\n                from { opacity: 0; transform: translateX(${a?"-":""}30px); }\n                to { opacity: 1; transform: translateX(0); }\n            }\n            @keyframes vaB2bFadeOut { from { opacity: 1; } to { opacity: 0; } }\n        `,i.appendChild(l);const d=document.createElement("div");d.style.cssText="display:flex;align-items:center;gap:10px;";const g=document.createElement("div");g.style.cssText="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#5E6AD2,#818cf8);display:flex;align-items:center;justify-content:center;flex-shrink:0;";const p=document.createElementNS("http://www.w3.org/2000/svg","svg");p.setAttribute("viewBox","0 0 24 24"),p.setAttribute("width","18"),p.setAttribute("height","18"),p.setAttribute("fill","white");const u=n.icon&&/^<(?:path|circle|rect|line|polyline|polygon|ellipse|g)\s/.test(n.icon.trim())?n.icon:'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>';p.innerHTML=u,g.appendChild(p);const m=document.createElement("div"),v=document.createElement("div");v.style.cssText="font-size:13px;color:rgba(255,255,255,0.9);line-height:1.4;",v.textContent=n.text;const h=document.createElement("div");h.style.cssText="font-size:11px;color:rgba(94,106,210,0.7);margin-top:4px;",h.textContent=n.time||"",m.appendChild(v),m.appendChild(h),d.appendChild(g),d.appendChild(m);const b=document.createElement("button");b.style.cssText="position:absolute;top:6px;"+(a?"left":"right")+":6px;background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.4);padding:2px;",b.setAttribute("aria-label","Close"),b.innerHTML='<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',b.addEventListener("click",()=>i.remove()),i.appendChild(b),i.appendChild(d),(s||document.body).appendChild(i),setTimeout(()=>{const e=r(c);e&&e.remove()},e.SOCIAL_PROOF_DURATION),t.socialProof.notificationsShown++,t.socialProof.lastShownTime=Date.now(),o("social_proof_shown",{index:t.socialProof.notificationsShown})}function b(){const e=new Date,a="ar"===t.currentLang||"ary"===t.currentLang,n=t.langData?.meta?.speechSynthesis||"fr-FR",i=[];for(let t=1;t<=7;t++){const o=new Date(e);o.setDate(e.getDate()+t);const s=o.getDay();if((a?[0,1,2,3,4]:[1,2,3,4,5]).includes(s)&&(o.setHours(10,0,0,0),i.push({date:o.toLocaleDateString(n,{weekday:"long",month:"long",day:"numeric"}),time:"10:00",iso:o.toISOString()}),i.length>=3))break}return i}async function f(){try{window.VOCALIA_CONFIG_INJECTED&&Object.assign(e,window.VOCALIA_CONFIG_INJECTED),window.VOCALIA_CONFIG&&Object.assign(e,window.VOCALIA_CONFIG);const n=function(){const t=new URLSearchParams(window.location.search).get("lang");if(t&&e.SUPPORTED_LANGS.includes(t))return t;const a=document.documentElement.lang?.toLowerCase()?.split("-")[0];if(a&&e.SUPPORTED_LANGS.includes(a))return a;const n=navigator.language||navigator.userLanguage,i=e.AUTO_DETECT_LANGUAGES[n]||e.AUTO_DETECT_LANGUAGES[n?.split("-")[0]];return i&&e.SUPPORTED_LANGS.includes(i)?i:e.DEFAULT_LANG}();await i(n);const l=document.querySelector("script[data-vocalia-tenant]");if(l?t.tenantId=l.dataset.vocaliaTenant:e.tenantId&&(t.tenantId=e.tenantId),function(){const e=new URLSearchParams(window.location.search),a=t.conversationContext.attribution;a.utm_source=e.get("utm_source")||a.utm_source,a.utm_medium=e.get("utm_medium")||a.utm_medium,a.utm_campaign=e.get("utm_campaign")||a.utm_campaign}(),function(){if(document.getElementById("vocalia-widget"))return;const n=t.langData,i=n.meta.rtl,l=i?"left":"right",d=document.createElement("div");d.id="vocalia-widget",d.style.cssText=`position:fixed;bottom:30px;${l}:25px;z-index:99999;${i?"direction:rtl;":""}`,document.body.appendChild(d),s=d.attachShadow({mode:"open"}),s.innerHTML=function(t,n,i){return`\n      <style>\n        #vocalia-widget {\n          --va-primary: ${e.primaryColor};\n          --va-primary-dark: ${e.primaryDark};\n          --va-accent: ${e.accentColor};\n          --va-dark: ${e.darkBg};\n        }\n        .va-trigger {\n          width: 60px; height: 60px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 100%);\n          border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4);\n          transition: all 0.3s ease; position: relative;\n          animation: vaTriggerPulse 2.5s ease-in-out infinite;\n        }\n        .va-trigger:hover { transform: scale(1.1); box-shadow: 0 6px 30px rgba(94, 106, 210, 0.6); animation: none; }\n        @keyframes vaTriggerPulse {\n          0%, 100% { box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4); transform: scale(1); }\n          50% { box-shadow: 0 4px 30px rgba(94, 106, 210, 0.7); transform: scale(1.02); }\n        }\n        .va-trigger img { width: 36px; height: 36px; object-fit: contain; border-radius: 50%; }\n\n        .va-panel {\n          display: none; position: absolute; bottom: 70px; ${i}: 0;\n          width: 380px; max-height: 520px; background: var(--va-dark);\n          border: 1px solid rgba(94, 106, 210, 0.3); border-radius: 16px;\n          overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n          flex-direction: column;\n        }\n        .va-panel.open { display: flex; animation: vaSlideUp 0.3s ease; }\n        @keyframes vaSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }\n\n        .va-header {\n          padding: 16px 20px; background: linear-gradient(135deg, var(--va-primary), var(--va-primary-dark));\n          display: flex; align-items: center; gap: 12px;\n        }\n        .va-header-logo { width: 40px; height: 40px; border-radius: 50%; background: white; padding: 4px; }\n        .va-header-logo img { width: 100%; height: 100%; object-fit: contain; }\n        .va-header-text h3 { margin: 0; font-size: 16px; color: white; font-weight: 600; }\n        .va-header-text p { margin: 2px 0 0; font-size: 12px; color: rgba(255,255,255,0.8); }\n        .va-close { margin-${n?"right":"left"}: auto; background: rgba(255,255,255,0.1); border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; transition: background 0.2s; }\n        .va-close:hover { background: rgba(255,255,255,0.2); }\n\n        .va-messages { flex: 1; overflow-y: auto; padding: 16px; min-height: 220px; max-height: 350px; }\n        .va-message { margin-bottom: 12px; display: flex; gap: 8px; }\n        .va-message-content { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; }\n        .va-message.assistant .va-message-content { background: rgba(94, 106, 210, 0.15); color: #e5e5e5; border-bottom-left-radius: 4px; }\n        .va-message.user { justify-content: flex-end; }\n        .va-message.user .va-message-content { background: var(--va-primary); color: white; border-bottom-right-radius: 4px; }\n\n        .va-input-area { padding: 12px 16px; border-top: 1px solid rgba(94, 106, 210, 0.2); display: flex; gap: 8px; background: rgba(0,0,0,0.2); }\n        .va-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(94, 106, 210, 0.3); border-radius: 24px; padding: 12px 18px; color: white; outline: none; font-size: 14px; }\n        .va-input:focus { border-color: var(--va-primary); box-shadow: 0 0 0 2px rgba(94, 106, 210, 0.2); }\n        .va-input::placeholder { color: rgba(255,255,255,0.5); }\n\n        .va-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--va-primary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n        .va-btn:hover { background: var(--va-primary-dark); transform: scale(1.05); }\n        .va-btn.listening { background: #DC2626; animation: vaPulse 1.5s infinite; }\n        .va-btn-send { background: transparent; border: 1px solid rgba(94, 106, 210, 0.5); }\n        .va-btn-send:hover { background: rgba(94, 106, 210, 0.2); border-color: var(--va-primary); }\n\n        @keyframes vaPulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }\n\n        .va-visualizer { height: 40px; display: none; padding: 0 16px; align-items: center; justify-content: center; background: rgba(94, 106, 210, 0.1); }\n        .va-visualizer.active { display: flex; }\n        .va-visualizer-bar { width: 4px; background: var(--va-accent); margin: 0 3px; border-radius: 2px; animation: vaSound 0.5s infinite alternate; }\n        .va-visualizer-bar:nth-child(1) { animation-delay: 0s; }\n        .va-visualizer-bar:nth-child(2) { animation-delay: 0.1s; }\n        .va-visualizer-bar:nth-child(3) { animation-delay: 0.2s; }\n        .va-visualizer-bar:nth-child(4) { animation-delay: 0.3s; }\n        .va-visualizer-bar:nth-child(5) { animation-delay: 0.15s; }\n        .va-visualizer-bar:nth-child(6) { animation-delay: 0.25s; }\n        .va-visualizer-bar:nth-child(7) { animation-delay: 0.05s; }\n        .va-visualizer-bar:nth-child(8) { animation-delay: 0.35s; }\n        @keyframes vaSound { 0% { height: 4px; opacity: 0.5; } 100% { height: 24px; opacity: 1; } }\n\n        .va-notif-bubble { position: absolute; bottom: 70px; ${i}: 0; white-space: nowrap; z-index: 9999; animation: vaFadeIn 0.5s ease; }\n        .va-notif-bubble-content { padding: 12px 16px; background: white; color: #0F172A; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); font-size: 14px; font-weight: 500; border-left: 4px solid var(--va-primary); }\n        @keyframes vaFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n\n        /* Service/Product Cards for Catalog Mode */\n        .va-service-cards { display: flex; overflow-x: auto; gap: 10px; padding: 8px 0; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }\n        .va-service-cards::-webkit-scrollbar { height: 3px; }\n        .va-service-cards::-webkit-scrollbar-thumb { background: var(--va-primary); border-radius: 3px; }\n        .va-service-card { min-width: 200px; max-width: 220px; background: rgba(94, 106, 210, 0.08); border: 1px solid rgba(94, 106, 210, 0.2); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; scroll-snap-align: start; flex-shrink: 0; }\n        .va-service-card:hover { border-color: var(--va-primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(94, 106, 210, 0.2); }\n        .va-service-card-img { width: 100%; height: 110px; object-fit: cover; background: rgba(94, 106, 210, 0.05); }\n        .va-service-card-img-placeholder { width: 100%; height: 110px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: rgba(94, 106, 210, 0.05); }\n        .va-service-card-body { padding: 10px 12px; }\n        .va-service-card-title { font-size: 13px; font-weight: 600; color: #e5e5e5; margin: 0 0 4px; line-height: 1.3; }\n        .va-service-card-desc { font-size: 11px; color: rgba(255,255,255,0.6); margin: 0 0 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }\n        .va-service-card-price { font-size: 13px; font-weight: 700; color: var(--va-accent); }\n        .va-service-card-cta { display: block; width: 100%; margin-top: 8px; padding: 6px; background: var(--va-primary); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; text-align: center; transition: background 0.2s; }\n        .va-service-card-cta:hover { background: var(--va-primary-dark); }\n        .va-catalog-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; color: #e5e5e5; font-size: 13px; font-weight: 600; }\n        .va-catalog-header svg { width: 14px; height: 14px; fill: var(--va-primary); }\n\n        @media (max-width: 480px) {\n          .va-panel { width: calc(100vw - 40px); ${i}: -5px; }\n        }\n      </style>\n\n      <button class="va-trigger" id="va-trigger" aria-label="${t.ui.ariaOpenAssistant}">\n        <img src="${e.LOGO_PATH}" alt="VocalIA" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22white%22><path d=%22M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z%22/><path d=%22M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z%22/></svg>'"/>\n      </button>\n\n      <div class="va-panel" id="va-panel" role="dialog" aria-label="${t.ui.headerTitle||"VocalIA Assistant"}" aria-modal="true">\n        <div class="va-header">\n          <div class="va-header-logo">\n            <img src="${e.LOGO_PATH}" alt="VocalIA" onerror="this.style.display='none'"/>\n          </div>\n          <div class="va-header-text">\n            <h3>${t.ui.headerTitle||"VocalIA Assistant"}</h3>\n            <p>${t.ui.headerSubtitleVoice||"Expert IA"}</p>\n          </div>\n          <button class="va-close" id="va-close" aria-label="${t.ui.ariaClose||"Fermer"}">âœ•</button>\n        </div>\n\n        <div class="va-visualizer" id="va-visualizer" aria-hidden="true">\n          ${Array.from({length:8},()=>'<div class="va-visualizer-bar"></div>').join("")}\n        </div>\n\n        <div class="va-messages" id="va-messages" aria-live="polite" aria-relevant="additions"></div>\n\n        <div class="va-input-area">\n          <input type="text" class="va-input" id="va-input" placeholder="${t.ui.placeholder||"Posez votre question..."}" autocomplete="off">\n          ${a||typeof MediaRecorder<"u"?'\n          <button class="va-btn" id="va-mic" aria-label="Activer le microphone">\n            <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>\n          </button>':""}\n          <button class="va-btn va-btn-send" id="va-send" aria-label="Envoyer">\n            <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n          </button>\n        </div>\n      </div>\n    `}(n,i,l),function(){const e=r("va-trigger"),a=r("va-close"),n=r("va-send"),i=r("va-input"),s=r("va-mic");e&&e.addEventListener("click",c),a&&a.addEventListener("click",c),n&&n.addEventListener("click",()=>{const e=i?.value?.trim();e&&p(e,"text")}),i&&i.addEventListener("keypress",e=>{if("Enter"===e.key){const t=e.target.value?.trim();t&&p(t,"text")}}),s&&(function(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;e?(t.recognition=new e,t.recognition.lang=t.langData?.meta?.speechRecognition||"fr-FR",t.recognition.continuous=!1,t.recognition.interimResults=!1,t.recognition.onresult=e=>{const t=e.results[0][0].transcript,a=r("va-input");a&&(a.value=t),p(t,"voice")},t.recognition.onend=()=>{t.isListening=!1;const e=r("va-mic"),a=r("va-visualizer");e&&e.classList.remove("listening"),a&&a.classList.remove("active")},t.recognition.onerror=e=>{t.isListening=!1;const a=r("va-mic");a&&a.classList.remove("listening")},t.sttMode="native"):t.sttMode=navigator.mediaDevices&&typeof MediaRecorder<"u"?"fallback":"none"}(),"none"!==t.sttMode?s.addEventListener("click",g):s.style.display="none"),document.addEventListener("keydown",e=>{if(t.isOpen){if("Escape"===e.key){c();const e=r("va-trigger");return void(e&&e.focus())}if("Tab"===e.key){const t=r("va-panel");if(!t)return;const a=t.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');if(0===a.length)return;const n=a[0],i=a[a.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),i.focus()):!e.shiftKey&&document.activeElement===i&&(e.preventDefault(),n.focus())}}}),o("widget_initialized",{language:t.currentLang})}(),setTimeout(()=>{t.isOpen||function(){const e=t.langData,a=r("va-trigger");if(!a)return;const n=document.createElement("div");n.className="va-notif-bubble";const i=document.createElement("div");i.className="va-notif-bubble-content",i.textContent="ðŸ‘‹ "+(e.ui.notifTitle||"Besoin d'aide ?"),n.appendChild(i),a.parentNode.appendChild(n),setTimeout(()=>n.remove(),6e3)}()},3e3)}(),function(){if(!e.EXIT_INTENT_ENABLED)return;const a=localStorage.getItem("vocalia_exit_intent");if(a&&Date.now()-parseInt(a)<e.EXIT_INTENT_COOLDOWN)return;document.addEventListener("mouseout",a=>{a.clientY<=10&&!t.exitIntent.triggered&&!t.isOpen&&Date.now()-t.exitIntent.pageLoadTime>e.EXIT_INTENT_DELAY&&v()});let n=window.scrollY;window.addEventListener("scroll",()=>{const a=window.scrollY,i=(n-a)/window.innerHeight;a<n&&i>.3&&!t.exitIntent.triggered&&!t.isOpen&&Date.now()-t.exitIntent.pageLoadTime>e.EXIT_INTENT_DELAY&&v(),n=a},{passive:!0})}(),t.tenantId)try{const a=await(await fetch(`${e.CONFIG_API_URL}?tenantId=${encodeURIComponent(t.tenantId)}`,{signal:AbortSignal.timeout(5e3)})).json();a.success&&(a.features&&(e.SOCIAL_PROOF_ENABLED=!1!==a.features.social_proof_enabled,e.EXIT_INTENT_ENABLED=!1!==a.features.exit_intent_enabled),a.booking&&(t.bookingConfig.url=a.booking.url||null,t.bookingConfig.phone=a.booking.phone||null,t.bookingConfig.enabled=a.features?.booking_enabled&&!(!a.booking.url&&!a.booking.phone)))}catch{}!async function(){if(e.SOCIAL_PROOF_ENABLED){try{const a=`${e.SOCIAL_PROOF_API_URL}?lang=${t.currentLang}`,n=await(await fetch(a,{signal:AbortSignal.timeout(5e3)})).json();if(!(n.success&&Array.isArray(n.messages)&&n.messages.length>0))return;t.socialProof.messages=n.messages}catch{return}setTimeout(()=>{h(),t.socialProof.intervalId=setInterval(()=>{t.socialProof.notificationsShown<e.SOCIAL_PROOF_MAX_SHOWN?h():clearInterval(t.socialProof.intervalId)},e.SOCIAL_PROOF_INTERVAL)},e.SOCIAL_PROOF_DELAY)}}()}catch{}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f()}();