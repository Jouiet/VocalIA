/* VocalIA Widget v2.7.0 - 2026-02-08 */
!function(){"use strict";const e={SUPPORTED_LANGS:["fr","en","es","ar","ary"],DEFAULT_LANG:"fr",VOICE_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/respond":"https://api.vocalia.ma/respond",AI_MODE:!0,API_TIMEOUT:1e4,CATALOG_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013/api/tenants":"https://api.vocalia.ma/api/tenants",ECOMMERCE_MODE:!0,MAX_CAROUSEL_ITEMS:5,API_BASE_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013":"https://api.vocalia.ma",BOOKING_API:"https://script.google.com/macros/s/AKfycbzXKtu88n0Z-oFiBm5kJYPmGOi29maowtMv2vEQ0o5Xhp4sayNdnm2cNBaAx2OlHkUK/exec",EXIT_INTENT_ENABLED:!0,EXIT_INTENT_DELAY:3e3,EXIT_INTENT_SENSITIVITY:20,EXIT_INTENT_COOLDOWN:864e5,EXIT_INTENT_MOBILE_SCROLL_RATIO:.3,EXIT_INTENT_PAGES:null,SOCIAL_PROOF_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/social-proof":"https://api.vocalia.ma/social-proof",SOCIAL_PROOF_ENABLED:!0,SOCIAL_PROOF_INTERVAL:25e3,SOCIAL_PROOF_DURATION:5e3,SOCIAL_PROOF_MAX_SHOWN:5,SOCIAL_PROOF_DELAY:8e3,primaryColor:"#5E6AD2",primaryDark:"#4f46e5",accentColor:"#10B981",darkBg:"#0f172a",LANG_PATH:"/voice-assistant/lang/voice-{lang}.json",SLOT_CACHE_TTL:3e5,CATALOG_CACHE_TTL:3e5,AUTO_DETECT_ENABLED:!0,AUTO_DETECT_LANGUAGES:{"fr-FR":"fr",fr:"fr","en-US":"en","en-GB":"en",en:"en","es-ES":"es","es-MX":"es",es:"es","ar-SA":"ar","ar-MA":"ar",ar:"ar",ary:"ary"}};function t(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function n(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}let a={isOpen:!1,isListening:!1,recognition:null,synthesis:window.speechSynthesis,conversationHistory:[],currentLang:null,langData:null,sessionId:`widget_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tenantId:null,tenantConfig:null,planFeatures:null,currency:null,availableSlotsCache:{slots:[],timestamp:0},catalogCache:{products:[],timestamp:0},conversationContext:{industry:null,need:null,stage:"discovery",lastTopic:null,attribution:{utm_source:null,utm_medium:null,utm_campaign:null,gclid:null,fbclid:null,referrer:document.referrer||null},bookingFlow:{active:!1,step:null,data:{name:null,email:null,datetime:null,service:null}}},ecommerce:{inputMethodStats:{voice:0,text:0},productsViewed:[],carouselsDisplayed:0,productClicks:0,lastInputMethod:null},exitIntent:{shown:!1,dismissed:!1,pageLoadTime:Date.now(),lastScrollY:0,triggered:!1},socialProof:{notificationsShown:0,intervalId:null,lastShownTime:0}};const i="SpeechRecognition"in window||"webkitSpeechRecognition"in window,o="speechSynthesis"in window,r=navigator.userAgent.toLowerCase().includes("firefox"),s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),c=!i||r||s;let l=null;function d(e){return l?l.getElementById(e):document.getElementById(e)}function p(e){return l?l.querySelectorAll(e):document.querySelectorAll(e)}async function u(t){const n=e.LANG_PATH.replace("{lang}",t);try{const e=await fetch(n);if(!e.ok)throw new Error(`Failed to load language: ${t}`);const i=await e.json();return a.currentLang=t,a.langData=i,i}catch(e){if(console.error("[VocalIA] Language load error:",e),"fr"!==t)return u("fr");throw e}}function g(e,t={}){const n={event_category:"voice_assistant",language:a.currentLang,attribution:a.conversationContext.attribution,...t};"function"==typeof gtag&&gtag("event",e,n),typeof dataLayer<"u"&&Array.isArray(dataLayer)&&dataLayer.push({event:e,...n})}function m(n,i="assistant"){const r=d("va-messages"),s=document.createElement("div");s.className=`va-message ${i}`,s.innerHTML=`<div class="va-message-content">${t(n)}</div>`,r.appendChild(s),r.scrollTop=r.scrollHeight,"assistant"===i&&o&&function(t){const n=a.langData?.meta?.code||a.currentLang||"fr";if("ary"===n)return void async function(t,n){const a=e.VOICE_API_URL.replace("/respond","/tts");try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,language:n})});if(!e.ok)return console.warn("[TTS] ElevenLabs request failed, falling back to Web Speech API"),void S(t);const i=await e.json();if(i.success&&i.audio){const e=new Audio(`data:audio/mp3;base64,${i.audio}`);e.onplay=()=>E("speaking"),e.onended=()=>L(),e.onerror=()=>L(),e.onpause=()=>L(),e.play().catch(e=>{console.warn("[TTS] Audio playback failed:",e.message),L(),S(t)})}else S(t)}catch(e){console.warn("[TTS] ElevenLabs error:",e.message),S(t)}}(t,n);if(!o)return;a.synthesis.cancel();const i=new SpeechSynthesisUtterance(t);i.lang=a.langData.meta.speechSynthesis,i.rate="ar"===n?.9:1,i.onstart=()=>E("speaking"),i.onend=()=>L(),i.onerror=()=>L(),a.synthesis.speak(i)}(n),a.conversationHistory.push({role:"user"===i?"user":"assistant",content:n})}function v(){const e=d("va-typing");e&&e.remove()}function h(e,t){const n={MAD:"DH",EUR:"‚Ç¨",USD:"$",GBP:"¬£"}[t=t||a.currency||"EUR"]||t,i=e.toLocaleString(a.currentLang||"fr",{minimumFractionDigits:0,maximumFractionDigits:2});return"EUR"===t||"USD"===t||"GBP"===t?`${n}${i}`:`${i} ${n}`}function f(e,i="detail"){if(!e)return;const o=d("va-messages"),r=document.createElement("div");r.className="va-message assistant";const s=e.image||e.images?.[0],c=!1!==e.available&&!1!==e.in_stock,l=n(e.id),p=t(e.name||""),u=e.description?t(e.description):"",m=n(e.image||e.images?.[0]||""),v=e.url?n(e.url):"";r.innerHTML=`\n      <div class="va-message-content">\n        <div class="va-single-product" data-product-id="${l}">\n          <div class="va-single-product-row">\n            ${s?`<img class="va-single-product-img" src="${m}" alt="${p}" />`:'<div class="va-single-product-img" style="display:flex;align-items:center;justify-content:center;font-size:32px;">üì¶</div>'}\n            <div class="va-single-product-details">\n              <h4 class="va-single-product-name">${p}</h4>\n              ${u?`<p class="va-single-product-desc">${u}</p>`:""}\n              <div class="va-single-product-price">${h(e.price,e.currency)}</div>\n            </div>\n          </div>\n          <div class="va-product-actions">\n            <button class="va-product-btn primary" onclick="window.VocalIA.viewProduct('${l}')" ${c?"":"disabled"}>\n              ${c?a.langData?.ecommerce?.viewDetails||"Voir d√©tails":a.langData?.ecommerce?.notifyMe||"Me notifier"}\n            </button>\n            ${v?`<button class="va-product-btn secondary" onclick="window.open('${v}', '_blank')">\n              ${a.langData?.ecommerce?.buyNow||"Acheter"}\n            </button>`:""}\n          </div>\n        </div>\n      </div>\n    `,o.appendChild(r),o.scrollTop=o.scrollHeight,a.ecommerce.productsViewed.push(e.id),g("product_viewed",{product_id:e.id,product_name:e.name,price:e.price,context:i,input_method:a.ecommerce.lastInputMethod})}function w(t,n=null,i="recommendations"){if(!t||0===t.length)return;const o=a.langData,r=o?.meta?.rtl,s=d("va-messages"),c=document.createElement("div");c.className="va-message assistant";const l=`carousel-${Date.now()}`,p=t.slice(0,e.MAX_CAROUSEL_ITEMS),u={recommendations:o?.ecommerce?.recommendedForYou||"Recommand√© pour vous",search_results:o?.ecommerce?.searchResults||"R√©sultats",category:o?.ecommerce?.fromCategory||"De cette cat√©gorie",popular:o?.ecommerce?.popular||"Populaires",related:o?.ecommerce?.relatedProducts||"Produits similaires"};c.innerHTML=`\n      <div class="va-message-content" style="padding: 8px 10px;">\n        <div class="va-carousel-header">\n          <span class="va-carousel-title">\n            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n            ${n||u[i]||u.recommendations}\n          </span>\n          <div class="va-carousel-nav">\n            <button onclick="this.getRootNode().getElementById('${l}').scrollBy({left: ${r?"150":"-150"}, behavior: 'smooth'})" aria-label="Previous">\n              <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>\n            </button>\n            <button onclick="this.getRootNode().getElementById('${l}').scrollBy({left: ${r?"-150":"150"}, behavior: 'smooth'})" aria-label="Next">\n              <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>\n            </button>\n          </div>\n        </div>\n        <div class="va-product-carousel" id="${l}">\n          ${p.map((e,t)=>function(e,t=!1){const n=e.image||e.images?.[0],i=!1!==e.available&&!1!==e.in_stock,o=e.stock,r=e.compare_at_price&&e.compare_at_price>e.price,s=e.created_at&&Date.now()-new Date(e.created_at).getTime()<6048e5;let c="",l="";i?void 0!==o&&o<5&&(c="low",l=a.langData?.ecommerce?.lowStock?.replace("{n}",o)||`Plus que ${o}`):(c="out",l=a.langData?.ecommerce?.outOfStock||"Rupture");let d="";return r?d=`<span class="va-product-badge sale">-${Math.round(100*(1-e.price/e.compare_at_price))}%</span>`:s&&(d=`<span class="va-product-badge new">${a.langData?.ecommerce?.new||"Nouveau"}</span>`),`\n      <div class="va-product-card ${t?"featured":""}" data-product-id="${e.id}" style="position: relative;">\n        ${d}\n        ${n?`<img class="va-product-img" src="${e.image||e.images[0]}" alt="${e.name}" loading="lazy" />`:'<div class="va-product-img-placeholder">üì¶</div>'}\n        <div class="va-product-info">\n          <p class="va-product-name">${e.name}</p>\n          <div class="va-product-price">\n            ${h(e.price,e.currency)}\n            ${r?`<span class="va-product-price-old">${h(e.compare_at_price,e.currency)}</span>`:""}\n          </div>\n          ${l?`<p class="va-product-stock ${c}">${l}</p>`:""}\n        </div>\n      </div>\n    `}(e,0===t)).join("")}\n        </div>\n      </div>\n    `,s.appendChild(c),s.scrollTop=s.scrollHeight,c.querySelectorAll(".va-product-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.productId,n=p.find(e=>e.id===t);n&&(a.ecommerce.productClicks++,g("product_card_clicked",{product_id:t,product_name:n.name,price:n.price,position:p.indexOf(n),carousel_context:i,input_method:a.ecommerce.lastInputMethod}),f(n,"carousel_click"))})}),a.ecommerce.carouselsDisplayed++,g("product_carousel_displayed",{products_count:p.length,context:i,product_ids:p.map(e=>e.id),input_method:a.ecommerce.lastInputMethod})}window.VocalIA=window.VocalIA||{},window.VocalIA.viewProduct=async function(t){if(a.tenantId)try{const n=await fetch(`${e.CATALOG_API_URL}/${a.tenantId}/catalog/detail/${encodeURIComponent(t)}`,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(n.ok){const e=await n.json();e.item&&f(e.item,"detail_view")}}catch(e){console.warn("[VocalIA] Product detail error:",e.message)}},window.VocalIA.displayProducts=function(e,t,n){w(e,t,n)},window.VocalIA.getEcommerceStats=function(){return{...a.ecommerce,voiceRatio:a.ecommerce.inputMethodStats.voice/Math.max(1,a.ecommerce.inputMethodStats.voice+a.ecommerce.inputMethodStats.text)}},window.VocalIA.showRecommendations=function(e,t="similar",n=null){e&&0!==e.length&&("function"==typeof gtag&&gtag("event","ai_recommendations_shown",{event_category:"recommendations",recommendation_type:t,items_count:e.length}),w(e,n,{similar:"related",bought_together:"recommendations",personalized:"recommendations"}[t]||"recommendations"))},window.VocalIA.getAIRecommendations=async function(t,n=[],i="similar"){if(!a.tenantId)return null;try{const o={tenant_id:a.tenantId,recommendation_type:i};t&&(o.product_id=t),n.length>0&&(o.product_ids=n);const r=await fetch(`${e.API_BASE_URL}/api/recommendations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.API_KEY||""}`},body:JSON.stringify(o)});if(!r.ok)return null;const s=await r.json();if(s.success&&s.recommendations?.length>0){const t=await Promise.all(s.recommendations.map(async t=>{if(t.productId&&!t.title){const n=await async function(t){if(!a.tenantId)return{};try{const n=await fetch(`${e.API_BASE_URL}/api/tenants/${a.tenantId}/catalog/${encodeURIComponent(t)}`);if(n.ok)return(await n.json()).item||{}}catch{}return{}}(t.productId);return{...t,...n}}return t}));return window.VocalIA.showRecommendations(t,i),t}return null}catch(e){return console.error("[VocalIA] Recommendations error:",e),null}},window.VocalIA.startQuiz=function(t="generic",n={}){if(a.planFeatures&&!1===a.planFeatures.ecom_quiz)return console.warn("[VocalIA] Quiz not available on current plan"),null;if(!window.VocalIAQuiz)return console.warn("[VocalIA] Voice Quiz not loaded. Include voice-quiz.js"),null;const i=new window.VocalIAQuiz({tenantId:a.tenantId,template:t,lang:a.langData?.meta?.code||"fr",apiBaseUrl:e.API_BASE_URL,voiceEnabled:!0,onComplete:e=>{"function"==typeof gtag&&gtag("event","quiz_completed",{event_category:"voice_quiz",template:t,answers_count:Object.keys(e.answers).length,with_lead:e.withLead}),e.tags?.length>0&&window.VocalIA.getAIRecommendations(null,[],"personalized")},onLeadCapture:e=>{"function"==typeof gtag&&gtag("event","quiz_lead_captured",{event_category:"voice_quiz",template:t}),_.syncPreference&&_.recordInteraction({type:"quiz_completed",product_id:null,metadata:{template:t,answers:e.answers}})},...n});return i.show(),i},window.VocalIA.isQuizSupported=function(){return!!window.VocalIAQuiz},window.VocalIA.initCartRecovery=function(e={}){return a.planFeatures&&!1===a.planFeatures.ecom_cart_recovery?(console.warn("[VocalIA] Cart recovery not available on current plan"),null):window.VocaliaAbandonedCart?window.VocaliaAbandonedCart.init({tenantId:a.tenantId||e.tenantId,lang:a.currentLang||e.lang,...e}):(console.warn("[VocalIA] Abandoned cart widget not loaded. Include abandoned-cart-recovery.js"),null)},window.VocalIA.triggerCartRecovery=function(e="manual"){if(!a.planFeatures||!1!==a.planFeatures.ecom_cart_recovery)if(window.VocaliaAbandonedCart?.getInstance())window.VocaliaAbandonedCart.getInstance().trigger(e);else{const t=window.VocalIA.initCartRecovery();t&&setTimeout(()=>t.trigger(e),100)}},window.VocalIA.setCartData=function(e){window.VocalIA.cart=e,window.VocaliaAbandonedCart?.getInstance()&&window.VocaliaAbandonedCart.getInstance().setCartData(e),"function"==typeof gtag&&e.total>0&&gtag("event","cart_updated",{event_category:"ecommerce",cart_value:e.total,items_count:e.items?.length||0,currency:e.currency||a.currency||"EUR"})},window.VocalIA.isCartRecoverySupported=function(){return!!window.VocaliaAbandonedCart},window.VocalIA.initShippingBar=function(e={}){return window.VocaliaShippingBar?window.VocaliaShippingBar.init({tenantId:a.tenantId||e.tenantId,lang:a.currentLang||e.lang,...e}):(console.warn("[VocalIA] Shipping bar widget not loaded. Include free-shipping-bar.js"),null)},window.VocalIA.updateShippingProgress=function(e){if(window.VocaliaShippingBar?.getInstance())window.VocaliaShippingBar.getInstance().updateCartValue(e);else if(window.VocaliaShippingBar){const t=window.VocalIA.initShippingBar();t&&t.updateCartValue(e)}},window.VocalIA.isShippingBarSupported=function(){return!!window.VocaliaShippingBar},window.VocalIA.showSpinWheel=function(e={}){return a.planFeatures&&!1===a.planFeatures.ecom_gamification?(console.warn("[VocalIA] Spin wheel not available on current plan"),null):window.VocaliaSpinWheel?window.VocaliaSpinWheel.show({tenantId:a.tenantId||e.tenantId,lang:a.currentLang||e.lang,...e}):(console.warn("[VocalIA] Spin wheel widget not loaded. Include spin-wheel.js"),null)},window.VocalIA.isSpinWheelAvailable=function(){const e=localStorage.getItem("va_spin_wheel_last_played");return!e||Date.now()-parseInt(e,10)>=864e5},window.VocalIA.isSpinWheelSupported=function(){return!!window.VocaliaSpinWheel};const y={widgets:{voiceChat:{active:!1,priority:1},recommendations:{active:!1,priority:2},quiz:{active:!1,priority:3},exitIntent:{active:!1,priority:4},socialProof:{active:!0,priority:5},abandonedCart:{active:!1,priority:6},spinWheel:{active:!1,priority:7},shippingBar:{active:!0,priority:8}},events:new Map,on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)},emit(e,t){(this.events.get(e)||[]).forEach(e=>{try{e(t)}catch(e){console.error("[Orchestrator] Event error:",e)}})},activate(e){const t=this.widgets[e];return!!t&&(t.active=!0,this.emit("widget:activated",{widget:e}),"function"==typeof gtag&&gtag("event","widget_activated",{event_category:"orchestrator",widget_name:e}),!0)},deactivate(e){const t=this.widgets[e];return!!t&&(t.active=!1,this.emit("widget:deactivated",{widget:e}),!0)},canShow(e){const t=this.widgets[e];if(!t)return!1;for(const[e,n]of Object.entries(this.widgets))if(n.active&&n.priority<t.priority)return!1;return!0},getStats(){return{activeWidgets:Object.entries(this.widgets).filter(([e,t])=>t.active).map(([e,t])=>e),totalWidgets:Object.keys(this.widgets).length,eventListeners:this.events.size}}};window.VocalIA.Orchestrator=y;const b={shippingBar:{file:"voice-widget-ecommerce-shipping.min.js",global:"VocaliaShippingBar"},abandonedCart:{file:"voice-widget-ecommerce-cart.min.js",global:"VocaliaAbandonedCart"},quiz:{file:"voice-widget-ecommerce-quiz.min.js",global:"VocalIAQuiz"},spinWheel:{file:"voice-widget-ecommerce-spin.min.js",global:"VocaliaSpinWheel"},recommendations:{file:"voice-widget-ecommerce-carousel.min.js",global:"VocalIARecommendations"}},x={};function I(e){const t=b[e];return t?window[t.global]?Promise.resolve(!0):(x[e]||(x[e]=new Promise((n,a)=>{const i=document.createElement("script");i.src=function(){const e=document.querySelectorAll('script[src*="voice-widget-ecommerce"]');if(e.length>0){const t=e[e.length-1].src;return t.substring(0,t.lastIndexOf("/")+1)}return"/voice-assistant/"}()+t.file,i.onload=()=>n(!0),i.onerror=()=>{delete x[e],a(new Error("Chunk unavailable: "+t.file))},document.head.appendChild(i)})),x[e]):Promise.reject(new Error("Unknown chunk: "+e))}window.VocalIA.loadChunk=I,y.on("widget:activated",({widget:t})=>{"spinWheel"===t&&window.VocaliaSpinWheel&&window.VocaliaSpinWheel.show({tenantId:a.tenantId,lang:a.currentLang}),"shippingBar"===t&&window.VocaliaShippingBar&&window.VocaliaShippingBar.init({tenantId:a.tenantId,lang:a.currentLang}),"recommendations"===t&&window.VocalIARecommendations&&new window.VocalIARecommendations({tenantId:a.tenantId,lang:a.currentLang,apiBase:e.API_BASE_URL}).render()}),y.on("widget:deactivated",({widget:e})=>{"spinWheel"===e&&window.VocaliaSpinWheel?.getInstance()&&window.VocaliaSpinWheel.getInstance().destroy(),"shippingBar"===e&&window.VocaliaShippingBar?.getInstance()&&window.VocaliaShippingBar.getInstance().destroy()});const _={profile:null,ltvTier:"bronze",async syncPreference(t=null){if(!a.tenantId)return null;try{const n=t||function(){const e=navigator.language||navigator.userLanguage||"",t={"fr-FR":"FR","fr-MA":"MA","fr-BE":"BE","fr-CA":"CA","en-US":"US","en-GB":"GB","en-CA":"CA","es-ES":"ES","es-MX":"MX","ar-MA":"MA","ar-SA":"SA","ar-AE":"AE"};if(t[e])return t[e];const n=Intl.DateTimeFormat().resolvedOptions().timeZone||"";return n.includes("Casablanca")?"MA":n.includes("Paris")?"FR":n.includes("London")?"GB":n.includes("New_York")||n.includes("Los_Angeles")?"US":{fr:"FR",en:"US",es:"ES",ar:"MA",ary:"MA"}[a.currentLang]||"FR"}(),i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/sync"),o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:a.tenantId,userId:a.sessionId,countryCode:n}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(o.ok){const e=await o.json();return _.profile=e.profile,_.ltvTier=e.ltvTier||"bronze",g("ucp_synced",{country:n,ltv_tier:_.ltvTier,locale:_.profile?.locale}),e}}catch(e){console.warn("[VocalIA] UCP sync error:",e.message)}return null},async recordInteraction(t,n={}){if(a.tenantId&&_.profile)try{const i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/interaction");await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:a.tenantId,userId:a.sessionId,type:"widget_chat",channel:"web_widget",metadata:{...n,input_method:a.ecommerce.lastInputMethod,interaction_type:t}}),signal:AbortSignal.timeout(5e3)})}catch{}},async trackEvent(t,n=null){if(a.tenantId)try{const i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/event");await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:a.tenantId,userId:a.sessionId,event:t,value:n,source:"voice"===a.ecommerce.lastInputMethod?"voice":"widget"}),signal:AbortSignal.timeout(5e3)})}catch{}},getRecommendationStrategy(){const e={bronze:{limit:3,showPrices:!0,upsell:!1},silver:{limit:4,showPrices:!0,upsell:!0},gold:{limit:5,showPrices:!0,upsell:!0,prioritySupport:!0},platinum:{limit:6,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0},diamond:{limit:8,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0,personalAssistant:!0}};return e[_.ltvTier]||e.bronze}},A={async fetchProducts(t={}){if(!a.tenantId)return[];try{const n=`${e.CATALOG_API_URL}/${a.tenantId}/catalog/browse`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:t.category,query:t.search,limit:t.limit||_.getRecommendationStrategy().limit,inStock:!1!==t.inStock,ltvTier:_.ltvTier}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(i.ok)return(await i.json()).items||[]}catch(e){console.warn("[VocalIA] MCP fetch error:",e.message)}return[]},async searchProducts(t){if(!a.tenantId||!t)return[];try{const n=`${e.CATALOG_API_URL}/${a.tenantId}/catalog/search`,i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:t,limit:_.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(i.ok)return(await i.json()).results||[]}catch(e){console.warn("[VocalIA] MCP search error:",e.message)}return[]},async getRecommendations(){if(!a.tenantId)return[];try{const t=`${e.CATALOG_API_URL}/${a.tenantId}/catalog/recommendations`,n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a.sessionId,ltvTier:_.ltvTier,productsViewed:a.ecommerce.productsViewed.slice(-10),locale:_.profile?.locale||a.currentLang,limit:_.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(n.ok)return(await n.json()).recommendations||[]}catch(e){console.warn("[VocalIA] MCP recommendations error:",e.message)}return[]}};function S(e){if(!o)return;a.synthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.lang="ar-SA",t.rate=.9,a.synthesis.speak(t)}function k(){"native"===a.sttMode&&a.recognition?a.isListening?(a.recognition.stop(),L()):(a.recognition.start(),a.isListening=!0,d("va-mic")?.classList.add("listening"),d("va-trigger")?.classList.add("listening"),E("listening"),g("voice_mic_activated",{mode:"native"})):"fallback"===a.sttMode&&(a.isListening?(a.recordingTimeout&&clearTimeout(a.recordingTimeout),"recording"===a.mediaRecorder?.state&&a.mediaRecorder.stop(),a.isListening=!1,d("va-mic")?.classList.remove("listening"),d("va-trigger")?.classList.remove("listening"),L()):(async function(){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});a.mediaRecorder=new MediaRecorder(t,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/ogg"}),a.audioChunks=[],a.mediaRecorder.ondataavailable=e=>{e.data.size>0&&a.audioChunks.push(e.data)},a.mediaRecorder.onstop=async()=>{t.getTracks().forEach(e=>e.stop());const n=new Blob(a.audioChunks,{type:a.mediaRecorder.mimeType});if(n.size<1e3)return;const i=e.API_BASE_URL+"/stt";try{const e=await(await fetch(i,{method:"POST",headers:{"X-Language":a.currentLang},body:n,signal:AbortSignal.timeout(15e3)})).json();e.success&&e.text&&(d("va-input").value=e.text,N(e.text,"voice"))}catch(e){console.error("[VocalIA ECOM] STT request failed:",e.message)}},a.mediaRecorder.start(),a.isListening=!0,a.recordingTimeout=setTimeout(()=>{"recording"===a.mediaRecorder?.state&&(a.mediaRecorder.stop(),a.isListening=!1,d("va-mic")?.classList.remove("listening"),d("va-trigger")?.classList.remove("listening"),L())},1e4)}catch(e){console.error("[VocalIA ECOM] Microphone access denied:",e.message),a.isListening=!1,d("va-mic")?.classList.remove("listening")}}(),d("va-mic")?.classList.add("listening"),d("va-trigger")?.classList.add("listening"),E("listening"),g("voice_mic_activated",{mode:"fallback"})))}function E(e="listening"){const t=d("va-visualizer"),n=d("va-visualizer-bars"),i=d("va-visualizer-label"),o=a.langData;t&&(t.classList.add("active"),n.classList.remove("speaking","listening","processing"),n.classList.add(e),i.classList.remove("speaking","listening","processing"),i.classList.add(e),i.textContent={listening:o?.ui?.voiceListening||"Listening...",speaking:o?.ui?.voiceSpeaking||"Speaking...",processing:o?.ui?.voiceProcessing||"Processing..."}[e]||e,"speaking"===e&&function(){const e=p(".va-visualizer-bar");e.length&&function t(){e.forEach(e=>{const t=8+28*Math.random();e.style.height=`${t}px`,e.style.opacity=.6+.4*Math.random()}),T=requestAnimationFrame(()=>{setTimeout(t,100)})}()}())}function L(){const e=d("va-visualizer"),t=d("va-visualizer-bars");e&&(e.classList.remove("active"),t.classList.remove("speaking","listening","processing"),T&&(cancelAnimationFrame(T),T=null),p(".va-visualizer-bar").forEach(e=>{e.style.height="4px",e.style.opacity="0.5"}))}window.VocalIA.UCP=_,window.VocalIA.MCP=A;let T=null;function C(e){V(e)&&P("desktop_mouseleave")}function O(t){!t.relatedTarget&&t.clientY<e.EXIT_INTENT_SENSITIVITY&&V(t)&&P("desktop_mouseout")}function M(){const t=window.scrollY,n=document.documentElement.scrollHeight-window.innerHeight;(a.exitIntent.lastScrollY-t)/n>e.EXIT_INTENT_MOBILE_SCROLL_RATIO&&t<.3*n&&V()&&P("mobile_scroll"),a.exitIntent.lastScrollY=t}function V(t=null){return!(a.exitIntent.shown||a.exitIntent.dismissed||a.isOpen||Date.now()-a.exitIntent.pageLoadTime<e.EXIT_INTENT_DELAY||a.conversationHistory.length>2)}function P(t="unknown"){if(a.exitIntent.triggered)return;a.exitIntent.triggered=!0,a.exitIntent.shown=!0,localStorage.setItem("vocalia_exit_intent_shown",Date.now().toString()),g("exit_intent_triggered",{trigger:t,page:window.location.pathname});const n=window.VocalIA?.cart;if(e.ECOMMERCE_MODE&&n&&n.items&&n.items.length>0&&(!a.planFeatures||!1!==a.planFeatures.ecom_cart_recovery))return g("exit_intent_cart_recovery",{cart_value:n.total,items:n.items.length}),void window.VocalIA.triggerCartRecovery("exit_intent");!function(){const e=a.langData||{},t=e?.meta?.rtl||!1,n=document.createElement("div");n.id="va-exit-overlay",n.innerHTML=`\n      <style>\n        #va-exit-overlay {\n          position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n          background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);\n          z-index: 999998; display: flex; align-items: center; justify-content: center;\n          animation: fadeIn 0.3s ease;\n        }\n        .va-exit-popup {\n          background: linear-gradient(145deg, #1e2642 0%, #191e35 100%);\n          border-radius: 24px; padding: 32px; max-width: 420px; width: 90%;\n          box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 60px rgba(94,106,210,0.15);\n          position: relative; text-align: center;\n          border: 1px solid rgba(94,106,210,0.2);\n          ${t?"direction: rtl;":""}\n        }\n        .va-exit-close {\n          position: absolute; top: 12px; ${t?"left":"right"}: 12px;\n          background: rgba(255,255,255,0.1); border: none; border-radius: 50%;\n          width: 32px; height: 32px; cursor: pointer; display: flex;\n          align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-exit-close:hover { background: rgba(255,255,255,0.2); }\n        .va-exit-close svg { width: 16px; height: 16px; fill: white; }\n        .va-exit-icon {\n          width: 80px; height: 80px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary, #5E6AD2) 0%, #10B981 100%);\n          margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 8px 32px rgba(94,106,210,0.4);\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-exit-icon svg { width: 40px; height: 40px; fill: white; }\n        .va-exit-title {\n          font-size: 24px; font-weight: 700; color: white; margin: 0 0 8px;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n        }\n        .va-exit-subtitle {\n          font-size: 15px; color: rgba(255,255,255,0.7); margin: 0 0 24px;\n          line-height: 1.5;\n        }\n        .va-exit-cta {\n          display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;\n        }\n        .va-exit-btn {\n          padding: 14px 28px; border-radius: 12px; font-size: 15px;\n          font-weight: 600; cursor: pointer; transition: all 0.2s;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n          border: none;\n        }\n        .va-exit-btn-primary {\n          background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n          color: white; box-shadow: 0 4px 20px rgba(94,106,210,0.4);\n        }\n        .va-exit-btn-primary:hover {\n          transform: translateY(-2px); box-shadow: 0 6px 30px rgba(94,106,210,0.6);\n        }\n        .va-exit-btn-secondary {\n          background: rgba(255,255,255,0.1); color: white;\n        }\n        .va-exit-btn-secondary:hover { background: rgba(255,255,255,0.15); }\n        .va-exit-voice-hint {\n          font-size: 12px; color: rgba(94,106,210,0.8); margin-top: 16px;\n          display: flex; align-items: center; justify-content: center; gap: 6px;\n        }\n        .va-exit-voice-hint svg { width: 14px; height: 14px; fill: currentColor; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n      </style>\n\n      <div class="va-exit-popup">\n        <button class="va-exit-close" id="va-exit-close" aria-label="Fermer">\n          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n        </button>\n\n        <div class="va-exit-icon">\n          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>\n        </div>\n\n        <h3 class="va-exit-title">${e?.exitIntent?.title||"Attendez !"}</h3>\n        <p class="va-exit-subtitle">${e?.exitIntent?.subtitle||"Avez-vous des questions ? Notre assistant IA peut vous aider instantan√©ment."}</p>\n\n        <div class="va-exit-cta">\n          <button class="va-exit-btn va-exit-btn-primary" id="va-exit-chat">\n            ${e?.exitIntent?.ctaChat||"üí¨ Discuter maintenant"}\n          </button>\n          <button class="va-exit-btn va-exit-btn-secondary" id="va-exit-demo">\n            ${e?.exitIntent?.ctaDemo||"üìÖ R√©server une d√©mo"}\n          </button>\n        </div>\n\n        <p class="va-exit-voice-hint">\n          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>\n          ${e?.exitIntent?.voiceHint||"Support vocal disponible"}\n        </p>\n      </div>\n    `,(l||document.body).appendChild(n),d("va-exit-close").addEventListener("click",z),d("va-exit-chat").addEventListener("click",()=>{z(),function(){const e=d("va-panel");if(e){e.classList.add("open"),a.isOpen=!0;const t=d("va-input");t&&t.focus()}}(),g("exit_intent_chat_clicked")}),d("va-exit-demo").addEventListener("click",()=>{z(),window.location.href="/booking",g("exit_intent_demo_clicked")}),n.addEventListener("click",e=>{e.target===n&&z()}),g("exit_intent_viewed")}()}function z(){a.exitIntent.dismissed=!0;const e=d("va-exit-overlay");e&&(e.style.animation="fadeOut 0.2s ease",setTimeout(()=>e.remove(),200)),g("exit_intent_dismissed")}function R(){if(a.isOpen)return;const t=a.langData||{},n=t?.meta?.rtl||!1,i=a.socialProof.messages.length>0?a.socialProof.messages:t?.socialProof?.messages||[{text:"Sophie de Paris vient de demander une d√©mo",icon:'<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>'},{text:"Une entreprise a automatis√© 500 appels ce mois",icon:'<path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>'},{text:"Nouveau client: Cabinet dentaire √† Casablanca",icon:'<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>'},{text:"Ahmed a r√©serv√© un rendez-vous via l'assistant",icon:'<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zm-7-9c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>'},{text:"12 leads qualifi√©s g√©n√©r√©s aujourd'hui",icon:'<path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>'}],o=i[Math.floor(Math.random()*i.length)],r=document.createElement("div");r.className="va-social-proof",r.id=`va-sp-${Date.now()}`,r.innerHTML=`\n      <style>\n        .va-social-proof {\n          position: fixed; bottom: 100px; ${n?"left":"right"}: 25px;\n          max-width: 280px; background: linear-gradient(145deg, #1e2642, #191e35);\n          border: 1px solid rgba(94,106,210,0.2); border-radius: 12px;\n          padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n          z-index: 99997; font-family: Inter, -apple-system, sans-serif;\n          animation: slideInRight 0.4s ease, fadeOut 0.3s ease ${e.SOCIAL_PROOF_DURATION-300}ms forwards;\n          ${n?"direction: rtl;":""}\n        }\n        @keyframes slideInRight {\n          from { opacity: 0; transform: translateX(${n?"-":""}30px); }\n          to { opacity: 1; transform: translateX(0); }\n        }\n        @keyframes fadeOut {\n          from { opacity: 1; }\n          to { opacity: 0; }\n        }\n        .va-sp-content { display: flex; align-items: center; gap: 10px; }\n        .va-sp-icon {\n          width: 36px; height: 36px; border-radius: 50%;\n          background: linear-gradient(135deg, #5E6AD2, #10B981);\n          display: flex; align-items: center; justify-content: center;\n          flex-shrink: 0;\n        }\n        .va-sp-icon svg { width: 18px; height: 18px; fill: white; }\n        .va-sp-text { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.4; }\n        .va-sp-time { font-size: 11px; color: rgba(94,106,210,0.7); margin-top: 4px; }\n        .va-sp-close {\n          position: absolute; top: 6px; ${n?"left":"right"}: 6px;\n          background: none; border: none; cursor: pointer;\n          color: rgba(255,255,255,0.4); padding: 2px;\n        }\n        .va-sp-close:hover { color: rgba(255,255,255,0.7); }\n      </style>\n\n      <button class="va-sp-close" aria-label="Fermer">\n        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n        </svg>\n      </button>\n\n      <div class="va-sp-content">\n        <div class="va-sp-icon">\n          <svg viewBox="0 0 24 24">${o.icon||'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>'}</svg>\n        </div>\n        <div>\n          <div class="va-sp-text">${o.text}</div>\n          <div class="va-sp-time">${o.time||function(e){const t=e?.socialProof?.times||["Il y a 2 min","Il y a 5 min","Il y a 12 min","Il y a 23 min","Il y a 1h"];return t[Math.floor(Math.random()*t.length)]}(t)}</div>\n        </div>\n      </div>\n    `,(l||document.body).appendChild(r),r.querySelector(".va-sp-close").addEventListener("click",()=>{r.remove()}),setTimeout(()=>{d(r.id)&&r.remove()},e.SOCIAL_PROOF_DURATION),a.socialProof.notificationsShown++,a.socialProof.lastShownTime=Date.now(),g("social_proof_shown",{index:a.socialProof.notificationsShown})}function $(){const e=new Date,t=a.langData.meta.speechSynthesis,n="ar"===a.langData.meta.code,i=[];for(let a=1;a<=7;a++){const o=new Date(e);o.setDate(e.getDate()+a);const r=o.getDay();if((n?[0,1,2,3,4]:[1,2,3,4,5]).includes(r)&&(o.setHours(10,0,0,0),i.push({date:o.toLocaleDateString(t,{weekday:"long",month:"long",day:"numeric"}),time:"10:00",iso:o.toISOString()}),i.length>=3))break}return i}async function D(t){const n=a.langData,i=t.toLowerCase(),o=a.conversationContext;if(o.bookingFlow.active){const n=await async function(t){const n=a.langData,i=t.toLowerCase(),o=a.conversationContext.bookingFlow;if(n.booking.cancelKeywords.some(e=>i.includes(e)))return g("voice_booking_cancelled",{step:o.step}),o.active=!1,o.step=null,o.data={name:null,email:null,datetime:null,service:n.booking.service},n.booking.messages.cancelled;if("name"===o.step){const e=t.trim();return e.length<2?n.booking.messages.askName:(o.data.name=e,o.step="email",n.booking.messages.askEmail.replace("{name}",e))}if("email"===o.step){const i=t.trim().toLowerCase();if(!function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(i))return n.booking.messages.invalidEmail;o.data.email=i,o.step="datetime";const r=await async function(){const t=Date.now();if(a.availableSlotsCache.slots.length>0&&t-a.availableSlotsCache.timestamp<e.SLOT_CACHE_TTL)return a.availableSlotsCache.slots;try{const n=await(await fetch(e.BOOKING_API+"?action=availability",{method:"GET",mode:"cors"})).json();if(n.success&&n.data?.slots){const e=a.langData.meta.speechSynthesis,i=n.data.slots.slice(0,6).map(t=>{const n=new Date(t.start);return{date:n.toLocaleDateString(e,{weekday:"long",month:"long",day:"numeric"}),time:n.toLocaleTimeString(e,{hour:"numeric",minute:"2-digit"}),iso:t.start}});return a.availableSlotsCache={slots:i,timestamp:t},i}}catch(e){console.error("[VocalIA] Slots fetch error:",e)}return $()}();if(0===r.length)return n.booking.messages.noSlots;let s=n.booking.messages.slotsIntro;return r.slice(0,3).forEach((e,t)=>{s+=n.booking.messages.slotFormat.replace("{index}",t+1).replace("{date}",e.date).replace("{time}",e.time)+"\n"}),s+=n.booking.messages.slotsOutro,s}if("datetime"===o.step){const e=a.availableSlotsCache.slots.length>0?a.availableSlotsCache.slots.slice(0,3):$();let t=null;for(const[a,o]of Object.entries(n.booking.slotKeywords))if(o.some(e=>i.includes(e))){t=e[parseInt(a)-1];break}return t?(o.data.datetime=t.iso,o.step="confirm",g("voice_booking_slot_selected",{slot_date:t.date,slot_time:t.time}),n.booking.messages.confirmIntro+n.booking.messages.confirmName.replace("{name}",o.data.name)+"\n"+n.booking.messages.confirmEmail.replace("{email}",o.data.email)+"\n"+n.booking.messages.confirmDate.replace("{date}",t.date).replace("{time}",t.time)+n.booking.messages.confirmOutro):n.booking.messages.slotNotUnderstood}return"confirm"===o.step?n.booking.confirmKeywords.some(e=>i.includes(e))?(o.step="submitting",null):n.booking.messages.confirmPrompt:null}(t);if("submitting"===o.bookingFlow.step)return await async function(){const t=a.langData,n=a.conversationContext.bookingFlow,i=function(){if(window.GeoLocale&&"function"==typeof window.GeoLocale.getTimezone)return window.GeoLocale.getTimezone();try{return{iana:Intl.DateTimeFormat().resolvedOptions().timeZone,offset:(new Date).getTimezoneOffset()}}catch{return{iana:null,offset:(new Date).getTimezoneOffset()}}}(),o=await async function(t){try{return await(await fetch(e.BOOKING_API,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(t)})).json()}catch(e){return console.error("[VocalIA] Booking error:",e),{success:!1,message:e.message}}}({name:n.data.name,email:n.data.email,datetime:n.data.datetime,service:n.data.service||t.booking.service,phone:"",notes:`Booking via voice assistant (${a.currentLang.toUpperCase()})`,timezone:i.iana||`UTC${i.offset>0?"-":"+"}${Math.abs(i.offset/60)}`});return n.active=!1,n.step=null,o.success?(g("voice_booking_completed",{service:n.data.service,datetime:n.data.datetime}),t.booking.messages.success.replace("{email}",n.data.email)):(g("voice_booking_failed",{error:o.message}),t.booking.messages.failure.replace("{message}",o.message))}();if(n)return n}return a.planFeatures&&!1===a.planFeatures.booking||!function(e){const t=a.langData,n=e.toLowerCase();return t.booking.keywords.some(e=>n.includes(e))}(i)?await async function(t){if(!e.AI_MODE)return null;try{const n=new AbortController,i=setTimeout(()=>n.abort(),e.API_TIMEOUT),o={message:t,language:a.currentLang,sessionId:a.sessionId||`widget_${Date.now()}`,tenant_id:a.tenantId,widget_type:"ECOM",history:a.conversationHistory.slice(-10).map(e=>({role:e.role,content:e.content}))};a.conversationHistory.length<=2&&(o.page_context=function(){const e=window.location.pathname,t=document.title||"",n=document.querySelector('meta[property="og:title"]')?.content||"",a=document.querySelector('meta[name="description"]')?.content||"",i=document.querySelector("h1")?.textContent?.trim()||"";let o="general";/\/(product|produit)/i.test(e)?o="product":/\/(collection|category|categorie)/i.test(e)?o="category":/\/(cart|panier)/i.test(e)?o="cart":/\/(checkout|commande)/i.test(e)?o="checkout":/\/(pricing|tarifs|prix)/i.test(e)?o="pricing":/\/(booking|rendez-vous|demo)/i.test(e)?o="booking":("/"===e||"/index.html"===e)&&(o="homepage");const r=document.querySelector('script[type="application/ld+json"]');let s=null;if(r)try{const e=JSON.parse(r.textContent);"Product"===e["@type"]&&(s={name:e.name,price:e.offers?.price,currency:e.offers?.priceCurrency})}catch{}return s||document.querySelector('meta[property="og:type"][content="product"]')&&(s={name:n||i,price:document.querySelector('meta[property="product:price:amount"]')?.content,currency:document.querySelector('meta[property="product:price:currency"]')?.content}),{path:e,pageType:o,title:n||i||t,description:a.slice(0,200),product:s}}());const r=await fetch(e.VOICE_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),signal:n.signal});if(clearTimeout(i),!r.ok)return console.warn("[VocalIA] API error:",r.status),null;const s=await r.json();return s.response?(s.features&&(a.planFeatures=s.features),g("voice_api_response",{language:a.currentLang,latency:s.latencyMs}),s.a2ui&&function(t){if(!t||!t.html)return;const n=d("va-messages");if(!n)return;const i=document.createElement("div");if(i.className="va-message assistant va-a2ui-wrapper",t.css){const e=document.createElement("style");e.textContent=t.css,i.appendChild(e)}const o=document.createElement("div");o.className="va-message-content",o.innerHTML=t.html,i.appendChild(o),n.appendChild(i),n.scrollTop=n.scrollHeight,i.querySelectorAll("[data-a2ui-action]").forEach(n=>{n.addEventListener("click",()=>{!async function(t,n){if(g("a2ui_action",{action:t,type:n.type}),"select_slot"===t){const e=n.element.closest("[data-a2ui-component]");if(e){e.querySelectorAll(".va-a2ui-slot").forEach(e=>e.classList.remove("selected")),n.element.classList.add("selected");const t=e.querySelector('[data-a2ui-action="confirm_booking"]');t&&(t.disabled=!1)}return}if("close"===t)return void n.wrapper.remove();const i={},o=n.element.closest("[data-a2ui-component]");if("confirm_booking"===t&&o){const e=o.querySelector(".va-a2ui-slot.selected");i.slot=e?.dataset.slot}else if("submit_lead"===t&&o){const e=o.querySelector("form");e&&new FormData(e).forEach((e,t)=>{i[t]=e})}try{const n=await(await fetch(e.VOICE_API_URL.replace("/respond","/a2ui/action"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t,data:i,sessionId:a.sessionId,tenant_id:a.tenantId,widget_type:"ECOM"})})).json();n.message&&m(n.message,"assistant")}catch(e){console.warn("[VocalIA ECOM] A2UI action failed:",e.message)}}(n.dataset.a2uiAction,{type:t.type,value:n.dataset.slot||n.dataset.productId||null,element:n,wrapper:i})})}),g("a2ui_rendered",{type:t.type})}(s.a2ui),s.catalog&&s.catalog.items&&s.catalog.items.length>0&&w(s.catalog.items,s.catalog.title,"api_response"),s.response):null}catch(e){"AbortError"===e.name?console.error("[VocalIA] API timeout"):console.error("[VocalIA] API error:",e.message);const t=a.langData?.ui||{};return"AbortError"===e.name?t.timeoutMessage||t.errorMessage||"The request took too long. Please try again.":t.connectionError||t.errorMessage||"Sorry, I'm experiencing a connection issue."}}(t)||n?.ui?.errorMessage||"D√©sol√©, je suis temporairement indisponible. Veuillez r√©essayer.":(o.bookingFlow.active=!0,o.bookingFlow.step="name",o.bookingFlow.data.service=n.booking.service,g("voice_booking_started",{step:"name"}),n.booking.messages.start)}async function N(t,n="text"){if(t.trim()){"voice"!==(i=n)&&"text"!==i||(a.ecommerce.inputMethodStats[i]++,a.ecommerce.lastInputMethod=i,g("input_method_used",{method:i,total_voice:a.ecommerce.inputMethodStats.voice,total_text:a.ecommerce.inputMethodStats.text,voice_ratio:a.ecommerce.inputMethodStats.voice/(a.ecommerce.inputMethodStats.voice+a.ecommerce.inputMethodStats.text)})),m(t,"user"),d("va-input").value="",function(){const e=d("va-messages"),t=document.createElement("div");t.className="va-message assistant",t.id="va-typing",t.innerHTML='<div class="va-message-content"><div class="va-typing"><span></span><span></span><span></span></div></div>',e.appendChild(t),e.scrollTop=e.scrollHeight}();try{if(e.ECOMMERCE_MODE&&a.tenantId){const i=function(e){const t=e.toLowerCase(),n=a.langData,i=n?.ecommerce?.searchKeywords||["cherche","recherche","trouve","looking for","search","find","busco","necesito","quiero","ÿ®ÿ≠ÿ´","ŸÜÿ®ÿ∫Ÿä","ÿ®ÿßÿ∫Ÿä"],o=n?.ecommerce?.categoryKeywords||{electronics:["t√©l√©phone","phone","laptop","ordinateur","ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™"],clothing:["v√™tement","clothes","robe","pantalon","ŸÖŸÑÿßÿ®ÿ≥","ÿ≠ŸàÿßŸäÿ¨"],food:["nourriture","food","manger","ÿ£ŸÉŸÑ","ŸÖÿßŸÉŸÑÿ©"],beauty:["beaut√©","cosm√©tique","beauty","makeup","ÿ≤ŸäŸÜÿ©","ÿ¨ŸÖÿßŸÑ"]},r=n?.ecommerce?.recommendKeywords||["recommande","sugg√®re","propose","recommend","suggest","recomienda","sugiere","ŸÜÿµÿ≠ŸÜŸä","ÿ¥ŸàŸÅ ŸÑŸä","ŸÇÿ™ÿ±ÿ≠"],s=i.some(e=>t.includes(e)),c=r.some(e=>t.includes(e));let l=null;for(const[e,n]of Object.entries(o))if(n.some(e=>t.includes(e))){l=e;break}let d=null;if(s){const t=e.split(/\s+/).filter(e=>e.length>2&&!i.includes(e.toLowerCase()));t.length>0&&(d=t.slice(-3).join(" "))}return s||c||l?{type:s?"search":c?"recommend":"category",category:l,query:d}:null}(t);if(i){g("product_intent_detected",{intent_type:i.type,category:i.category,query:i.query,input_method:n});let o=[];if(o="search"===i.type&&i.query?await A.searchProducts(i.query):"recommend"===i.type?await A.getRecommendations():await A.fetchProducts({category:i.category,limit:e.MAX_CAROUSEL_ITEMS}),0===o.length&&(o=await async function(t={}){if(!e.ECOMMERCE_MODE||!a.tenantId)return[];const n=JSON.stringify({tenantId:a.tenantId,...t}),i=Date.now();if(a.catalogCache.key===n&&i-a.catalogCache.timestamp<e.CATALOG_CACHE_TTL)return a.catalogCache.products;try{const o=t.search?`${e.CATALOG_API_URL}/${a.tenantId}/catalog/search`:`${e.CATALOG_API_URL}/${a.tenantId}/catalog`,r=new URLSearchParams;t.category&&r.append("category",t.category),t.search&&r.append("q",t.search),t.limit&&r.append("limit",t.limit);const s=r.toString()?`${o}?${r}`:o,c=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!c.ok)return console.warn("[VocalIA] Catalog API error:",c.status),[];const l=await c.json(),d=l.items||l.results||l.products||[];return a.catalogCache={key:n,products:d,timestamp:i},d}catch(e){return console.warn("[VocalIA] Catalog fetch error:",e.message),[]}}({category:i.category,search:i.query,limit:e.MAX_CAROUSEL_ITEMS})),o.length>0)return v(),_.recordInteraction("product_search",{intent:i.type,category:i.category,query:i.query,results_count:o.length}),w(o,i.query?`${a.langData?.ecommerce?.resultsFor||"R√©sultats pour"} "${i.query}"`:null,i.type),void m(await D(t),"assistant")}}const i=await D(t);v(),m(i,"assistant")}catch(e){v(),m(a.langData.ui.errorMessage,"assistant"),console.error("[VocalIA] Response error:",e)}}var i}function B(){a.isOpen=!a.isOpen;const e=d("va-panel");if(a.isOpen){if(e.classList.add("open"),g("voice_panel_opened"),0===a.conversationHistory.length){const e=a.langData;m(c?e.ui.welcomeMessageTextOnly:e.ui.welcomeMessage,"assistant")}d("va-input").focus()}else e.classList.remove("open"),a.synthesis&&a.synthesis.cancel(),g("voice_panel_closed")}async function U(){try{window.VOCALIA_CONFIG_INJECTED&&Object.assign(e,window.VOCALIA_CONFIG_INJECTED),window.VOCALIA_CONFIG&&Object.assign(e,window.VOCALIA_CONFIG);const t=function(){const t=new URLSearchParams(window.location.search).get("lang");if(t&&e.SUPPORTED_LANGS.includes(t))return t;const n=document.documentElement.lang?.toLowerCase()?.split("-")[0];if(n&&e.SUPPORTED_LANGS.includes(n))return n;const a=navigator.language||navigator.userLanguage,i=e.AUTO_DETECT_LANGUAGES[a]||e.AUTO_DETECT_LANGUAGES[a?.split("-")[0]];return i&&e.SUPPORTED_LANGS.includes(i)?i:e.DEFAULT_LANG}();await u(t),function(){if(e.tenantId)return void(a.tenantId=e.tenantId);const t=document.querySelector("script[data-vocalia-tenant]")||document.querySelector("script[data-tenant-id]");if(t)return void(a.tenantId=t.dataset.vocaliaTenant||t.dataset.tenantId);const n=new URLSearchParams(window.location.search),i=n.get("tenant_id")||n.get("tenantId");if(i)return void(a.tenantId=i);const o=document.querySelector('meta[name="vocalia-tenant"]');if(o)return void(a.tenantId=o.content);if(window.VOCALIA_TENANT_ID)return void(a.tenantId=window.VOCALIA_TENANT_ID);const r=document.getElementById("vocalia-widget")||document.getElementById("voice-assistant-widget");r?.dataset.tenantId&&(a.tenantId=r.dataset.tenantId)}(),a.tenantId&&(await async function(){if(!a.tenantId)return null;const t=`${e.VOICE_API_URL.replace("/respond","/config")}?tenantId=${encodeURIComponent(a.tenantId)}`;try{const n=await fetch(t,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!n.ok)throw new Error("Config fetch failed");const i=await n.json();if(i.success){if(i.branding&&i.branding.primaryColor){e.primaryColor=i.branding.primaryColor;const t=document.getElementById("voice-assistant-widget");t&&t.style.setProperty("--va-primary",e.primaryColor)}return a.tenantConfig=i,i.plan_features&&(a.planFeatures=i.plan_features),i.currency&&(a.currency=i.currency),g("tenant_config_loaded",{tenantId:a.tenantId,plan:i.plan}),i}}catch(e){console.warn("[VocalIA ECOM] Config fetch failed, using static defaults:",e.message)}return null}(),e.ECOMMERCE_MODE&&_.syncPreference().catch(e=>console.warn("[VocalIA] UCP init failed:",e.message))),function(){const e=new URLSearchParams(window.location.search),t=a.conversationContext.attribution;t.utm_source=e.get("utm_source")||t.utm_source,t.utm_medium=e.get("utm_medium")||t.utm_medium,t.utm_campaign=e.get("utm_campaign")||t.utm_campaign,t.gclid=e.get("gclid")||t.gclid,t.fbclid=e.get("fbclid")||t.fbclid}(),function(){if(document.getElementById("voice-assistant-widget"))return;const t=a.langData,n=t.meta.rtl,o=n?"left":"right",r=document.createElement("div");r.id="voice-assistant-widget",r.style.cssText=`position:fixed;bottom:30px;${o}:25px;z-index:99999;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;${n?"direction:rtl;":""}`,document.body.appendChild(r),l=r.attachShadow({mode:"open"}),l.innerHTML=function(t,n,a){return`\n      <style>\n        #voice-assistant-widget {\n          --va-primary: ${e.primaryColor};\n          --va-primary-dark: ${e.primaryDark};\n          --va-accent: ${e.accentColor};\n          --va-dark: ${e.darkBg};\n        }\n        .va-trigger {\n          width: 60px; height: 60px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4);\n          transition: all 0.3s ease; position: relative;\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-trigger::before {\n          content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;\n          border-radius: 50%; background: linear-gradient(135deg, var(--va-primary), var(--va-accent));\n          opacity: 0; z-index: -1; animation: pulse-ring 2s ease-out infinite;\n        }\n        .va-trigger::after {\n          content: ''; position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px;\n          border-radius: 50%; border: 2px solid var(--va-primary);\n          opacity: 0; animation: pulse-ring-outer 2s ease-out infinite 0.5s;\n        }\n        @keyframes pulse-glow {\n          0%, 100% { box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4); transform: scale(1); }\n          50% { box-shadow: 0 4px 30px rgba(94, 106, 210, 0.7); transform: scale(1.02); }\n        }\n        @keyframes pulse-ring {\n          0% { transform: scale(1); opacity: 0.6; }\n          100% { transform: scale(1.4); opacity: 0; }\n        }\n        @keyframes pulse-ring-outer {\n          0% { transform: scale(1); opacity: 0.4; }\n          100% { transform: scale(1.6); opacity: 0; }\n        }\n        .va-trigger:hover {\n          transform: scale(1.1); box-shadow: 0 6px 30px rgba(94, 106, 210, 0.6); animation: none;\n        }\n        .va-trigger:hover::before, .va-trigger:hover::after { animation: none; opacity: 0; }\n        .va-trigger img { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; }\n        .va-trigger.listening { animation: pulse 1.5s infinite; }\n        @keyframes pulse {\n          0%, 100% { box-shadow: 0 0 0 0 rgba(94, 106, 210, 0.7); }\n          50% { box-shadow: 0 0 0 15px rgba(94, 106, 210, 0); }\n        }\n        .va-panel {\n          display: none; position: absolute; bottom: 70px; ${a}: 0;\n          width: 360px; max-height: 500px; background: var(--va-dark);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;\n          overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n          ${n?"direction: rtl; text-align: right;":""}\n        }\n        .va-panel.open { display: flex; flex-direction: column; animation: slideUp 0.3s ease; }\n        @keyframes slideUp {\n          from { opacity: 0; transform: translateY(20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        .va-header {\n          padding: 16px;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          display: flex; align-items: center; gap: 12px; ${n?"flex-direction: row-reverse;":""}\n        }\n        .va-header-icon {\n          width: 40px; height: 40px; background: rgba(255,255,255,0.2);\n          border-radius: 50%; display: flex; align-items: center; justify-content: center;\n        }\n        .va-header-icon img { width: 24px; height: 24px; object-fit: contain; border-radius: 4px; }\n        .va-header-text h3 { margin: 0; font-size: 16px; font-weight: 600; color: white; }\n        .va-header-text p { margin: 2px 0 0; font-size: 12px; color: rgba(255,255,255,0.8); }\n        .va-close {\n          margin-${n?"right":"left"}: auto; background: none; border: none;\n          color: white; cursor: pointer; padding: 4px; opacity: 0.8;\n        }\n        .va-close:hover { opacity: 1; }\n        .va-messages { flex: 1; overflow-y: auto; padding: 16px; max-height: 300px; }\n        .va-message { margin-bottom: 12px; display: flex; gap: 8px; }\n        .va-message.user { flex-direction: ${n?"row":"row-reverse"}; }\n        .va-message.assistant { flex-direction: ${n?"row-reverse":"row"}; }\n        .va-message-content {\n          max-width: 80%; padding: 10px 14px; border-radius: 12px;\n          font-size: 14px; line-height: 1.5;\n        }\n        .va-message.assistant .va-message-content { background: rgba(255,255,255,0.1); color: #e5e5e5; }\n        .va-message.user .va-message-content { background: var(--va-primary); color: white; }\n        .va-input-area {\n          padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.1);\n          display: flex; gap: 8px; ${n?"flex-direction: row-reverse; direction: rtl; text-align: right;":""}\n        }\n        .va-input {\n          flex: 1; background: rgba(255,255,255,0.1);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;\n          padding: 10px 16px; color: white; font-size: 14px; outline: none;\n          ${n?"direction: rtl; text-align: right;":""}\n        }\n        .va-input::placeholder { color: rgba(255,255,255,0.5); }\n        .va-input:focus { border-color: var(--va-primary); }\n        .va-mic-btn {\n          width: 40px; height: 40px; border-radius: 50%;\n          background: ${i||typeof MediaRecorder<"u"?"var(--va-primary)":"rgba(255,255,255,0.1)"};\n          border: none; cursor: ${i||typeof MediaRecorder<"u"?"pointer":"not-allowed"};\n          display: flex; align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-mic-btn.listening { background: #ef4444; animation: pulse 1s infinite; }\n        .va-mic-btn svg { width: 20px; height: 20px; fill: white; }\n\n        /* Voice Waveform Visualizer (SOTA 2026) */\n        .va-visualizer {\n          height: 48px; padding: 8px 16px; display: none;\n          background: linear-gradient(180deg, rgba(94,106,210,0.1) 0%, transparent 100%);\n          border-bottom: 1px solid rgba(255,255,255,0.05);\n        }\n        .va-visualizer.active { display: block; animation: fadeIn 0.3s ease; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n        .va-visualizer-canvas {\n          width: 100%; height: 100%; display: block;\n        }\n        .va-visualizer-bars {\n          display: flex; align-items: center; justify-content: center;\n          gap: 3px; height: 100%;\n        }\n        .va-visualizer-bar {\n          width: 3px; border-radius: 2px; background: var(--va-primary);\n          transition: height 0.1s ease;\n        }\n        .va-visualizer-bars.speaking .va-visualizer-bar {\n          animation: soundBar 0.5s ease-in-out infinite alternate;\n        }\n        @keyframes soundBar {\n          0% { height: 4px; opacity: 0.5; }\n          100% { height: var(--bar-height, 24px); opacity: 1; }\n        }\n        .va-visualizer-bar:nth-child(1) { animation-delay: 0.0s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(2) { animation-delay: 0.1s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(3) { animation-delay: 0.2s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(4) { animation-delay: 0.1s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(5) { animation-delay: 0.15s; --bar-height: 36px; }\n        .va-visualizer-bar:nth-child(6) { animation-delay: 0.2s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(7) { animation-delay: 0.25s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(8) { animation-delay: 0.15s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(9) { animation-delay: 0.1s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(10) { animation-delay: 0.05s; --bar-height: 16px; }\n        .va-visualizer-label {\n          font-size: 10px; color: rgba(255,255,255,0.5); text-align: center;\n          margin-top: 4px; text-transform: uppercase; letter-spacing: 1px;\n        }\n        .va-visualizer-label.listening { color: #ef4444; }\n        .va-visualizer-label.speaking { color: var(--va-primary); }\n        .va-send-btn {\n          width: 40px; height: 40px; border-radius: 50%; background: var(--va-primary);\n          border: none; cursor: pointer; display: flex; align-items: center;\n          justify-content: center; transition: all 0.2s;\n        }\n        .va-send-btn:hover { transform: scale(1.1); }\n        .va-send-btn svg { width: 20px; height: 20px; fill: white; ${n?"transform: scaleX(-1);":""} }\n        .va-typing { display: flex; gap: 4px; padding: 10px 14px; direction: ltr; }\n        .va-typing span {\n          width: 8px; height: 8px; background: rgba(255,255,255,0.5);\n          border-radius: 50%; animation: typing 1.4s infinite ease-in-out;\n        }\n        .va-typing span:nth-child(2) { animation-delay: 0.2s; }\n        .va-typing span:nth-child(3) { animation-delay: 0.4s; }\n        @keyframes typing {\n          0%, 60%, 100% { transform: translateY(0); }\n          30% { transform: translateY(-6px); }\n        }\n        .va-cta {\n          padding: 12px 16px; background: rgba(94, 106, 210, 0.1);\n          border-top: 1px solid rgba(94, 106, 210, 0.2);\n        }\n        .va-cta a {\n          display: block; text-align: center; padding: 10px;\n          background: var(--va-primary); color: white; text-decoration: none;\n          border-radius: 8px; font-size: 14px; font-weight: 500; transition: all 0.2s;\n        }\n        .va-cta a:hover { background: var(--va-primary-dark); }\n        @keyframes notifSlideIn {\n          from { opacity: 0; transform: translateX(${n?"-":""}20px) scale(0.9); }\n          to { opacity: 1; transform: translateX(0) scale(1); }\n        }\n        @keyframes notifSlideOut {\n          from { opacity: 1; transform: translateX(0) scale(1); }\n          to { opacity: 0; transform: translateX(${n?"-":""}20px) scale(0.9); }\n        }\n        @media (max-width: 480px) { .va-panel { width: calc(100vw - 40px); ${a}: -10px; } }\n\n        /* E-commerce Product Cards & Carousel (Phase 1) */\n        .va-product-carousel {\n          display: flex; gap: 12px; overflow-x: auto; padding: 8px 0 12px;\n          scrollbar-width: thin; scrollbar-color: var(--va-primary) transparent;\n          scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;\n        }\n        .va-product-carousel::-webkit-scrollbar { height: 4px; }\n        .va-product-carousel::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }\n        .va-product-carousel::-webkit-scrollbar-thumb { background: var(--va-primary); border-radius: 4px; }\n        .va-product-card {\n          flex: 0 0 auto; width: 140px; background: rgba(255,255,255,0.05);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;\n          overflow: hidden; cursor: pointer; transition: all 0.2s ease;\n          scroll-snap-align: start;\n        }\n        .va-product-card:hover {\n          border-color: var(--va-primary); transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(94, 106, 210, 0.2);\n        }\n        .va-product-card.featured {\n          border-color: var(--va-accent);\n          background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(255,255,255,0.05) 100%);\n        }\n        .va-product-img {\n          width: 100%; height: 100px; object-fit: cover;\n          background: rgba(255,255,255,0.1);\n        }\n        .va-product-img-placeholder {\n          width: 100%; height: 100px; display: flex; align-items: center; justify-content: center;\n          background: linear-gradient(135deg, rgba(94,106,210,0.1) 0%, rgba(16,185,129,0.1) 100%);\n          color: rgba(255,255,255,0.3); font-size: 32px;\n        }\n        .va-product-info { padding: 10px; }\n        .va-product-name {\n          font-size: 12px; font-weight: 600; color: #e5e5e5;\n          margin: 0 0 4px; line-height: 1.3;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-product-price {\n          font-size: 14px; font-weight: 700; color: var(--va-primary);\n          display: flex; align-items: baseline; gap: 4px;\n        }\n        .va-product-price-old {\n          font-size: 10px; color: rgba(255,255,255,0.4);\n          text-decoration: line-through; font-weight: 400;\n        }\n        .va-product-badge {\n          position: absolute; top: 8px; ${a}: 8px;\n          background: var(--va-accent); color: white; font-size: 9px;\n          padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase;\n        }\n        .va-product-badge.sale { background: #ef4444; }\n        .va-product-badge.new { background: var(--va-primary); }\n        .va-product-stock {\n          font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px;\n        }\n        .va-product-stock.low { color: #f59e0b; }\n        .va-product-stock.out { color: #ef4444; }\n        .va-carousel-header {\n          display: flex; justify-content: space-between; align-items: center;\n          padding: 8px 0; margin-bottom: 4px;\n        }\n        .va-carousel-title {\n          font-size: 13px; font-weight: 600; color: #e5e5e5;\n          display: flex; align-items: center; gap: 6px;\n        }\n        .va-carousel-title svg { width: 16px; height: 16px; fill: var(--va-primary); }\n        .va-carousel-nav {\n          display: flex; gap: 4px;\n        }\n        .va-carousel-nav button {\n          width: 24px; height: 24px; border-radius: 50%; border: none;\n          background: rgba(255,255,255,0.1); color: white; cursor: pointer;\n          display: flex; align-items: center; justify-content: center;\n          transition: all 0.2s;\n        }\n        .va-carousel-nav button:hover { background: var(--va-primary); }\n        .va-carousel-nav button:disabled { opacity: 0.3; cursor: not-allowed; }\n        .va-carousel-nav button svg { width: 14px; height: 14px; fill: currentColor; }\n        .va-product-actions {\n          display: flex; gap: 4px; margin-top: 8px;\n        }\n        .va-product-btn {\n          flex: 1; padding: 6px 8px; border-radius: 6px; border: none;\n          font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;\n        }\n        .va-product-btn.primary {\n          background: var(--va-primary); color: white;\n        }\n        .va-product-btn.primary:hover { background: var(--va-primary-dark); }\n        .va-product-btn.secondary {\n          background: rgba(255,255,255,0.1); color: #e5e5e5;\n        }\n        .va-product-btn.secondary:hover { background: rgba(255,255,255,0.2); }\n        .va-single-product {\n          background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);\n          border-radius: 12px; padding: 12px; margin: 8px 0;\n        }\n        .va-single-product-row { display: flex; gap: 12px; }\n        .va-single-product-img {\n          width: 80px; height: 80px; border-radius: 8px; object-fit: cover;\n          background: rgba(255,255,255,0.1); flex-shrink: 0;\n        }\n        .va-single-product-details { flex: 1; min-width: 0; }\n        .va-single-product-name {\n          font-size: 14px; font-weight: 600; color: #e5e5e5; margin: 0 0 4px;\n        }\n        .va-single-product-desc {\n          font-size: 11px; color: rgba(255,255,255,0.6); margin: 0 0 8px;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-single-product-price {\n          font-size: 16px; font-weight: 700; color: var(--va-primary);\n        }\n        .va-input-method-indicator {\n          position: absolute; top: 12px; ${n?"left":"right"}: 50px;\n          font-size: 10px; color: rgba(255,255,255,0.4); display: flex; gap: 8px;\n        }\n        .va-input-method-indicator span {\n          display: flex; align-items: center; gap: 3px;\n        }\n        .va-input-method-indicator svg { width: 12px; height: 12px; fill: currentColor; }\n        .va-input-method-indicator .active { color: var(--va-primary); }\n      </style>\n\n      <button class="va-trigger" id="va-trigger" aria-label="${t.ui.ariaOpenAssistant}">\n        <img src="/logo.png" alt="VocalIA" />\n      </button>\n\n      <div class="va-panel" id="va-panel" role="dialog" aria-label="${t.ui.headerTitle}" aria-modal="true">\n        <div class="va-header">\n          <div class="va-header-icon">\n            <img src="/logo.png" alt="VocalIA" />\n          </div>\n          <div class="va-header-text">\n            <h3>${t.ui.headerTitle}</h3>\n            <p>${c?t.ui.headerSubtitleText:t.ui.headerSubtitleVoice}</p>\n          </div>\n          <button class="va-close" id="va-close" aria-label="${t.ui.ariaClose}">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n        </div>\n\n        \x3c!-- Voice Waveform Visualizer (SOTA 2026) --\x3e\n        <div class="va-visualizer" id="va-visualizer" aria-hidden="true">\n          <div class="va-visualizer-bars" id="va-visualizer-bars">\n            ${Array.from({length:10},()=>'<div class="va-visualizer-bar"></div>').join("")}\n          </div>\n          <div class="va-visualizer-label" id="va-visualizer-label">${t.ui.voiceReady||"Voice Ready"}</div>\n        </div>\n\n        <div class="va-messages" id="va-messages" aria-live="polite" aria-relevant="additions"></div>\n\n        <div class="va-input-area">\n          <input type="text" class="va-input" id="va-input" placeholder="${t.ui.placeholder}">\n          ${i||typeof MediaRecorder<"u"?`\n          <button class="va-mic-btn" id="va-mic" aria-label="${t.ui.ariaMic||"Microphone"}">\n            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/></svg>\n          </button>\n          `:""}\n          <button class="va-send-btn" id="va-send" aria-label="${t.ui.ariaSend}">\n            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n          </button>\n        </div>\n\n        <div class="va-cta">\n          <a href="${t.ui.ctaLink}">${t.ui.ctaButton}</a>\n        </div>\n      </div>\n    `}(t,n,o),function(){d("va-trigger").addEventListener("click",B),d("va-close").addEventListener("click",B),d("va-send").addEventListener("click",()=>{N(d("va-input").value,"text")}),d("va-input").addEventListener("keypress",e=>{"Enter"===e.key&&N(e.target.value,"text")}),function(){if(i){const e=window.SpeechRecognition||window.webkitSpeechRecognition;a.recognition=new e,a.recognition.lang=a.langData.meta.speechRecognition,a.recognition.continuous=!1,a.recognition.interimResults=!1,a.recognition.onresult=e=>{const t=e.results[0][0].transcript;d("va-input").value=t,N(t,"voice"),e.results[0][0].confidence&&g("voice_recognition_result",{confidence:e.results[0][0].confidence,detected_lang:a.recognition.lang})},a.recognition.onend=()=>{a.isListening=!1,d("va-mic")?.classList.remove("listening"),d("va-trigger")?.classList.remove("listening"),L()},a.recognition.onerror=e=>{a.isListening=!1,d("va-mic")?.classList.remove("listening"),L(),g("voice_recognition_error",{error:e.error})},a.sttMode="native"}else navigator.mediaDevices&&typeof MediaRecorder<"u"?(a.sttMode="fallback",console.log("[VocalIA ECOM] Using MediaRecorder STT fallback")):a.sttMode="none"}();const e=d("va-mic");e&&"none"!==a.sttMode?e.addEventListener("click",k):e&&"none"===a.sttMode&&(e.style.display="none"),document.addEventListener("keydown",e=>{if(a.isOpen){if("Escape"===e.key){B();const e=d("va-trigger");return void(e&&e.focus())}if("Tab"===e.key){const t=d("va-panel");if(!t)return;const n=t.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');if(0===n.length)return;const a=n[0],i=n[n.length-1];e.shiftKey&&document.activeElement===a?(e.preventDefault(),i.focus()):!e.shiftKey&&document.activeElement===i&&(e.preventDefault(),a.focus())}}})}(),setTimeout(()=>{a.isOpen||function(){const e=a.langData,t=e.meta.rtl,n=t?"left":"right",i=d("va-trigger"),o=document.createElement("div");o.className="va-notification",o.innerHTML=`\n      <div class="va-notif-icon">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n        </svg>\n      </div>\n      <div class="va-notif-text">\n        <span class="va-notif-title">${e.ui.notifTitle}</span>\n        <span class="va-notif-sub">${e.ui.notifSub}</span>\n      </div>\n    `,o.style.cssText=`\n      position: absolute; bottom: 75px; ${n}: 0;\n      display: flex; align-items: center; gap: 10px;\n      background: rgba(25, 30, 53, 0.95);\n      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n      border: 1px solid rgba(94, 106, 210, 0.3);\n      padding: 12px 16px; border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(94, 106, 210, 0.15);\n      animation: notifSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer; white-space: nowrap; z-index: 9999;\n      ${t?"direction: rtl; flex-direction: row-reverse;":""}\n    `;const r=o.querySelector(".va-notif-icon");r&&(r.style.cssText="width: 32px; height: 32px; background: linear-gradient(135deg, rgba(94, 106, 210, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #5E6AD2; flex-shrink: 0;");const s=o.querySelector(".va-notif-text");s&&(s.style.cssText="display: flex; flex-direction: column; gap: 2px;");const c=o.querySelector(".va-notif-title");c&&(c.style.cssText="font-size: 14px; font-weight: 600; color: #E4F4FC;");const l=o.querySelector(".va-notif-sub");l&&(l.style.cssText="font-size: 11px; color: rgba(255, 255, 255, 0.7);");const p=document.createElement("div");p.style.cssText=`position: absolute; bottom: -6px; ${n}: 24px; width: 12px; height: 12px; background: rgba(25, 30, 53, 0.95); border-${t?"left":"right"}: 1px solid rgba(94, 106, 210, 0.3); border-bottom: 1px solid rgba(94, 106, 210, 0.3); transform: rotate(${t?"-":""}45deg);`,o.appendChild(p),i.parentNode.appendChild(o),o.addEventListener("click",B),setTimeout(()=>{o.style.animation="notifSlideOut 0.3s ease forwards",setTimeout(()=>o.remove(),300)},6e3)}()},2e3)}(),function(){if(!e.EXIT_INTENT_ENABLED)return;const t=localStorage.getItem("vocalia_exit_intent_shown");t&&Date.now()-parseInt(t)<e.EXIT_INTENT_COOLDOWN||e.EXIT_INTENT_PAGES&&!e.EXIT_INTENT_PAGES.includes(window.location.pathname)||(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?window.addEventListener("scroll",M,{passive:!0}):(document.addEventListener("mouseleave",C),document.addEventListener("mouseout",O)))}(),async function(){if(e.SOCIAL_PROOF_ENABLED){try{const t=`${e.SOCIAL_PROOF_API_URL}?lang=${a.currentLang}`,n=await(await fetch(t,{signal:AbortSignal.timeout(5e3)})).json();n.success&&Array.isArray(n.messages)&&n.messages.length>0&&(a.socialProof.messages=n.messages)}catch(e){console.warn("[VocalIA ECOM] Social proof fetch failed, using fallback:",e.message)}setTimeout(()=>{R(),a.socialProof.intervalId=setInterval(()=>{a.socialProof.notificationsShown<e.SOCIAL_PROOF_MAX_SHOWN?R():clearInterval(a.socialProof.intervalId)},e.SOCIAL_PROOF_INTERVAL)},e.SOCIAL_PROOF_DELAY)}}(),function(){if(!e.ECOMMERCE_MODE||!a.tenantId)return;const t=a.planFeatures||{},n=e=>!1!==t[e],i=()=>{if(window.VocaliaShippingBar)try{window.VocaliaShippingBar.init({tenantId:a.tenantId,lang:a.currentLang,currency:a.currency||"EUR",voiceEnabled:!0}),y.activate("shippingBar")}catch(e){console.warn("[VocalIA] ShippingBar init failed:",e.message)}},o=()=>{!window.VocaliaSpinWheel||!window.VocalIA.isSpinWheelAvailable()||setTimeout(()=>{if(!a.isOpen&&y.canShow("spinWheel"))try{window.VocaliaSpinWheel.show({tenantId:a.tenantId,lang:a.currentLang,voiceEnabled:!0}),y.activate("spinWheel")}catch(e){console.warn("[VocalIA] SpinWheel init failed:",e.message)}},15e3)},r=()=>{if(window.VocalIARecommendations)try{window.VocalIA.RecommendationCarousel=window.VocalIARecommendations,y.activate("recommendations")}catch(e){console.warn("[VocalIA] RecommendationCarousel init failed:",e.message)}};window.VocaliaShippingBar?i():I("shippingBar").then(i).catch(()=>{}),n("ecom_gamification")&&(window.VocaliaSpinWheel?o():I("spinWheel").then(o).catch(()=>{})),n("ecom_recommendations")&&(window.VocalIARecommendations?r():I("recommendations").then(r).catch(()=>{})),setTimeout(()=>{n("ecom_cart_recovery")&&I("abandonedCart").catch(()=>{}),n("ecom_quiz")&&I("quiz").catch(()=>{})},5e3)}(),g("voice_widget_loaded",{language:a.currentLang,ecommerce_mode:e.ECOMMERCE_MODE&&!!a.tenantId,tenant_id:a.tenantId,exit_intent_enabled:e.EXIT_INTENT_ENABLED,social_proof_enabled:e.SOCIAL_PROOF_ENABLED})}catch(e){console.error("[VocalIA] Init error:",e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",U):U()}();