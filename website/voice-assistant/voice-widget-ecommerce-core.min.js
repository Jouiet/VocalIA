/* VocalIA Widget v2.7.0 - 2026-02-13 */
!function(){"use strict";const e={SUPPORTED_LANGS:["fr","en","es","ar","ary"],DEFAULT_LANG:"fr",VOICE_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/respond":"https://api.vocalia.ma/respond",AI_MODE:!0,API_TIMEOUT:1e4,CATALOG_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013/api/tenants":"https://api.vocalia.ma/api/tenants",ECOMMERCE_MODE:!0,MAX_CAROUSEL_ITEMS:5,API_BASE_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013":"https://api.vocalia.ma",BOOKING_API:"https://script.google.com/macros/s/AKfycbzXKtu88n0Z-oFiBm5kJYPmGOi29maowtMv2vEQ0o5Xhp4sayNdnm2cNBaAx2OlHkUK/exec",EXIT_INTENT_ENABLED:!0,EXIT_INTENT_DELAY:3e3,EXIT_INTENT_SENSITIVITY:20,EXIT_INTENT_COOLDOWN:864e5,EXIT_INTENT_MOBILE_SCROLL_RATIO:.3,EXIT_INTENT_PAGES:null,SOCIAL_PROOF_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/social-proof":"https://api.vocalia.ma/social-proof",SOCIAL_PROOF_ENABLED:!0,SOCIAL_PROOF_INTERVAL:25e3,SOCIAL_PROOF_DURATION:5e3,SOCIAL_PROOF_MAX_SHOWN:5,SOCIAL_PROOF_DELAY:8e3,primaryColor:"#5E6AD2",primaryDark:"#4f46e5",accentColor:"#10B981",darkBg:"#0f172a",LANG_PATH:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/voice-assistant/lang/voice-{lang}.json":"https://vocalia.ma/voice-assistant/lang/voice-{lang}.json",SLOT_CACHE_TTL:3e5,CATALOG_CACHE_TTL:3e5,AUTO_DETECT_ENABLED:!0,AUTO_DETECT_LANGUAGES:{"fr-FR":"fr",fr:"fr","en-US":"en","en-GB":"en",en:"en","es-ES":"es","es-MX":"es",es:"es","ar-SA":"ar","ar-MA":"ar",ar:"ar",ary:"ary"}};function t(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function n(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const a="va_v3_conversation",i=function(){try{const e=sessionStorage.getItem(a);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.ts>18e5?(sessionStorage.removeItem(a),null):t}catch{return null}}();let o={isOpen:!1,isListening:!1,recognition:null,synthesis:window.speechSynthesis,conversationHistory:i?.history||[],currentLang:i?.lang||null,langData:null,sessionId:i?.sessionId||`widget_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tenantId:null,tenantConfig:null,planFeatures:null,currency:null,availableSlotsCache:{slots:[],timestamp:0},catalogCache:{products:[],timestamp:0},conversationContext:{industry:null,need:null,stage:"discovery",lastTopic:null,attribution:{utm_source:null,utm_medium:null,utm_campaign:null,gclid:null,fbclid:null,referrer:document.referrer||null},bookingFlow:{active:!1,step:null,data:{name:null,email:null,datetime:null,service:null}}},ecommerce:{inputMethodStats:{voice:0,text:0},productsViewed:[],carouselsDisplayed:0,productClicks:0,lastInputMethod:null},exitIntent:{shown:!1,dismissed:!1,pageLoadTime:Date.now(),lastScrollY:0,triggered:!1},socialProof:{notificationsShown:0,intervalId:null,lastShownTime:0}};const r="SpeechRecognition"in window||"webkitSpeechRecognition"in window,s="speechSynthesis"in window,c=navigator.userAgent.toLowerCase().includes("firefox"),l=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),d=!r||c||l;let p=null;function u(e){return p?p.getElementById(e):document.getElementById(e)}function g(e){return p?p.querySelectorAll(e):document.querySelectorAll(e)}async function m(t){const n=e.LANG_PATH.replace("{lang}",t);try{const e=await fetch(n);if(!e.ok)throw new Error(`Failed to load language: ${t}`);const a=await e.json();return o.currentLang=t,o.langData=a,a}catch(e){if(console.error("[VocalIA] Language load error:",e),"fr"!==t)return m("fr");throw e}}function v(e,t={}){const n={event_category:"voice_assistant",language:o.currentLang,attribution:o.conversationContext.attribution,...t};"function"==typeof gtag&&gtag("event",e,n),typeof dataLayer<"u"&&Array.isArray(dataLayer)&&dataLayer.push({event:e,...n})}function h(n,i="assistant"){const r=u("va-messages"),c=document.createElement("div");c.className=`va-message ${i}`,c.innerHTML=`<div class="va-message-content">${t(n)}</div>`,r.appendChild(c),r.scrollTop=r.scrollHeight,"assistant"===i&&s&&function(t){const n=o.langData?.meta?.code||o.currentLang||"fr";if("ary"===n)return void async function(t,n){const a=e.VOICE_API_URL.replace("/respond","/tts");try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,language:n})});if(!e.ok)return console.warn("[TTS] ElevenLabs request failed, falling back to Web Speech API"),void T(t);const i=await e.json();if(i.success&&i.audio){const e=new Audio(`data:audio/mp3;base64,${i.audio}`);e.onplay=()=>L("speaking"),e.onended=()=>C(),e.onerror=()=>C(),e.onpause=()=>C(),e.play().catch(e=>{console.warn("[TTS] Audio playback failed:",e.message),C(),T(t)})}else T(t)}catch(e){console.warn("[TTS] ElevenLabs error:",e.message),T(t)}}(t,n);if(!s)return;o.synthesis.cancel();const a=new SpeechSynthesisUtterance(t);a.lang=o.langData.meta.speechSynthesis,a.rate="ar"===n?.9:1,a.onstart=()=>L("speaking"),a.onend=()=>C(),a.onerror=()=>C(),o.synthesis.speak(a)}(n),o.conversationHistory.push({role:"user"===i?"user":"assistant",content:n}),function(){try{sessionStorage.setItem(a,JSON.stringify({sessionId:o.sessionId,history:o.conversationHistory.slice(-50),lang:o.currentLang,ts:Date.now()}))}catch{}}()}function f(){const e=u("va-typing");e&&e.remove()}function w(e,t){const n={MAD:"DH",EUR:"â‚¬",USD:"$",GBP:"Â£"}[t=t||o.currency||"EUR"]||t,a=e.toLocaleString(o.currentLang||"fr",{minimumFractionDigits:0,maximumFractionDigits:2});return"EUR"===t||"USD"===t||"GBP"===t?`${n}${a}`:`${a} ${n}`}function y(e,a="detail"){if(!e)return;const i=u("va-messages"),r=document.createElement("div");r.className="va-message assistant";const s=e.image||e.images?.[0],c=!1!==e.available&&!1!==e.in_stock,l=n(e.id),d=t(e.name||""),p=e.description?t(e.description):"",g=n(e.image||e.images?.[0]||""),m=e.url?n(e.url):"";r.innerHTML=`\n      <div class="va-message-content">\n        <div class="va-single-product" data-product-id="${l}">\n          <div class="va-single-product-row">\n            ${s?`<img class="va-single-product-img" src="${g}" alt="${d}" />`:'<div class="va-single-product-img" style="display:flex;align-items:center;justify-content:center;font-size:32px;">ðŸ“¦</div>'}\n            <div class="va-single-product-details">\n              <h4 class="va-single-product-name">${d}</h4>\n              ${p?`<p class="va-single-product-desc">${p}</p>`:""}\n              <div class="va-single-product-price">${w(e.price,e.currency)}</div>\n            </div>\n          </div>\n          <div class="va-product-actions">\n            <button class="va-product-btn primary" onclick="window.VocalIA.viewProduct('${l}')" ${c?"":"disabled"}>\n              ${c?o.langData?.ecommerce?.viewDetails||"Voir dÃ©tails":o.langData?.ecommerce?.notifyMe||"Me notifier"}\n            </button>\n            ${m?`<button class="va-product-btn secondary" onclick="window.open('${m}', '_blank')">\n              ${o.langData?.ecommerce?.buyNow||"Acheter"}\n            </button>`:""}\n          </div>\n        </div>\n      </div>\n    `,i.appendChild(r),i.scrollTop=i.scrollHeight,o.ecommerce.productsViewed.push(e.id),v("product_viewed",{product_id:e.id,product_name:e.name,price:e.price,context:a,input_method:o.ecommerce.lastInputMethod})}function b(a,i=null,r="recommendations"){if(!a||0===a.length)return;const s=o.langData,c=s?.meta?.rtl,l=u("va-messages"),d=document.createElement("div");d.className="va-message assistant";const p=`carousel-${Date.now()}`,g=a.slice(0,e.MAX_CAROUSEL_ITEMS),m={recommendations:s?.ecommerce?.recommendedForYou||"RecommandÃ© pour vous",search_results:s?.ecommerce?.searchResults||"RÃ©sultats",category:s?.ecommerce?.fromCategory||"De cette catÃ©gorie",popular:s?.ecommerce?.popular||"Populaires",related:s?.ecommerce?.relatedProducts||"Produits similaires"};d.innerHTML=`\n      <div class="va-message-content" style="padding: 8px 10px;">\n        <div class="va-carousel-header">\n          <span class="va-carousel-title">\n            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n            ${i||m[r]||m.recommendations}\n          </span>\n          <div class="va-carousel-nav">\n            <button onclick="this.getRootNode().getElementById('${p}').scrollBy({left: ${c?"150":"-150"}, behavior: 'smooth'})" aria-label="${s?.ui?.ariaPrev||"Previous"}">\n              <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>\n            </button>\n            <button onclick="this.getRootNode().getElementById('${p}').scrollBy({left: ${c?"-150":"150"}, behavior: 'smooth'})" aria-label="${s?.ui?.ariaNext||"Next"}">\n              <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>\n            </button>\n          </div>\n        </div>\n        <div class="va-product-carousel" id="${p}">\n          ${g.map((e,a)=>function(e,a=!1){const i=e.image||e.images?.[0],r=!1!==e.available&&!1!==e.in_stock,s=e.stock,c=e.compare_at_price&&e.compare_at_price>e.price,l=e.created_at&&Date.now()-new Date(e.created_at).getTime()<6048e5;let d="",p="";r?void 0!==s&&s<5&&(d="low",p=o.langData?.ecommerce?.lowStock?.replace("{n}",s)||`Plus que ${s}`):(d="out",p=o.langData?.ecommerce?.outOfStock||"Rupture");let u="";return c?u=`<span class="va-product-badge sale">-${Math.round(100*(1-e.price/e.compare_at_price))}%</span>`:l&&(u=`<span class="va-product-badge new">${o.langData?.ecommerce?.new||"Nouveau"}</span>`),`\n      <div class="va-product-card ${a?"featured":""}" data-product-id="${n(String(e.id))}" style="position: relative;">\n        ${u}\n        ${i?`<img class="va-product-img" src="${n(e.image||e.images[0])}" alt="${n(e.name)}" loading="lazy" />`:'<div class="va-product-img-placeholder">ðŸ“¦</div>'}\n        <div class="va-product-info">\n          <p class="va-product-name">${t(e.name)}</p>\n          <div class="va-product-price">\n            ${w(e.price,e.currency)}\n            ${c?`<span class="va-product-price-old">${w(e.compare_at_price,e.currency)}</span>`:""}\n          </div>\n          ${p?`<p class="va-product-stock ${d}">${p}</p>`:""}\n        </div>\n      </div>\n    `}(e,0===a)).join("")}\n        </div>\n      </div>\n    `,l.appendChild(d),l.scrollTop=l.scrollHeight,d.querySelectorAll(".va-product-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.productId,n=g.find(e=>e.id===t);n&&(o.ecommerce.productClicks++,v("product_card_clicked",{product_id:t,product_name:n.name,price:n.price,position:g.indexOf(n),carousel_context:r,input_method:o.ecommerce.lastInputMethod}),y(n,"carousel_click"))})}),o.ecommerce.carouselsDisplayed++,v("product_carousel_displayed",{products_count:g.length,context:r,product_ids:g.map(e=>e.id),input_method:o.ecommerce.lastInputMethod})}window.VocalIA=window.VocalIA||{},window.VocalIA.viewProduct=async function(t){if(o.tenantId)try{const n=await fetch(`${e.CATALOG_API_URL}/${o.tenantId}/catalog/detail/${encodeURIComponent(t)}`,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(n.ok){const e=await n.json();e.item&&y(e.item,"detail_view")}}catch(e){console.warn("[VocalIA] Product detail error:",e.message)}},window.VocalIA.displayProducts=function(e,t,n){b(e,t,n)},window.VocalIA.getEcommerceStats=function(){return{...o.ecommerce,voiceRatio:o.ecommerce.inputMethodStats.voice/Math.max(1,o.ecommerce.inputMethodStats.voice+o.ecommerce.inputMethodStats.text)}},window.VocalIA.showRecommendations=function(e,t="similar",n=null){e&&0!==e.length&&("function"==typeof gtag&&gtag("event","ai_recommendations_shown",{event_category:"recommendations",recommendation_type:t,items_count:e.length}),b(e,n,{similar:"related",bought_together:"recommendations",personalized:"recommendations"}[t]||"recommendations"))},window.VocalIA.getAIRecommendations=async function(t,n=[],a="similar"){if(!o.tenantId)return null;try{const i={tenant_id:o.tenantId,recommendation_type:a};t&&(i.product_id=t),n.length>0&&(i.product_ids=n);const r=await fetch(`${e.API_BASE_URL}/api/recommendations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.API_KEY||""}`},body:JSON.stringify(i)});if(!r.ok)return null;const s=await r.json();if(s.success&&s.recommendations?.length>0){const t=await Promise.all(s.recommendations.map(async t=>{if(t.productId&&!t.title){const n=await async function(t){if(!o.tenantId)return{};try{const n=await fetch(`${e.API_BASE_URL}/api/tenants/${o.tenantId}/catalog/${encodeURIComponent(t)}`);if(n.ok)return(await n.json()).item||{}}catch{}return{}}(t.productId);return{...t,...n}}return t}));return window.VocalIA.showRecommendations(t,a),t}return null}catch(e){return console.error("[VocalIA] Recommendations error:",e),null}},window.VocalIA.startQuiz=function(t="generic",n={}){if(o.planFeatures&&!1===o.planFeatures.ecom_quiz)return console.warn("[VocalIA] Quiz not available on current plan"),null;if(!window.VocalIAQuiz)return console.warn("[VocalIA] Voice Quiz not loaded. Include voice-quiz.js"),null;const a=new window.VocalIAQuiz({tenantId:o.tenantId,template:t,lang:o.langData?.meta?.code||"fr",apiBaseUrl:e.API_BASE_URL,voiceEnabled:!0,onComplete:e=>{"function"==typeof gtag&&gtag("event","quiz_completed",{event_category:"voice_quiz",template:t,answers_count:Object.keys(e.answers).length,with_lead:e.withLead}),e.tags?.length>0&&window.VocalIA.getAIRecommendations(null,[],"personalized")},onLeadCapture:e=>{"function"==typeof gtag&&gtag("event","quiz_lead_captured",{event_category:"voice_quiz",template:t}),S.syncPreference&&S.recordInteraction("quiz_completed",{template:t,answers:e.answers})},...n});return a.show(),a},window.VocalIA.isQuizSupported=function(){return!!window.VocalIAQuiz},window.VocalIA.initCartRecovery=function(e={}){return o.planFeatures&&!1===o.planFeatures.ecom_cart_recovery?(console.warn("[VocalIA] Cart recovery not available on current plan"),null):window.VocaliaAbandonedCart?window.VocaliaAbandonedCart.init({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Abandoned cart widget not loaded. Include abandoned-cart-recovery.js"),null)},window.VocalIA.triggerCartRecovery=function(e="manual"){if(!o.planFeatures||!1!==o.planFeatures.ecom_cart_recovery)if(window.VocaliaAbandonedCart?.getInstance())window.VocaliaAbandonedCart.getInstance().trigger(e);else{const t=window.VocalIA.initCartRecovery();t&&setTimeout(()=>t.trigger(e),100)}},window.VocalIA.setCartData=function(e){window.VocalIA.cart=e,window.VocaliaAbandonedCart?.getInstance()&&window.VocaliaAbandonedCart.getInstance().setCartData(e),"function"==typeof gtag&&e.total>0&&gtag("event","cart_updated",{event_category:"ecommerce",cart_value:e.total,items_count:e.items?.length||0,currency:e.currency||o.currency||"EUR"})},window.VocalIA.isCartRecoverySupported=function(){return!!window.VocaliaAbandonedCart},window.VocalIA.initShippingBar=function(e={}){return window.VocaliaShippingBar?window.VocaliaShippingBar.init({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Shipping bar widget not loaded. Include free-shipping-bar.js"),null)},window.VocalIA.updateShippingProgress=function(e){if(window.VocaliaShippingBar?.getInstance())window.VocaliaShippingBar.getInstance().updateCartValue(e);else if(window.VocaliaShippingBar){const t=window.VocalIA.initShippingBar();t&&t.updateCartValue(e)}},window.VocalIA.isShippingBarSupported=function(){return!!window.VocaliaShippingBar},window.VocalIA.showSpinWheel=function(e={}){return o.planFeatures&&!1===o.planFeatures.ecom_gamification?(console.warn("[VocalIA] Spin wheel not available on current plan"),null):window.VocaliaSpinWheel?window.VocaliaSpinWheel.show({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Spin wheel widget not loaded. Include spin-wheel.js"),null)},window.VocalIA.isSpinWheelAvailable=function(){try{const e=localStorage.getItem("va_spin_wheel_last_played");return!e||Date.now()-parseInt(e,10)>=864e5}catch{return!0}},window.VocalIA.isSpinWheelSupported=function(){return!!window.VocaliaSpinWheel};const x={widgets:{voiceChat:{active:!1,priority:1},recommendations:{active:!1,priority:2},quiz:{active:!1,priority:3},exitIntent:{active:!1,priority:4},socialProof:{active:!0,priority:5},abandonedCart:{active:!1,priority:6},spinWheel:{active:!1,priority:7},shippingBar:{active:!0,priority:8}},events:new Map,on(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)},emit(e,t){(this.events.get(e)||[]).forEach(e=>{try{e(t)}catch(e){console.error("[Orchestrator] Event error:",e)}})},activate(e){const t=this.widgets[e];return!!t&&(t.active=!0,this.emit("widget:activated",{widget:e}),"function"==typeof gtag&&gtag("event","widget_activated",{event_category:"orchestrator",widget_name:e}),!0)},deactivate(e){const t=this.widgets[e];return!!t&&(t.active=!1,this.emit("widget:deactivated",{widget:e}),!0)},canShow(e){const t=this.widgets[e];if(!t)return!1;for(const[e,n]of Object.entries(this.widgets))if(n.active&&n.priority<t.priority)return!1;return!0},getStats(){return{activeWidgets:Object.entries(this.widgets).filter(([e,t])=>t.active).map(([e,t])=>e),totalWidgets:Object.keys(this.widgets).length,eventListeners:this.events.size}}};window.VocalIA.Orchestrator=x;const I={shippingBar:{file:"voice-widget-ecommerce-shipping.js",global:"VocaliaShippingBar"},abandonedCart:{file:"voice-widget-ecommerce-cart.js",global:"VocaliaAbandonedCart"},quiz:{file:"voice-widget-ecommerce-quiz.js",global:"VocalIAQuiz"},spinWheel:{file:"voice-widget-ecommerce-spin.js",global:"VocaliaSpinWheel"},recommendations:{file:"voice-widget-ecommerce-carousel.js",global:"VocalIARecommendations"}},_={};function A(e){const t=I[e];return t?window[t.global]?Promise.resolve(!0):(_[e]||(_[e]=new Promise((n,a)=>{const i=document.createElement("script");i.src=function(){const e=document.querySelectorAll('script[src*="voice-widget-ecommerce"]');if(e.length>0){const t=e[e.length-1].src;return t.substring(0,t.lastIndexOf("/")+1)}return"/voice-assistant/"}()+t.file,i.onload=()=>n(!0),i.onerror=()=>{delete _[e],a(new Error("Chunk unavailable: "+t.file))},document.head.appendChild(i)})),_[e]):Promise.reject(new Error("Unknown chunk: "+e))}window.VocalIA.loadChunk=A,x.on("widget:activated",({widget:t})=>{"spinWheel"===t&&window.VocaliaSpinWheel&&window.VocaliaSpinWheel.show({tenantId:o.tenantId,lang:o.currentLang}),"shippingBar"===t&&window.VocaliaShippingBar&&window.VocaliaShippingBar.init({tenantId:o.tenantId,lang:o.currentLang}),"recommendations"===t&&window.VocalIARecommendations&&new window.VocalIARecommendations({tenantId:o.tenantId,lang:o.currentLang,apiBase:e.API_BASE_URL}).render()}),x.on("widget:deactivated",({widget:e})=>{"spinWheel"===e&&window.VocaliaSpinWheel?.getInstance()&&window.VocaliaSpinWheel.getInstance().destroy(),"shippingBar"===e&&window.VocaliaShippingBar?.getInstance()&&window.VocaliaShippingBar.getInstance().destroy()});const S={profile:null,ltvTier:"bronze",async syncPreference(t=null){if(!o.tenantId)return null;try{const n=t||function(){const e=navigator.language||navigator.userLanguage||"",t={"fr-FR":"FR","fr-MA":"MA","fr-BE":"BE","fr-CA":"CA","en-US":"US","en-GB":"GB","en-CA":"CA","es-ES":"ES","es-MX":"MX","ar-MA":"MA","ar-SA":"SA","ar-AE":"AE"};if(t[e])return t[e];const n=Intl.DateTimeFormat().resolvedOptions().timeZone||"";return n.includes("Casablanca")?"MA":n.includes("Paris")?"FR":n.includes("London")?"GB":n.includes("New_York")||n.includes("Los_Angeles")?"US":{fr:"FR",en:"US",es:"ES",ar:"MA",ary:"MA"}[o.currentLang]||"FR"}(),a=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/sync"),i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,countryCode:n}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(i.ok){const e=await i.json();return S.profile=e.profile,S.ltvTier=e.ltvTier||"bronze",v("ucp_synced",{country:n,ltv_tier:S.ltvTier,locale:S.profile?.locale}),e}}catch(e){console.warn("[VocalIA] UCP sync error:",e.message)}return null},async recordInteraction(t,n={}){if(o.tenantId&&S.profile)try{const a=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/interaction");await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,type:"widget_chat",channel:"web_widget",metadata:{...n,input_method:o.ecommerce.lastInputMethod,interaction_type:t}}),signal:AbortSignal.timeout(5e3)})}catch{}},async trackEvent(t,n=null){if(o.tenantId)try{const a=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/event");await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,event:t,value:n,source:"voice"===o.ecommerce.lastInputMethod?"voice":"widget"}),signal:AbortSignal.timeout(5e3)})}catch{}},getRecommendationStrategy(){const e={bronze:{limit:3,showPrices:!0,upsell:!1},silver:{limit:4,showPrices:!0,upsell:!0},gold:{limit:5,showPrices:!0,upsell:!0,prioritySupport:!0},platinum:{limit:6,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0},diamond:{limit:8,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0,personalAssistant:!0}};return e[S.ltvTier]||e.bronze}},E={async fetchProducts(t={}){if(!o.tenantId)return[];try{const n=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/browse`,a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:t.category,query:t.search,limit:t.limit||S.getRecommendationStrategy().limit,inStock:!1!==t.inStock,ltvTier:S.ltvTier}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(a.ok)return(await a.json()).items||[]}catch(e){console.warn("[VocalIA] MCP fetch error:",e.message)}return[]},async searchProducts(t){if(!o.tenantId||!t)return[];try{const n=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/search`,a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:t,limit:S.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(a.ok)return(await a.json()).results||[]}catch(e){console.warn("[VocalIA] MCP search error:",e.message)}return[]},async getRecommendations(){if(!o.tenantId)return[];try{const t=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/recommendations`,n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:o.sessionId,ltvTier:S.ltvTier,productsViewed:o.ecommerce.productsViewed.slice(-10),locale:S.profile?.locale||o.currentLang,limit:S.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(n.ok)return(await n.json()).recommendations||[]}catch(e){console.warn("[VocalIA] MCP recommendations error:",e.message)}return[]}};function T(e){if(!s)return;o.synthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.lang="ar-SA",t.rate=.9,o.synthesis.speak(t)}function k(){"native"===o.sttMode&&o.recognition?o.isListening?(o.recognition.stop(),C()):(o.recognition.start(),o.isListening=!0,u("va-mic")?.classList.add("listening"),u("va-trigger")?.classList.add("listening"),L("listening"),v("voice_mic_activated",{mode:"native"})):"fallback"===o.sttMode&&(o.isListening?(o.recordingTimeout&&clearTimeout(o.recordingTimeout),"recording"===o.mediaRecorder?.state&&o.mediaRecorder.stop(),o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),C()):(async function(){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});o.mediaRecorder=new MediaRecorder(t,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/ogg"}),o.audioChunks=[],o.mediaRecorder.ondataavailable=e=>{e.data.size>0&&o.audioChunks.push(e.data)},o.mediaRecorder.onstop=async()=>{t.getTracks().forEach(e=>e.stop());const n=new Blob(o.audioChunks,{type:o.mediaRecorder.mimeType});if(n.size<1e3)return;const a=e.API_BASE_URL+"/stt";try{const e=await(await fetch(a,{method:"POST",headers:{"X-Language":o.currentLang},body:n,signal:AbortSignal.timeout(15e3)})).json();e.success&&e.text&&(u("va-input").value=e.text,U(e.text,"voice"))}catch(e){console.error("[VocalIA ECOM] STT request failed:",e.message)}},o.mediaRecorder.start(),o.isListening=!0,o.recordingTimeout=setTimeout(()=>{"recording"===o.mediaRecorder?.state&&(o.mediaRecorder.stop(),o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),C())},1e4)}catch(e){console.error("[VocalIA ECOM] Microphone access denied:",e.message),o.isListening=!1,u("va-mic")?.classList.remove("listening")}}(),u("va-mic")?.classList.add("listening"),u("va-trigger")?.classList.add("listening"),L("listening"),v("voice_mic_activated",{mode:"fallback"})))}function L(e="listening"){const t=u("va-visualizer"),n=u("va-visualizer-bars"),a=u("va-visualizer-label"),i=o.langData;t&&(t.classList.add("active"),n.classList.remove("speaking","listening","processing"),n.classList.add(e),a.classList.remove("speaking","listening","processing"),a.classList.add(e),a.textContent={listening:i?.ui?.voiceListening||"Listening...",speaking:i?.ui?.voiceSpeaking||"Speaking...",processing:i?.ui?.voiceProcessing||"Processing..."}[e]||e,"speaking"===e&&function(){const e=g(".va-visualizer-bar");e.length&&function t(){e.forEach(e=>{const t=8+28*Math.random();e.style.height=`${t}px`,e.style.opacity=.6+.4*Math.random()}),O=requestAnimationFrame(()=>{setTimeout(t,100)})}()}())}function C(){const e=u("va-visualizer"),t=u("va-visualizer-bars");e&&(e.classList.remove("active"),t.classList.remove("speaking","listening","processing"),O&&(cancelAnimationFrame(O),O=null),g(".va-visualizer-bar").forEach(e=>{e.style.height="4px",e.style.opacity="0.5"}))}window.VocalIA.UCP=S,window.VocalIA.MCP=E;let O=null;function M(e){$(e)&&V("desktop_mouseleave")}function P(t){!t.relatedTarget&&t.clientY<e.EXIT_INTENT_SENSITIVITY&&$(t)&&V("desktop_mouseout")}function R(){const t=window.scrollY,n=document.documentElement.scrollHeight-window.innerHeight;(o.exitIntent.lastScrollY-t)/n>e.EXIT_INTENT_MOBILE_SCROLL_RATIO&&t<.3*n&&$()&&V("mobile_scroll"),o.exitIntent.lastScrollY=t}function $(t=null){return!(o.exitIntent.shown||o.exitIntent.dismissed||o.isOpen||Date.now()-o.exitIntent.pageLoadTime<e.EXIT_INTENT_DELAY||o.conversationHistory.length>2)}function V(t="unknown"){if(o.exitIntent.triggered)return;o.exitIntent.triggered=!0,o.exitIntent.shown=!0;try{localStorage.setItem("vocalia_exit_intent_shown",Date.now().toString())}catch{}v("exit_intent_triggered",{trigger:t,page:window.location.pathname});const n=window.VocalIA?.cart;if(e.ECOMMERCE_MODE&&n&&n.items&&n.items.length>0&&(!o.planFeatures||!1!==o.planFeatures.ecom_cart_recovery))return v("exit_intent_cart_recovery",{cart_value:n.total,items:n.items.length}),void window.VocalIA.triggerCartRecovery("exit_intent");!function(){const e=o.langData||{},t=e?.meta?.rtl||!1,n=document.createElement("div");n.id="va-exit-overlay",n.innerHTML=`\n      <style>\n        #va-exit-overlay {\n          position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n          background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);\n          z-index: 999998; display: flex; align-items: center; justify-content: center;\n          animation: fadeIn 0.3s ease;\n        }\n        .va-exit-popup {\n          background: linear-gradient(145deg, #1e2642 0%, #191e35 100%);\n          border-radius: 24px; padding: 32px; max-width: 420px; width: 90%;\n          box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 60px rgba(94,106,210,0.15);\n          position: relative; text-align: center;\n          border: 1px solid rgba(94,106,210,0.2);\n          ${t?"direction: rtl;":""}\n        }\n        .va-exit-close {\n          position: absolute; top: 12px; ${t?"left":"right"}: 12px;\n          background: rgba(255,255,255,0.1); border: none; border-radius: 50%;\n          width: 32px; height: 32px; cursor: pointer; display: flex;\n          align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-exit-close:hover { background: rgba(255,255,255,0.2); }\n        .va-exit-close svg { width: 16px; height: 16px; fill: white; }\n        .va-exit-icon {\n          width: 80px; height: 80px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary, #5E6AD2) 0%, #10B981 100%);\n          margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 8px 32px rgba(94,106,210,0.4);\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-exit-icon svg { width: 40px; height: 40px; fill: white; }\n        .va-exit-title {\n          font-size: 24px; font-weight: 700; color: white; margin: 0 0 8px;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n        }\n        .va-exit-subtitle {\n          font-size: 15px; color: rgba(255,255,255,0.7); margin: 0 0 24px;\n          line-height: 1.5;\n        }\n        .va-exit-cta {\n          display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;\n        }\n        .va-exit-btn {\n          padding: 14px 28px; border-radius: 12px; font-size: 15px;\n          font-weight: 600; cursor: pointer; transition: all 0.2s;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n          border: none;\n        }\n        .va-exit-btn-primary {\n          background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n          color: white; box-shadow: 0 4px 20px rgba(94,106,210,0.4);\n        }\n        .va-exit-btn-primary:hover {\n          transform: translateY(-2px); box-shadow: 0 6px 30px rgba(94,106,210,0.6);\n        }\n        .va-exit-btn-secondary {\n          background: rgba(255,255,255,0.1); color: white;\n        }\n        .va-exit-btn-secondary:hover { background: rgba(255,255,255,0.15); }\n        .va-exit-voice-hint {\n          font-size: 12px; color: rgba(94,106,210,0.8); margin-top: 16px;\n          display: flex; align-items: center; justify-content: center; gap: 6px;\n        }\n        .va-exit-voice-hint svg { width: 14px; height: 14px; fill: currentColor; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n      </style>\n\n      <div class="va-exit-popup">\n        <button class="va-exit-close" id="va-exit-close" aria-label="${o.langData?.ui?.ariaClose||"Close"}">\n          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n        </button>\n\n        <div class="va-exit-icon">\n          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>\n        </div>\n\n        <h3 class="va-exit-title">${e?.exitIntent?.title||"Attendez !"}</h3>\n        <p class="va-exit-subtitle">${e?.exitIntent?.subtitle||"Avez-vous des questions ? Notre assistant IA peut vous aider instantanÃ©ment."}</p>\n\n        <div class="va-exit-cta">\n          <button class="va-exit-btn va-exit-btn-primary" id="va-exit-chat">\n            ${e?.exitIntent?.ctaChat||"ðŸ’¬ Discuter maintenant"}\n          </button>\n          <button class="va-exit-btn va-exit-btn-secondary" id="va-exit-demo">\n            ${e?.exitIntent?.ctaDemo||"ðŸ“… RÃ©server une dÃ©mo"}\n          </button>\n        </div>\n\n        <p class="va-exit-voice-hint">\n          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>\n          ${e?.exitIntent?.voiceHint||"Support vocal disponible"}\n        </p>\n      </div>\n    `,(p||document.body).appendChild(n),u("va-exit-close").addEventListener("click",D),u("va-exit-chat").addEventListener("click",()=>{D(),function(){const e=u("va-panel");if(e){e.classList.add("open"),o.isOpen=!0;const t=u("va-input");t&&t.focus()}}(),v("exit_intent_chat_clicked")}),u("va-exit-demo").addEventListener("click",()=>{D(),window.location.href="/booking",v("exit_intent_demo_clicked")}),n.addEventListener("click",e=>{e.target===n&&D()}),v("exit_intent_viewed")}()}function D(){o.exitIntent.dismissed=!0;const e=u("va-exit-overlay");e&&(e.style.animation="fadeOut 0.2s ease",setTimeout(()=>e.remove(),200)),v("exit_intent_dismissed")}function N(){if(o.isOpen)return;const n=o.langData||{},a=n?.meta?.rtl||!1,i=o.socialProof.messages.length>0?o.socialProof.messages:n?.socialProof?.messages||[];if(0===i.length)return;const r=i[Math.floor(Math.random()*i.length)],s=document.createElement("div");s.className="va-social-proof",s.id=`va-sp-${Date.now()}`,s.innerHTML=`\n      <style>\n        .va-social-proof {\n          position: fixed; bottom: 100px; ${a?"left":"right"}: 25px;\n          max-width: 280px; background: linear-gradient(145deg, #1e2642, #191e35);\n          border: 1px solid rgba(94,106,210,0.2); border-radius: 12px;\n          padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n          z-index: 99997; font-family: Inter, -apple-system, sans-serif;\n          animation: slideInRight 0.4s ease, fadeOut 0.3s ease ${e.SOCIAL_PROOF_DURATION-300}ms forwards;\n          ${a?"direction: rtl;":""}\n        }\n        @keyframes slideInRight {\n          from { opacity: 0; transform: translateX(${a?"-":""}30px); }\n          to { opacity: 1; transform: translateX(0); }\n        }\n        @keyframes fadeOut {\n          from { opacity: 1; }\n          to { opacity: 0; }\n        }\n        .va-sp-content { display: flex; align-items: center; gap: 10px; }\n        .va-sp-icon {\n          width: 36px; height: 36px; border-radius: 50%;\n          background: linear-gradient(135deg, #5E6AD2, #10B981);\n          display: flex; align-items: center; justify-content: center;\n          flex-shrink: 0;\n        }\n        .va-sp-icon svg { width: 18px; height: 18px; fill: white; }\n        .va-sp-text { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.4; }\n        .va-sp-time { font-size: 11px; color: rgba(94,106,210,0.7); margin-top: 4px; }\n        .va-sp-close {\n          position: absolute; top: 6px; ${a?"left":"right"}: 6px;\n          background: none; border: none; cursor: pointer;\n          color: rgba(255,255,255,0.4); padding: 2px;\n        }\n        .va-sp-close:hover { color: rgba(255,255,255,0.7); }\n      </style>\n\n      <button class="va-sp-close" aria-label="${o.langData?.ui?.ariaClose||"Close"}">\n        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n        </svg>\n      </button>\n\n      <div class="va-sp-content">\n        <div class="va-sp-icon">\n          <svg viewBox="0 0 24 24">${r.icon&&/^<(?:path|circle|rect|line|polyline|polygon|ellipse|g)\s/.test(r.icon.trim())?r.icon:'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>'}</svg>\n        </div>\n        <div>\n          <div class="va-sp-text">${t(r.text||"")}</div>\n          <div class="va-sp-time">${t(r.time||function(e){const t=e?.socialProof?.times||["Il y a 2 min","Il y a 5 min","Il y a 12 min","Il y a 23 min","Il y a 1h"];return t[Math.floor(Math.random()*t.length)]}(n))}</div>\n        </div>\n      </div>\n    `,(p||document.body).appendChild(s),s.querySelector(".va-sp-close").addEventListener("click",()=>{s.remove()}),setTimeout(()=>{u(s.id)&&s.remove()},e.SOCIAL_PROOF_DURATION),o.socialProof.notificationsShown++,o.socialProof.lastShownTime=Date.now(),v("social_proof_shown",{index:o.socialProof.notificationsShown})}function z(){const e=new Date,t=o.langData.meta.speechSynthesis,n="ar"===o.langData.meta.code,a=[];for(let i=1;i<=7;i++){const o=new Date(e);o.setDate(e.getDate()+i);const r=o.getDay();if((n?[0,1,2,3,4]:[1,2,3,4,5]).includes(r)&&(o.setHours(10,0,0,0),a.push({date:o.toLocaleDateString(t,{weekday:"long",month:"long",day:"numeric"}),time:"10:00",iso:o.toISOString()}),a.length>=3))break}return a}async function B(t){const n=o.langData,a=t.toLowerCase(),i=o.conversationContext;if(i.bookingFlow.active){const n=await async function(t){const n=o.langData,a=t.toLowerCase(),i=o.conversationContext.bookingFlow;if(n.booking.cancelKeywords.some(e=>a.includes(e)))return v("voice_booking_cancelled",{step:i.step}),i.active=!1,i.step=null,i.data={name:null,email:null,datetime:null,service:n.booking.service},n.booking.messages.cancelled;if("name"===i.step){const e=t.trim();return e.length<2?n.booking.messages.askName:(i.data.name=e,i.step="email",n.booking.messages.askEmail.replace("{name}",e))}if("email"===i.step){const a=t.trim().toLowerCase();if(!function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(a))return n.booking.messages.invalidEmail;i.data.email=a,i.step="datetime";const r=await async function(){const t=Date.now();if(o.availableSlotsCache.slots.length>0&&t-o.availableSlotsCache.timestamp<e.SLOT_CACHE_TTL)return o.availableSlotsCache.slots;try{const n=await(await fetch(e.BOOKING_API+"?action=availability",{method:"GET",mode:"cors"})).json();if(n.success&&n.data?.slots){const e=o.langData.meta.speechSynthesis,a=n.data.slots.slice(0,6).map(t=>{const n=new Date(t.start);return{date:n.toLocaleDateString(e,{weekday:"long",month:"long",day:"numeric"}),time:n.toLocaleTimeString(e,{hour:"numeric",minute:"2-digit"}),iso:t.start}});return o.availableSlotsCache={slots:a,timestamp:t},a}}catch(e){console.error("[VocalIA] Slots fetch error:",e)}return z()}();if(0===r.length)return n.booking.messages.noSlots;let s=n.booking.messages.slotsIntro;return r.slice(0,3).forEach((e,t)=>{s+=n.booking.messages.slotFormat.replace("{index}",t+1).replace("{date}",e.date).replace("{time}",e.time)+"\n"}),s+=n.booking.messages.slotsOutro,s}if("datetime"===i.step){const e=o.availableSlotsCache.slots.length>0?o.availableSlotsCache.slots.slice(0,3):z();let t=null;for(const[i,o]of Object.entries(n.booking.slotKeywords))if(o.some(e=>a.includes(e))){t=e[parseInt(i)-1];break}return t?(i.data.datetime=t.iso,i.step="confirm",v("voice_booking_slot_selected",{slot_date:t.date,slot_time:t.time}),n.booking.messages.confirmIntro+n.booking.messages.confirmName.replace("{name}",i.data.name)+"\n"+n.booking.messages.confirmEmail.replace("{email}",i.data.email)+"\n"+n.booking.messages.confirmDate.replace("{date}",t.date).replace("{time}",t.time)+n.booking.messages.confirmOutro):n.booking.messages.slotNotUnderstood}return"confirm"===i.step?n.booking.confirmKeywords.some(e=>a.includes(e))?(i.step="submitting",null):n.booking.messages.confirmPrompt:null}(t);if("submitting"===i.bookingFlow.step)return await async function(){const t=o.langData,n=o.conversationContext.bookingFlow,a=function(){if(window.GeoLocale&&"function"==typeof window.GeoLocale.getTimezone)return window.GeoLocale.getTimezone();try{return{iana:Intl.DateTimeFormat().resolvedOptions().timeZone,offset:(new Date).getTimezoneOffset()}}catch{return{iana:null,offset:(new Date).getTimezoneOffset()}}}(),i=await async function(t){try{return await(await fetch(e.BOOKING_API,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(t)})).json()}catch(e){return console.error("[VocalIA] Booking error:",e),{success:!1,message:e.message}}}({name:n.data.name,email:n.data.email,datetime:n.data.datetime,service:n.data.service||t.booking.service,phone:"",notes:`Booking via voice assistant (${o.currentLang.toUpperCase()})`,timezone:a.iana||`UTC${a.offset>0?"-":"+"}${Math.abs(a.offset/60)}`});return n.active=!1,n.step=null,i.success?(v("voice_booking_completed",{service:n.data.service,datetime:n.data.datetime}),t.booking.messages.success.replace("{email}",n.data.email)):(v("voice_booking_failed",{error:i.message}),t.booking.messages.failure.replace("{message}",i.message))}();if(n)return n}return o.planFeatures&&!1===o.planFeatures.booking||!function(e){const t=o.langData;if(!t?.booking?.keywords)return!1;const n=e.toLowerCase();return t.booking.keywords.some(e=>n.includes(e))}(a)?await async function(t){if(!e.AI_MODE)return null;try{const n=new AbortController,a=setTimeout(()=>n.abort(),e.API_TIMEOUT),i={message:t,language:o.currentLang,sessionId:o.sessionId||`widget_${Date.now()}`,tenant_id:o.tenantId,api_key:e.api_key||void 0,widget_type:"ECOM",history:o.conversationHistory.slice(-10).map(e=>({role:e.role,content:e.content}))};o.conversationHistory.length<=2&&(i.page_context=function(){const e=window.location.pathname,t=document.title||"",n=document.querySelector('meta[property="og:title"]')?.content||"",a=document.querySelector('meta[name="description"]')?.content||"",i=document.querySelector("h1")?.textContent?.trim()||"";let o="general";/\/(product|produit)/i.test(e)?o="product":/\/(collection|category|categorie)/i.test(e)?o="category":/\/(cart|panier)/i.test(e)?o="cart":/\/(checkout|commande)/i.test(e)?o="checkout":/\/(pricing|tarifs|prix)/i.test(e)?o="pricing":/\/(booking|rendez-vous|demo)/i.test(e)?o="booking":("/"===e||"/index.html"===e)&&(o="homepage");const r=document.querySelector('script[type="application/ld+json"]');let s=null;if(r)try{const e=JSON.parse(r.textContent);"Product"===e["@type"]&&(s={name:e.name,price:e.offers?.price,currency:e.offers?.priceCurrency})}catch{}return s||document.querySelector('meta[property="og:type"][content="product"]')&&(s={name:n||i,price:document.querySelector('meta[property="product:price:amount"]')?.content,currency:document.querySelector('meta[property="product:price:currency"]')?.content}),{path:e,pageType:o,title:n||i||t,description:a.slice(0,200),product:s}}());const r=await fetch(e.VOICE_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:n.signal});if(clearTimeout(a),!r.ok)return console.warn("[VocalIA] API error:",r.status),null;const s=await r.json();return s.response?(s.features&&(o.planFeatures=s.features),v("voice_api_response",{language:o.currentLang,latency:s.latencyMs}),s.a2ui&&function(t){if(!t||!t.html)return;const n=u("va-messages");if(!n)return;const a=document.createElement("div");if(a.className="va-message assistant va-a2ui-wrapper",t.css){const e=document.createElement("style");e.textContent=t.css,a.appendChild(e)}const i=document.createElement("div");i.className="va-message-content",i.innerHTML=function(e){const t=/^(div|span|button|p|h[1-6]|ul|ol|li|img|svg|path|line|circle|label|input|select|option|strong|em|br|a)$/i,n=/^(class|id|style|data-[a-z-]+|aria-[a-z]+|role|type|placeholder|value|src|alt|href|viewBox|d|fill|stroke|stroke-width|stroke-linecap|stroke-linejoin|xmlns|width|height|x1|y1|x2|y2|cx|cy|r|loading|dir|disabled)$/i,a=document.createElement("div");a.innerHTML=e;const i=e=>{const a=Array.from(e.childNodes);for(const e of a)if(3!==e.nodeType){if(1!==e.nodeType){e.remove();continue}if(!t.test(e.tagName)){e.remove();continue}for(const t of Array.from(e.attributes))n.test(t.name)||e.removeAttribute(t.name);for(const t of Array.from(e.attributes))t.name.startsWith("on")&&e.removeAttribute(t.name);e.hasAttribute("href")&&/^\s*javascript:/i.test(e.getAttribute("href"))&&e.removeAttribute("href"),e.hasAttribute("src")&&/^\s*javascript:/i.test(e.getAttribute("src"))&&e.removeAttribute("src"),i(e)}};return i(a),a.innerHTML}(t.html),a.appendChild(i),n.appendChild(a),n.scrollTop=n.scrollHeight,a.querySelectorAll("[data-a2ui-action]").forEach(n=>{n.addEventListener("click",()=>{!async function(t,n){if(v("a2ui_action",{action:t,type:n.type}),"select_slot"===t){const e=n.element.closest("[data-a2ui-component]");if(e){e.querySelectorAll(".va-a2ui-slot").forEach(e=>e.classList.remove("selected")),n.element.classList.add("selected");const t=e.querySelector('[data-a2ui-action="confirm_booking"]');t&&(t.disabled=!1)}return}if("close"===t)return void n.wrapper.remove();const a={},i=n.element.closest("[data-a2ui-component]");if("confirm_booking"===t&&i){const e=i.querySelector(".va-a2ui-slot.selected");a.slot=e?.dataset.slot}else if("submit_lead"===t&&i){const e=i.querySelector("form");e&&new FormData(e).forEach((e,t)=>{a[t]=e})}try{const n=await(await fetch(e.VOICE_API_URL.replace("/respond","/a2ui/action"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t,data:a,sessionId:o.sessionId,tenant_id:o.tenantId,widget_type:"ECOM"})})).json();n.message&&h(n.message,"assistant")}catch(e){console.warn("[VocalIA ECOM] A2UI action failed:",e.message)}}(n.dataset.a2uiAction,{type:t.type,value:n.dataset.slot||n.dataset.productId||null,element:n,wrapper:a})})}),v("a2ui_rendered",{type:t.type})}(s.a2ui),s.catalog&&s.catalog.items&&s.catalog.items.length>0&&b(s.catalog.items,s.catalog.title,"api_response"),s.response):null}catch(e){"AbortError"===e.name?console.error("[VocalIA] API timeout"):console.error("[VocalIA] API error:",e.message);const t=o.langData?.ui||{};return"AbortError"===e.name?t.timeoutMessage||t.errorMessage||"The request took too long. Please try again.":t.connectionError||t.errorMessage||"Sorry, I'm experiencing a connection issue."}}(t)||n?.ui?.errorMessage||"DÃ©solÃ©, je suis temporairement indisponible. Veuillez rÃ©essayer.":(i.bookingFlow.active=!0,i.bookingFlow.step="name",i.bookingFlow.data.service=n.booking.service,v("voice_booking_started",{step:"name"}),n.booking.messages.start)}async function U(t,n="text"){if(t.trim()){"voice"!==(a=n)&&"text"!==a||(o.ecommerce.inputMethodStats[a]++,o.ecommerce.lastInputMethod=a,v("input_method_used",{method:a,total_voice:o.ecommerce.inputMethodStats.voice,total_text:o.ecommerce.inputMethodStats.text,voice_ratio:o.ecommerce.inputMethodStats.voice/(o.ecommerce.inputMethodStats.voice+o.ecommerce.inputMethodStats.text)})),h(t,"user"),u("va-input").value="",function(){const e=u("va-messages"),t=document.createElement("div");t.className="va-message assistant",t.id="va-typing",t.innerHTML='<div class="va-message-content"><div class="va-typing"><span></span><span></span><span></span></div></div>',e.appendChild(t),e.scrollTop=e.scrollHeight}();try{if(e.ECOMMERCE_MODE&&o.tenantId){const a=function(e){const t=e.toLowerCase(),n=o.langData,a=n?.ecommerce?.searchKeywords||["cherche","recherche","trouve","looking for","search","find","busco","necesito","quiero","Ø¨Ø­Ø«","Ù†Ø¨ØºÙŠ","Ø¨Ø§ØºÙŠ"],i=n?.ecommerce?.categoryKeywords||{electronics:["tÃ©lÃ©phone","phone","laptop","ordinateur","Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª"],clothing:["vÃªtement","clothes","robe","pantalon","Ù…Ù„Ø§Ø¨Ø³","Ø­ÙˆØ§ÙŠØ¬"],food:["nourriture","food","manger","Ø£ÙƒÙ„","Ù…Ø§ÙƒÙ„Ø©"],beauty:["beautÃ©","cosmÃ©tique","beauty","makeup","Ø²ÙŠÙ†Ø©","Ø¬Ù…Ø§Ù„"]},r=n?.ecommerce?.recommendKeywords||["recommande","suggÃ¨re","propose","recommend","suggest","recomienda","sugiere","Ù†ØµØ­Ù†ÙŠ","Ø´ÙˆÙ Ù„ÙŠ","Ù‚ØªØ±Ø­"],s=a.some(e=>t.includes(e)),c=r.some(e=>t.includes(e));let l=null;for(const[e,n]of Object.entries(i))if(n.some(e=>t.includes(e))){l=e;break}let d=null;if(s){const t=e.split(/\s+/).filter(e=>e.length>2&&!a.includes(e.toLowerCase()));t.length>0&&(d=t.slice(-3).join(" "))}return s||c||l?{type:s?"search":c?"recommend":"category",category:l,query:d}:null}(t);if(a){v("product_intent_detected",{intent_type:a.type,category:a.category,query:a.query,input_method:n});let i=[];if(i="search"===a.type&&a.query?await E.searchProducts(a.query):"recommend"===a.type?await E.getRecommendations():await E.fetchProducts({category:a.category,limit:e.MAX_CAROUSEL_ITEMS}),0===i.length&&(i=await async function(t={}){if(!e.ECOMMERCE_MODE||!o.tenantId)return[];const n=JSON.stringify({tenantId:o.tenantId,...t}),a=Date.now();if(o.catalogCache.key===n&&a-o.catalogCache.timestamp<e.CATALOG_CACHE_TTL)return o.catalogCache.products;try{const i=t.search?`${e.CATALOG_API_URL}/${o.tenantId}/catalog/search`:`${e.CATALOG_API_URL}/${o.tenantId}/catalog`,r=new URLSearchParams;t.category&&r.append("category",t.category),t.search&&r.append("q",t.search),t.limit&&r.append("limit",t.limit);const s=r.toString()?`${i}?${r}`:i,c=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!c.ok)return console.warn("[VocalIA] Catalog API error:",c.status),[];const l=await c.json(),d=l.items||l.results||l.products||[];return o.catalogCache={key:n,products:d,timestamp:a},d}catch(e){return console.warn("[VocalIA] Catalog fetch error:",e.message),[]}}({category:a.category,search:a.query,limit:e.MAX_CAROUSEL_ITEMS})),i.length>0)return f(),S.recordInteraction("product_search",{intent:a.type,category:a.category,query:a.query,results_count:i.length}),b(i,a.query?`${o.langData?.ecommerce?.resultsFor||"RÃ©sultats pour"} "${a.query}"`:null,a.type),void h(await B(t),"assistant")}}const a=await B(t);f(),h(a,"assistant")}catch(e){f(),h(o.langData.ui.errorMessage,"assistant"),console.error("[VocalIA] Response error:",e)}}var a}function j(){o.isOpen=!o.isOpen;const e=u("va-panel");if(o.isOpen){e.classList.add("open"),v("voice_panel_opened");const n=u("va-messages");if(o.conversationHistory.length>0&&n&&0===n.children.length){for(const e of o.conversationHistory){const a=document.createElement("div");a.className=`va-message ${e.role}`,a.innerHTML=`<div class="va-message-content">${t(e.content)}</div>`,n.appendChild(a)}n.scrollTop=n.scrollHeight}else if(0===o.conversationHistory.length){const e=o.langData;h(d?e.ui.welcomeMessageTextOnly:e.ui.welcomeMessage,"assistant")}u("va-input").focus()}else e.classList.remove("open"),o.synthesis&&o.synthesis.cancel(),v("voice_panel_closed")}const F=new Set(["DEFAULT_LANG","ECOMMERCE_MODE","EXIT_INTENT_ENABLED","EXIT_INTENT_DELAY","EXIT_INTENT_SENSITIVITY","EXIT_INTENT_COOLDOWN","EXIT_INTENT_MOBILE_SCROLL_RATIO","EXIT_INTENT_PAGES","SOCIAL_PROOF_ENABLED","SOCIAL_PROOF_INTERVAL","SOCIAL_PROOF_DURATION","SOCIAL_PROOF_MAX_SHOWN","MAX_CAROUSEL_ITEMS","AI_MODE","API_TIMEOUT"]);function q(t){if(t&&"object"==typeof t)for(const n of Object.keys(t))F.has(n)&&(e[n]=t[n])}async function G(){try{window.VOCALIA_CONFIG_INJECTED&&q(window.VOCALIA_CONFIG_INJECTED),window.VOCALIA_CONFIG&&q(window.VOCALIA_CONFIG);const t=function(){const t=new URLSearchParams(window.location.search).get("lang");if(t&&e.SUPPORTED_LANGS.includes(t))return t;const n=document.documentElement.lang?.toLowerCase()?.split("-")[0];if(n&&e.SUPPORTED_LANGS.includes(n))return n;const a=navigator.language||navigator.userLanguage,i=e.AUTO_DETECT_LANGUAGES[a]||e.AUTO_DETECT_LANGUAGES[a?.split("-")[0]];return i&&e.SUPPORTED_LANGS.includes(i)?i:e.DEFAULT_LANG}();await m(t),function(){if(e.tenantId)return void(o.tenantId=e.tenantId);const t=document.querySelector("script[data-vocalia-tenant]")||document.querySelector("script[data-tenant-id]");if(t)return void(o.tenantId=t.dataset.vocaliaTenant||t.dataset.tenantId);const n=new URLSearchParams(window.location.search),a=n.get("tenant_id")||n.get("tenantId");if(a)return void(o.tenantId=a);const i=document.querySelector('meta[name="vocalia-tenant"]');if(i)return void(o.tenantId=i.content);if(window.VOCALIA_TENANT_ID)return void(o.tenantId=window.VOCALIA_TENANT_ID);const r=document.getElementById("vocalia-widget")||document.getElementById("voice-assistant-widget");r?.dataset.tenantId&&(o.tenantId=r.dataset.tenantId)}(),o.tenantId&&(await async function(){if(!o.tenantId)return null;const t=`${e.VOICE_API_URL.replace("/respond","/config")}?tenantId=${encodeURIComponent(o.tenantId)}`;try{const n=await fetch(t,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!n.ok)throw new Error("Config fetch failed");const a=await n.json();if(a.success){if(a.branding&&a.branding.primaryColor){e.primaryColor=a.branding.primaryColor;const t=document.getElementById("voice-assistant-widget");t&&t.style.setProperty("--va-primary",e.primaryColor)}return o.tenantConfig=a,a.plan_features&&(o.planFeatures=a.plan_features),a.currency&&(o.currency=a.currency),v("tenant_config_loaded",{tenantId:o.tenantId,plan:a.plan}),a}}catch(e){console.warn("[VocalIA ECOM] Config fetch failed, using static defaults:",e.message)}return null}(),e.ECOMMERCE_MODE&&S.syncPreference().catch(e=>console.warn("[VocalIA] UCP init failed:",e.message))),function(){const e=new URLSearchParams(window.location.search),t=o.conversationContext.attribution;t.utm_source=e.get("utm_source")||t.utm_source,t.utm_medium=e.get("utm_medium")||t.utm_medium,t.utm_campaign=e.get("utm_campaign")||t.utm_campaign,t.gclid=e.get("gclid")||t.gclid,t.fbclid=e.get("fbclid")||t.fbclid}(),function(){if(document.getElementById("voice-assistant-widget"))return;const t=o.langData,n=t.meta.rtl,a=n?"left":"right",i=document.createElement("div");i.id="voice-assistant-widget",i.style.cssText=`position:fixed;bottom:30px;${a}:25px;z-index:99999;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;${n?"direction:rtl;":""}`,document.body.appendChild(i),p=i.attachShadow({mode:"open"}),p.innerHTML=function(t,n,a){return`\n      <style>\n        #voice-assistant-widget {\n          --va-primary: ${e.primaryColor};\n          --va-primary-dark: ${e.primaryDark};\n          --va-accent: ${e.accentColor};\n          --va-dark: ${e.darkBg};\n        }\n        .va-trigger {\n          width: 60px; height: 60px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4);\n          transition: all 0.3s ease; position: relative;\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-trigger::before {\n          content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;\n          border-radius: 50%; background: linear-gradient(135deg, var(--va-primary), var(--va-accent));\n          opacity: 0; z-index: -1; animation: pulse-ring 2s ease-out infinite;\n        }\n        .va-trigger::after {\n          content: ''; position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px;\n          border-radius: 50%; border: 2px solid var(--va-primary);\n          opacity: 0; animation: pulse-ring-outer 2s ease-out infinite 0.5s;\n        }\n        @keyframes pulse-glow {\n          0%, 100% { box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4); transform: scale(1); }\n          50% { box-shadow: 0 4px 30px rgba(94, 106, 210, 0.7); transform: scale(1.02); }\n        }\n        @keyframes pulse-ring {\n          0% { transform: scale(1); opacity: 0.6; }\n          100% { transform: scale(1.4); opacity: 0; }\n        }\n        @keyframes pulse-ring-outer {\n          0% { transform: scale(1); opacity: 0.4; }\n          100% { transform: scale(1.6); opacity: 0; }\n        }\n        .va-trigger:hover {\n          transform: scale(1.1); box-shadow: 0 6px 30px rgba(94, 106, 210, 0.6); animation: none;\n        }\n        .va-trigger:hover::before, .va-trigger:hover::after { animation: none; opacity: 0; }\n        .va-trigger img { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; }\n        .va-trigger.listening { animation: pulse 1.5s infinite; }\n        @keyframes pulse {\n          0%, 100% { box-shadow: 0 0 0 0 rgba(94, 106, 210, 0.7); }\n          50% { box-shadow: 0 0 0 15px rgba(94, 106, 210, 0); }\n        }\n        .va-panel {\n          display: none; position: absolute; bottom: 70px; ${a}: 0;\n          width: 360px; max-height: 500px; background: var(--va-dark);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;\n          overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n          ${n?"direction: rtl; text-align: right;":""}\n        }\n        .va-panel.open { display: flex; flex-direction: column; animation: slideUp 0.3s ease; }\n        @keyframes slideUp {\n          from { opacity: 0; transform: translateY(20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        .va-header {\n          padding: 16px;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          display: flex; align-items: center; gap: 12px; ${n?"flex-direction: row-reverse;":""}\n        }\n        .va-header-icon {\n          width: 40px; height: 40px; background: rgba(255,255,255,0.2);\n          border-radius: 50%; display: flex; align-items: center; justify-content: center;\n        }\n        .va-header-icon img { width: 24px; height: 24px; object-fit: contain; border-radius: 4px; }\n        .va-header-text h3 { margin: 0; font-size: 16px; font-weight: 600; color: white; }\n        .va-header-text p { margin: 2px 0 0; font-size: 12px; color: rgba(255,255,255,0.8); }\n        .va-close {\n          margin-${n?"right":"left"}: auto; background: none; border: none;\n          color: white; cursor: pointer; padding: 4px; opacity: 0.8;\n        }\n        .va-close:hover { opacity: 1; }\n        .va-messages { flex: 1; overflow-y: auto; padding: 16px; max-height: 300px; }\n        .va-message { margin-bottom: 12px; display: flex; gap: 8px; }\n        .va-message.user { flex-direction: ${n?"row":"row-reverse"}; }\n        .va-message.assistant { flex-direction: ${n?"row-reverse":"row"}; }\n        .va-message-content {\n          max-width: 80%; padding: 10px 14px; border-radius: 12px;\n          font-size: 14px; line-height: 1.5;\n        }\n        .va-message.assistant .va-message-content { background: rgba(255,255,255,0.1); color: #e5e5e5; }\n        .va-message.user .va-message-content { background: var(--va-primary); color: white; }\n        .va-input-area {\n          padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.1);\n          display: flex; gap: 8px; ${n?"flex-direction: row-reverse; direction: rtl; text-align: right;":""}\n        }\n        .va-input {\n          flex: 1; background: rgba(255,255,255,0.1);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;\n          padding: 10px 16px; color: white; font-size: 14px; outline: none;\n          ${n?"direction: rtl; text-align: right;":""}\n        }\n        .va-input::placeholder { color: rgba(255,255,255,0.5); }\n        .va-input:focus { border-color: var(--va-primary); }\n        .va-mic-btn {\n          width: 40px; height: 40px; border-radius: 50%;\n          background: ${r||typeof MediaRecorder<"u"?"var(--va-primary)":"rgba(255,255,255,0.1)"};\n          border: none; cursor: ${r||typeof MediaRecorder<"u"?"pointer":"not-allowed"};\n          display: flex; align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-mic-btn.listening { background: #ef4444; animation: pulse 1s infinite; }\n        .va-mic-btn svg { width: 20px; height: 20px; fill: white; }\n\n        /* Voice Waveform Visualizer (SOTA 2026) */\n        .va-visualizer {\n          height: 48px; padding: 8px 16px; display: none;\n          background: linear-gradient(180deg, rgba(94,106,210,0.1) 0%, transparent 100%);\n          border-bottom: 1px solid rgba(255,255,255,0.05);\n        }\n        .va-visualizer.active { display: block; animation: fadeIn 0.3s ease; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n        .va-visualizer-canvas {\n          width: 100%; height: 100%; display: block;\n        }\n        .va-visualizer-bars {\n          display: flex; align-items: center; justify-content: center;\n          gap: 3px; height: 100%;\n        }\n        .va-visualizer-bar {\n          width: 3px; border-radius: 2px; background: var(--va-primary);\n          transition: height 0.1s ease;\n        }\n        .va-visualizer-bars.speaking .va-visualizer-bar {\n          animation: soundBar 0.5s ease-in-out infinite alternate;\n        }\n        @keyframes soundBar {\n          0% { height: 4px; opacity: 0.5; }\n          100% { height: var(--bar-height, 24px); opacity: 1; }\n        }\n        .va-visualizer-bar:nth-child(1) { animation-delay: 0.0s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(2) { animation-delay: 0.1s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(3) { animation-delay: 0.2s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(4) { animation-delay: 0.1s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(5) { animation-delay: 0.15s; --bar-height: 36px; }\n        .va-visualizer-bar:nth-child(6) { animation-delay: 0.2s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(7) { animation-delay: 0.25s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(8) { animation-delay: 0.15s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(9) { animation-delay: 0.1s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(10) { animation-delay: 0.05s; --bar-height: 16px; }\n        .va-visualizer-label {\n          font-size: 10px; color: rgba(255,255,255,0.5); text-align: center;\n          margin-top: 4px; text-transform: uppercase; letter-spacing: 1px;\n        }\n        .va-visualizer-label.listening { color: #ef4444; }\n        .va-visualizer-label.speaking { color: var(--va-primary); }\n        .va-send-btn {\n          width: 40px; height: 40px; border-radius: 50%; background: var(--va-primary);\n          border: none; cursor: pointer; display: flex; align-items: center;\n          justify-content: center; transition: all 0.2s;\n        }\n        .va-send-btn:hover { transform: scale(1.1); }\n        .va-send-btn svg { width: 20px; height: 20px; fill: white; ${n?"transform: scaleX(-1);":""} }\n        .va-typing { display: flex; gap: 4px; padding: 10px 14px; direction: ltr; }\n        .va-typing span {\n          width: 8px; height: 8px; background: rgba(255,255,255,0.5);\n          border-radius: 50%; animation: typing 1.4s infinite ease-in-out;\n        }\n        .va-typing span:nth-child(2) { animation-delay: 0.2s; }\n        .va-typing span:nth-child(3) { animation-delay: 0.4s; }\n        @keyframes typing {\n          0%, 60%, 100% { transform: translateY(0); }\n          30% { transform: translateY(-6px); }\n        }\n        .va-cta {\n          padding: 12px 16px; background: rgba(94, 106, 210, 0.1);\n          border-top: 1px solid rgba(94, 106, 210, 0.2);\n        }\n        .va-cta a {\n          display: block; text-align: center; padding: 10px;\n          background: var(--va-primary); color: white; text-decoration: none;\n          border-radius: 8px; font-size: 14px; font-weight: 500; transition: all 0.2s;\n        }\n        .va-cta a:hover { background: var(--va-primary-dark); }\n        @keyframes notifSlideIn {\n          from { opacity: 0; transform: translateX(${n?"-":""}20px) scale(0.9); }\n          to { opacity: 1; transform: translateX(0) scale(1); }\n        }\n        @keyframes notifSlideOut {\n          from { opacity: 1; transform: translateX(0) scale(1); }\n          to { opacity: 0; transform: translateX(${n?"-":""}20px) scale(0.9); }\n        }\n        @media (max-width: 480px) { .va-panel { width: calc(100vw - 40px); ${a}: -10px; } }\n\n        /* E-commerce Product Cards & Carousel (Phase 1) */\n        .va-product-carousel {\n          display: flex; gap: 12px; overflow-x: auto; padding: 8px 0 12px;\n          scrollbar-width: thin; scrollbar-color: var(--va-primary) transparent;\n          scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;\n        }\n        .va-product-carousel::-webkit-scrollbar { height: 4px; }\n        .va-product-carousel::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }\n        .va-product-carousel::-webkit-scrollbar-thumb { background: var(--va-primary); border-radius: 4px; }\n        .va-product-card {\n          flex: 0 0 auto; width: 140px; background: rgba(255,255,255,0.05);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;\n          overflow: hidden; cursor: pointer; transition: all 0.2s ease;\n          scroll-snap-align: start;\n        }\n        .va-product-card:hover {\n          border-color: var(--va-primary); transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(94, 106, 210, 0.2);\n        }\n        .va-product-card.featured {\n          border-color: var(--va-accent);\n          background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(255,255,255,0.05) 100%);\n        }\n        .va-product-img {\n          width: 100%; height: 100px; object-fit: cover;\n          background: rgba(255,255,255,0.1);\n        }\n        .va-product-img-placeholder {\n          width: 100%; height: 100px; display: flex; align-items: center; justify-content: center;\n          background: linear-gradient(135deg, rgba(94,106,210,0.1) 0%, rgba(16,185,129,0.1) 100%);\n          color: rgba(255,255,255,0.3); font-size: 32px;\n        }\n        .va-product-info { padding: 10px; }\n        .va-product-name {\n          font-size: 12px; font-weight: 600; color: #e5e5e5;\n          margin: 0 0 4px; line-height: 1.3;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-product-price {\n          font-size: 14px; font-weight: 700; color: var(--va-primary);\n          display: flex; align-items: baseline; gap: 4px;\n        }\n        .va-product-price-old {\n          font-size: 10px; color: rgba(255,255,255,0.4);\n          text-decoration: line-through; font-weight: 400;\n        }\n        .va-product-badge {\n          position: absolute; top: 8px; ${a}: 8px;\n          background: var(--va-accent); color: white; font-size: 9px;\n          padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase;\n        }\n        .va-product-badge.sale { background: #ef4444; }\n        .va-product-badge.new { background: var(--va-primary); }\n        .va-product-stock {\n          font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px;\n        }\n        .va-product-stock.low { color: #f59e0b; }\n        .va-product-stock.out { color: #ef4444; }\n        .va-carousel-header {\n          display: flex; justify-content: space-between; align-items: center;\n          padding: 8px 0; margin-bottom: 4px;\n        }\n        .va-carousel-title {\n          font-size: 13px; font-weight: 600; color: #e5e5e5;\n          display: flex; align-items: center; gap: 6px;\n        }\n        .va-carousel-title svg { width: 16px; height: 16px; fill: var(--va-primary); }\n        .va-carousel-nav {\n          display: flex; gap: 4px;\n        }\n        .va-carousel-nav button {\n          width: 24px; height: 24px; border-radius: 50%; border: none;\n          background: rgba(255,255,255,0.1); color: white; cursor: pointer;\n          display: flex; align-items: center; justify-content: center;\n          transition: all 0.2s;\n        }\n        .va-carousel-nav button:hover { background: var(--va-primary); }\n        .va-carousel-nav button:disabled { opacity: 0.3; cursor: not-allowed; }\n        .va-carousel-nav button svg { width: 14px; height: 14px; fill: currentColor; }\n        .va-product-actions {\n          display: flex; gap: 4px; margin-top: 8px;\n        }\n        .va-product-btn {\n          flex: 1; padding: 6px 8px; border-radius: 6px; border: none;\n          font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;\n        }\n        .va-product-btn.primary {\n          background: var(--va-primary); color: white;\n        }\n        .va-product-btn.primary:hover { background: var(--va-primary-dark); }\n        .va-product-btn.secondary {\n          background: rgba(255,255,255,0.1); color: #e5e5e5;\n        }\n        .va-product-btn.secondary:hover { background: rgba(255,255,255,0.2); }\n        .va-single-product {\n          background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);\n          border-radius: 12px; padding: 12px; margin: 8px 0;\n        }\n        .va-single-product-row { display: flex; gap: 12px; }\n        .va-single-product-img {\n          width: 80px; height: 80px; border-radius: 8px; object-fit: cover;\n          background: rgba(255,255,255,0.1); flex-shrink: 0;\n        }\n        .va-single-product-details { flex: 1; min-width: 0; }\n        .va-single-product-name {\n          font-size: 14px; font-weight: 600; color: #e5e5e5; margin: 0 0 4px;\n        }\n        .va-single-product-desc {\n          font-size: 11px; color: rgba(255,255,255,0.6); margin: 0 0 8px;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-single-product-price {\n          font-size: 16px; font-weight: 700; color: var(--va-primary);\n        }\n        .va-input-method-indicator {\n          position: absolute; top: 12px; ${n?"left":"right"}: 50px;\n          font-size: 10px; color: rgba(255,255,255,0.4); display: flex; gap: 8px;\n        }\n        .va-input-method-indicator span {\n          display: flex; align-items: center; gap: 3px;\n        }\n        .va-input-method-indicator svg { width: 12px; height: 12px; fill: currentColor; }\n        .va-input-method-indicator .active { color: var(--va-primary); }\n      </style>\n\n      <button class="va-trigger" id="va-trigger" aria-label="${t.ui.ariaOpenAssistant}">\n        <img src="${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/logo.png":"https://vocalia.ma/logo.png"}" alt="VocalIA" />\n      </button>\n\n      <div class="va-panel" id="va-panel" role="dialog" aria-label="${t.ui.headerTitle}" aria-modal="true">\n        <div class="va-header">\n          <div class="va-header-icon">\n            <img src="${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/logo.png":"https://vocalia.ma/logo.png"}" alt="VocalIA" />\n          </div>\n          <div class="va-header-text">\n            <h3>${t.ui.headerTitle}</h3>\n            <p>${d?t.ui.headerSubtitleText:t.ui.headerSubtitleVoice}</p>\n          </div>\n          <button class="va-close" id="va-close" aria-label="${t.ui.ariaClose}">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n        </div>\n\n        \x3c!-- Voice Waveform Visualizer (SOTA 2026) --\x3e\n        <div class="va-visualizer" id="va-visualizer" aria-hidden="true">\n          <div class="va-visualizer-bars" id="va-visualizer-bars">\n            ${Array.from({length:10},()=>'<div class="va-visualizer-bar"></div>').join("")}\n          </div>\n          <div class="va-visualizer-label" id="va-visualizer-label">${t.ui.voiceReady||"Voice Ready"}</div>\n        </div>\n\n        <div class="va-messages" id="va-messages" aria-live="polite" aria-relevant="additions"></div>\n\n        <div class="va-input-area">\n          <input type="text" class="va-input" id="va-input" placeholder="${t.ui.placeholder}">\n          ${r||typeof MediaRecorder<"u"?`\n          <button class="va-mic-btn" id="va-mic" aria-label="${t.ui.ariaMic||"Microphone"}">\n            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/></svg>\n          </button>\n          `:""}\n          <button class="va-send-btn" id="va-send" aria-label="${t.ui.ariaSend}">\n            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n          </button>\n        </div>\n\n        <div class="va-cta">\n          <a href="${t.ui.ctaLink}">${t.ui.ctaButton}</a>\n        </div>\n      </div>\n    `}(t,n,a),function(){u("va-trigger").addEventListener("click",j),u("va-close").addEventListener("click",j),u("va-send").addEventListener("click",()=>{U(u("va-input").value,"text")}),u("va-input").addEventListener("keypress",e=>{"Enter"===e.key&&U(e.target.value,"text")}),function(){if(r){const e=window.SpeechRecognition||window.webkitSpeechRecognition;o.recognition=new e,o.recognition.lang=o.langData.meta.speechRecognition,o.recognition.continuous=!1,o.recognition.interimResults=!1,o.recognition.onresult=e=>{const t=e.results[0][0].transcript;u("va-input").value=t,U(t,"voice"),e.results[0][0].confidence&&v("voice_recognition_result",{confidence:e.results[0][0].confidence,detected_lang:o.recognition.lang})},o.recognition.onend=()=>{o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),C()},o.recognition.onerror=e=>{o.isListening=!1,u("va-mic")?.classList.remove("listening"),C(),v("voice_recognition_error",{error:e.error})},o.sttMode="native"}else navigator.mediaDevices&&typeof MediaRecorder<"u"?(o.sttMode="fallback",console.log("[VocalIA ECOM] Using MediaRecorder STT fallback")):o.sttMode="none"}();const e=u("va-mic");e&&"none"!==o.sttMode?e.addEventListener("click",k):e&&"none"===o.sttMode&&(e.style.display="none"),document.addEventListener("keydown",e=>{if(o.isOpen){if("Escape"===e.key){j();const e=u("va-trigger");return void(e&&e.focus())}if("Tab"===e.key){const t=u("va-panel");if(!t)return;const n=t.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');if(0===n.length)return;const a=n[0],i=n[n.length-1],o=(p||document).activeElement;e.shiftKey&&o===a?(e.preventDefault(),i.focus()):!e.shiftKey&&o===i&&(e.preventDefault(),a.focus())}}})}(),setTimeout(()=>{o.isOpen||function(){const e=o.langData,t=e.meta.rtl,n=t?"left":"right",a=u("va-trigger"),i=document.createElement("div");i.className="va-notification",i.innerHTML=`\n      <div class="va-notif-icon">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n        </svg>\n      </div>\n      <div class="va-notif-text">\n        <span class="va-notif-title">${e.ui.notifTitle}</span>\n        <span class="va-notif-sub">${e.ui.notifSub}</span>\n      </div>\n    `,i.style.cssText=`\n      position: absolute; bottom: 75px; ${n}: 0;\n      display: flex; align-items: center; gap: 10px;\n      background: rgba(25, 30, 53, 0.95);\n      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n      border: 1px solid rgba(94, 106, 210, 0.3);\n      padding: 12px 16px; border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(94, 106, 210, 0.15);\n      animation: notifSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer; white-space: nowrap; z-index: 9999;\n      ${t?"direction: rtl; flex-direction: row-reverse;":""}\n    `;const r=i.querySelector(".va-notif-icon");r&&(r.style.cssText="width: 32px; height: 32px; background: linear-gradient(135deg, rgba(94, 106, 210, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #5E6AD2; flex-shrink: 0;");const s=i.querySelector(".va-notif-text");s&&(s.style.cssText="display: flex; flex-direction: column; gap: 2px;");const c=i.querySelector(".va-notif-title");c&&(c.style.cssText="font-size: 14px; font-weight: 600; color: #E4F4FC;");const l=i.querySelector(".va-notif-sub");l&&(l.style.cssText="font-size: 11px; color: rgba(255, 255, 255, 0.7);");const d=document.createElement("div");d.style.cssText=`position: absolute; bottom: -6px; ${n}: 24px; width: 12px; height: 12px; background: rgba(25, 30, 53, 0.95); border-${t?"left":"right"}: 1px solid rgba(94, 106, 210, 0.3); border-bottom: 1px solid rgba(94, 106, 210, 0.3); transform: rotate(${t?"-":""}45deg);`,i.appendChild(d),a.parentNode.appendChild(i),i.addEventListener("click",j),setTimeout(()=>{i.style.animation="notifSlideOut 0.3s ease forwards",setTimeout(()=>i.remove(),300)},6e3)}()},2e3)}(),function(){if(!e.EXIT_INTENT_ENABLED)return;let t=null;try{t=localStorage.getItem("vocalia_exit_intent_shown")}catch{}t&&Date.now()-parseInt(t)<e.EXIT_INTENT_COOLDOWN||e.EXIT_INTENT_PAGES&&!e.EXIT_INTENT_PAGES.includes(window.location.pathname)||(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?window.addEventListener("scroll",R,{passive:!0}):(document.addEventListener("mouseleave",M),document.addEventListener("mouseout",P)))}(),async function(){if(e.SOCIAL_PROOF_ENABLED){try{const t=`${e.SOCIAL_PROOF_API_URL}?lang=${o.currentLang}`,n=await(await fetch(t,{signal:AbortSignal.timeout(5e3)})).json();n.success&&Array.isArray(n.messages)&&n.messages.length>0&&(o.socialProof.messages=n.messages)}catch(e){console.warn("[VocalIA ECOM] Social proof API unavailable, using lang data:",e.message)}setTimeout(()=>{N(),o.socialProof.intervalId=setInterval(()=>{o.socialProof.notificationsShown<e.SOCIAL_PROOF_MAX_SHOWN?N():clearInterval(o.socialProof.intervalId)},e.SOCIAL_PROOF_INTERVAL)},e.SOCIAL_PROOF_DELAY)}}(),function(){if(!e.ECOMMERCE_MODE||!o.tenantId)return;const t=o.planFeatures||{},n=e=>!1!==t[e],a=()=>{if(window.VocaliaShippingBar)try{window.VocaliaShippingBar.init({tenantId:o.tenantId,lang:o.currentLang,currency:o.currency||"EUR",voiceEnabled:!0}),x.activate("shippingBar")}catch(e){console.warn("[VocalIA] ShippingBar init failed:",e.message)}},i=()=>{!window.VocaliaSpinWheel||!window.VocalIA.isSpinWheelAvailable()||setTimeout(()=>{if(!o.isOpen&&x.canShow("spinWheel"))try{window.VocaliaSpinWheel.show({tenantId:o.tenantId,lang:o.currentLang,voiceEnabled:!0}),x.activate("spinWheel")}catch(e){console.warn("[VocalIA] SpinWheel init failed:",e.message)}},15e3)},r=()=>{if(window.VocalIARecommendations)try{window.VocalIA.RecommendationCarousel=window.VocalIARecommendations,x.activate("recommendations")}catch(e){console.warn("[VocalIA] RecommendationCarousel init failed:",e.message)}};window.VocaliaShippingBar?a():A("shippingBar").then(a).catch(()=>{}),n("ecom_gamification")&&(window.VocaliaSpinWheel?i():A("spinWheel").then(i).catch(()=>{})),n("ecom_recommendations")&&(window.VocalIARecommendations?r():A("recommendations").then(r).catch(()=>{})),setTimeout(()=>{n("ecom_cart_recovery")&&A("abandonedCart").catch(()=>{}),n("ecom_quiz")&&A("quiz").catch(()=>{})},5e3)}(),v("voice_widget_loaded",{language:o.currentLang,ecommerce_mode:e.ECOMMERCE_MODE&&!!o.tenantId,tenant_id:o.tenantId,exit_intent_enabled:e.EXIT_INTENT_ENABLED,social_proof_enabled:e.SOCIAL_PROOF_ENABLED})}catch(e){console.error("[VocalIA] Init error:",e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",G):G()}();