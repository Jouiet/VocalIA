/* VocalIA Widget v2.7.0 - 2026-02-08 */
!function(){"use strict";const e={fr:{title:"Votre panier vous attend !",subtitle:"Vous avez {{count}} article(s) dans votre panier",subtitleSingular:"Vous avez 1 article dans votre panier",voiceReminder:"Attendez ! Ne partez pas les mains vides...",valueLabel:"Valeur totale :",offerLabel:"Offre exclusive :",offerText:"{{discount}}% de reduction si vous finalisez maintenant",callbackTitle:"Rappel vocal gratuit",callbackDesc:"Recevez un rappel vocal personnalise",smsTitle:"Rappel par SMS",smsDesc:"Lien direct vers votre panier",emailTitle:"Rappel par email",emailDesc:"Recapitulatif de votre panier",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"votre@email.com",sendBtn:"Recevoir le rappel",checkoutBtn:"Finaliser ma commande",continueBrowsing:"Continuer mes achats",successCallback:"Parfait ! Vous recevrez un appel dans quelques minutes.",successSms:"SMS envoye ! Verifiez votre telephone.",successEmail:"Email envoye ! Verifiez votre boite de reception.",errorInvalid:"Veuillez entrer un numero ou email valide",errorSend:"Erreur lors de l'envoi. Reessayez.",cartItemsLabel:"Articles :",expiresIn:"Offre valable encore {{minutes}} min"},en:{title:"Your cart is waiting!",subtitle:"You have {{count}} item(s) in your cart",subtitleSingular:"You have 1 item in your cart",voiceReminder:"Wait! Don't leave empty-handed...",valueLabel:"Total value:",offerLabel:"Exclusive offer:",offerText:"{{discount}}% off if you complete now",callbackTitle:"Free voice callback",callbackDesc:"Get a personalized voice reminder",smsTitle:"SMS reminder",smsDesc:"Direct link to your cart",emailTitle:"Email reminder",emailDesc:"Summary of your cart",phonePlaceholder:"+1 XXX XXX XXXX",emailPlaceholder:"your@email.com",sendBtn:"Get reminder",checkoutBtn:"Complete my order",continueBrowsing:"Continue shopping",successCallback:"Perfect! You'll receive a call shortly.",successSms:"SMS sent! Check your phone.",successEmail:"Email sent! Check your inbox.",errorInvalid:"Please enter a valid phone or email",errorSend:"Error sending. Please retry.",cartItemsLabel:"Items:",expiresIn:"Offer valid for {{minutes}} more min"},es:{title:"Tu carrito te espera!",subtitle:"Tienes {{count}} articulo(s) en tu carrito",subtitleSingular:"Tienes 1 articulo en tu carrito",voiceReminder:"Espera! No te vayas con las manos vacias...",valueLabel:"Valor total:",offerLabel:"Oferta exclusiva:",offerText:"{{discount}}% de descuento si finalizas ahora",callbackTitle:"Llamada de recordatorio gratis",callbackDesc:"Recibe un recordatorio de voz personalizado",smsTitle:"Recordatorio por SMS",smsDesc:"Enlace directo a tu carrito",emailTitle:"Recordatorio por email",emailDesc:"Resumen de tu carrito",phonePlaceholder:"+34 XXX XXX XXX",emailPlaceholder:"tu@email.com",sendBtn:"Recibir recordatorio",checkoutBtn:"Finalizar mi pedido",continueBrowsing:"Seguir comprando",successCallback:"Perfecto! Recibiras una llamada en breve.",successSms:"SMS enviado! Revisa tu telefono.",successEmail:"Email enviado! Revisa tu bandeja.",errorInvalid:"Por favor ingresa un numero o email valido",errorSend:"Error al enviar. Reintenta.",cartItemsLabel:"Articulos:",expiresIn:"Oferta valida por {{minutes}} min mas"},ar:{title:"سلتك بانتظارك!",subtitle:"لديك {{count}} منتج(ات) في سلتك",subtitleSingular:"لديك منتج واحد في سلتك",voiceReminder:"انتظر! لا تغادر بيدين فارغتين...",valueLabel:"القيمة الإجمالية:",offerLabel:"عرض حصري:",offerText:"{{discount}}% خصم إذا أتممت الآن",callbackTitle:"مكالمة تذكير مجانية",callbackDesc:"احصل على تذكير صوتي مخصص",smsTitle:"تذكير عبر SMS",smsDesc:"رابط مباشر لسلتك",emailTitle:"تذكير عبر البريد",emailDesc:"ملخص سلتك",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"بريدك@مثال.com",sendBtn:"استلم التذكير",checkoutBtn:"إتمام طلبي",continueBrowsing:"متابعة التسوق",successCallback:"ممتاز! ستتلقى مكالمة قريبًا.",successSms:"تم إرسال SMS! تحقق من هاتفك.",successEmail:"تم إرسال البريد! تحقق من صندوقك.",errorInvalid:"يرجى إدخال رقم أو بريد صحيح",errorSend:"خطأ في الإرسال. حاول مجددًا.",cartItemsLabel:"المنتجات:",expiresIn:"العرض صالح لمدة {{minutes}} دقيقة"},ary:{title:"الباني ديالك كيتسناك!",subtitle:"عندك {{count}} منتوج(ات) فالباني",subtitleSingular:"عندك منتوج واحد فالباني",voiceReminder:"تسنا! ما تمشيش بيديك خاويين...",valueLabel:"المجموع:",offerLabel:"عرض خاص:",offerText:"{{discount}}% تخفيض إلا كملتي دابا",callbackTitle:"تيليفون مجاني",callbackDesc:"غادي نعيطو ليك باش نفكروك",smsTitle:"SMS للتذكير",smsDesc:"لينك مباشر للباني",emailTitle:"إيميل للتذكير",emailDesc:"ملخص الباني ديالك",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"الإيميل ديالك",sendBtn:"بغيت التذكير",checkoutBtn:"نكمل الطلب",continueBrowsing:"نكمل التسوق",successCallback:"مزيان! غادي نعيطو ليك دابا.",successSms:"SMS مشى! شوف التيليفون.",successEmail:"الإيميل مشى! شوف البوات.",errorInvalid:"دخل رقم ولا إيميل صحيح",errorSend:"كاين مشكل. عاود.",cartItemsLabel:"المنتوجات:",expiresIn:"العرض صالح {{minutes}} دقيقة"}};class t{constructor(t={}){this.config={tenantId:t.tenantId||this.detectTenantId(),lang:t.lang||this.detectLanguage(),apiUrl:t.apiUrl||this.detectApiUrl(),discountPercent:t.discountPercent||10,offerDurationMinutes:t.offerDurationMinutes||15,inactivityTimeout:t.inactivityTimeout||18e4,tabBlurTimeout:t.tabBlurTimeout||6e4,minCartValue:t.minCartValue||0,cooldownPeriod:t.cooldownPeriod||864e5,voiceEnabled:!1!==t.voiceEnabled,checkoutUrl:t.checkoutUrl||"/checkout",cartSelector:t.cartSelector||null,onShow:t.onShow||null,onHide:t.onHide||null,onRecovery:t.onRecovery||null},this.state={isVisible:!1,isSpeaking:!1,selectedChannel:"voice",cartData:null,timerInterval:null,remainingMinutes:this.config.offerDurationMinutes,inactivityTimer:null,tabBlurTimer:null,messageType:null,messageText:null},this.elements={},this.translations=e[this.config.lang]||e.en,this.isRTL=["ar","ary"].includes(this.config.lang),this.init()}detectTenantId(){const e=document.querySelector("[data-vocalia-tenant]");return e?e.dataset.vocaliaTenant:new URLSearchParams(window.location.search).get("tenant")||"default"}detectLanguage(){const e=document.querySelector("[data-vocalia-lang]");if(e)return e.dataset.vocaliaLang;const t=new URLSearchParams(window.location.search);if(t.get("lang"))return t.get("lang");const n=navigator.language?.split("-")[0];return["fr","en","es","ar","ary"].includes(n)?n:"fr"}detectApiUrl(){return"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013/api":"https://api.vocalia.ma/api"}init(){if(!document.querySelector("#va-abandoned-cart-styles")){const e=document.createElement("style");e.id="va-abandoned-cart-styles",e.textContent='\n    .va-abandoned-cart-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.7);\n      backdrop-filter: blur(4px);\n      z-index: 10001;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      visibility: hidden;\n      transition: opacity 0.3s ease, visibility 0.3s ease;\n    }\n\n    .va-abandoned-cart-overlay.active {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    .va-abandoned-cart-modal {\n      background: linear-gradient(135deg, #0f172a 0%, #0c1220 100%);\n      border: 1px solid rgba(94, 106, 210, 0.3);\n      border-radius: 24px;\n      max-width: 480px;\n      width: 95%;\n      max-height: 90vh;\n      overflow-y: auto;\n      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 40px rgba(94, 106, 210, 0.2);\n      animation: vaCartSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    .va-abandoned-cart-modal[dir="rtl"] {\n      text-align: right;\n    }\n\n    @keyframes vaCartSlideIn {\n      from {\n        transform: translateY(-30px) scale(0.95);\n        opacity: 0;\n      }\n      to {\n        transform: translateY(0) scale(1);\n        opacity: 1;\n      }\n    }\n\n    .va-cart-header {\n      padding: 24px 24px 16px;\n      text-align: center;\n      border-bottom: 1px solid rgba(94, 106, 210, 0.15);\n    }\n\n    .va-cart-icon {\n      width: 64px;\n      height: 64px;\n      margin: 0 auto 16px;\n      background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: vaPulseCart 2s infinite;\n    }\n\n    @keyframes vaPulseCart {\n      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(94, 106, 210, 0.4); }\n      50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(94, 106, 210, 0); }\n    }\n\n    .va-cart-icon svg {\n      width: 32px;\n      height: 32px;\n      fill: white;\n    }\n\n    .va-cart-title {\n      color: #FFFFFF;\n      font-size: 24px;\n      font-weight: 700;\n      margin: 0 0 8px;\n    }\n\n    .va-cart-subtitle {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 16px;\n      margin: 0;\n    }\n\n    .va-cart-value {\n      background: rgba(94, 106, 210, 0.1);\n      border-radius: 12px;\n      padding: 12px 16px;\n      margin: 16px 24px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n\n    .va-cart-value-label {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 14px;\n    }\n\n    .va-cart-value-amount {\n      color: #5E6AD2;\n      font-size: 20px;\n      font-weight: 700;\n    }\n\n    .va-cart-offer {\n      background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(94, 106, 210, 0.15) 100%);\n      border: 1px solid rgba(16, 185, 129, 0.3);\n      border-radius: 12px;\n      padding: 12px 16px;\n      margin: 0 24px 16px;\n      text-align: center;\n    }\n\n    .va-cart-offer-label {\n      color: #10B981;\n      font-size: 12px;\n      font-weight: 600;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n    }\n\n    .va-cart-offer-text {\n      color: #FFFFFF;\n      font-size: 16px;\n      font-weight: 600;\n      margin-top: 4px;\n    }\n\n    .va-cart-timer {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n      margin-top: 8px;\n    }\n\n    .va-cart-items-preview {\n      padding: 0 24px 16px;\n    }\n\n    .va-cart-items-label {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n      margin-bottom: 8px;\n    }\n\n    .va-cart-items-row {\n      display: flex;\n      gap: 8px;\n      overflow-x: auto;\n      padding-bottom: 8px;\n    }\n\n    .va-cart-item-thumb {\n      width: 48px;\n      height: 48px;\n      border-radius: 8px;\n      object-fit: cover;\n      border: 1px solid rgba(94, 106, 210, 0.2);\n      flex-shrink: 0;\n    }\n\n    .va-cart-recovery-options {\n      padding: 0 24px 16px;\n    }\n\n    .va-recovery-option {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px;\n      background: rgba(255, 255, 255, 0.03);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      border-radius: 12px;\n      margin-bottom: 8px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .va-recovery-option:hover {\n      background: rgba(94, 106, 210, 0.1);\n      border-color: rgba(94, 106, 210, 0.3);\n    }\n\n    .va-recovery-option.selected {\n      background: rgba(94, 106, 210, 0.15);\n      border-color: #5E6AD2;\n    }\n\n    .va-recovery-option-icon {\n      width: 40px;\n      height: 40px;\n      border-radius: 10px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n    }\n\n    .va-recovery-option-icon.voice {\n      background: linear-gradient(135deg, #5E6AD2 0%, #4f46e5 100%);\n    }\n\n    .va-recovery-option-icon.sms {\n      background: linear-gradient(135deg, #10B981 0%, #059669 100%);\n    }\n\n    .va-recovery-option-icon.email {\n      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);\n    }\n\n    .va-recovery-option-icon svg {\n      width: 20px;\n      height: 20px;\n      fill: white;\n    }\n\n    .va-recovery-option-content {\n      flex: 1;\n    }\n\n    .va-recovery-option-title {\n      color: #FFFFFF;\n      font-size: 14px;\n      font-weight: 600;\n      margin-bottom: 2px;\n    }\n\n    .va-recovery-option-desc {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n    }\n\n    .va-recovery-option-radio {\n      width: 20px;\n      height: 20px;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      border-radius: 50%;\n      position: relative;\n    }\n\n    .va-recovery-option.selected .va-recovery-option-radio {\n      border-color: #5E6AD2;\n    }\n\n    .va-recovery-option.selected .va-recovery-option-radio::after {\n      content: \'\';\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 10px;\n      height: 10px;\n      background: #5E6AD2;\n      border-radius: 50%;\n    }\n\n    .va-cart-input-group {\n      padding: 0 24px 16px;\n    }\n\n    .va-cart-input {\n      width: 100%;\n      padding: 14px 16px;\n      background: rgba(255, 255, 255, 0.05);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-radius: 12px;\n      color: #FFFFFF;\n      font-size: 16px;\n      outline: none;\n      transition: border-color 0.2s ease;\n      box-sizing: border-box;\n    }\n\n    .va-cart-input:focus {\n      border-color: #5E6AD2;\n    }\n\n    .va-cart-input::placeholder {\n      color: rgba(255, 255, 255, 0.4);\n    }\n\n    .va-cart-input[dir="rtl"] {\n      text-align: right;\n    }\n\n    .va-cart-actions {\n      padding: 0 24px 24px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n\n    .va-cart-btn {\n      padding: 14px 24px;\n      border-radius: 12px;\n      font-size: 16px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border: none;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n    }\n\n    .va-cart-btn.primary {\n      background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n      color: white;\n    }\n\n    .va-cart-btn.primary:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 25px rgba(94, 106, 210, 0.4);\n    }\n\n    .va-cart-btn.secondary {\n      background: rgba(94, 106, 210, 0.1);\n      color: #5E6AD2;\n      border: 1px solid rgba(94, 106, 210, 0.3);\n    }\n\n    .va-cart-btn.secondary:hover {\n      background: rgba(94, 106, 210, 0.2);\n    }\n\n    .va-cart-btn.text {\n      background: transparent;\n      color: rgba(255, 255, 255, 0.6);\n    }\n\n    .va-cart-btn.text:hover {\n      color: #FFFFFF;\n    }\n\n    .va-cart-btn:disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n      transform: none;\n    }\n\n    .va-cart-btn svg {\n      width: 18px;\n      height: 18px;\n    }\n\n    .va-cart-close {\n      position: absolute;\n      top: 16px;\n      right: 16px;\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: background 0.2s ease;\n    }\n\n    .va-cart-close:hover {\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .va-cart-close svg {\n      width: 16px;\n      height: 16px;\n      fill: white;\n    }\n\n    [dir="rtl"] .va-cart-close {\n      right: auto;\n      left: 16px;\n    }\n\n    .va-cart-message {\n      padding: 12px 16px;\n      margin: 0 24px 16px;\n      border-radius: 10px;\n      font-size: 14px;\n      text-align: center;\n    }\n\n    .va-cart-message.success {\n      background: rgba(16, 185, 129, 0.15);\n      border: 1px solid rgba(16, 185, 129, 0.3);\n      color: #10B981;\n    }\n\n    .va-cart-message.error {\n      background: rgba(239, 68, 68, 0.15);\n      border: 1px solid rgba(239, 68, 68, 0.3);\n      color: #EF4444;\n    }\n\n    /* Voice speaking animation */\n    .va-cart-speaking .va-cart-icon {\n      animation: vaSpeakingPulse 0.5s infinite;\n    }\n\n    @keyframes vaSpeakingPulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.1); }\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 480px) {\n      .va-abandoned-cart-modal {\n        border-radius: 20px 20px 0 0;\n        max-width: 100%;\n        width: 100%;\n        position: fixed;\n        bottom: 0;\n        margin: 0;\n        max-height: 85vh;\n      }\n\n      .va-cart-header {\n        padding: 20px 20px 14px;\n      }\n\n      .va-cart-title {\n        font-size: 20px;\n      }\n\n      .va-cart-value,\n      .va-cart-offer,\n      .va-cart-recovery-options,\n      .va-cart-input-group,\n      .va-cart-actions {\n        padding-left: 20px;\n        padding-right: 20px;\n      }\n    }\n  ',document.head.appendChild(e)}this.createModal(),this.setupDetection(),this.checkCooldown(),this.setupOrchestratorIntegration()}createModal(){const e=document.createElement("div");e.className="va-abandoned-cart-overlay",e.id="va-abandoned-cart-overlay",e.innerHTML=this.getModalHTML(),document.body.appendChild(e),this.elements.overlay=e,this.elements.modal=e.querySelector(".va-abandoned-cart-modal"),this.elements.closeBtn=e.querySelector(".va-cart-close"),this.elements.input=e.querySelector(".va-cart-input"),this.elements.sendBtn=e.querySelector(".va-cart-send-btn"),this.elements.checkoutBtn=e.querySelector(".va-cart-checkout-btn"),this.elements.continueBtn=e.querySelector(".va-cart-continue-btn"),this.elements.message=e.querySelector(".va-cart-message"),this.elements.timer=e.querySelector(".va-cart-timer"),this.elements.subtitle=e.querySelector(".va-cart-subtitle"),this.elements.valueAmount=e.querySelector(".va-cart-value-amount"),this.elements.itemsRow=e.querySelector(".va-cart-items-row"),this.elements.offerText=e.querySelector(".va-cart-offer-text"),this.elements.closeBtn.addEventListener("click",()=>this.hide()),this.elements.overlay.addEventListener("click",e=>{e.target===this.elements.overlay&&this.hide()}),e.querySelectorAll(".va-recovery-option").forEach(e=>{e.addEventListener("click",()=>this.selectChannel(e.dataset.channel))}),this.elements.sendBtn.addEventListener("click",()=>this.sendReminder()),this.elements.checkoutBtn.addEventListener("click",()=>this.goToCheckout()),this.elements.continueBtn.addEventListener("click",()=>this.hide()),this.elements.input.addEventListener("focus",()=>this.updateInputPlaceholder())}getModalHTML(){const e=this.translations;return`\n        <div class="va-abandoned-cart-modal" dir="${this.isRTL?"rtl":"ltr"}" role="dialog" aria-modal="true" aria-labelledby="va-cart-title">\n          <button class="va-cart-close" aria-label="Close">\n            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n\n          <div class="va-cart-header">\n            <div class="va-cart-icon">\n              <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>\n            </div>\n            <h2 class="va-cart-title" id="va-cart-title">${e.title}</h2>\n            <p class="va-cart-subtitle">${e.subtitleSingular}</p>\n          </div>\n\n          <div class="va-cart-value">\n            <span class="va-cart-value-label">${e.valueLabel}</span>\n            <span class="va-cart-value-amount">0 MAD</span>\n          </div>\n\n          <div class="va-cart-offer">\n            <div class="va-cart-offer-label">${e.offerLabel}</div>\n            <div class="va-cart-offer-text">${e.offerText.replace("{{discount}}",this.config.discountPercent)}</div>\n            <div class="va-cart-timer">${e.expiresIn.replace("{{minutes}}",this.config.offerDurationMinutes)}</div>\n          </div>\n\n          <div class="va-cart-items-preview">\n            <div class="va-cart-items-label">${e.cartItemsLabel}</div>\n            <div class="va-cart-items-row"></div>\n          </div>\n\n          <div class="va-cart-recovery-options">\n            <div class="va-recovery-option selected" data-channel="voice">\n              <div class="va-recovery-option-icon voice">\n                <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.callbackTitle}</div>\n                <div class="va-recovery-option-desc">${e.callbackDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n\n            <div class="va-recovery-option" data-channel="sms">\n              <div class="va-recovery-option-icon sms">\n                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.smsTitle}</div>\n                <div class="va-recovery-option-desc">${e.smsDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n\n            <div class="va-recovery-option" data-channel="email">\n              <div class="va-recovery-option-icon email">\n                <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.emailTitle}</div>\n                <div class="va-recovery-option-desc">${e.emailDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n          </div>\n\n          <div class="va-cart-input-group">\n            <input type="text" class="va-cart-input" placeholder="${e.phonePlaceholder}" dir="${this.isRTL?"rtl":"ltr"}">\n          </div>\n\n          <div class="va-cart-message" style="display: none;"></div>\n\n          <div class="va-cart-actions">\n            <button class="va-cart-btn primary va-cart-send-btn">\n              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n              ${e.sendBtn}\n            </button>\n            <button class="va-cart-btn secondary va-cart-checkout-btn">\n              ${e.checkoutBtn}\n            </button>\n            <button class="va-cart-btn text va-cart-continue-btn">\n              ${e.continueBrowsing}\n            </button>\n          </div>\n        </div>\n      `}setupDetection(){document.addEventListener("mouseout",e=>{e.clientY<10&&!this.state.isVisible&&this.checkAndShow("exit_intent")}),document.addEventListener("visibilitychange",()=>{document.hidden?this.startTabBlurTimer():this.clearTabBlurTimer()}),this.resetInactivityTimer(),["mousemove","keydown","scroll","touchstart"].forEach(e=>{document.addEventListener(e,()=>this.resetInactivityTimer(),{passive:!0})}),window.addEventListener("beforeunload",()=>{this.hasCartItems()&&this.trackEvent("cart_abandoned_page_exit")})}setupOrchestratorIntegration(){window.VocalIA?.Orchestrator&&(window.VocalIA.Orchestrator.on("widgetActivated",e=>{"abandonedCart"!==e.widgetName&&this.state.isVisible&&this.hide()}),window.VocalIA.Orchestrator.widgets.abandonedCart={priority:6,isActive:!1,element:null,triggers:["cart_abandon","exit_with_cart"]})}checkCooldown(){const e=localStorage.getItem("va_cart_recovery_last_shown");this.cooldownActive=!!(e&&Date.now()-parseInt(e,10)<this.config.cooldownPeriod)}startInactivityTimer(){this.state.inactivityTimer=setTimeout(()=>{this.checkAndShow("inactivity")},this.config.inactivityTimeout)}resetInactivityTimer(){this.state.inactivityTimer&&clearTimeout(this.state.inactivityTimer),this.startInactivityTimer()}startTabBlurTimer(){this.state.tabBlurTimer=setTimeout(()=>{this.checkAndShow("tab_blur")},this.config.tabBlurTimeout)}clearTabBlurTimer(){this.state.tabBlurTimer&&(clearTimeout(this.state.tabBlurTimer),this.state.tabBlurTimer=null)}hasCartItems(){const e=this.getCartData();return e&&e.items&&e.items.length>0}getCartData(){if(this.config.cartSelector){const e=document.querySelector(this.config.cartSelector);if(e)try{return JSON.parse(e.textContent||e.dataset.cart)}catch{}}if(window.VocalIA?.cart)return window.VocalIA.cart;if(window.Shopify?.checkout?.line_items)return{items:window.Shopify.checkout.line_items.map(e=>({id:e.variant_id,name:e.title,price:e.price,quantity:e.quantity,image:e.image})),total:window.Shopify.checkout.total_price/100,currency:window.Shopify.checkout.currency||window.VocalIA?.cart?.currency||"EUR"};if(window.wc_cart_fragments_params){const e=document.querySelector(".cart-contents-count"),t=parseInt(e?.textContent||"0");if(t>0){const e=parseFloat(document.querySelector(".cart-contents .amount, .woocommerce-Price-amount")?.textContent?.replace(/[^\d.]/g,"")||"0");return{items:Array(t).fill({}),total:e,currency:window.VocalIA?.cart?.currency||"EUR"}}}const e=localStorage.getItem("va_cart")||localStorage.getItem("cart");if(e)try{return JSON.parse(e)}catch{}return window.location.search.includes("demo_cart=1")?{items:[{id:"1",name:"Produit Demo 1",price:299,quantity:1,image:"https://placehold.co/100x100/191E35/5E6AD2?text=P1"},{id:"2",name:"Produit Demo 2",price:199,quantity:2,image:"https://placehold.co/100x100/191E35/10B981?text=P2"}],total:697,currency:window.VocalIA?.cart?.currency||"EUR"}:null}checkAndShow(e){this.state.isVisible||this.cooldownActive||this.hasCartItems()&&(window.VocalIA?.Orchestrator&&!window.VocalIA.Orchestrator.canShow("abandonedCart")||(this.state.cartData=this.getCartData(),!(this.state.cartData.total<this.config.minCartValue)&&this.show(e)))}show(e="manual"){this.state.isVisible||(this.state.isVisible=!0,this.updateCartDisplay(),this.elements.overlay.classList.add("active"),this.startCountdown(),this.config.voiceEnabled&&setTimeout(()=>this.speak(this.translations.voiceReminder),500),localStorage.setItem("va_cart_recovery_last_shown",Date.now().toString()),this.cooldownActive=!0,window.VocalIA?.Orchestrator&&window.VocalIA.Orchestrator.activate("abandonedCart"),this.trackEvent("cart_recovery_shown",{trigger:e,cart_value:this.state.cartData?.total||0,items_count:this.state.cartData?.items?.length||0}),this.config.onShow&&this.config.onShow({trigger:e,cartData:this.state.cartData}))}hide(){this.state.isVisible=!1,this.elements.overlay.classList.remove("active"),this.stopCountdown(),this.stopSpeaking(),window.VocalIA?.Orchestrator&&window.VocalIA.Orchestrator.deactivate("abandonedCart"),this.trackEvent("cart_recovery_closed"),this.config.onHide&&this.config.onHide()}updateCartDisplay(){const e=this.state.cartData;if(!e)return;const t=e.items?.length||0;this.elements.subtitle.textContent=1===t?this.translations.subtitleSingular:this.translations.subtitle.replace("{{count}}",t);const n=e.currency||window.VocalIA?.cart?.currency||"EUR",a=e.total||0,i={MAD:"DH",EUR:"€",USD:"$",GBP:"£"}[n]||n;this.elements.valueAmount.textContent="EUR"===n||"USD"===n||"GBP"===n?`${i}${a.toLocaleString()}`:`${a.toLocaleString()} ${i}`,this.elements.itemsRow.innerHTML="",e.items&&e.items.slice(0,5).forEach(e=>{if(e.image){const t=document.createElement("img");t.className="va-cart-item-thumb",t.src=e.image,t.alt=e.name||"Product",this.elements.itemsRow.appendChild(t)}})}startCountdown(){this.state.remainingMinutes=this.config.offerDurationMinutes,this.updateTimerDisplay(),this.state.timerInterval=setInterval(()=>{this.state.remainingMinutes-=1,this.updateTimerDisplay(),this.state.remainingMinutes<=0&&(this.stopCountdown(),this.hide())},6e4)}stopCountdown(){this.state.timerInterval&&(clearInterval(this.state.timerInterval),this.state.timerInterval=null)}updateTimerDisplay(){this.elements.timer.textContent=this.translations.expiresIn.replace("{{minutes}}",this.state.remainingMinutes)}selectChannel(e){this.state.selectedChannel=e,this.elements.overlay.querySelectorAll(".va-recovery-option").forEach(t=>{t.classList.toggle("selected",t.dataset.channel===e)}),this.updateInputPlaceholder(),this.trackEvent("cart_recovery_channel_selected",{channel:e})}updateInputPlaceholder(){const e=this.translations;switch(this.state.selectedChannel){case"voice":case"sms":this.elements.input.placeholder=e.phonePlaceholder,this.elements.input.type="tel";break;case"email":this.elements.input.placeholder=e.emailPlaceholder,this.elements.input.type="email"}}async sendReminder(){const e=this.elements.input.value.trim(),t=this.state.selectedChannel;if(this.validateInput(e,t)){this.elements.sendBtn.disabled=!0;try{if(!(await fetch(`${this.config.apiUrl}/cart-recovery`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenant_id:this.config.tenantId,channel:t,contact:e,cart:this.state.cartData,discount_percent:this.config.discountPercent,language:this.config.lang,checkout_url:window.location.origin+this.config.checkoutUrl})})).ok)throw new Error("API error");const n={voice:this.translations.successCallback,sms:this.translations.successSms,email:this.translations.successEmail};this.showMessage("success",n[t]),this.config.voiceEnabled&&this.speak(n[t]),this.trackEvent("cart_recovery_reminder_sent",{channel:t,cart_value:this.state.cartData?.total||0}),this.config.onRecovery&&this.config.onRecovery({channel:t,contact:e,cartData:this.state.cartData}),setTimeout(()=>this.hide(),3e3)}catch(e){console.error("[AbandonedCartRecovery] Send error:",e),this.showMessage("error",this.translations.errorSend)}finally{this.elements.sendBtn.disabled=!1}}else this.showMessage("error",this.translations.errorInvalid)}validateInput(e,t){if(!e)return!1;switch(t){case"voice":case"sms":return/^\+?[0-9]{8,15}$/.test(e.replace(/[\s-]/g,""));case"email":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);default:return!1}}showMessage(e,t){this.elements.message.className=`va-cart-message ${e}`,this.elements.message.textContent=t,this.elements.message.style.display="block",setTimeout(()=>{this.elements.message.style.display="none"},5e3)}goToCheckout(){this.trackEvent("cart_recovery_checkout_clicked",{cart_value:this.state.cartData?.total||0,discount_applied:this.config.discountPercent});const e=`COMEBACK${this.config.discountPercent}`,t=new URL(this.config.checkoutUrl,window.location.origin);t.searchParams.set("discount",e),window.location.href=t.toString()}speak(e){if(!window.speechSynthesis)return;this.stopSpeaking(),this.state.isSpeaking=!0,this.elements.modal.classList.add("va-cart-speaking");const t=new SpeechSynthesisUtterance(e);t.lang={fr:"fr-FR",en:"en-US",es:"es-ES",ar:"ar-SA",ary:"ar-MA"}[this.config.lang]||"fr-FR",t.rate=.9,t.pitch=1,t.onend=()=>{this.state.isSpeaking=!1,this.elements.modal.classList.remove("va-cart-speaking")},window.speechSynthesis.speak(t)}stopSpeaking(){window.speechSynthesis&&window.speechSynthesis.cancel(),this.state.isSpeaking=!1,this.elements.modal?.classList.remove("va-cart-speaking")}trackEvent(e,t={}){window.gtag&&window.gtag("event",e,{event_category:"cart_recovery",tenant_id:this.config.tenantId,language:this.config.lang,...t}),window.plausible&&window.plausible(e,{props:t}),window.VocalIA?.trackEvent&&window.VocalIA.trackEvent(e,t)}trigger(e="manual"){this.checkAndShow(e)}setCartData(e){this.state.cartData=e,this.state.isVisible&&this.updateCartDisplay()}setDiscount(e){this.config.discountPercent=e,this.elements.offerText&&(this.elements.offerText.textContent=this.translations.offerText.replace("{{discount}}",e))}destroy(){this.hide(),this.elements.overlay?.remove(),this.state.inactivityTimer&&clearTimeout(this.state.inactivityTimer),this.state.tabBlurTimer&&clearTimeout(this.state.tabBlurTimer)}}let n=null;function a(e={}){return n&&n.destroy(),n=new t(e),n}window.VocaliaAbandonedCart={init:a,getInstance:()=>n,AbandonedCartRecovery:t},typeof window.VocalIA<"u"&&(window.VocalIA.AbandonedCart=window.VocaliaAbandonedCart,window.VocalIA.triggerCartRecovery=function(e="manual"){n||(n=a()),n.trigger(e)},window.VocalIA.setCartData=function(e){n||(n=a()),n.setCartData(e)}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-vocalia-cart-recovery]");e&&a({tenantId:e.dataset.vocaliaTenant,lang:e.dataset.vocaliaLang,discountPercent:parseInt(e.dataset.discount)||10,voiceEnabled:"false"!==e.dataset.voice})})}();