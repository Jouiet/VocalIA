/* VocalIA Widget v2.7.0 - 2026-02-26 */
!function(){"use strict";const e={SUPPORTED_LANGS:["fr","en","es","ar","ary"],DEFAULT_LANG:"fr",VOICE_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/respond":"https://api.vocalia.ma/respond",AI_MODE:!0,API_TIMEOUT:1e4,CATALOG_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013/api/tenants":"https://api.vocalia.ma/api/tenants",ECOMMERCE_MODE:!0,MAX_CAROUSEL_ITEMS:5,API_BASE_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013":"https://api.vocalia.ma",BOOKING_API:"https://script.google.com/macros/s/AKfycbzXKtu88n0Z-oFiBm5kJYPmGOi29maowtMv2vEQ0o5Xhp4sayNdnm2cNBaAx2OlHkUK/exec",EXIT_INTENT_ENABLED:!0,EXIT_INTENT_DELAY:3e3,EXIT_INTENT_SENSITIVITY:20,EXIT_INTENT_COOLDOWN:864e5,EXIT_INTENT_MOBILE_SCROLL_RATIO:.3,EXIT_INTENT_PAGES:null,SOCIAL_PROOF_API_URL:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3004/social-proof":"https://api.vocalia.ma/social-proof",SOCIAL_PROOF_ENABLED:!0,SOCIAL_PROOF_INTERVAL:25e3,SOCIAL_PROOF_DURATION:5e3,SOCIAL_PROOF_MAX_SHOWN:5,SOCIAL_PROOF_DELAY:8e3,primaryColor:"#5E6AD2",primaryDark:"#4f46e5",accentColor:"#10B981",darkBg:"#0f172a",widgetPosition:null,LANG_PATH:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/voice-assistant/lang/voice-{lang}.json":"https://vocalia.ma/voice-assistant/lang/voice-{lang}.json",SLOT_CACHE_TTL:3e5,CATALOG_CACHE_TTL:3e5,AUTO_DETECT_ENABLED:!0,AUTO_DETECT_LANGUAGES:{"fr-FR":"fr",fr:"fr","en-US":"en","en-GB":"en",en:"en","es-ES":"es","es-MX":"es",es:"es","ar-SA":"ar","ar-MA":"ar",ar:"ar",ary:"ary"}};function n(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function t(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const i="va_v3_conversation",a=function(){try{const e=sessionStorage.getItem(i);if(!e)return null;const n=JSON.parse(e);return Date.now()-n.ts>18e5?(sessionStorage.removeItem(i),null):n}catch{return null}}();let o={isOpen:!1,isListening:!1,recognition:null,synthesis:window.speechSynthesis,conversationHistory:a?.history||[],currentLang:a?.lang||null,langData:null,sessionId:a?.sessionId||`widget_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tenantId:null,tenantConfig:null,planFeatures:null,currency:null,availableSlotsCache:{slots:[],timestamp:0},catalogCache:{products:[],timestamp:0},conversationContext:{industry:null,need:null,stage:"discovery",lastTopic:null,attribution:{utm_source:null,utm_medium:null,utm_campaign:null,gclid:null,fbclid:null,referrer:document.referrer||null},bookingFlow:{active:!1,step:null,data:{name:null,email:null,datetime:null,service:null}}},ecommerce:{inputMethodStats:{voice:0,text:0},productsViewed:[],carouselsDisplayed:0,productClicks:0,lastInputMethod:null},exitIntent:{shown:!1,dismissed:!1,pageLoadTime:Date.now(),lastScrollY:0,triggered:!1},socialProof:{notificationsShown:0,intervalId:null,lastShownTime:0}};const s="SpeechRecognition"in window||"webkitSpeechRecognition"in window,r="speechSynthesis"in window,c=navigator.userAgent.toLowerCase().includes("firefox"),l=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),d=!s||c||l;let p=null;function u(e){return p?p.getElementById(e):document.getElementById(e)}function h(e){return p?p.querySelectorAll(e):document.querySelectorAll(e)}async function g(n){const t=e.LANG_PATH.replace("{lang}",n);try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load language: ${n}`);const i=await e.json();return o.currentLang=n,o.langData=i,i}catch(e){if(console.error("[VocalIA] Language load error:",e),"fr"!==n)return g("fr");throw e}}function v(e,n={}){const t={event_category:"voice_assistant",language:o.currentLang,session_id:o.sessionId,attribution:o.conversationContext.attribution,...n};"function"==typeof gtag&&gtag("event",e,t),typeof dataLayer<"u"&&Array.isArray(dataLayer)&&dataLayer.push({event:e,...t})}function m(t,a="assistant"){const s=u("va-messages"),c=document.createElement("div");c.className=`va-message ${a}`,c.innerHTML=`<div class="va-message-content">${n(t)}</div>`,s.appendChild(c),s.scrollTop=s.scrollHeight,"assistant"===a&&r&&function(n){const t=o.langData?.meta?.code||o.currentLang||"fr";if(V.isEnabled()&&V.connected)return V.sendText(n),void q("speaking");if("ary"===t)return void async function(n,t){const i=e.VOICE_API_URL.replace("/respond","/tts");try{const e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,language:t})});if(!e.ok)return console.warn("[TTS] ElevenLabs request failed, falling back to Web Speech API"),void A(n);const a=await e.json();if(a.success&&a.audio){const e=new Audio(`data:audio/mp3;base64,${a.audio}`);e.onplay=()=>q("speaking"),e.onended=()=>M(),e.onerror=()=>M(),e.onpause=()=>M(),e.play().catch(e=>{console.warn("[TTS] Audio playback failed:",e.message),M(),A(n)})}else A(n)}catch(e){console.warn("[TTS] ElevenLabs error:",e.message),A(n)}}(n,t);if(!r)return;o.synthesis.cancel();const i=new SpeechSynthesisUtterance(n);i.lang=o.langData.meta.speechSynthesis,i.rate="ar"===t?.9:1,i.onstart=()=>q("speaking"),i.onend=()=>M(),i.onerror=()=>M(),o.synthesis.speak(i)}(t),o.conversationHistory.push({role:"user"===a?"user":"assistant",content:t}),function(){try{sessionStorage.setItem(i,JSON.stringify({sessionId:o.sessionId,history:o.conversationHistory.slice(-50),lang:o.currentLang,ts:Date.now()}))}catch{}}()}function f(){const e=u("va-typing");e&&e.remove()}function b(e,n){const t={MAD:"DH",EUR:"â‚¬",USD:"$",GBP:"Â£"}[n=n||o.currency||"EUR"]||n,i=e.toLocaleString(o.currentLang||"fr",{minimumFractionDigits:0,maximumFractionDigits:2});return"EUR"===n||"USD"===n||"GBP"===n?`${t}${i}`:`${i} ${t}`}function w(e,i="detail"){if(!e)return;const a=u("va-messages"),s=document.createElement("div");s.className="va-message assistant";const r=e.image||e.images?.[0],c=!1!==e.available&&!1!==e.in_stock,l=t(e.id),d=n(e.name||""),p=e.description?n(e.description):"",h=t(e.image||e.images?.[0]||""),g=e.url?t(e.url):"";s.innerHTML=`\n      <div class="va-message-content">\n        <div class="va-single-product" data-product-id="${l}">\n          <div class="va-single-product-row">\n            ${r?`<img class="va-single-product-img" src="${h}" alt="${d}" />`:'<div class="va-single-product-img" style="display:flex;align-items:center;justify-content:center;font-size:32px;">ðŸ“¦</div>'}\n            <div class="va-single-product-details">\n              <h4 class="va-single-product-name">${d}</h4>\n              ${p?`<p class="va-single-product-desc">${p}</p>`:""}\n              <div class="va-single-product-price">${b(e.price,e.currency)}</div>\n            </div>\n          </div>\n          <div class="va-product-actions">\n            <button class="va-product-btn primary" onclick="window.VocalIA.viewProduct('${l}')" ${c?"":"disabled"}>\n              ${c?o.langData?.ecommerce?.viewDetails||"Voir dÃ©tails":o.langData?.ecommerce?.notifyMe||"Me notifier"}\n            </button>\n            ${g?`<button class="va-product-btn secondary" onclick="window.open('${g}', '_blank')">\n              ${o.langData?.ecommerce?.buyNow||"Acheter"}\n            </button>`:""}\n          </div>\n        </div>\n      </div>\n    `,a.appendChild(s),a.scrollTop=a.scrollHeight,o.ecommerce.productsViewed.push(e.id),v("product_viewed",{product_id:e.id,product_name:e.name,price:e.price,context:i,input_method:o.ecommerce.lastInputMethod})}function y(i,a=null,s="recommendations"){if(!i||0===i.length)return;const r=o.langData,c=r?.meta?.rtl,l=u("va-messages"),d=document.createElement("div");d.className="va-message assistant";const p=`carousel-${Date.now()}`,h=i.slice(0,e.MAX_CAROUSEL_ITEMS),g={recommendations:r?.ecommerce?.recommendedForYou||"RecommandÃ© pour vous",search_results:r?.ecommerce?.searchResults||"RÃ©sultats",category:r?.ecommerce?.fromCategory||"De cette catÃ©gorie",popular:r?.ecommerce?.popular||"Populaires",related:r?.ecommerce?.relatedProducts||"Produits similaires"};d.innerHTML=`\n      <div class="va-message-content" style="padding: 8px 10px;">\n        <div class="va-carousel-header">\n          <span class="va-carousel-title">\n            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n            ${a||g[s]||g.recommendations}\n          </span>\n          <div class="va-carousel-nav">\n            <button onclick="this.getRootNode().getElementById('${p}').scrollBy({left: ${c?"150":"-150"}, behavior: 'smooth'})" aria-label="${r?.ui?.ariaPrev||"Previous"}">\n              <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>\n            </button>\n            <button onclick="this.getRootNode().getElementById('${p}').scrollBy({left: ${c?"-150":"150"}, behavior: 'smooth'})" aria-label="${r?.ui?.ariaNext||"Next"}">\n              <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>\n            </button>\n          </div>\n        </div>\n        <div class="va-product-carousel" id="${p}">\n          ${h.map((e,i)=>function(e,i=!1){const a=e.image||e.images?.[0],s=!1!==e.available&&!1!==e.in_stock,r=e.stock,c=e.compare_at_price&&e.compare_at_price>e.price,l=e.created_at&&Date.now()-new Date(e.created_at).getTime()<6048e5;let d="",p="";s?void 0!==r&&r<5&&(d="low",p=o.langData?.ecommerce?.lowStock?.replace("{n}",r)||`Plus que ${r}`):(d="out",p=o.langData?.ecommerce?.outOfStock||"Rupture");let u="";return c?u=`<span class="va-product-badge sale">-${Math.round(100*(1-e.price/e.compare_at_price))}%</span>`:l&&(u=`<span class="va-product-badge new">${o.langData?.ecommerce?.new||"Nouveau"}</span>`),`\n      <div class="va-product-card ${i?"featured":""}" data-product-id="${t(String(e.id))}" style="position: relative;">\n        ${u}\n        ${a?`<img class="va-product-img" src="${t(e.image||e.images[0])}" alt="${t(e.name)}" loading="lazy" />`:'<div class="va-product-img-placeholder">ðŸ“¦</div>'}\n        <div class="va-product-info">\n          <p class="va-product-name">${n(e.name)}</p>\n          <div class="va-product-price">\n            ${b(e.price,e.currency)}\n            ${c?`<span class="va-product-price-old">${b(e.compare_at_price,e.currency)}</span>`:""}\n          </div>\n          ${p?`<p class="va-product-stock ${d}">${p}</p>`:""}\n        </div>\n      </div>\n    `}(e,0===i)).join("")}\n        </div>\n      </div>\n    `,l.appendChild(d),l.scrollTop=l.scrollHeight,d.querySelectorAll(".va-product-card").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.productId,t=h.find(e=>e.id===n);t&&(o.ecommerce.productClicks++,v("product_card_clicked",{product_id:n,product_name:t.name,price:t.price,position:h.indexOf(t),carousel_context:s,input_method:o.ecommerce.lastInputMethod}),w(t,"carousel_click"))})}),o.ecommerce.carouselsDisplayed++,v("product_carousel_displayed",{products_count:h.length,context:s,product_ids:h.map(e=>e.id),input_method:o.ecommerce.lastInputMethod})}window.VocalIA=window.VocalIA||{},window.VocalIA.viewProduct=async function(n){if(o.tenantId)try{const t=await fetch(`${e.CATALOG_API_URL}/${o.tenantId}/catalog/detail/${encodeURIComponent(n)}`,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(t.ok){const e=await t.json();e.item&&w(e.item,"detail_view")}}catch(e){console.warn("[VocalIA] Product detail error:",e.message)}},window.VocalIA.displayProducts=function(e,n,t){y(e,n,t)},window.VocalIA.getEcommerceStats=function(){return{...o.ecommerce,voiceRatio:o.ecommerce.inputMethodStats.voice/Math.max(1,o.ecommerce.inputMethodStats.voice+o.ecommerce.inputMethodStats.text)}},window.VocalIA.showRecommendations=function(e,n="similar",t=null){e&&0!==e.length&&("function"==typeof gtag&&gtag("event","ai_recommendations_shown",{event_category:"recommendations",recommendation_type:n,items_count:e.length}),y(e,t,{similar:"related",bought_together:"recommendations",personalized:"recommendations"}[n]||"recommendations"))},window.VocalIA.getAIRecommendations=async function(n,t=[],i="similar"){if(!o.tenantId)return null;try{const a={tenant_id:o.tenantId,recommendation_type:i};n&&(a.product_id=n),t.length>0&&(a.product_ids=t);const s=await fetch(`${e.API_BASE_URL}/api/recommendations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.API_KEY||""}`},body:JSON.stringify(a)});if(!s.ok)return null;const r=await s.json();if(r.success&&r.recommendations?.length>0){const n=await Promise.all(r.recommendations.map(async n=>{if(n.productId&&!n.title){const t=await async function(n){if(!o.tenantId)return{};try{const t=await fetch(`${e.API_BASE_URL}/api/tenants/${o.tenantId}/catalog/${encodeURIComponent(n)}`);if(t.ok)return(await t.json()).item||{}}catch{}return{}}(n.productId);return{...n,...t}}return n}));return window.VocalIA.showRecommendations(n,i),n}return null}catch(e){return console.error("[VocalIA] Recommendations error:",e),null}},window.VocalIA.startQuiz=function(n="generic",t={}){if(o.planFeatures&&!1===o.planFeatures.ecom_quiz)return console.warn("[VocalIA] Quiz not available on current plan"),null;if(!window.VocalIAQuiz)return console.warn("[VocalIA] Voice Quiz not loaded. Include voice-quiz.js"),null;const i=new window.VocalIAQuiz({tenantId:o.tenantId,template:n,lang:o.langData?.meta?.code||"fr",apiBaseUrl:e.API_BASE_URL,voiceEnabled:!0,onComplete:e=>{"function"==typeof gtag&&gtag("event","quiz_completed",{event_category:"voice_quiz",template:n,answers_count:Object.keys(e.answers).length,with_lead:e.withLead}),e.tags?.length>0&&window.VocalIA.getAIRecommendations(null,[],"personalized")},onLeadCapture:e=>{"function"==typeof gtag&&gtag("event","quiz_lead_captured",{event_category:"voice_quiz",template:n}),k.syncPreference&&k.recordInteraction("quiz_completed",{template:n,answers:e.answers})},...t});return i.show(),i},window.VocalIA.isQuizSupported=function(){return!!window.VocalIAQuiz},window.VocalIA.initCartRecovery=function(e={}){return o.planFeatures&&!1===o.planFeatures.ecom_cart_recovery?(console.warn("[VocalIA] Cart recovery not available on current plan"),null):window.VocaliaAbandonedCart?window.VocaliaAbandonedCart.init({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Abandoned cart widget not loaded. Include abandoned-cart-recovery.js"),null)},window.VocalIA.triggerCartRecovery=function(e="manual"){if(!o.planFeatures||!1!==o.planFeatures.ecom_cart_recovery)if(window.VocaliaAbandonedCart?.getInstance())window.VocaliaAbandonedCart.getInstance().trigger(e);else{const n=window.VocalIA.initCartRecovery();n&&setTimeout(()=>n.trigger(e),100)}},window.VocalIA.setCartData=function(e){window.VocalIA.cart=e,window.VocaliaAbandonedCart?.getInstance()&&window.VocaliaAbandonedCart.getInstance().setCartData(e),"function"==typeof gtag&&e.total>0&&gtag("event","cart_updated",{event_category:"ecommerce",cart_value:e.total,items_count:e.items?.length||0,currency:e.currency||o.currency||"EUR"})},window.VocalIA.isCartRecoverySupported=function(){return!!window.VocaliaAbandonedCart},window.VocalIA.initShippingBar=function(e={}){return window.VocaliaShippingBar?window.VocaliaShippingBar.init({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Shipping bar widget not loaded. Include free-shipping-bar.js"),null)},window.VocalIA.updateShippingProgress=function(e){if(window.VocaliaShippingBar?.getInstance())window.VocaliaShippingBar.getInstance().updateCartValue(e);else if(window.VocaliaShippingBar){const n=window.VocalIA.initShippingBar();n&&n.updateCartValue(e)}},window.VocalIA.isShippingBarSupported=function(){return!!window.VocaliaShippingBar},window.VocalIA.showSpinWheel=function(e={}){return o.planFeatures&&!1===o.planFeatures.ecom_gamification?(console.warn("[VocalIA] Spin wheel not available on current plan"),null):window.VocaliaSpinWheel?window.VocaliaSpinWheel.show({tenantId:o.tenantId||e.tenantId,lang:o.currentLang||e.lang,...e}):(console.warn("[VocalIA] Spin wheel widget not loaded. Include spin-wheel.js"),null)},window.VocalIA.isSpinWheelAvailable=function(){try{const e=localStorage.getItem("va_spin_wheel_last_played");return!e||Date.now()-parseInt(e,10)>=864e5}catch{return!0}},window.VocalIA.isSpinWheelSupported=function(){return!!window.VocaliaSpinWheel};const x={widgets:{voiceChat:{active:!1,priority:1},recommendations:{active:!1,priority:2},quiz:{active:!1,priority:3},exitIntent:{active:!1,priority:4},socialProof:{active:!0,priority:5},abandonedCart:{active:!1,priority:6},spinWheel:{active:!1,priority:7},shippingBar:{active:!0,priority:8}},events:new Map,on(e,n){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(n)},emit(e,n){(this.events.get(e)||[]).forEach(e=>{try{e(n)}catch(e){console.error("[Orchestrator] Event error:",e)}})},activate(e){const n=this.widgets[e];return!!n&&(n.active=!0,this.emit("widget:activated",{widget:e}),"function"==typeof gtag&&gtag("event","widget_activated",{event_category:"orchestrator",widget_name:e}),!0)},deactivate(e){const n=this.widgets[e];return!!n&&(n.active=!1,this.emit("widget:deactivated",{widget:e}),!0)},canShow(e){const n=this.widgets[e];if(!n)return!1;for(const[e,t]of Object.entries(this.widgets))if(t.active&&t.priority<n.priority)return!1;return!0},getStats(){return{activeWidgets:Object.entries(this.widgets).filter(([e,n])=>n.active).map(([e,n])=>e),totalWidgets:Object.keys(this.widgets).length,eventListeners:this.events.size}}};window.VocalIA.Orchestrator=x;const _={shippingBar:{file:"voice-widget-ecommerce-shipping.js",global:"VocaliaShippingBar"},abandonedCart:{file:"voice-widget-ecommerce-cart.js",global:"VocaliaAbandonedCart"},quiz:{file:"voice-widget-ecommerce-quiz.js",global:"VocalIAQuiz"},spinWheel:{file:"voice-widget-ecommerce-spin.js",global:"VocaliaSpinWheel"},recommendations:{file:"voice-widget-ecommerce-carousel.js",global:"VocalIARecommendations"}},I={};function S(e){const n=_[e];return n?window[n.global]?Promise.resolve(!0):(I[e]||(I[e]=new Promise((t,i)=>{const a=document.createElement("script");a.src=function(){const e=document.querySelectorAll('script[src*="voice-widget-ecommerce"]');if(e.length>0){const n=e[e.length-1].src;return n.substring(0,n.lastIndexOf("/")+1)}return"/voice-assistant/"}()+n.file,a.onload=()=>t(!0),a.onerror=()=>{delete I[e],i(new Error("Chunk unavailable: "+n.file))},document.head.appendChild(a)})),I[e]):Promise.reject(new Error("Unknown chunk: "+e))}window.VocalIA.loadChunk=S,x.on("widget:activated",({widget:n})=>{"spinWheel"===n&&window.VocaliaSpinWheel&&window.VocaliaSpinWheel.show({tenantId:o.tenantId,lang:o.currentLang}),"shippingBar"===n&&window.VocaliaShippingBar&&window.VocaliaShippingBar.init({tenantId:o.tenantId,lang:o.currentLang}),"recommendations"===n&&window.VocalIARecommendations&&new window.VocalIARecommendations({tenantId:o.tenantId,lang:o.currentLang,apiBase:e.API_BASE_URL}).render()}),x.on("widget:deactivated",({widget:e})=>{"spinWheel"===e&&window.VocaliaSpinWheel?.getInstance()&&window.VocaliaSpinWheel.getInstance().destroy(),"shippingBar"===e&&window.VocaliaShippingBar?.getInstance()&&window.VocaliaShippingBar.getInstance().destroy()});const k={profile:null,ltvTier:"bronze",async syncPreference(n=null){if(!o.tenantId)return null;try{const t=n||function(){const e=navigator.language||navigator.userLanguage||"",n={"fr-FR":"FR","fr-MA":"MA","fr-BE":"BE","fr-CA":"CA","en-US":"US","en-GB":"GB","en-CA":"CA","es-ES":"ES","es-MX":"MX","ar-MA":"MA","ar-SA":"SA","ar-AE":"AE"};if(n[e])return n[e];const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"";return t.includes("Casablanca")?"MA":t.includes("Paris")?"FR":t.includes("London")?"GB":t.includes("New_York")||t.includes("Los_Angeles")?"US":{fr:"FR",en:"US",es:"ES",ar:"MA",ary:"MA"}[o.currentLang]||"FR"}(),i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/sync"),a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,countryCode:t}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(a.ok){const e=await a.json();return k.profile=e.profile,k.ltvTier=e.ltvTier||"bronze",v("ucp_synced",{country:t,ltv_tier:k.ltvTier,locale:k.profile?.locale}),e}}catch(e){console.warn("[VocalIA] UCP sync error:",e.message)}return null},async recordInteraction(n,t={}){if(o.tenantId&&k.profile)try{const i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/interaction");await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,type:"widget_chat",channel:"web_widget",metadata:{...t,input_method:o.ecommerce.lastInputMethod,interaction_type:n}}),signal:AbortSignal.timeout(5e3)})}catch{}},async trackEvent(n,t=null){if(o.tenantId)try{const i=e.CATALOG_API_URL.replace("/api/tenants","/api/ucp/event");await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:o.tenantId,userId:o.sessionId,event:n,value:t,source:"voice"===o.ecommerce.lastInputMethod?"voice":"widget"}),signal:AbortSignal.timeout(5e3)})}catch{}},getRecommendationStrategy(){const e={bronze:{limit:3,showPrices:!0,upsell:!1},silver:{limit:4,showPrices:!0,upsell:!0},gold:{limit:5,showPrices:!0,upsell:!0,prioritySupport:!0},platinum:{limit:6,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0},diamond:{limit:8,showPrices:!0,upsell:!0,prioritySupport:!0,exclusiveOffers:!0,personalAssistant:!0}};return e[k.ltvTier]||e.bronze}},C={async fetchProducts(n={}){if(!o.tenantId)return[];try{const t=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/browse`,i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:n.category,query:n.search,limit:n.limit||k.getRecommendationStrategy().limit,inStock:!1!==n.inStock,ltvTier:k.ltvTier}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(i.ok)return(await i.json()).items||[]}catch(e){console.warn("[VocalIA] MCP fetch error:",e.message)}return[]},async searchProducts(n){if(!o.tenantId||!n)return[];try{const t=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/search`,i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:n,limit:k.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(i.ok)return(await i.json()).results||[]}catch(e){console.warn("[VocalIA] MCP search error:",e.message)}return[]},async getRecommendations(){if(!o.tenantId)return[];try{const n=`${e.CATALOG_API_URL}/${o.tenantId}/catalog/recommendations`,t=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:o.sessionId,ltvTier:k.ltvTier,productsViewed:o.ecommerce.productsViewed.slice(-10),locale:k.profile?.locale||o.currentLang,limit:k.getRecommendationStrategy().limit}),signal:AbortSignal.timeout(e.API_TIMEOUT)});if(t.ok)return(await t.json()).recommendations||[]}catch(e){console.warn("[VocalIA] MCP recommendations error:",e.message)}return[]}};function A(e){if(!r)return;o.synthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.lang="ar-SA",n.rate=.9,o.synthesis.speak(n)}window.VocalIA.UCP=k,window.VocalIA.MCP=C;let L=null,E=null,T=null;function z(){o.cloudRecordingTimeout&&clearTimeout(o.cloudRecordingTimeout),o.isListening=!1,V.commitAudio(),T&&(T.disconnect(),T=null),E&&(E.getTracks().forEach(e=>e.stop()),E=null),L&&(L.close().catch(()=>{}),L=null)}function O(){V.isEnabled()&&V.connected?o.isListening?(z(),u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),M()):(async function(){try{E=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:24e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}}),L=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});const e=L.createMediaStreamSource(E);T=L.createScriptProcessor(4096,1,1),T.onaudioprocess=e=>{if(!o.isListening||!V.connected)return;const n=e.inputBuffer.getChannelData(0),t=new Int16Array(n.length);for(let e=0;e<n.length;e++){const i=Math.max(-1,Math.min(1,n[e]));t[e]=i<0?32768*i:32767*i}const i=new Uint8Array(t.buffer);let a="";for(let e=0;e<i.length;e++)a+=String.fromCharCode(i[e]);const s=btoa(a);V.sendAudio(s)},e.connect(T),T.connect(L.destination),o.isListening=!0,o.cloudRecordingTimeout=setTimeout(()=>{o.isListening&&(z(),u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),M())},15e3)}catch(e){console.error("[VocalIA] Cloud mic access denied:",e.message),o.isListening=!1}}(),u("va-mic")?.classList.add("listening"),u("va-trigger")?.classList.add("listening"),q("listening"),v("voice_mic_activated",{mode:"cloud"})):"native"===o.sttMode&&o.recognition?o.isListening?(o.recognition.stop(),M()):(o.recognition.start(),o.isListening=!0,u("va-mic")?.classList.add("listening"),u("va-trigger")?.classList.add("listening"),q("listening"),v("voice_mic_activated",{mode:"native"})):"fallback"===o.sttMode&&(o.isListening?(o.recordingTimeout&&clearTimeout(o.recordingTimeout),"recording"===o.mediaRecorder?.state&&o.mediaRecorder.stop(),o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),M()):(async function(){try{const n=await navigator.mediaDevices.getUserMedia({audio:!0});o.mediaRecorder=new MediaRecorder(n,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/ogg"}),o.audioChunks=[],o.mediaRecorder.ondataavailable=e=>{e.data.size>0&&o.audioChunks.push(e.data)},o.mediaRecorder.onstop=async()=>{n.getTracks().forEach(e=>e.stop());const t=new Blob(o.audioChunks,{type:o.mediaRecorder.mimeType});if(t.size<1e3)return;const i=e.API_BASE_URL+"/stt";try{const e=await(await fetch(i,{method:"POST",headers:{"X-Language":o.currentLang},body:t,signal:AbortSignal.timeout(15e3)})).json();e.success&&e.text&&(u("va-input").value=e.text,G(e.text,"voice"))}catch(e){console.error("[VocalIA ECOM] STT request failed:",e.message)}},o.mediaRecorder.start(),o.isListening=!0,o.recordingTimeout=setTimeout(()=>{"recording"===o.mediaRecorder?.state&&(o.mediaRecorder.stop(),o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),M())},1e4)}catch(e){console.error("[VocalIA ECOM] Microphone access denied:",e.message),o.isListening=!1,u("va-mic")?.classList.remove("listening")}}(),u("va-mic")?.classList.add("listening"),u("va-trigger")?.classList.add("listening"),q("listening"),v("voice_mic_activated",{mode:"fallback"})))}const V={ws:null,audioCtx:null,audioQueue:[],isPlaying:!1,connected:!1,sessionId:null,getWsUrl:()=>`${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"ws://localhost:3007":"wss://api.vocalia.ma:3007"}?voice=${"ary"===o.currentLang||"ar"===o.currentLang?"ara":"alloy"}&tenant_id=${encodeURIComponent(o.tenantId||"default")}`,isEnabled:()=>!0===o.tenantConfig?.features?.cloud_voice||!0===o.tenantConfig?.plan_features?.cloud_voice,async connect(){if(!(this.ws&&this.ws.readyState<=1))try{this.ws=new WebSocket(this.getWsUrl()),this.ws.onopen=()=>{console.log("[VocalIA] Cloud voice connected"),this.connected=!0,v("cloud_voice_connected",{tenantId:o.tenantId})},this.ws.onmessage=e=>{try{const n=JSON.parse(e.data);if("proxy.connected"===n.type&&(this.sessionId=n.sessionId),"response.audio.delta"===n.type&&n.delta&&this.queueAudio(n.delta),"response.audio.done"===n.type&&this.flushAudioQueue(),"conversation.item.created"===n.type&&n.item?.content){const e=n.item.content.find(e=>"text"===e.type);e&&appendBotMessage(e.text)}}catch{}},this.ws.onclose=()=>{this.connected=!1,this.sessionId=null,console.log("[VocalIA] Cloud voice disconnected")},this.ws.onerror=()=>{this.connected=!1,console.warn("[VocalIA] Cloud voice error, falling back to Web Speech")}}catch(e){console.warn("[VocalIA] Cloud voice init failed:",e.message)}},disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1,this.sessionId=null},sendText(e){return!(!this.connected||!this.ws||(this.ws.send(JSON.stringify({type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:e}]}})),this.ws.send(JSON.stringify({type:"response.create"})),0))},sendAudio(e){return!(!this.connected||!this.ws||(this.ws.send(JSON.stringify({type:"input_audio_buffer.append",audio:e})),0))},commitAudio(){return!(!this.connected||!this.ws||(this.ws.send(JSON.stringify({type:"input_audio_buffer.commit"})),this.ws.send(JSON.stringify({type:"response.create"})),0))},queueAudio(e){this.audioQueue.push(e),this.isPlaying||this.playNextChunk()},async playNextChunk(){if(0===this.audioQueue.length)return this.isPlaying=!1,void M();this.isPlaying=!0,q("speaking"),this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));const e=this.audioQueue.shift();try{const n=atob(e),t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);const i=new Int16Array(t.buffer),a=this.audioCtx.createBuffer(1,i.length,24e3),o=a.getChannelData(0);for(let e=0;e<i.length;e++)o[e]=i[e]/32768;const s=this.audioCtx.createBufferSource();s.buffer=a,s.connect(this.audioCtx.destination),s.onended=()=>this.playNextChunk(),s.start()}catch{this.playNextChunk()}},flushAudioQueue(){!this.isPlaying&&this.audioQueue.length>0&&this.playNextChunk()}};function q(e="listening"){const n=u("va-visualizer"),t=u("va-visualizer-bars"),i=u("va-visualizer-label"),a=o.langData;n&&(n.classList.add("active"),t.classList.remove("speaking","listening","processing"),t.classList.add(e),i.classList.remove("speaking","listening","processing"),i.classList.add(e),i.textContent={listening:a?.ui?.voiceListening||"Listening...",speaking:a?.ui?.voiceSpeaking||"Speaking...",processing:a?.ui?.voiceProcessing||"Processing..."}[e]||e,"speaking"===e&&function(){const e=h(".va-visualizer-bar");e.length&&function n(){e.forEach(e=>{const n=8+28*Math.random();e.style.height=`${n}px`,e.style.opacity=.6+.4*Math.random()}),P=requestAnimationFrame(()=>{setTimeout(n,100)})}()}())}function M(){const e=u("va-visualizer"),n=u("va-visualizer-bars");e&&(e.classList.remove("active"),n.classList.remove("speaking","listening","processing"),P&&(cancelAnimationFrame(P),P=null),h(".va-visualizer-bar").forEach(e=>{e.style.height="4px",e.style.opacity="0.5"}))}let P=null;function R(e){B(e)&&F("desktop_mouseleave")}function $(n){!n.relatedTarget&&n.clientY<e.EXIT_INTENT_SENSITIVITY&&B(n)&&F("desktop_mouseout")}function D(){const n=window.scrollY,t=document.documentElement.scrollHeight-window.innerHeight;(o.exitIntent.lastScrollY-n)/t>e.EXIT_INTENT_MOBILE_SCROLL_RATIO&&n<.3*t&&B()&&F("mobile_scroll"),o.exitIntent.lastScrollY=n}function B(n=null){return!(o.exitIntent.shown||o.exitIntent.dismissed||o.isOpen||Date.now()-o.exitIntent.pageLoadTime<e.EXIT_INTENT_DELAY||o.conversationHistory.length>2)}function F(n="unknown"){if(o.exitIntent.triggered)return;o.exitIntent.triggered=!0,o.exitIntent.shown=!0;try{localStorage.setItem("vocalia_exit_intent_shown",Date.now().toString())}catch{}v("exit_intent_triggered",{trigger:n,page:window.location.pathname});const t=window.VocalIA?.cart;if(e.ECOMMERCE_MODE&&t&&t.items&&t.items.length>0&&(!o.planFeatures||!1!==o.planFeatures.ecom_cart_recovery))return v("exit_intent_cart_recovery",{cart_value:t.total,items:t.items.length}),void window.VocalIA.triggerCartRecovery("exit_intent");!function(){const e=o.langData||{},n=e?.meta?.rtl||!1,t=document.createElement("div");t.id="va-exit-overlay",t.innerHTML=`\n      <style>\n        #va-exit-overlay {\n          position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n          background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);\n          z-index: 999998; display: flex; align-items: center; justify-content: center;\n          animation: fadeIn 0.3s ease;\n        }\n        .va-exit-popup {\n          background: linear-gradient(145deg, #1e2642 0%, #191e35 100%);\n          border-radius: 24px; padding: 32px; max-width: 420px; width: 90%;\n          box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 60px rgba(94,106,210,0.15);\n          position: relative; text-align: center;\n          border: 1px solid rgba(94,106,210,0.2);\n          ${n?"direction: rtl;":""}\n        }\n        .va-exit-close {\n          position: absolute; top: 12px; ${n?"left":"right"}: 12px;\n          background: rgba(255,255,255,0.1); border: none; border-radius: 50%;\n          width: 32px; height: 32px; cursor: pointer; display: flex;\n          align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-exit-close:hover { background: rgba(255,255,255,0.2); }\n        .va-exit-close svg { width: 16px; height: 16px; fill: white; }\n        .va-exit-icon {\n          width: 80px; height: 80px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary, #5E6AD2) 0%, #10B981 100%);\n          margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 8px 32px rgba(94,106,210,0.4);\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-exit-icon svg { width: 40px; height: 40px; fill: white; }\n        .va-exit-title {\n          font-size: 24px; font-weight: 700; color: white; margin: 0 0 8px;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n        }\n        .va-exit-subtitle {\n          font-size: 15px; color: rgba(255,255,255,0.7); margin: 0 0 24px;\n          line-height: 1.5;\n        }\n        .va-exit-cta {\n          display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;\n        }\n        .va-exit-btn {\n          padding: 14px 28px; border-radius: 12px; font-size: 15px;\n          font-weight: 600; cursor: pointer; transition: all 0.2s;\n          font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;\n          border: none;\n        }\n        .va-exit-btn-primary {\n          background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n          color: white; box-shadow: 0 4px 20px rgba(94,106,210,0.4);\n        }\n        .va-exit-btn-primary:hover {\n          transform: translateY(-2px); box-shadow: 0 6px 30px rgba(94,106,210,0.6);\n        }\n        .va-exit-btn-secondary {\n          background: rgba(255,255,255,0.1); color: white;\n        }\n        .va-exit-btn-secondary:hover { background: rgba(255,255,255,0.15); }\n        .va-exit-voice-hint {\n          font-size: 12px; color: rgba(94,106,210,0.8); margin-top: 16px;\n          display: flex; align-items: center; justify-content: center; gap: 6px;\n        }\n        .va-exit-voice-hint svg { width: 14px; height: 14px; fill: currentColor; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n      </style>\n\n      <div class="va-exit-popup">\n        <button class="va-exit-close" id="va-exit-close" aria-label="${o.langData?.ui?.ariaClose||"Close"}">\n          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n        </button>\n\n        <div class="va-exit-icon">\n          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>\n        </div>\n\n        <h3 class="va-exit-title">${e?.exitIntent?.title||"Attendez !"}</h3>\n        <p class="va-exit-subtitle">${e?.exitIntent?.subtitle||"Avez-vous des questions ? Notre assistant IA peut vous aider instantanÃ©ment."}</p>\n\n        <div class="va-exit-cta">\n          <button class="va-exit-btn va-exit-btn-primary" id="va-exit-chat">\n            ${e?.exitIntent?.ctaChat||"ðŸ’¬ Discuter maintenant"}\n          </button>\n          <button class="va-exit-btn va-exit-btn-secondary" id="va-exit-demo">\n            ${e?.exitIntent?.ctaDemo||"ðŸ“… RÃ©server une dÃ©mo"}\n          </button>\n        </div>\n\n        <p class="va-exit-voice-hint">\n          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>\n          ${e?.exitIntent?.voiceHint||"Support vocal disponible"}\n        </p>\n      </div>\n    `,(p||document.body).appendChild(t),u("va-exit-close").addEventListener("click",N),u("va-exit-chat").addEventListener("click",()=>{N(),function(){const e=u("va-panel");if(e){e.classList.add("open"),o.isOpen=!0;const n=u("va-input");n&&n.focus()}}(),v("exit_intent_chat_clicked")}),u("va-exit-demo").addEventListener("click",()=>{N(),window.location.href="/booking",v("exit_intent_demo_clicked")}),t.addEventListener("click",e=>{e.target===t&&N()}),v("exit_intent_viewed")}()}function N(){o.exitIntent.dismissed=!0;const e=u("va-exit-overlay");e&&(e.style.animation="fadeOut 0.2s ease",setTimeout(()=>e.remove(),200)),v("exit_intent_dismissed")}function U(){if(o.isOpen)return;const t=o.langData||{},i=t?.meta?.rtl||!1,a=o.socialProof.messages.length>0?o.socialProof.messages:t?.socialProof?.messages||[];if(0===a.length)return;const s=a[Math.floor(Math.random()*a.length)],r=document.createElement("div");r.className="va-social-proof",r.id=`va-sp-${Date.now()}`,r.innerHTML=`\n      <style>\n        .va-social-proof {\n          position: fixed; bottom: 100px; ${i?"left":"right"}: 25px;\n          max-width: 280px; background: linear-gradient(145deg, #1e2642, #191e35);\n          border: 1px solid rgba(94,106,210,0.2); border-radius: 12px;\n          padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n          z-index: 99997; font-family: Inter, -apple-system, sans-serif;\n          animation: slideInRight 0.4s ease, fadeOut 0.3s ease ${e.SOCIAL_PROOF_DURATION-300}ms forwards;\n          ${i?"direction: rtl;":""}\n        }\n        @keyframes slideInRight {\n          from { opacity: 0; transform: translateX(${i?"-":""}30px); }\n          to { opacity: 1; transform: translateX(0); }\n        }\n        @keyframes fadeOut {\n          from { opacity: 1; }\n          to { opacity: 0; }\n        }\n        .va-sp-content { display: flex; align-items: center; gap: 10px; }\n        .va-sp-icon {\n          width: 36px; height: 36px; border-radius: 50%;\n          background: linear-gradient(135deg, #5E6AD2, #10B981);\n          display: flex; align-items: center; justify-content: center;\n          flex-shrink: 0;\n        }\n        .va-sp-icon svg { width: 18px; height: 18px; fill: white; }\n        .va-sp-text { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.4; }\n        .va-sp-time { font-size: 11px; color: rgba(94,106,210,0.7); margin-top: 4px; }\n        .va-sp-close {\n          position: absolute; top: 6px; ${i?"left":"right"}: 6px;\n          background: none; border: none; cursor: pointer;\n          color: rgba(255,255,255,0.4); padding: 2px;\n        }\n        .va-sp-close:hover { color: rgba(255,255,255,0.7); }\n      </style>\n\n      <button class="va-sp-close" aria-label="${o.langData?.ui?.ariaClose||"Close"}">\n        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n        </svg>\n      </button>\n\n      <div class="va-sp-content">\n        <div class="va-sp-icon">\n          <svg viewBox="0 0 24 24">${s.icon&&/^<(?:path|circle|rect|line|polyline|polygon|ellipse|g)\s/.test(s.icon.trim())?s.icon:'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>'}</svg>\n        </div>\n        <div>\n          <div class="va-sp-text">${n(s.text||"")}</div>\n          <div class="va-sp-time">${n(s.time||function(e){const n=e?.socialProof?.times||["Il y a 2 min","Il y a 5 min","Il y a 12 min","Il y a 23 min","Il y a 1h"];return n[Math.floor(Math.random()*n.length)]}(t))}</div>\n        </div>\n      </div>\n    `,(p||document.body).appendChild(r),r.querySelector(".va-sp-close").addEventListener("click",()=>{r.remove()}),setTimeout(()=>{u(r.id)&&r.remove()},e.SOCIAL_PROOF_DURATION),o.socialProof.notificationsShown++,o.socialProof.lastShownTime=Date.now(),v("social_proof_shown",{index:o.socialProof.notificationsShown})}function j(){const e=new Date,n=o.langData.meta.speechSynthesis,t="ar"===o.langData.meta.code,i=[];for(let a=1;a<=7;a++){const o=new Date(e);o.setDate(e.getDate()+a);const s=o.getDay();if((t?[0,1,2,3,4]:[1,2,3,4,5]).includes(s)&&(o.setHours(10,0,0,0),i.push({date:o.toLocaleDateString(n,{weekday:"long",month:"long",day:"numeric"}),time:"10:00",iso:o.toISOString()}),i.length>=3))break}return i}async function H(n){const t=o.langData,i=n.toLowerCase(),a=o.conversationContext;if(a.bookingFlow.active){const t=await async function(n){const t=o.langData,i=n.toLowerCase(),a=o.conversationContext.bookingFlow;if(t.booking.cancelKeywords.some(e=>i.includes(e)))return v("voice_booking_cancelled",{step:a.step}),a.active=!1,a.step=null,a.data={name:null,email:null,datetime:null,service:t.booking.service},t.booking.messages.cancelled;if("name"===a.step){const e=n.trim();return e.length<2?t.booking.messages.askName:(a.data.name=e,a.step="email",t.booking.messages.askEmail.replace("{name}",e))}if("email"===a.step){const i=n.trim().toLowerCase();if(!function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(i))return t.booking.messages.invalidEmail;a.data.email=i,a.step="datetime";const s=await async function(){const n=Date.now();if(o.availableSlotsCache.slots.length>0&&n-o.availableSlotsCache.timestamp<e.SLOT_CACHE_TTL)return o.availableSlotsCache.slots;try{const t=await(await fetch(e.BOOKING_API+"?action=availability",{method:"GET",mode:"cors"})).json();if(t.success&&t.data?.slots){const e=o.langData.meta.speechSynthesis,i=t.data.slots.slice(0,6).map(n=>{const t=new Date(n.start);return{date:t.toLocaleDateString(e,{weekday:"long",month:"long",day:"numeric"}),time:t.toLocaleTimeString(e,{hour:"numeric",minute:"2-digit"}),iso:n.start}});return o.availableSlotsCache={slots:i,timestamp:n},i}}catch(e){console.error("[VocalIA] Slots fetch error:",e)}return j()}();if(0===s.length)return t.booking.messages.noSlots;let r=t.booking.messages.slotsIntro;return s.slice(0,3).forEach((e,n)=>{r+=t.booking.messages.slotFormat.replace("{index}",n+1).replace("{date}",e.date).replace("{time}",e.time)+"\n"}),r+=t.booking.messages.slotsOutro,r}if("datetime"===a.step){const e=o.availableSlotsCache.slots.length>0?o.availableSlotsCache.slots.slice(0,3):j();let n=null;for(const[a,o]of Object.entries(t.booking.slotKeywords))if(o.some(e=>i.includes(e))){n=e[parseInt(a)-1];break}return n?(a.data.datetime=n.iso,a.step="confirm",v("voice_booking_slot_selected",{slot_date:n.date,slot_time:n.time}),t.booking.messages.confirmIntro+t.booking.messages.confirmName.replace("{name}",a.data.name)+"\n"+t.booking.messages.confirmEmail.replace("{email}",a.data.email)+"\n"+t.booking.messages.confirmDate.replace("{date}",n.date).replace("{time}",n.time)+t.booking.messages.confirmOutro):t.booking.messages.slotNotUnderstood}return"confirm"===a.step?t.booking.confirmKeywords.some(e=>i.includes(e))?(a.step="submitting",null):t.booking.messages.confirmPrompt:null}(n);if("submitting"===a.bookingFlow.step)return await async function(){const n=o.langData,t=o.conversationContext.bookingFlow,i=function(){if(window.GeoLocale&&"function"==typeof window.GeoLocale.getTimezone)return window.GeoLocale.getTimezone();try{return{iana:Intl.DateTimeFormat().resolvedOptions().timeZone,offset:(new Date).getTimezoneOffset()}}catch{return{iana:null,offset:(new Date).getTimezoneOffset()}}}(),a=await async function(n){try{return await(await fetch(e.BOOKING_API,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(n)})).json()}catch(e){return console.error("[VocalIA] Booking error:",e),{success:!1,message:e.message}}}({name:t.data.name,email:t.data.email,datetime:t.data.datetime,service:t.data.service||n.booking.service,phone:"",notes:`Booking via voice assistant (${o.currentLang.toUpperCase()})`,timezone:i.iana||`UTC${i.offset>0?"-":"+"}${Math.abs(i.offset/60)}`});return t.active=!1,t.step=null,a.success?(v("voice_booking_completed",{service:t.data.service,datetime:t.data.datetime}),n.booking.messages.success.replace("{email}",t.data.email)):(v("voice_booking_failed",{error:a.message}),n.booking.messages.failure.replace("{message}",a.message))}();if(t)return t}return o.planFeatures&&!1===o.planFeatures.booking||!function(e){const n=o.langData;if(!n?.booking?.keywords)return!1;const t=e.toLowerCase();return n.booking.keywords.some(e=>t.includes(e))}(i)?await async function(n){if(!e.AI_MODE)return null;try{const t=new AbortController,i=setTimeout(()=>t.abort(),e.API_TIMEOUT),a={message:n,language:o.currentLang,sessionId:o.sessionId||`widget_${Date.now()}`,tenant_id:o.tenantId,api_key:e.api_key||void 0,widget_type:"ECOM",history:o.conversationHistory.slice(-10).map(e=>({role:e.role,content:e.content}))};o.conversationHistory.length<=2&&(a.page_context=function(){const e=window.location.pathname,n=document.title||"",t=document.querySelector('meta[property="og:title"]')?.content||"",i=document.querySelector('meta[name="description"]')?.content||"",a=document.querySelector("h1")?.textContent?.trim()||"";let o="general";/\/(product|produit)/i.test(e)?o="product":/\/(collection|category|categorie)/i.test(e)?o="category":/\/(cart|panier)/i.test(e)?o="cart":/\/(checkout|commande)/i.test(e)?o="checkout":/\/(pricing|tarifs|prix)/i.test(e)?o="pricing":/\/(booking|rendez-vous|demo)/i.test(e)?o="booking":("/"===e||"/index.html"===e)&&(o="homepage");const s=document.querySelector('script[type="application/ld+json"]');let r=null;if(s)try{const e=JSON.parse(s.textContent);"Product"===e["@type"]&&(r={name:e.name,price:e.offers?.price,currency:e.offers?.priceCurrency})}catch{}return r||document.querySelector('meta[property="og:type"][content="product"]')&&(r={name:t||a,price:document.querySelector('meta[property="product:price:amount"]')?.content,currency:document.querySelector('meta[property="product:price:currency"]')?.content}),{path:e,pageType:o,title:t||a||n,description:i.slice(0,200),product:r}}());const s=await fetch(e.VOICE_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:t.signal});if(clearTimeout(i),!s.ok)return console.warn("[VocalIA] API error:",s.status),null;const r=await s.json();return r.response?(r.features&&(o.planFeatures=r.features),v("voice_api_response",{language:o.currentLang,latency:r.latencyMs}),r.a2ui&&function(n){if(!n||!n.html)return;const t=u("va-messages");if(!t)return;const i=document.createElement("div");if(i.className="va-message assistant va-a2ui-wrapper",n.css){const e=document.createElement("style");e.textContent=n.css,i.appendChild(e)}const a=document.createElement("div");a.className="va-message-content",a.innerHTML=function(e){const n=/^(div|span|button|p|h[1-6]|ul|ol|li|img|svg|path|line|circle|label|input|select|option|strong|em|br|a)$/i,t=/^(class|id|style|data-[a-z-]+|aria-[a-z]+|role|type|placeholder|value|src|alt|href|viewBox|d|fill|stroke|stroke-width|stroke-linecap|stroke-linejoin|xmlns|width|height|x1|y1|x2|y2|cx|cy|r|loading|dir|disabled)$/i,i=document.createElement("div");i.innerHTML=e;const a=e=>{const i=Array.from(e.childNodes);for(const e of i)if(3!==e.nodeType){if(1!==e.nodeType){e.remove();continue}if(!n.test(e.tagName)){e.remove();continue}for(const n of Array.from(e.attributes))t.test(n.name)||e.removeAttribute(n.name);for(const n of Array.from(e.attributes))n.name.startsWith("on")&&e.removeAttribute(n.name);e.hasAttribute("href")&&/^\s*javascript:/i.test(e.getAttribute("href"))&&e.removeAttribute("href"),e.hasAttribute("src")&&/^\s*javascript:/i.test(e.getAttribute("src"))&&e.removeAttribute("src"),a(e)}};return a(i),i.innerHTML}(n.html),i.appendChild(a),t.appendChild(i),t.scrollTop=t.scrollHeight,i.querySelectorAll("[data-a2ui-action]").forEach(t=>{t.addEventListener("click",()=>{!async function(n,t){if(v("a2ui_action",{action:n,type:t.type}),"select_slot"===n){const e=t.element.closest("[data-a2ui-component]");if(e){e.querySelectorAll(".va-a2ui-slot").forEach(e=>e.classList.remove("selected")),t.element.classList.add("selected");const n=e.querySelector('[data-a2ui-action="confirm_booking"]');n&&(n.disabled=!1)}return}if("close"===n)return void t.wrapper.remove();const i={},a=t.element.closest("[data-a2ui-component]");if("confirm_booking"===n&&a){const e=a.querySelector(".va-a2ui-slot.selected");i.slot=e?.dataset.slot}else if("submit_lead"===n&&a){const e=a.querySelector("form");e&&new FormData(e).forEach((e,n)=>{i[n]=e})}try{const t=await(await fetch(e.VOICE_API_URL.replace("/respond","/a2ui/action"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:n,data:i,sessionId:o.sessionId,tenant_id:o.tenantId,widget_type:"ECOM"})})).json();t.message&&m(t.message,"assistant")}catch(e){console.warn("[VocalIA ECOM] A2UI action failed:",e.message)}}(t.dataset.a2uiAction,{type:n.type,value:t.dataset.slot||t.dataset.productId||null,element:t,wrapper:i})})}),v("a2ui_rendered",{type:n.type})}(r.a2ui),r.catalog&&r.catalog.items&&r.catalog.items.length>0&&y(r.catalog.items,r.catalog.title,"api_response"),r.response):null}catch(e){"AbortError"===e.name?console.error("[VocalIA] API timeout"):console.error("[VocalIA] API error:",e.message);const n=o.langData?.ui||{};return"AbortError"===e.name?n.timeoutMessage||n.errorMessage||"The request took too long. Please try again.":n.connectionError||n.errorMessage||"Sorry, I'm experiencing a connection issue."}}(n)||t?.ui?.errorMessage||"DÃ©solÃ©, je suis temporairement indisponible. Veuillez rÃ©essayer.":(a.bookingFlow.active=!0,a.bookingFlow.step="name",a.bookingFlow.data.service=t.booking.service,v("voice_booking_started",{step:"name"}),t.booking.messages.start)}async function G(n,t="text"){if(n.trim()){"voice"!==(i=t)&&"text"!==i||(o.ecommerce.inputMethodStats[i]++,o.ecommerce.lastInputMethod=i,v("input_method_used",{method:i,total_voice:o.ecommerce.inputMethodStats.voice,total_text:o.ecommerce.inputMethodStats.text,voice_ratio:o.ecommerce.inputMethodStats.voice/(o.ecommerce.inputMethodStats.voice+o.ecommerce.inputMethodStats.text)})),m(n,"user"),u("va-input").value="",function(){const e=u("va-messages"),n=document.createElement("div");n.className="va-message assistant",n.id="va-typing",n.innerHTML='<div class="va-message-content"><div class="va-typing"><span></span><span></span><span></span></div></div>',e.appendChild(n),e.scrollTop=e.scrollHeight}();try{if(e.ECOMMERCE_MODE&&o.tenantId){const i=function(e){const n=e.toLowerCase(),t=o.langData,i=t?.ecommerce?.searchKeywords||["cherche","recherche","trouve","looking for","search","find","busco","necesito","quiero","Ø¨Ø­Ø«","Ù†Ø¨ØºÙŠ","Ø¨Ø§ØºÙŠ"],a=t?.ecommerce?.categoryKeywords||{electronics:["tÃ©lÃ©phone","phone","laptop","ordinateur","Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª"],clothing:["vÃªtement","clothes","robe","pantalon","Ù…Ù„Ø§Ø¨Ø³","Ø­ÙˆØ§ÙŠØ¬"],food:["nourriture","food","manger","Ø£ÙƒÙ„","Ù…Ø§ÙƒÙ„Ø©"],beauty:["beautÃ©","cosmÃ©tique","beauty","makeup","Ø²ÙŠÙ†Ø©","Ø¬Ù…Ø§Ù„"]},s=t?.ecommerce?.recommendKeywords||["recommande","suggÃ¨re","propose","recommend","suggest","recomienda","sugiere","Ù†ØµØ­Ù†ÙŠ","Ø´ÙˆÙ Ù„ÙŠ","Ù‚ØªØ±Ø­"],r=i.some(e=>n.includes(e)),c=s.some(e=>n.includes(e));let l=null;for(const[e,t]of Object.entries(a))if(t.some(e=>n.includes(e))){l=e;break}let d=null;if(r){const n=e.split(/\s+/).filter(e=>e.length>2&&!i.includes(e.toLowerCase()));n.length>0&&(d=n.slice(-3).join(" "))}return r||c||l?{type:r?"search":c?"recommend":"category",category:l,query:d}:null}(n);if(i){v("product_intent_detected",{intent_type:i.type,category:i.category,query:i.query,input_method:t});let a=[];if(a="search"===i.type&&i.query?await C.searchProducts(i.query):"recommend"===i.type?await C.getRecommendations():await C.fetchProducts({category:i.category,limit:e.MAX_CAROUSEL_ITEMS}),0===a.length&&(a=await async function(n={}){if(!e.ECOMMERCE_MODE||!o.tenantId)return[];const t=JSON.stringify({tenantId:o.tenantId,...n}),i=Date.now();if(o.catalogCache.key===t&&i-o.catalogCache.timestamp<e.CATALOG_CACHE_TTL)return o.catalogCache.products;try{const a=n.search?`${e.CATALOG_API_URL}/${o.tenantId}/catalog/search`:`${e.CATALOG_API_URL}/${o.tenantId}/catalog`,s=new URLSearchParams;n.category&&s.append("category",n.category),n.search&&s.append("q",n.search),n.limit&&s.append("limit",n.limit);const r=s.toString()?`${a}?${s}`:a,c=await fetch(r,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!c.ok)return console.warn("[VocalIA] Catalog API error:",c.status),[];const l=await c.json(),d=l.items||l.results||l.products||[];return o.catalogCache={key:t,products:d,timestamp:i},d}catch(e){return console.warn("[VocalIA] Catalog fetch error:",e.message),[]}}({category:i.category,search:i.query,limit:e.MAX_CAROUSEL_ITEMS})),a.length>0)return f(),k.recordInteraction("product_search",{intent:i.type,category:i.category,query:i.query,results_count:a.length}),y(a,i.query?`${o.langData?.ecommerce?.resultsFor||"RÃ©sultats pour"} "${i.query}"`:null,i.type),void m(await H(n),"assistant")}}const i=await H(n);f(),m(i,"assistant")}catch(e){f(),m(o.langData.ui.errorMessage,"assistant"),console.error("[VocalIA] Response error:",e)}}var i}function X(){o.isOpen=!o.isOpen;const e=u("va-panel");if(o.isOpen){e.classList.add("open"),v("voice_panel_opened");const t=u("va-messages");if(o.conversationHistory.length>0&&t&&0===t.children.length){for(const e of o.conversationHistory){const i=document.createElement("div");i.className=`va-message ${e.role}`,i.innerHTML=`<div class="va-message-content">${n(e.content)}</div>`,t.appendChild(i)}t.scrollTop=t.scrollHeight}else if(0===o.conversationHistory.length){const e=o.langData;m(d?e.ui.welcomeMessageTextOnly:e.ui.welcomeMessage,"assistant")}u("va-input").focus()}else e.classList.remove("open"),o.synthesis&&o.synthesis.cancel(),v("voice_panel_closed")}const W=new Set(["DEFAULT_LANG","ECOMMERCE_MODE","EXIT_INTENT_ENABLED","EXIT_INTENT_DELAY","EXIT_INTENT_SENSITIVITY","EXIT_INTENT_COOLDOWN","EXIT_INTENT_MOBILE_SCROLL_RATIO","EXIT_INTENT_PAGES","SOCIAL_PROOF_ENABLED","SOCIAL_PROOF_INTERVAL","SOCIAL_PROOF_DURATION","SOCIAL_PROOF_MAX_SHOWN","MAX_CAROUSEL_ITEMS","AI_MODE","API_TIMEOUT","widgetPosition"]);function Y(n){if(n&&"object"==typeof n)for(const t of Object.keys(n))W.has(t)&&(e[t]=n[t])}async function Q(){try{window.VOCALIA_CONFIG_INJECTED&&Y(window.VOCALIA_CONFIG_INJECTED),window.VOCALIA_CONFIG&&Y(window.VOCALIA_CONFIG);const n=function(){const n=new URLSearchParams(window.location.search).get("lang");if(n&&e.SUPPORTED_LANGS.includes(n))return n;const t=document.documentElement.lang?.toLowerCase()?.split("-")[0];if(t&&e.SUPPORTED_LANGS.includes(t))return t;const i=navigator.language||navigator.userLanguage,a=e.AUTO_DETECT_LANGUAGES[i]||e.AUTO_DETECT_LANGUAGES[i?.split("-")[0]];return a&&e.SUPPORTED_LANGS.includes(a)?a:e.DEFAULT_LANG}();await g(n),function(){if(e.tenantId)return void(o.tenantId=e.tenantId);const n=document.querySelector("script[data-vocalia-tenant]")||document.querySelector("script[data-tenant-id]");if(n)return void(o.tenantId=n.dataset.vocaliaTenant||n.dataset.tenantId);const t=new URLSearchParams(window.location.search),i=t.get("tenant_id")||t.get("tenantId");if(i)return void(o.tenantId=i);const a=document.querySelector('meta[name="vocalia-tenant"]');if(a)return void(o.tenantId=a.content);if(window.VOCALIA_TENANT_ID)return void(o.tenantId=window.VOCALIA_TENANT_ID);const s=document.getElementById("vocalia-widget")||document.getElementById("voice-assistant-widget");s?.dataset.tenantId&&(o.tenantId=s.dataset.tenantId)}(),o.tenantId&&(await async function(){if(!o.tenantId)return null;const n=`${e.VOICE_API_URL.replace("/respond","/config")}?tenantId=${encodeURIComponent(o.tenantId)}`;try{const t=await fetch(n,{signal:AbortSignal.timeout(e.API_TIMEOUT)});if(!t.ok)throw new Error("Config fetch failed");const i=await t.json();if(i.success){if(i.branding&&i.branding.primaryColor){e.primaryColor=i.branding.primaryColor;const n=document.getElementById("voice-assistant-widget");n&&n.style.setProperty("--va-primary",e.primaryColor)}return i.position&&["bottom-right","bottom-left"].includes(i.position)&&(e.widgetPosition=i.position),o.tenantConfig=i,i.plan_features&&(o.planFeatures=i.plan_features),i.currency&&(o.currency=i.currency),v("tenant_config_loaded",{tenantId:o.tenantId,plan:i.plan}),i}}catch(e){console.warn("[VocalIA ECOM] Config fetch failed, using static defaults:",e.message)}return null}(),e.ECOMMERCE_MODE&&k.syncPreference().catch(e=>console.warn("[VocalIA] UCP init failed:",e.message)),V.isEnabled()&&V.connect().catch(e=>console.warn("[VocalIA] Cloud voice init failed:",e.message))),function(){const e=new URLSearchParams(window.location.search),n=o.conversationContext.attribution;n.utm_source=e.get("utm_source")||n.utm_source,n.utm_medium=e.get("utm_medium")||n.utm_medium,n.utm_campaign=e.get("utm_campaign")||n.utm_campaign,n.gclid=e.get("gclid")||n.gclid,n.fbclid=e.get("fbclid")||n.fbclid}(),function(){if(document.getElementById("voice-assistant-widget"))return;const n=o.langData,t=n.meta.rtl,i="bottom-left"===e.widgetPosition?"left":"bottom-right"===e.widgetPosition?"right":t?"left":"right",a=document.createElement("div");a.id="voice-assistant-widget",a.style.cssText=`position:fixed;bottom:30px;${i}:25px;z-index:99999;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;${t?"direction:rtl;":""}`,document.body.appendChild(a),p=a.attachShadow({mode:"open"}),p.innerHTML=function(n,t,i){return`\n      <style>\n        #voice-assistant-widget {\n          --va-primary: ${e.primaryColor};\n          --va-primary-dark: ${e.primaryDark};\n          --va-accent: ${e.accentColor};\n          --va-dark: ${e.darkBg};\n        }\n        .va-trigger {\n          width: 60px; height: 60px; border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;\n          box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4);\n          transition: all 0.3s ease; position: relative;\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n        .va-trigger::before {\n          content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;\n          border-radius: 50%; background: linear-gradient(135deg, var(--va-primary), var(--va-accent));\n          opacity: 0; z-index: -1; animation: pulse-ring 2s ease-out infinite;\n        }\n        .va-trigger::after {\n          content: ''; position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px;\n          border-radius: 50%; border: 2px solid var(--va-primary);\n          opacity: 0; animation: pulse-ring-outer 2s ease-out infinite 0.5s;\n        }\n        @keyframes pulse-glow {\n          0%, 100% { box-shadow: 0 4px 20px rgba(94, 106, 210, 0.4); transform: scale(1); }\n          50% { box-shadow: 0 4px 30px rgba(94, 106, 210, 0.7); transform: scale(1.02); }\n        }\n        @keyframes pulse-ring {\n          0% { transform: scale(1); opacity: 0.6; }\n          100% { transform: scale(1.4); opacity: 0; }\n        }\n        @keyframes pulse-ring-outer {\n          0% { transform: scale(1); opacity: 0.4; }\n          100% { transform: scale(1.6); opacity: 0; }\n        }\n        .va-trigger:hover {\n          transform: scale(1.1); box-shadow: 0 6px 30px rgba(94, 106, 210, 0.6); animation: none;\n        }\n        .va-trigger:hover::before, .va-trigger:hover::after { animation: none; opacity: 0; }\n        .va-trigger img { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; }\n        .va-trigger.listening { animation: pulse 1.5s infinite; }\n        @keyframes pulse {\n          0%, 100% { box-shadow: 0 0 0 0 rgba(94, 106, 210, 0.7); }\n          50% { box-shadow: 0 0 0 15px rgba(94, 106, 210, 0); }\n        }\n        .va-panel {\n          display: none; position: absolute; bottom: 70px; ${i}: 0;\n          width: 360px; max-height: 500px; background: var(--va-dark);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;\n          overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n          ${t?"direction: rtl; text-align: right;":""}\n        }\n        .va-panel.open { display: flex; flex-direction: column; animation: slideUp 0.3s ease; }\n        @keyframes slideUp {\n          from { opacity: 0; transform: translateY(20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        .va-header {\n          padding: 16px;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          display: flex; align-items: center; gap: 12px; ${t?"flex-direction: row-reverse;":""}\n        }\n        .va-header-icon {\n          width: 40px; height: 40px; background: rgba(255,255,255,0.2);\n          border-radius: 50%; display: flex; align-items: center; justify-content: center;\n        }\n        .va-header-icon img { width: 24px; height: 24px; object-fit: contain; border-radius: 4px; }\n        .va-header-text h3 { margin: 0; font-size: 16px; font-weight: 600; color: white; }\n        .va-header-text p { margin: 2px 0 0; font-size: 12px; color: rgba(255,255,255,0.8); }\n        .va-close {\n          margin-${t?"right":"left"}: auto; background: none; border: none;\n          color: white; cursor: pointer; padding: 4px; opacity: 0.8;\n        }\n        .va-close:hover { opacity: 1; }\n        .va-messages { flex: 1; overflow-y: auto; padding: 16px; max-height: 300px; }\n        .va-message { margin-bottom: 12px; display: flex; gap: 8px; }\n        .va-message.user { flex-direction: ${t?"row":"row-reverse"}; }\n        .va-message.assistant { flex-direction: ${t?"row-reverse":"row"}; }\n        .va-message-content {\n          max-width: 80%; padding: 10px 14px; border-radius: 12px;\n          font-size: 14px; line-height: 1.5;\n        }\n        .va-message.assistant .va-message-content { background: rgba(255,255,255,0.1); color: #e5e5e5; }\n        .va-message.user .va-message-content { background: var(--va-primary); color: white; }\n        .va-input-area {\n          padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.1);\n          display: flex; gap: 8px; ${t?"flex-direction: row-reverse; direction: rtl; text-align: right;":""}\n        }\n        .va-input {\n          flex: 1; background: rgba(255,255,255,0.1);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;\n          padding: 10px 16px; color: white; font-size: 14px; outline: none;\n          ${t?"direction: rtl; text-align: right;":""}\n        }\n        .va-input::placeholder { color: rgba(255,255,255,0.5); }\n        .va-input:focus { border-color: var(--va-primary); }\n        .va-mic-btn {\n          width: 40px; height: 40px; border-radius: 50%;\n          background: ${s||typeof MediaRecorder<"u"?"var(--va-primary)":"rgba(255,255,255,0.1)"};\n          border: none; cursor: ${s||typeof MediaRecorder<"u"?"pointer":"not-allowed"};\n          display: flex; align-items: center; justify-content: center; transition: all 0.2s;\n        }\n        .va-mic-btn.listening { background: #ef4444; animation: pulse 1s infinite; }\n        .va-mic-btn svg { width: 20px; height: 20px; fill: white; }\n\n        /* Voice Waveform Visualizer (SOTA 2026) */\n        .va-visualizer {\n          height: 48px; padding: 8px 16px; display: none;\n          background: linear-gradient(180deg, rgba(94,106,210,0.1) 0%, transparent 100%);\n          border-bottom: 1px solid rgba(255,255,255,0.05);\n        }\n        .va-visualizer.active { display: block; animation: fadeIn 0.3s ease; }\n        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n        .va-visualizer-canvas {\n          width: 100%; height: 100%; display: block;\n        }\n        .va-visualizer-bars {\n          display: flex; align-items: center; justify-content: center;\n          gap: 3px; height: 100%;\n        }\n        .va-visualizer-bar {\n          width: 3px; border-radius: 2px; background: var(--va-primary);\n          transition: height 0.1s ease;\n        }\n        .va-visualizer-bars.speaking .va-visualizer-bar {\n          animation: soundBar 0.5s ease-in-out infinite alternate;\n        }\n        @keyframes soundBar {\n          0% { height: 4px; opacity: 0.5; }\n          100% { height: var(--bar-height, 24px); opacity: 1; }\n        }\n        .va-visualizer-bar:nth-child(1) { animation-delay: 0.0s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(2) { animation-delay: 0.1s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(3) { animation-delay: 0.2s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(4) { animation-delay: 0.1s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(5) { animation-delay: 0.15s; --bar-height: 36px; }\n        .va-visualizer-bar:nth-child(6) { animation-delay: 0.2s; --bar-height: 32px; }\n        .va-visualizer-bar:nth-child(7) { animation-delay: 0.25s; --bar-height: 20px; }\n        .va-visualizer-bar:nth-child(8) { animation-delay: 0.15s; --bar-height: 28px; }\n        .va-visualizer-bar:nth-child(9) { animation-delay: 0.1s; --bar-height: 24px; }\n        .va-visualizer-bar:nth-child(10) { animation-delay: 0.05s; --bar-height: 16px; }\n        .va-visualizer-label {\n          font-size: 10px; color: rgba(255,255,255,0.5); text-align: center;\n          margin-top: 4px; text-transform: uppercase; letter-spacing: 1px;\n        }\n        .va-visualizer-label.listening { color: #ef4444; }\n        .va-visualizer-label.speaking { color: var(--va-primary); }\n        .va-send-btn {\n          width: 40px; height: 40px; border-radius: 50%; background: var(--va-primary);\n          border: none; cursor: pointer; display: flex; align-items: center;\n          justify-content: center; transition: all 0.2s;\n        }\n        .va-send-btn:hover { transform: scale(1.1); }\n        .va-send-btn svg { width: 20px; height: 20px; fill: white; ${t?"transform: scaleX(-1);":""} }\n        .va-typing { display: flex; gap: 4px; padding: 10px 14px; direction: ltr; }\n        .va-typing span {\n          width: 8px; height: 8px; background: rgba(255,255,255,0.5);\n          border-radius: 50%; animation: typing 1.4s infinite ease-in-out;\n        }\n        .va-typing span:nth-child(2) { animation-delay: 0.2s; }\n        .va-typing span:nth-child(3) { animation-delay: 0.4s; }\n        @keyframes typing {\n          0%, 60%, 100% { transform: translateY(0); }\n          30% { transform: translateY(-6px); }\n        }\n        .va-cta {\n          padding: 12px 16px; background: rgba(94, 106, 210, 0.1);\n          border-top: 1px solid rgba(94, 106, 210, 0.2);\n        }\n        .va-cta a {\n          display: block; text-align: center; padding: 10px;\n          background: var(--va-primary); color: white; text-decoration: none;\n          border-radius: 8px; font-size: 14px; font-weight: 500; transition: all 0.2s;\n        }\n        .va-cta a:hover { background: var(--va-primary-dark); }\n        @keyframes notifSlideIn {\n          from { opacity: 0; transform: translateX(${t?"-":""}20px) scale(0.9); }\n          to { opacity: 1; transform: translateX(0) scale(1); }\n        }\n        @keyframes notifSlideOut {\n          from { opacity: 1; transform: translateX(0) scale(1); }\n          to { opacity: 0; transform: translateX(${t?"-":""}20px) scale(0.9); }\n        }\n        @media (max-width: 480px) { .va-panel { width: calc(100vw - 40px); ${i}: -10px; } }\n\n        /* E-commerce Product Cards & Carousel (Phase 1) */\n        .va-product-carousel {\n          display: flex; gap: 12px; overflow-x: auto; padding: 8px 0 12px;\n          scrollbar-width: thin; scrollbar-color: var(--va-primary) transparent;\n          scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;\n        }\n        .va-product-carousel::-webkit-scrollbar { height: 4px; }\n        .va-product-carousel::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }\n        .va-product-carousel::-webkit-scrollbar-thumb { background: var(--va-primary); border-radius: 4px; }\n        .va-product-card {\n          flex: 0 0 auto; width: 140px; background: rgba(255,255,255,0.05);\n          border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;\n          overflow: hidden; cursor: pointer; transition: all 0.2s ease;\n          scroll-snap-align: start;\n        }\n        .va-product-card:hover {\n          border-color: var(--va-primary); transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(94, 106, 210, 0.2);\n        }\n        .va-product-card.featured {\n          border-color: var(--va-accent);\n          background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(255,255,255,0.05) 100%);\n        }\n        .va-product-img {\n          width: 100%; height: 100px; object-fit: cover;\n          background: rgba(255,255,255,0.1);\n        }\n        .va-product-img-placeholder {\n          width: 100%; height: 100px; display: flex; align-items: center; justify-content: center;\n          background: linear-gradient(135deg, rgba(94,106,210,0.1) 0%, rgba(16,185,129,0.1) 100%);\n          color: rgba(255,255,255,0.3); font-size: 32px;\n        }\n        .va-product-info { padding: 10px; }\n        .va-product-name {\n          font-size: 12px; font-weight: 600; color: #e5e5e5;\n          margin: 0 0 4px; line-height: 1.3;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-product-price {\n          font-size: 14px; font-weight: 700; color: var(--va-primary);\n          display: flex; align-items: baseline; gap: 4px;\n        }\n        .va-product-price-old {\n          font-size: 10px; color: rgba(255,255,255,0.4);\n          text-decoration: line-through; font-weight: 400;\n        }\n        .va-product-badge {\n          position: absolute; top: 8px; ${i}: 8px;\n          background: var(--va-accent); color: white; font-size: 9px;\n          padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase;\n        }\n        .va-product-badge.sale { background: #ef4444; }\n        .va-product-badge.new { background: var(--va-primary); }\n        .va-product-stock {\n          font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px;\n        }\n        .va-product-stock.low { color: #f59e0b; }\n        .va-product-stock.out { color: #ef4444; }\n        .va-carousel-header {\n          display: flex; justify-content: space-between; align-items: center;\n          padding: 8px 0; margin-bottom: 4px;\n        }\n        .va-carousel-title {\n          font-size: 13px; font-weight: 600; color: #e5e5e5;\n          display: flex; align-items: center; gap: 6px;\n        }\n        .va-carousel-title svg { width: 16px; height: 16px; fill: var(--va-primary); }\n        .va-carousel-nav {\n          display: flex; gap: 4px;\n        }\n        .va-carousel-nav button {\n          width: 24px; height: 24px; border-radius: 50%; border: none;\n          background: rgba(255,255,255,0.1); color: white; cursor: pointer;\n          display: flex; align-items: center; justify-content: center;\n          transition: all 0.2s;\n        }\n        .va-carousel-nav button:hover { background: var(--va-primary); }\n        .va-carousel-nav button:disabled { opacity: 0.3; cursor: not-allowed; }\n        .va-carousel-nav button svg { width: 14px; height: 14px; fill: currentColor; }\n        .va-product-actions {\n          display: flex; gap: 4px; margin-top: 8px;\n        }\n        .va-product-btn {\n          flex: 1; padding: 6px 8px; border-radius: 6px; border: none;\n          font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;\n        }\n        .va-product-btn.primary {\n          background: var(--va-primary); color: white;\n        }\n        .va-product-btn.primary:hover { background: var(--va-primary-dark); }\n        .va-product-btn.secondary {\n          background: rgba(255,255,255,0.1); color: #e5e5e5;\n        }\n        .va-product-btn.secondary:hover { background: rgba(255,255,255,0.2); }\n        .va-single-product {\n          background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);\n          border-radius: 12px; padding: 12px; margin: 8px 0;\n        }\n        .va-single-product-row { display: flex; gap: 12px; }\n        .va-single-product-img {\n          width: 80px; height: 80px; border-radius: 8px; object-fit: cover;\n          background: rgba(255,255,255,0.1); flex-shrink: 0;\n        }\n        .va-single-product-details { flex: 1; min-width: 0; }\n        .va-single-product-name {\n          font-size: 14px; font-weight: 600; color: #e5e5e5; margin: 0 0 4px;\n        }\n        .va-single-product-desc {\n          font-size: 11px; color: rgba(255,255,255,0.6); margin: 0 0 8px;\n          display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;\n        }\n        .va-single-product-price {\n          font-size: 16px; font-weight: 700; color: var(--va-primary);\n        }\n        .va-input-method-indicator {\n          position: absolute; top: 12px; ${t?"left":"right"}: 50px;\n          font-size: 10px; color: rgba(255,255,255,0.4); display: flex; gap: 8px;\n        }\n        .va-input-method-indicator span {\n          display: flex; align-items: center; gap: 3px;\n        }\n        .va-input-method-indicator svg { width: 12px; height: 12px; fill: currentColor; }\n        .va-input-method-indicator .active { color: var(--va-primary); }\n      </style>\n\n      <button class="va-trigger" id="va-trigger" aria-label="${n.ui.ariaOpenAssistant}">\n        <img src="${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/logo.png":"https://vocalia.ma/logo.png"}" alt="VocalIA" />\n      </button>\n\n      <div class="va-panel" id="va-panel" role="dialog" aria-label="${n.ui.headerTitle}" aria-modal="true">\n        <div class="va-header">\n          <div class="va-header-icon">\n            <img src="${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"/logo.png":"https://vocalia.ma/logo.png"}" alt="VocalIA" />\n          </div>\n          <div class="va-header-text">\n            <h3>${n.ui.headerTitle}</h3>\n            <p>${d?n.ui.headerSubtitleText:n.ui.headerSubtitleVoice}</p>\n          </div>\n          <button class="va-close" id="va-close" aria-label="${n.ui.ariaClose}">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n        </div>\n\n        \x3c!-- Voice Waveform Visualizer (SOTA 2026) --\x3e\n        <div class="va-visualizer" id="va-visualizer" aria-hidden="true">\n          <div class="va-visualizer-bars" id="va-visualizer-bars">\n            ${Array.from({length:10},()=>'<div class="va-visualizer-bar"></div>').join("")}\n          </div>\n          <div class="va-visualizer-label" id="va-visualizer-label">${n.ui.voiceReady||"Voice Ready"}</div>\n        </div>\n\n        <div class="va-messages" id="va-messages" aria-live="polite" aria-relevant="additions"></div>\n\n        <div class="va-input-area">\n          <input type="text" class="va-input" id="va-input" placeholder="${n.ui.placeholder}">\n          ${s||typeof MediaRecorder<"u"?`\n          <button class="va-mic-btn" id="va-mic" aria-label="${n.ui.ariaMic||"Microphone"}">\n            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/></svg>\n          </button>\n          `:""}\n          <button class="va-send-btn" id="va-send" aria-label="${n.ui.ariaSend}">\n            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n          </button>\n        </div>\n\n        <div class="va-cta">\n          <a href="${n.ui.ctaLink}">${n.ui.ctaButton}</a>\n        </div>\n      </div>\n    `}(n,t,i),function(){u("va-trigger").addEventListener("click",X),u("va-close").addEventListener("click",X),u("va-send").addEventListener("click",()=>{G(u("va-input").value,"text")}),u("va-input").addEventListener("keypress",e=>{"Enter"===e.key&&G(e.target.value,"text")}),function(){if(s){const e=window.SpeechRecognition||window.webkitSpeechRecognition;o.recognition=new e,o.recognition.lang=o.langData.meta.speechRecognition,o.recognition.continuous=!1,o.recognition.interimResults=!1,o.recognition.onresult=e=>{const n=e.results[0][0].transcript;u("va-input").value=n,G(n,"voice"),e.results[0][0].confidence&&v("voice_recognition_result",{confidence:e.results[0][0].confidence,detected_lang:o.recognition.lang})},o.recognition.onend=()=>{o.isListening=!1,u("va-mic")?.classList.remove("listening"),u("va-trigger")?.classList.remove("listening"),M()},o.recognition.onerror=e=>{o.isListening=!1,u("va-mic")?.classList.remove("listening"),M(),v("voice_recognition_error",{error:e.error})},o.sttMode="native"}else navigator.mediaDevices&&typeof MediaRecorder<"u"?(o.sttMode="fallback",console.log("[VocalIA ECOM] Using MediaRecorder STT fallback")):o.sttMode="none"}();const e=u("va-mic");e&&"none"!==o.sttMode?e.addEventListener("click",O):e&&"none"===o.sttMode&&(e.style.display="none"),document.addEventListener("keydown",e=>{if(o.isOpen){if("Escape"===e.key){X();const e=u("va-trigger");return void(e&&e.focus())}if("Tab"===e.key){const n=u("va-panel");if(!n)return;const t=n.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');if(0===t.length)return;const i=t[0],a=t[t.length-1],o=(p||document).activeElement;e.shiftKey&&o===i?(e.preventDefault(),a.focus()):!e.shiftKey&&o===a&&(e.preventDefault(),i.focus())}}})}(),setTimeout(()=>{o.isOpen||function(){const n=o.langData,t=n.meta.rtl,i="bottom-left"===e.widgetPosition?"left":"bottom-right"===e.widgetPosition?"right":t?"left":"right",a=u("va-trigger"),s=document.createElement("div");s.className="va-notification",s.innerHTML=`\n      <div class="va-notif-icon">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n        </svg>\n      </div>\n      <div class="va-notif-text">\n        <span class="va-notif-title">${n.ui.notifTitle}</span>\n        <span class="va-notif-sub">${n.ui.notifSub}</span>\n      </div>\n    `,s.style.cssText=`\n      position: absolute; bottom: 75px; ${i}: 0;\n      display: flex; align-items: center; gap: 10px;\n      background: rgba(25, 30, 53, 0.95);\n      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n      border: 1px solid rgba(94, 106, 210, 0.3);\n      padding: 12px 16px; border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(94, 106, 210, 0.15);\n      animation: notifSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer; white-space: nowrap; z-index: 9999;\n      ${t?"direction: rtl; flex-direction: row-reverse;":""}\n    `;const r=s.querySelector(".va-notif-icon");r&&(r.style.cssText="width: 32px; height: 32px; background: linear-gradient(135deg, rgba(94, 106, 210, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #5E6AD2; flex-shrink: 0;");const c=s.querySelector(".va-notif-text");c&&(c.style.cssText="display: flex; flex-direction: column; gap: 2px;");const l=s.querySelector(".va-notif-title");l&&(l.style.cssText="font-size: 14px; font-weight: 600; color: #E4F4FC;");const d=s.querySelector(".va-notif-sub");d&&(d.style.cssText="font-size: 11px; color: rgba(255, 255, 255, 0.7);");const p=document.createElement("div");p.style.cssText=`position: absolute; bottom: -6px; ${i}: 24px; width: 12px; height: 12px; background: rgba(25, 30, 53, 0.95); border-${t?"left":"right"}: 1px solid rgba(94, 106, 210, 0.3); border-bottom: 1px solid rgba(94, 106, 210, 0.3); transform: rotate(${t?"-":""}45deg);`,s.appendChild(p),a.parentNode.appendChild(s),s.addEventListener("click",X),setTimeout(()=>{s.style.animation="notifSlideOut 0.3s ease forwards",setTimeout(()=>s.remove(),300)},6e3)}()},2e3)}(),function(){if(!e.EXIT_INTENT_ENABLED)return;let n=null;try{n=localStorage.getItem("vocalia_exit_intent_shown")}catch{}n&&Date.now()-parseInt(n)<e.EXIT_INTENT_COOLDOWN||e.EXIT_INTENT_PAGES&&!e.EXIT_INTENT_PAGES.includes(window.location.pathname)||(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?window.addEventListener("scroll",D,{passive:!0}):(document.addEventListener("mouseleave",R),document.addEventListener("mouseout",$)))}(),async function(){if(e.SOCIAL_PROOF_ENABLED){try{const n=`${e.SOCIAL_PROOF_API_URL}?lang=${o.currentLang}`,t=await(await fetch(n,{signal:AbortSignal.timeout(5e3)})).json();t.success&&Array.isArray(t.messages)&&t.messages.length>0&&(o.socialProof.messages=t.messages)}catch(e){console.warn("[VocalIA ECOM] Social proof API unavailable, using lang data:",e.message)}setTimeout(()=>{U(),o.socialProof.intervalId=setInterval(()=>{o.socialProof.notificationsShown<e.SOCIAL_PROOF_MAX_SHOWN?U():clearInterval(o.socialProof.intervalId)},e.SOCIAL_PROOF_INTERVAL)},e.SOCIAL_PROOF_DELAY)}}(),function(){if(!e.ECOMMERCE_MODE||!o.tenantId)return;const n=o.planFeatures||{},t=e=>!1!==n[e],i=()=>{if(window.VocaliaShippingBar)try{window.VocaliaShippingBar.init({tenantId:o.tenantId,lang:o.currentLang,currency:o.currency||"EUR",voiceEnabled:!0}),x.activate("shippingBar")}catch(e){console.warn("[VocalIA] ShippingBar init failed:",e.message)}},a=()=>{!window.VocaliaSpinWheel||!window.VocalIA.isSpinWheelAvailable()||setTimeout(()=>{if(!o.isOpen&&x.canShow("spinWheel"))try{window.VocaliaSpinWheel.show({tenantId:o.tenantId,lang:o.currentLang,voiceEnabled:!0}),x.activate("spinWheel")}catch(e){console.warn("[VocalIA] SpinWheel init failed:",e.message)}},15e3)},s=()=>{if(window.VocalIARecommendations)try{window.VocalIA.RecommendationCarousel=window.VocalIARecommendations,x.activate("recommendations")}catch(e){console.warn("[VocalIA] RecommendationCarousel init failed:",e.message)}};window.VocaliaShippingBar?i():S("shippingBar").then(i).catch(()=>{}),t("ecom_gamification")&&(window.VocaliaSpinWheel?a():S("spinWheel").then(a).catch(()=>{})),t("ecom_recommendations")&&(window.VocalIARecommendations?s():S("recommendations").then(s).catch(()=>{})),setTimeout(()=>{t("ecom_cart_recovery")&&S("abandonedCart").catch(()=>{}),t("ecom_quiz")&&S("quiz").catch(()=>{})},5e3)}(),v("voice_widget_loaded",{language:o.currentLang,ecommerce_mode:e.ECOMMERCE_MODE&&!!o.tenantId,tenant_id:o.tenantId,exit_intent_enabled:e.EXIT_INTENT_ENABLED,social_proof_enabled:e.SOCIAL_PROOF_ENABLED})}catch(e){console.error("[VocalIA] Init error:",e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Q):Q()}(),function(){"use strict";const e={fr:{title:"Votre panier vous attend !",subtitle:"Vous avez {{count}} article(s) dans votre panier",subtitleSingular:"Vous avez 1 article dans votre panier",voiceReminder:"Attendez ! Ne partez pas les mains vides...",valueLabel:"Valeur totale :",offerLabel:"Offre exclusive :",offerText:"{{discount}}% de reduction si vous finalisez maintenant",callbackTitle:"Rappel vocal gratuit",callbackDesc:"Recevez un rappel vocal personnalise",smsTitle:"Rappel par SMS",smsDesc:"Lien direct vers votre panier",emailTitle:"Rappel par email",emailDesc:"Recapitulatif de votre panier",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"votre@email.com",sendBtn:"Recevoir le rappel",checkoutBtn:"Finaliser ma commande",continueBrowsing:"Continuer mes achats",successCallback:"Parfait ! Vous recevrez un appel dans quelques minutes.",successSms:"SMS envoye ! Verifiez votre telephone.",successEmail:"Email envoye ! Verifiez votre boite de reception.",errorInvalid:"Veuillez entrer un numero ou email valide",errorSend:"Erreur lors de l'envoi. Reessayez.",cartItemsLabel:"Articles :",expiresIn:"Offre valable encore {{minutes}} min",ariaClose:"Fermer"},en:{title:"Your cart is waiting!",subtitle:"You have {{count}} item(s) in your cart",subtitleSingular:"You have 1 item in your cart",voiceReminder:"Wait! Don't leave empty-handed...",valueLabel:"Total value:",offerLabel:"Exclusive offer:",offerText:"{{discount}}% off if you complete now",callbackTitle:"Free voice callback",callbackDesc:"Get a personalized voice reminder",smsTitle:"SMS reminder",smsDesc:"Direct link to your cart",emailTitle:"Email reminder",emailDesc:"Summary of your cart",phonePlaceholder:"+1 XXX XXX XXXX",emailPlaceholder:"your@email.com",sendBtn:"Get reminder",checkoutBtn:"Complete my order",continueBrowsing:"Continue shopping",successCallback:"Perfect! You'll receive a call shortly.",successSms:"SMS sent! Check your phone.",successEmail:"Email sent! Check your inbox.",errorInvalid:"Please enter a valid phone or email",errorSend:"Error sending. Please retry.",cartItemsLabel:"Items:",expiresIn:"Offer valid for {{minutes}} more min",ariaClose:"Close"},es:{title:"Tu carrito te espera!",subtitle:"Tienes {{count}} articulo(s) en tu carrito",subtitleSingular:"Tienes 1 articulo en tu carrito",voiceReminder:"Espera! No te vayas con las manos vacias...",valueLabel:"Valor total:",offerLabel:"Oferta exclusiva:",offerText:"{{discount}}% de descuento si finalizas ahora",callbackTitle:"Llamada de recordatorio gratis",callbackDesc:"Recibe un recordatorio de voz personalizado",smsTitle:"Recordatorio por SMS",smsDesc:"Enlace directo a tu carrito",emailTitle:"Recordatorio por email",emailDesc:"Resumen de tu carrito",phonePlaceholder:"+34 XXX XXX XXX",emailPlaceholder:"tu@email.com",sendBtn:"Recibir recordatorio",checkoutBtn:"Finalizar mi pedido",continueBrowsing:"Seguir comprando",successCallback:"Perfecto! Recibiras una llamada en breve.",successSms:"SMS enviado! Revisa tu telefono.",successEmail:"Email enviado! Revisa tu bandeja.",errorInvalid:"Por favor ingresa un numero o email valido",errorSend:"Error al enviar. Reintenta.",cartItemsLabel:"Articulos:",expiresIn:"Oferta valida por {{minutes}} min mas",ariaClose:"Cerrar"},ar:{title:"Ø³Ù„ØªÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ!",subtitle:"Ù„Ø¯ÙŠÙƒ {{count}} Ù…Ù†ØªØ¬(Ø§Øª) ÙÙŠ Ø³Ù„ØªÙƒ",subtitleSingular:"Ù„Ø¯ÙŠÙƒ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø³Ù„ØªÙƒ",voiceReminder:"Ø§Ù†ØªØ¸Ø±! Ù„Ø§ ØªØºØ§Ø¯Ø± Ø¨ÙŠØ¯ÙŠÙ† ÙØ§Ø±ØºØªÙŠÙ†...",valueLabel:"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:",offerLabel:"Ø¹Ø±Ø¶ Ø­ØµØ±ÙŠ:",offerText:"{{discount}}% Ø®ØµÙ… Ø¥Ø°Ø§ Ø£ØªÙ…Ù…Øª Ø§Ù„Ø¢Ù†",callbackTitle:"Ù…ÙƒØ§Ù„Ù…Ø© ØªØ°ÙƒÙŠØ± Ù…Ø¬Ø§Ù†ÙŠØ©",callbackDesc:"Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªØ°ÙƒÙŠØ± ØµÙˆØªÙŠ Ù…Ø®ØµØµ",smsTitle:"ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± SMS",smsDesc:"Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ø³Ù„ØªÙƒ",emailTitle:"ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯",emailDesc:"Ù…Ù„Ø®Øµ Ø³Ù„ØªÙƒ",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"Ø¨Ø±ÙŠØ¯Ùƒ@Ù…Ø«Ø§Ù„.com",sendBtn:"Ø§Ø³ØªÙ„Ù… Ø§Ù„ØªØ°ÙƒÙŠØ±",checkoutBtn:"Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ÙŠ",continueBrowsing:"Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚",successCallback:"Ù…Ù…ØªØ§Ø²! Ø³ØªØªÙ„Ù‚Ù‰ Ù…ÙƒØ§Ù„Ù…Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§.",successSms:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ SMS! ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡Ø§ØªÙÙƒ.",successEmail:"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯! ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚Ùƒ.",errorInvalid:"ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø¨Ø±ÙŠØ¯ ØµØ­ÙŠØ­",errorSend:"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.",cartItemsLabel:"Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:",expiresIn:"Ø§Ù„Ø¹Ø±Ø¶ ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© {{minutes}} Ø¯Ù‚ÙŠÙ‚Ø©",ariaClose:"Ø¥ØºÙ„Ø§Ù‚"},ary:{title:"Ø§Ù„Ø¨Ø§Ù†ÙŠ Ø¯ÙŠØ§Ù„Ùƒ ÙƒÙŠØªØ³Ù†Ø§Ùƒ!",subtitle:"Ø¹Ù†Ø¯Ùƒ {{count}} Ù…Ù†ØªÙˆØ¬(Ø§Øª) ÙØ§Ù„Ø¨Ø§Ù†ÙŠ",subtitleSingular:"Ø¹Ù†Ø¯Ùƒ Ù…Ù†ØªÙˆØ¬ ÙˆØ§Ø­Ø¯ ÙØ§Ù„Ø¨Ø§Ù†ÙŠ",voiceReminder:"ØªØ³Ù†Ø§! Ù…Ø§ ØªÙ…Ø´ÙŠØ´ Ø¨ÙŠØ¯ÙŠÙƒ Ø®Ø§ÙˆÙŠÙŠÙ†...",valueLabel:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:",offerLabel:"Ø¹Ø±Ø¶ Ø®Ø§Øµ:",offerText:"{{discount}}% ØªØ®ÙÙŠØ¶ Ø¥Ù„Ø§ ÙƒÙ…Ù„ØªÙŠ Ø¯Ø§Ø¨Ø§",callbackTitle:"ØªÙŠÙ„ÙŠÙÙˆÙ† Ù…Ø¬Ø§Ù†ÙŠ",callbackDesc:"ØºØ§Ø¯ÙŠ Ù†Ø¹ÙŠØ·Ùˆ Ù„ÙŠÙƒ Ø¨Ø§Ø´ Ù†ÙÙƒØ±ÙˆÙƒ",smsTitle:"SMS Ù„Ù„ØªØ°ÙƒÙŠØ±",smsDesc:"Ù„ÙŠÙ†Ùƒ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¨Ø§Ù†ÙŠ",emailTitle:"Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªØ°ÙƒÙŠØ±",emailDesc:"Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø§Ù†ÙŠ Ø¯ÙŠØ§Ù„Ùƒ",phonePlaceholder:"+212 6XX XXX XXX",emailPlaceholder:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯ÙŠØ§Ù„Ùƒ",sendBtn:"Ø¨ØºÙŠØª Ø§Ù„ØªØ°ÙƒÙŠØ±",checkoutBtn:"Ù†ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨",continueBrowsing:"Ù†ÙƒÙ…Ù„ Ø§Ù„ØªØ³ÙˆÙ‚",successCallback:"Ù…Ø²ÙŠØ§Ù†! ØºØ§Ø¯ÙŠ Ù†Ø¹ÙŠØ·Ùˆ Ù„ÙŠÙƒ Ø¯Ø§Ø¨Ø§.",successSms:"SMS Ù…Ø´Ù‰! Ø´ÙˆÙ Ø§Ù„ØªÙŠÙ„ÙŠÙÙˆÙ†.",successEmail:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø´Ù‰! Ø´ÙˆÙ Ø§Ù„Ø¨ÙˆØ§Øª.",errorInvalid:"Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆÙ„Ø§ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­",errorSend:"ÙƒØ§ÙŠÙ† Ù…Ø´ÙƒÙ„. Ø¹Ø§ÙˆØ¯.",cartItemsLabel:"Ø§Ù„Ù…Ù†ØªÙˆØ¬Ø§Øª:",expiresIn:"Ø§Ù„Ø¹Ø±Ø¶ ØµØ§Ù„Ø­ {{minutes}} Ø¯Ù‚ÙŠÙ‚Ø©",ariaClose:"Ø³Ø¯"}};class n{constructor(n={}){this.config={tenantId:n.tenantId||this.detectTenantId(),lang:n.lang||this.detectLanguage(),apiUrl:n.apiUrl||this.detectApiUrl(),discountPercent:n.discountPercent||10,offerDurationMinutes:n.offerDurationMinutes||15,inactivityTimeout:n.inactivityTimeout||18e4,tabBlurTimeout:n.tabBlurTimeout||6e4,minCartValue:n.minCartValue||0,cooldownPeriod:n.cooldownPeriod||864e5,voiceEnabled:!1!==n.voiceEnabled,checkoutUrl:n.checkoutUrl||"/checkout",cartSelector:n.cartSelector||null,onShow:n.onShow||null,onHide:n.onHide||null,onRecovery:n.onRecovery||null},this.state={isVisible:!1,isSpeaking:!1,selectedChannel:"voice",cartData:null,timerInterval:null,remainingMinutes:this.config.offerDurationMinutes,inactivityTimer:null,tabBlurTimer:null,messageType:null,messageText:null},this.elements={},this.translations=e[this.config.lang]||e.en,this.isRTL=["ar","ary"].includes(this.config.lang),this._handlers={mouseout:e=>{e.clientY<10&&!this.state.isVisible&&this.checkAndShow("exit_intent")},visibilitychange:()=>{document.hidden?this.startTabBlurTimer():this.clearTabBlurTimer()},activity:()=>this.resetInactivityTimer(),beforeunload:()=>{this.hasCartItems()&&this.trackEvent("cart_abandoned_page_exit")}},this.init()}detectTenantId(){if(window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.tenant_id)return window.VOCALIA_CONFIG.tenant_id;const e=document.querySelector("[data-vocalia-tenant]");return e?e.dataset.vocaliaTenant:new URLSearchParams(window.location.search).get("tenant")||"default"}detectLanguage(){const e=document.querySelector("[data-vocalia-lang]");if(e)return e.dataset.vocaliaLang;const n=new URLSearchParams(window.location.search);if(n.get("lang"))return n.get("lang");const t=navigator.language?.split("-")[0];return["fr","en","es","ar","ary"].includes(t)?t:"fr"}detectApiUrl(){return window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.api_url?window.VOCALIA_CONFIG.api_url:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013":"https://api.vocalia.ma"}init(){this.createModal(),this.setupDetection(),this.checkCooldown(),this.setupOrchestratorIntegration()}createModal(){const e=document.createElement("div");e.className="va-abandoned-cart-overlay",e.id="va-abandoned-cart-overlay",e.innerHTML=this.getModalHTML(),this.host=document.createElement("div"),this.host.id="va-cart-recovery-host",this.host.style.cssText="position:fixed;inset:0;z-index:10003;pointer-events:none;",document.body.appendChild(this.host),this._shadowRoot=this.host.attachShadow({mode:"open"});const n=document.createElement("style");n.id="va-abandoned-cart-styles",n.textContent='\n    .va-abandoned-cart-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.7);\n      backdrop-filter: blur(4px);\n      z-index: 10001;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      visibility: hidden;\n      transition: opacity 0.3s ease, visibility 0.3s ease;\n    }\n\n    .va-abandoned-cart-overlay.active {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    .va-abandoned-cart-modal {\n      background: linear-gradient(135deg, #0f172a 0%, #0c1220 100%);\n      border: 1px solid rgba(94, 106, 210, 0.3);\n      border-radius: 24px;\n      max-width: 480px;\n      width: 95%;\n      max-height: 90vh;\n      overflow-y: auto;\n      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 40px rgba(94, 106, 210, 0.2);\n      animation: vaCartSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    .va-abandoned-cart-modal[dir="rtl"] {\n      text-align: right;\n    }\n\n    @keyframes vaCartSlideIn {\n      from {\n        transform: translateY(-30px) scale(0.95);\n        opacity: 0;\n      }\n      to {\n        transform: translateY(0) scale(1);\n        opacity: 1;\n      }\n    }\n\n    .va-cart-header {\n      padding: 24px 24px 16px;\n      text-align: center;\n      border-bottom: 1px solid rgba(94, 106, 210, 0.15);\n    }\n\n    .va-cart-icon {\n      width: 64px;\n      height: 64px;\n      margin: 0 auto 16px;\n      background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: vaPulseCart 2s infinite;\n    }\n\n    @keyframes vaPulseCart {\n      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(94, 106, 210, 0.4); }\n      50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(94, 106, 210, 0); }\n    }\n\n    .va-cart-icon svg {\n      width: 32px;\n      height: 32px;\n      fill: white;\n    }\n\n    .va-cart-title {\n      color: #FFFFFF;\n      font-size: 24px;\n      font-weight: 700;\n      margin: 0 0 8px;\n    }\n\n    .va-cart-subtitle {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 16px;\n      margin: 0;\n    }\n\n    .va-cart-value {\n      background: rgba(94, 106, 210, 0.1);\n      border-radius: 12px;\n      padding: 12px 16px;\n      margin: 16px 24px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n\n    .va-cart-value-label {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 14px;\n    }\n\n    .va-cart-value-amount {\n      color: #5E6AD2;\n      font-size: 20px;\n      font-weight: 700;\n    }\n\n    .va-cart-offer {\n      background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(94, 106, 210, 0.15) 100%);\n      border: 1px solid rgba(16, 185, 129, 0.3);\n      border-radius: 12px;\n      padding: 12px 16px;\n      margin: 0 24px 16px;\n      text-align: center;\n    }\n\n    .va-cart-offer-label {\n      color: #10B981;\n      font-size: 12px;\n      font-weight: 600;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n    }\n\n    .va-cart-offer-text {\n      color: #FFFFFF;\n      font-size: 16px;\n      font-weight: 600;\n      margin-top: 4px;\n    }\n\n    .va-cart-timer {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n      margin-top: 8px;\n    }\n\n    .va-cart-items-preview {\n      padding: 0 24px 16px;\n    }\n\n    .va-cart-items-label {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n      margin-bottom: 8px;\n    }\n\n    .va-cart-items-row {\n      display: flex;\n      gap: 8px;\n      overflow-x: auto;\n      padding-bottom: 8px;\n    }\n\n    .va-cart-item-thumb {\n      width: 48px;\n      height: 48px;\n      border-radius: 8px;\n      object-fit: cover;\n      border: 1px solid rgba(94, 106, 210, 0.2);\n      flex-shrink: 0;\n    }\n\n    .va-cart-recovery-options {\n      padding: 0 24px 16px;\n    }\n\n    .va-recovery-option {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px;\n      background: rgba(255, 255, 255, 0.03);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      border-radius: 12px;\n      margin-bottom: 8px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .va-recovery-option:hover {\n      background: rgba(94, 106, 210, 0.1);\n      border-color: rgba(94, 106, 210, 0.3);\n    }\n\n    .va-recovery-option.selected {\n      background: rgba(94, 106, 210, 0.15);\n      border-color: #5E6AD2;\n    }\n\n    .va-recovery-option-icon {\n      width: 40px;\n      height: 40px;\n      border-radius: 10px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n    }\n\n    .va-recovery-option-icon.voice {\n      background: linear-gradient(135deg, #5E6AD2 0%, #4f46e5 100%);\n    }\n\n    .va-recovery-option-icon.sms {\n      background: linear-gradient(135deg, #10B981 0%, #059669 100%);\n    }\n\n    .va-recovery-option-icon.email {\n      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);\n    }\n\n    .va-recovery-option-icon svg {\n      width: 20px;\n      height: 20px;\n      fill: white;\n    }\n\n    .va-recovery-option-content {\n      flex: 1;\n    }\n\n    .va-recovery-option-title {\n      color: #FFFFFF;\n      font-size: 14px;\n      font-weight: 600;\n      margin-bottom: 2px;\n    }\n\n    .va-recovery-option-desc {\n      color: rgba(255, 255, 255, 0.6);\n      font-size: 12px;\n    }\n\n    .va-recovery-option-radio {\n      width: 20px;\n      height: 20px;\n      border: 2px solid rgba(255, 255, 255, 0.3);\n      border-radius: 50%;\n      position: relative;\n    }\n\n    .va-recovery-option.selected .va-recovery-option-radio {\n      border-color: #5E6AD2;\n    }\n\n    .va-recovery-option.selected .va-recovery-option-radio::after {\n      content: \'\';\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 10px;\n      height: 10px;\n      background: #5E6AD2;\n      border-radius: 50%;\n    }\n\n    .va-cart-input-group {\n      padding: 0 24px 16px;\n    }\n\n    .va-cart-input {\n      width: 100%;\n      padding: 14px 16px;\n      background: rgba(255, 255, 255, 0.05);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-radius: 12px;\n      color: #FFFFFF;\n      font-size: 16px;\n      outline: none;\n      transition: border-color 0.2s ease;\n      box-sizing: border-box;\n    }\n\n    .va-cart-input:focus {\n      border-color: #5E6AD2;\n    }\n\n    .va-cart-input::placeholder {\n      color: rgba(255, 255, 255, 0.4);\n    }\n\n    .va-cart-input[dir="rtl"] {\n      text-align: right;\n    }\n\n    .va-cart-actions {\n      padding: 0 24px 24px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n\n    .va-cart-btn {\n      padding: 14px 24px;\n      border-radius: 12px;\n      font-size: 16px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border: none;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n    }\n\n    .va-cart-btn.primary {\n      background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n      color: white;\n    }\n\n    .va-cart-btn.primary:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 25px rgba(94, 106, 210, 0.4);\n    }\n\n    .va-cart-btn.secondary {\n      background: rgba(94, 106, 210, 0.1);\n      color: #5E6AD2;\n      border: 1px solid rgba(94, 106, 210, 0.3);\n    }\n\n    .va-cart-btn.secondary:hover {\n      background: rgba(94, 106, 210, 0.2);\n    }\n\n    .va-cart-btn.text {\n      background: transparent;\n      color: rgba(255, 255, 255, 0.6);\n    }\n\n    .va-cart-btn.text:hover {\n      color: #FFFFFF;\n    }\n\n    .va-cart-btn:disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n      transform: none;\n    }\n\n    .va-cart-btn svg {\n      width: 18px;\n      height: 18px;\n    }\n\n    .va-cart-close {\n      position: absolute;\n      top: 16px;\n      right: 16px;\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: background 0.2s ease;\n    }\n\n    .va-cart-close:hover {\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .va-cart-close svg {\n      width: 16px;\n      height: 16px;\n      fill: white;\n    }\n\n    [dir="rtl"] .va-cart-close {\n      right: auto;\n      left: 16px;\n    }\n\n    .va-cart-message {\n      padding: 12px 16px;\n      margin: 0 24px 16px;\n      border-radius: 10px;\n      font-size: 14px;\n      text-align: center;\n    }\n\n    .va-cart-message.success {\n      background: rgba(16, 185, 129, 0.15);\n      border: 1px solid rgba(16, 185, 129, 0.3);\n      color: #10B981;\n    }\n\n    .va-cart-message.error {\n      background: rgba(239, 68, 68, 0.15);\n      border: 1px solid rgba(239, 68, 68, 0.3);\n      color: #EF4444;\n    }\n\n    /* Voice speaking animation */\n    .va-cart-speaking .va-cart-icon {\n      animation: vaSpeakingPulse 0.5s infinite;\n    }\n\n    @keyframes vaSpeakingPulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.1); }\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 480px) {\n      .va-abandoned-cart-modal {\n        border-radius: 20px 20px 0 0;\n        max-width: 100%;\n        width: 100%;\n        position: fixed;\n        bottom: 0;\n        margin: 0;\n        max-height: 85vh;\n      }\n\n      .va-cart-header {\n        padding: 20px 20px 14px;\n      }\n\n      .va-cart-title {\n        font-size: 20px;\n      }\n\n      .va-cart-value,\n      .va-cart-offer,\n      .va-cart-recovery-options,\n      .va-cart-input-group,\n      .va-cart-actions {\n        padding-left: 20px;\n        padding-right: 20px;\n      }\n    }\n  ',this._shadowRoot.appendChild(n),e.style.pointerEvents="auto",this._shadowRoot.appendChild(e),this.elements.overlay=e,this.elements.modal=e.querySelector(".va-abandoned-cart-modal"),this.elements.closeBtn=e.querySelector(".va-cart-close"),this.elements.input=e.querySelector(".va-cart-input"),this.elements.sendBtn=e.querySelector(".va-cart-send-btn"),this.elements.checkoutBtn=e.querySelector(".va-cart-checkout-btn"),this.elements.continueBtn=e.querySelector(".va-cart-continue-btn"),this.elements.message=e.querySelector(".va-cart-message"),this.elements.timer=e.querySelector(".va-cart-timer"),this.elements.subtitle=e.querySelector(".va-cart-subtitle"),this.elements.valueAmount=e.querySelector(".va-cart-value-amount"),this.elements.itemsRow=e.querySelector(".va-cart-items-row"),this.elements.offerText=e.querySelector(".va-cart-offer-text"),this.elements.closeBtn.addEventListener("click",()=>this.hide()),this.elements.overlay.addEventListener("click",e=>{e.target===this.elements.overlay&&this.hide()}),e.querySelectorAll(".va-recovery-option").forEach(e=>{e.addEventListener("click",()=>this.selectChannel(e.dataset.channel))}),this.elements.sendBtn.addEventListener("click",()=>this.sendReminder()),this.elements.checkoutBtn.addEventListener("click",()=>this.goToCheckout()),this.elements.continueBtn.addEventListener("click",()=>this.hide()),this.elements.input.addEventListener("focus",()=>this.updateInputPlaceholder())}getModalHTML(){const e=this.translations;return`\n        <div class="va-abandoned-cart-modal" dir="${this.isRTL?"rtl":"ltr"}" role="dialog" aria-modal="true" aria-labelledby="va-cart-title">\n          <button class="va-cart-close" aria-label="${e.ariaClose}">\n            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n\n          <div class="va-cart-header">\n            <div class="va-cart-icon">\n              <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>\n            </div>\n            <h2 class="va-cart-title" id="va-cart-title">${e.title}</h2>\n            <p class="va-cart-subtitle">${e.subtitleSingular}</p>\n          </div>\n\n          <div class="va-cart-value">\n            <span class="va-cart-value-label">${e.valueLabel}</span>\n            <span class="va-cart-value-amount">0 MAD</span>\n          </div>\n\n          <div class="va-cart-offer">\n            <div class="va-cart-offer-label">${e.offerLabel}</div>\n            <div class="va-cart-offer-text">${e.offerText.replace("{{discount}}",this.config.discountPercent)}</div>\n            <div class="va-cart-timer">${e.expiresIn.replace("{{minutes}}",this.config.offerDurationMinutes)}</div>\n          </div>\n\n          <div class="va-cart-items-preview">\n            <div class="va-cart-items-label">${e.cartItemsLabel}</div>\n            <div class="va-cart-items-row"></div>\n          </div>\n\n          <div class="va-cart-recovery-options">\n            <div class="va-recovery-option selected" data-channel="voice">\n              <div class="va-recovery-option-icon voice">\n                <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.callbackTitle}</div>\n                <div class="va-recovery-option-desc">${e.callbackDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n\n            <div class="va-recovery-option" data-channel="sms">\n              <div class="va-recovery-option-icon sms">\n                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.smsTitle}</div>\n                <div class="va-recovery-option-desc">${e.smsDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n\n            <div class="va-recovery-option" data-channel="email">\n              <div class="va-recovery-option-icon email">\n                <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>\n              </div>\n              <div class="va-recovery-option-content">\n                <div class="va-recovery-option-title">${e.emailTitle}</div>\n                <div class="va-recovery-option-desc">${e.emailDesc}</div>\n              </div>\n              <div class="va-recovery-option-radio"></div>\n            </div>\n          </div>\n\n          <div class="va-cart-input-group">\n            <input type="text" class="va-cart-input" placeholder="${e.phonePlaceholder}" dir="${this.isRTL?"rtl":"ltr"}">\n          </div>\n\n          <div class="va-cart-message" style="display: none;"></div>\n\n          <div class="va-cart-actions">\n            <button class="va-cart-btn primary va-cart-send-btn">\n              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n              ${e.sendBtn}\n            </button>\n            <button class="va-cart-btn secondary va-cart-checkout-btn">\n              ${e.checkoutBtn}\n            </button>\n            <button class="va-cart-btn text va-cart-continue-btn">\n              ${e.continueBrowsing}\n            </button>\n          </div>\n        </div>\n      `}setupDetection(){document.addEventListener("mouseout",this._handlers.mouseout),document.addEventListener("visibilitychange",this._handlers.visibilitychange),this.resetInactivityTimer(),["mousemove","keydown","scroll","touchstart"].forEach(e=>{document.addEventListener(e,this._handlers.activity,{passive:!0})}),window.addEventListener("beforeunload",this._handlers.beforeunload)}setupOrchestratorIntegration(){window.VocalIA?.Orchestrator&&(window.VocalIA.Orchestrator.on("widgetActivated",e=>{"abandonedCart"!==e.widgetName&&this.state.isVisible&&this.hide()}),window.VocalIA.Orchestrator.widgets.abandonedCart={priority:6,isActive:!1,element:null,triggers:["cart_abandon","exit_with_cart"]})}checkCooldown(){try{const e=localStorage.getItem("va_cart_recovery_last_shown");if(e&&Date.now()-parseInt(e,10)<this.config.cooldownPeriod)return void(this.cooldownActive=!0)}catch{}this.cooldownActive=!1}startInactivityTimer(){this.state.inactivityTimer=setTimeout(()=>{this.checkAndShow("inactivity")},this.config.inactivityTimeout)}resetInactivityTimer(){this.state.inactivityTimer&&clearTimeout(this.state.inactivityTimer),this.startInactivityTimer()}startTabBlurTimer(){this.state.tabBlurTimer=setTimeout(()=>{this.checkAndShow("tab_blur")},this.config.tabBlurTimeout)}clearTabBlurTimer(){this.state.tabBlurTimer&&(clearTimeout(this.state.tabBlurTimer),this.state.tabBlurTimer=null)}hasCartItems(){const e=this.getCartData();return e&&e.items&&e.items.length>0}getCartData(){if(this.config.cartSelector){const e=document.querySelector(this.config.cartSelector);if(e)try{return JSON.parse(e.textContent||e.dataset.cart)}catch{}}if(window.VocalIA?.cart)return window.VocalIA.cart;if(window.Shopify?.checkout?.line_items)return{items:window.Shopify.checkout.line_items.map(e=>({id:e.variant_id,name:e.title,price:e.price,quantity:e.quantity,image:e.image})),total:window.Shopify.checkout.total_price/100,currency:window.Shopify.checkout.currency||window.VocalIA?.cart?.currency||"EUR"};if(window.wc_cart_fragments_params){const e=document.querySelector(".cart-contents-count"),n=parseInt(e?.textContent||"0");if(n>0){const e=parseFloat(document.querySelector(".cart-contents .amount, .woocommerce-Price-amount")?.textContent?.replace(/[^\d.]/g,"")||"0");return{items:Array(n).fill({}),total:e,currency:window.VocalIA?.cart?.currency||"EUR"}}}let e=null;try{e=localStorage.getItem("va_cart")||localStorage.getItem("cart")}catch{}if(e)try{return JSON.parse(e)}catch{}return window.location.search.includes("demo_cart=1")?{items:[{id:"1",name:"Produit Demo 1",price:299,quantity:1,image:"https://placehold.co/100x100/191E35/5E6AD2?text=P1"},{id:"2",name:"Produit Demo 2",price:199,quantity:2,image:"https://placehold.co/100x100/191E35/10B981?text=P2"}],total:697,currency:window.VocalIA?.cart?.currency||"EUR"}:null}checkAndShow(e){this.state.isVisible||this.cooldownActive||this.hasCartItems()&&(window.VocalIA?.Orchestrator&&!window.VocalIA.Orchestrator.canShow("abandonedCart")||(this.state.cartData=this.getCartData(),!(this.state.cartData.total<this.config.minCartValue)&&this.show(e)))}show(e="manual"){if(!this.state.isVisible){this.state.isVisible=!0,this.updateCartDisplay(),this.elements.overlay.classList.add("active"),this.startCountdown(),this.config.voiceEnabled&&setTimeout(()=>this.speak(this.translations.voiceReminder),500);try{localStorage.setItem("va_cart_recovery_last_shown",Date.now().toString())}catch{}this.cooldownActive=!0,window.VocalIA?.Orchestrator&&window.VocalIA.Orchestrator.activate("abandonedCart"),this.trackEvent("cart_recovery_shown",{trigger:e,cart_value:this.state.cartData?.total||0,items_count:this.state.cartData?.items?.length||0}),this.config.onShow&&this.config.onShow({trigger:e,cartData:this.state.cartData})}}hide(){this.state.isVisible=!1,this.elements.overlay.classList.remove("active"),this.stopCountdown(),this.stopSpeaking(),window.VocalIA?.Orchestrator&&window.VocalIA.Orchestrator.deactivate("abandonedCart"),this.trackEvent("cart_recovery_closed"),this.config.onHide&&this.config.onHide()}updateCartDisplay(){const e=this.state.cartData;if(!e)return;const n=e.items?.length||0;this.elements.subtitle.textContent=1===n?this.translations.subtitleSingular:this.translations.subtitle.replace("{{count}}",n);const t=e.currency||window.VocalIA?.cart?.currency||"EUR",i=e.total||0,a={MAD:"DH",EUR:"â‚¬",USD:"$",GBP:"Â£"}[t]||t;this.elements.valueAmount.textContent="EUR"===t||"USD"===t||"GBP"===t?`${a}${i.toLocaleString()}`:`${i.toLocaleString()} ${a}`,this.elements.itemsRow.innerHTML="",e.items&&e.items.slice(0,5).forEach(e=>{if(e.image){const n=document.createElement("img");n.className="va-cart-item-thumb",n.src=e.image,n.alt=e.name||"Product",this.elements.itemsRow.appendChild(n)}})}startCountdown(){this.state.remainingMinutes=this.config.offerDurationMinutes,this.updateTimerDisplay(),this.state.timerInterval=setInterval(()=>{this.state.remainingMinutes-=1,this.updateTimerDisplay(),this.state.remainingMinutes<=0&&(this.stopCountdown(),this.hide())},6e4)}stopCountdown(){this.state.timerInterval&&(clearInterval(this.state.timerInterval),this.state.timerInterval=null)}updateTimerDisplay(){this.elements.timer.textContent=this.translations.expiresIn.replace("{{minutes}}",this.state.remainingMinutes)}selectChannel(e){this.state.selectedChannel=e,this.elements.overlay.querySelectorAll(".va-recovery-option").forEach(n=>{n.classList.toggle("selected",n.dataset.channel===e)}),this.updateInputPlaceholder(),this.trackEvent("cart_recovery_channel_selected",{channel:e})}updateInputPlaceholder(){const e=this.translations;switch(this.state.selectedChannel){case"voice":case"sms":this.elements.input.placeholder=e.phonePlaceholder,this.elements.input.type="tel";break;case"email":this.elements.input.placeholder=e.emailPlaceholder,this.elements.input.type="email"}}async sendReminder(){const e=this.elements.input.value.trim(),n=this.state.selectedChannel;if(this.validateInput(e,n)){this.elements.sendBtn.disabled=!0;try{if(!(await fetch(`${this.config.apiUrl}/api/cart-recovery`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenant_id:this.config.tenantId,channel:n,contact:e,cart:this.state.cartData,discount_percent:this.config.discountPercent,language:this.config.lang,checkout_url:window.location.origin+this.config.checkoutUrl})})).ok)throw new Error("API error");const t={voice:this.translations.successCallback,sms:this.translations.successSms,email:this.translations.successEmail};this.showMessage("success",t[n]),this.config.voiceEnabled&&this.speak(t[n]),this.trackEvent("cart_recovery_reminder_sent",{channel:n,cart_value:this.state.cartData?.total||0}),this.config.onRecovery&&this.config.onRecovery({channel:n,contact:e,cartData:this.state.cartData}),setTimeout(()=>this.hide(),3e3)}catch(e){console.error("[AbandonedCartRecovery] Send error:",e),this.showMessage("error",this.translations.errorSend)}finally{this.elements.sendBtn.disabled=!1}}else this.showMessage("error",this.translations.errorInvalid)}validateInput(e,n){if(!e)return!1;switch(n){case"voice":case"sms":return/^\+?[0-9]{8,15}$/.test(e.replace(/[\s-]/g,""));case"email":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);default:return!1}}showMessage(e,n){this.elements.message.className=`va-cart-message ${e}`,this.elements.message.textContent=n,this.elements.message.style.display="block",setTimeout(()=>{this.elements.message.style.display="none"},5e3)}goToCheckout(){this.trackEvent("cart_recovery_checkout_clicked",{cart_value:this.state.cartData?.total||0,discount_applied:this.config.discountPercent});const e=`COMEBACK${this.config.discountPercent}`,n=new URL(this.config.checkoutUrl,window.location.origin);n.searchParams.set("discount",e),window.location.href=n.toString()}speak(e){if(!window.speechSynthesis)return;this.stopSpeaking(),this.state.isSpeaking=!0,this.elements.modal.classList.add("va-cart-speaking");const n=new SpeechSynthesisUtterance(e);n.lang={fr:"fr-FR",en:"en-US",es:"es-ES",ar:"ar-SA",ary:"ar-MA"}[this.config.lang]||"fr-FR",n.rate=.9,n.pitch=1,n.onend=()=>{this.state.isSpeaking=!1,this.elements.modal.classList.remove("va-cart-speaking")},window.speechSynthesis.speak(n)}stopSpeaking(){window.speechSynthesis&&window.speechSynthesis.cancel(),this.state.isSpeaking=!1,this.elements.modal?.classList.remove("va-cart-speaking")}trackEvent(e,t={}){n._hasAnalyticsConsent()&&(window.gtag&&window.gtag("event",e,{event_category:"cart_recovery",tenant_id:this.config.tenantId,language:this.config.lang,...t}),window.plausible&&window.plausible(e,{props:t}),window.VocalIA?.trackEvent&&window.VocalIA.trackEvent(e,t))}static _hasAnalyticsConsent(){if(window.VOCALIA_CONFIG&&!1===window.VOCALIA_CONFIG.analytics_consent)return!1;if(window.VOCALIA_CONFIG&&!0===window.VOCALIA_CONFIG.analytics_consent)return!0;try{if("denied"===localStorage.getItem("va_consent"))return!1}catch{}return!(typeof window.CookieConsent<"u"&&!window.CookieConsent.allowedCategory?.("analytics"))}trigger(e="manual"){this.checkAndShow(e)}setCartData(e){this.state.cartData=e,this.state.isVisible&&this.updateCartDisplay()}setDiscount(e){this.config.discountPercent=e,this.elements.offerText&&(this.elements.offerText.textContent=this.translations.offerText.replace("{{discount}}",e))}destroy(){this.hide(),document.removeEventListener("mouseout",this._handlers.mouseout),document.removeEventListener("visibilitychange",this._handlers.visibilitychange),["mousemove","keydown","scroll","touchstart"].forEach(e=>{document.removeEventListener(e,this._handlers.activity)}),window.removeEventListener("beforeunload",this._handlers.beforeunload),this.host?.remove(),this.host=null,this._shadowRoot=null,this.elements.overlay=null,this.state.inactivityTimer&&clearTimeout(this.state.inactivityTimer),this.state.tabBlurTimer&&clearTimeout(this.state.tabBlurTimer)}}let t=null;function i(e={}){return t&&t.destroy(),t=new n(e),t}window.VocaliaAbandonedCart={init:i,getInstance:()=>t,AbandonedCartRecovery:n},typeof window.VocalIA<"u"&&(window.VocalIA.AbandonedCart=window.VocaliaAbandonedCart,window.VocalIA.triggerCartRecovery=function(e="manual"){t||(t=i()),t.trigger(e)},window.VocalIA.setCartData=function(e){t||(t=i()),t.setCartData(e)}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-vocalia-cart-recovery]");e&&i({tenantId:e.dataset.vocaliaTenant,lang:e.dataset.vocaliaLang,discountPercent:parseInt(e.dataset.discount)||10,voiceEnabled:"false"!==e.dataset.voice})})}(),function(e){"use strict";function n(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}const t={skincare:{title:{fr:"Trouvez votre routine parfaite",en:"Find Your Perfect Routine",es:"Encuentra tu rutina perfecta",ar:"Ø§Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø±ÙˆØªÙŠÙ†Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",ary:"Ù„Ù‚Ù‰ Ø±ÙˆØªÙŠÙ†Ùƒ Ù„ÙŠ ÙŠÙ†Ø§Ø³Ø¨Ùƒ"},questions:[{id:"skin_type",question:{fr:"Quel est votre type de peau ?",en:"What is your skin type?",es:"Â¿CuÃ¡l es tu tipo de piel?",ar:"Ù…Ø§ Ù‡Ùˆ Ù†ÙˆØ¹ Ø¨Ø´Ø±ØªÙƒØŸ",ary:"Ø´Ù†Ùˆ Ù†ÙˆØ¹ Ø¬Ù„Ø¯Ùƒ?"},options:[{value:"dry",label:{fr:"SÃ¨che",en:"Dry",es:"Seca",ar:"Ø¬Ø§ÙØ©",ary:"Ù†Ø§Ø´Ù"}},{value:"oily",label:{fr:"Grasse",en:"Oily",es:"Grasa",ar:"Ø¯Ù‡Ù†ÙŠØ©",ary:"Ø¯Ù‡Ù†ÙŠ"}},{value:"combination",label:{fr:"Mixte",en:"Combination",es:"Mixta",ar:"Ù…Ø®ØªÙ„Ø·Ø©",ary:"Ù…Ø®Ù„ÙˆØ·"}},{value:"sensitive",label:{fr:"Sensible",en:"Sensitive",es:"Sensible",ar:"Ø­Ø³Ø§Ø³Ø©",ary:"Ø­Ø³Ø§Ø³"}}],tags:{dry:["hydrating","moisturizing"],oily:["mattifying","oil-control"],combination:["balancing"],sensitive:["gentle","calming"]}},{id:"concern",question:{fr:"Quelle est votre prÃ©occupation principale ?",en:"What is your main concern?",es:"Â¿CuÃ¡l es tu principal preocupaciÃ³n?",ar:"Ù…Ø§ Ù‡Ùˆ Ù‚Ù„Ù‚Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŸ",ary:"Ø´Ù†Ùˆ Ù„ÙŠ ÙƒÙŠÙ‡Ù…Ùƒ Ø¨Ø²Ø§Ù?"},options:[{value:"acne",label:{fr:"AcnÃ©",en:"Acne",es:"AcnÃ©",ar:"Ø­Ø¨ Ø§Ù„Ø´Ø¨Ø§Ø¨",ary:"Ø§Ù„Ø­Ø¨ÙˆØ¨"}},{value:"aging",label:{fr:"Anti-Ã¢ge",en:"Anti-aging",es:"Anti-edad",ar:"Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø´ÙŠØ®ÙˆØ®Ø©",ary:"Ø¶Ø¯ Ø§Ù„Ø´ÙŠØ®ÙˆØ®Ø©"}},{value:"hydration",label:{fr:"Hydratation",en:"Hydration",es:"HidrataciÃ³n",ar:"ØªØ±Ø·ÙŠØ¨",ary:"Ø§Ù„ØªØ±Ø·ÙŠØ¨"}},{value:"brightening",label:{fr:"Ã‰clat",en:"Brightening",es:"Luminosidad",ar:"Ø¥Ø´Ø±Ø§Ù‚",ary:"Ø§Ù„Ø¨Ø±ÙŠÙ‚"}}],tags:{acne:["salicylic","anti-acne"],aging:["retinol","anti-wrinkle"],hydration:["hyaluronic","moisturizing"],brightening:["vitamin-c","brightening"]}},{id:"budget",question:{fr:"Quel est votre budget ?",en:"What is your budget?",es:"Â¿CuÃ¡l es tu presupuesto?",ar:"Ù…Ø§ Ù‡ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒØŸ",ary:"Ø´Ø­Ø§Ù„ Ù…Ø¹Ø§Ùƒ ØªØµØ±Ù?"},options:[{value:"budget",label:{fr:"Ã‰conomique (< 50â‚¬)",en:"Budget (< $50)",es:"EconÃ³mico (< 50â‚¬)",ar:"Ø§Ù‚ØªØµØ§Ø¯ÙŠ (< 50$)",ary:"Ø±Ø®ÙŠØµ (< 500 DH)"}},{value:"mid",label:{fr:"Moyen (50-100â‚¬)",en:"Mid-range ($50-100)",es:"Medio (50-100â‚¬)",ar:"Ù…ØªÙˆØ³Ø· (50-100$)",ary:"Ù…Ø¹ØªØ¯Ù„ (500-1000 DH)"}},{value:"premium",label:{fr:"Premium (100â‚¬+)",en:"Premium ($100+)",es:"Premium (100â‚¬+)",ar:"Ù…Ù…ØªØ§Ø² (100$+)",ary:"ØºØ§Ù„ÙŠ (+1000 DH)"}}],priceRanges:{budget:{max:50},mid:{min:50,max:100},premium:{min:100}}}]},electronics:{title:{fr:"Trouvez l'appareil idÃ©al",en:"Find Your Ideal Device",es:"Encuentra tu dispositivo ideal",ar:"Ø§Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",ary:"Ù„Ù‚Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙŠ ÙŠÙ†Ø§Ø³Ø¨Ùƒ"},questions:[{id:"usage",question:{fr:"Quelle sera l'utilisation principale ?",en:"What will be the main use?",es:"Â¿CuÃ¡l serÃ¡ el uso principal?",ar:"Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŸ",ary:"Ø´Ù†Ùˆ ØºØ§Ø¯ÙŠ Ø¯ÙŠØ± Ø¨ÙŠÙ‡ØŸ"},options:[{value:"work",label:{fr:"Travail",en:"Work",es:"Trabajo",ar:"Ø¹Ù…Ù„",ary:"Ø®Ø¯Ù…Ø©"}},{value:"gaming",label:{fr:"Gaming",en:"Gaming",es:"Gaming",ar:"Ø£Ù„Ø¹Ø§Ø¨",ary:"Ø§Ù„Ø¹Ø§Ø¨"}},{value:"casual",label:{fr:"Usage quotidien",en:"Daily use",es:"Uso diario",ar:"Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠÙˆÙ…ÙŠ",ary:"ÙƒÙ„ ÙŠÙˆÙ…"}},{value:"creative",label:{fr:"CrÃ©ation",en:"Creative work",es:"CreaciÃ³n",ar:"Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ",ary:"Ø¥Ø¨Ø¯Ø§Ø¹"}}],tags:{work:["professional","productivity"],gaming:["gaming","high-performance"],casual:["everyday","budget-friendly"],creative:["creative","high-specs"]}},{id:"priority",question:{fr:"Quelle est votre prioritÃ© ?",en:"What is your priority?",es:"Â¿CuÃ¡l es tu prioridad?",ar:"Ù…Ø§ Ù‡ÙŠ Ø£ÙˆÙ„ÙˆÙŠØªÙƒØŸ",ary:"Ø´Ù†Ùˆ Ù„ÙŠ Ù…Ù‡Ù… Ø¹Ù†Ø¯Ùƒ Ø¨Ø²Ø§ÙØŸ"},options:[{value:"performance",label:{fr:"Performance",en:"Performance",es:"Rendimiento",ar:"Ø£Ø¯Ø§Ø¡",ary:"Ø§Ù„Ù‚ÙˆØ©"}},{value:"battery",label:{fr:"Autonomie",en:"Battery life",es:"BaterÃ­a",ar:"Ø¹Ù…Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©",ary:"Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©"}},{value:"portability",label:{fr:"PortabilitÃ©",en:"Portability",es:"Portabilidad",ar:"Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ù„",ary:"Ø®ÙÙŠÙ"}},{value:"price",label:{fr:"Prix",en:"Price",es:"Precio",ar:"Ø§Ù„Ø³Ø¹Ø±",ary:"Ø§Ù„Ø«Ù…Ù†"}}]}]},generic:{title:{fr:"Trouvez votre produit idÃ©al",en:"Find Your Ideal Product",es:"Encuentra tu producto ideal",ar:"Ø§Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ",ary:"Ù„Ù‚Ù‰ Ø§Ù„Ù…Ù†ØªÙˆØ¬ Ù„ÙŠ ÙŠÙ†Ø§Ø³Ø¨Ùƒ"},questions:[{id:"need",question:{fr:"Qu'est-ce que vous recherchez ?",en:"What are you looking for?",es:"Â¿QuÃ© estÃ¡s buscando?",ar:"Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡ØŸ",ary:"Ø´Ù†Ùˆ ÙƒØªÙ‚Ù„Ø¨ Ø¹Ù„ÙŠÙ‡ØŸ"},voiceKeywords:{fr:["cherche","besoin","voudrais"],en:["looking","need","want"],es:["busco","necesito","quiero"],ar:["Ø£Ø¨Ø­Ø«","Ø£Ø±ÙŠØ¯"],ary:["ÙƒÙ†Ù‚Ù„Ø¨","Ø¨ØºÙŠØª"]}},{id:"budget",question:{fr:"Quel est votre budget ?",en:"What is your budget?",es:"Â¿CuÃ¡l es tu presupuesto?",ar:"Ù…Ø§ Ù‡ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒØŸ",ary:"Ø´Ø­Ø§Ù„ Ù…Ø¹Ø§ÙƒØŸ"},options:[{value:"low",label:{fr:"< 50â‚¬",en:"< $50",es:"< 50â‚¬",ar:"< 50$",ary:"< 500 DH"}},{value:"mid",label:{fr:"50-150â‚¬",en:"$50-150",es:"50-150â‚¬",ar:"50-150$",ary:"500-1500 DH"}},{value:"high",label:{fr:"> 150â‚¬",en:"> $150",es:"> 150â‚¬",ar:"> 150$",ary:"> 1500 DH"}}]}]}};class i{constructor(e={}){this.options={tenantId:e.tenantId||this._detectTenantId(),template:"generic",customQuestions:null,lang:"fr",voiceEnabled:!0,onComplete:null,onLeadCapture:null,apiBaseUrl:typeof window<"u"&&window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.api_url||(typeof window<"u"&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname)?"http://localhost:3013":"https://api.vocalia.ma"),...e},this.container=null,this.isVisible=!1,this.currentStep=0,this.answers={},this.questions=[],this.isListening=!1,this.recognition=null,this._initQuestions(),this._initVoiceRecognition()}_detectTenantId(){if(typeof window<"u"&&window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.tenant_id)return window.VOCALIA_CONFIG.tenant_id;const e=typeof document<"u"&&document.querySelector("[data-vocalia-tenant]");return e?e.dataset.vocaliaTenant:null}_injectStyles(e){if(e.querySelector("#va-quiz-styles"))return;const n=document.createElement("style");n.id="va-quiz-styles",n.textContent='\n    .va-quiz-overlay {\n      position: fixed;\n      inset: 0;\n      background: rgba(0, 0, 0, 0.7);\n      backdrop-filter: blur(8px);\n      z-index: 10003;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      visibility: hidden;\n      transition: all 0.3s ease;\n    }\n\n    .va-quiz-overlay.va-quiz-visible {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    .va-quiz-container {\n      width: 90%;\n      max-width: 500px;\n      max-height: 90vh;\n      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.95));\n      border-radius: 20px;\n      border: 1px solid rgba(139, 92, 246, 0.3);\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(139, 92, 246, 0.15);\n      overflow: hidden;\n      transform: scale(0.9) translateY(20px);\n      transition: transform 0.3s ease;\n    }\n\n    .va-quiz-visible .va-quiz-container {\n      transform: scale(1) translateY(0);\n    }\n\n    .va-quiz-header {\n      padding: 20px;\n      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.15));\n      border-bottom: 1px solid rgba(139, 92, 246, 0.2);\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n\n    .va-quiz-title {\n      color: #e2e8f0;\n      font-size: 18px;\n      font-weight: 600;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .va-quiz-title svg {\n      width: 24px;\n      height: 24px;\n      color: #8b5cf6;\n    }\n\n    .va-quiz-close {\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      color: #94a3b8;\n      cursor: pointer;\n      padding: 8px;\n      border-radius: 8px;\n      transition: all 0.2s;\n    }\n\n    .va-quiz-close:hover {\n      background: rgba(255, 255, 255, 0.15);\n      color: #e2e8f0;\n    }\n\n    .va-quiz-progress {\n      padding: 0 20px;\n      margin-top: 16px;\n    }\n\n    .va-quiz-progress-bar {\n      height: 4px;\n      background: rgba(255, 255, 255, 0.1);\n      border-radius: 2px;\n      overflow: hidden;\n    }\n\n    .va-quiz-progress-fill {\n      height: 100%;\n      background: linear-gradient(90deg, #8b5cf6, #3b82f6);\n      border-radius: 2px;\n      transition: width 0.3s ease;\n    }\n\n    .va-quiz-progress-text {\n      color: #64748b;\n      font-size: 12px;\n      margin-top: 8px;\n      text-align: right;\n    }\n\n    .va-quiz-content {\n      padding: 24px 20px;\n      max-height: 50vh;\n      overflow-y: auto;\n    }\n\n    .va-quiz-question {\n      color: #e2e8f0;\n      font-size: 20px;\n      font-weight: 500;\n      line-height: 1.4;\n      margin-bottom: 24px;\n      text-align: center;\n    }\n\n    .va-quiz-options {\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    }\n\n    .va-quiz-option {\n      background: rgba(255, 255, 255, 0.05);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      border-radius: 12px;\n      padding: 16px 20px;\n      color: #e2e8f0;\n      font-size: 15px;\n      text-align: left;\n      cursor: pointer;\n      transition: all 0.2s;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .va-quiz-option:hover {\n      background: rgba(139, 92, 246, 0.15);\n      border-color: rgba(139, 92, 246, 0.4);\n      transform: translateX(4px);\n    }\n\n    .va-quiz-option.va-quiz-selected {\n      background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));\n      border-color: #8b5cf6;\n    }\n\n    .va-quiz-option-icon {\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.1);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n    }\n\n    .va-quiz-option.va-quiz-selected .va-quiz-option-icon {\n      background: #8b5cf6;\n    }\n\n    .va-quiz-option-icon svg {\n      width: 14px;\n      height: 14px;\n      color: #94a3b8;\n    }\n\n    .va-quiz-option.va-quiz-selected .va-quiz-option-icon svg {\n      color: white;\n    }\n\n    .va-quiz-voice-section {\n      margin-top: 20px;\n      padding: 16px;\n      background: rgba(139, 92, 246, 0.1);\n      border-radius: 12px;\n      text-align: center;\n    }\n\n    .va-quiz-voice-hint {\n      color: #a78bfa;\n      font-size: 13px;\n      margin-bottom: 12px;\n    }\n\n    .va-quiz-voice-btn {\n      background: linear-gradient(135deg, #8b5cf6, #6366f1);\n      border: none;\n      color: white;\n      padding: 14px 24px;\n      border-radius: 50px;\n      font-size: 15px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .va-quiz-voice-btn:hover {\n      transform: scale(1.05);\n      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);\n    }\n\n    .va-quiz-voice-btn.va-quiz-listening {\n      animation: va-quiz-pulse 1.5s infinite;\n    }\n\n    @keyframes va-quiz-pulse {\n      0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }\n      50% { box-shadow: 0 0 0 15px rgba(139, 92, 246, 0); }\n    }\n\n    .va-quiz-voice-btn svg {\n      width: 20px;\n      height: 20px;\n    }\n\n    .va-quiz-footer {\n      padding: 16px 20px;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n      display: flex;\n      justify-content: space-between;\n      gap: 12px;\n    }\n\n    .va-quiz-btn {\n      flex: 1;\n      padding: 14px 20px;\n      border-radius: 10px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n      border: none;\n    }\n\n    .va-quiz-btn-back {\n      background: rgba(255, 255, 255, 0.1);\n      color: #94a3b8;\n    }\n\n    .va-quiz-btn-back:hover {\n      background: rgba(255, 255, 255, 0.15);\n      color: #e2e8f0;\n    }\n\n    .va-quiz-btn-next {\n      background: linear-gradient(135deg, #8b5cf6, #6366f1);\n      color: white;\n    }\n\n    .va-quiz-btn-next:hover:not(:disabled) {\n      transform: translateY(-1px);\n      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);\n    }\n\n    .va-quiz-btn-next:disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n    }\n\n    /* Results screen */\n    .va-quiz-results {\n      text-align: center;\n      padding: 20px;\n    }\n\n    .va-quiz-results-icon {\n      width: 64px;\n      height: 64px;\n      background: linear-gradient(135deg, #10b981, #059669);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin: 0 auto 20px;\n    }\n\n    .va-quiz-results-icon svg {\n      width: 32px;\n      height: 32px;\n      color: white;\n    }\n\n    .va-quiz-results-title {\n      color: #e2e8f0;\n      font-size: 22px;\n      font-weight: 600;\n      margin-bottom: 12px;\n    }\n\n    .va-quiz-results-subtitle {\n      color: #94a3b8;\n      font-size: 14px;\n      margin-bottom: 24px;\n    }\n\n    .va-quiz-lead-form {\n      background: rgba(255, 255, 255, 0.05);\n      border-radius: 12px;\n      padding: 20px;\n      margin-bottom: 20px;\n    }\n\n    .va-quiz-lead-form input {\n      width: 100%;\n      background: rgba(255, 255, 255, 0.1);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 8px;\n      padding: 12px 16px;\n      color: #e2e8f0;\n      font-size: 14px;\n      margin-bottom: 12px;\n    }\n\n    .va-quiz-lead-form input:focus {\n      outline: none;\n      border-color: #8b5cf6;\n    }\n\n    .va-quiz-lead-form input::placeholder {\n      color: #64748b;\n    }\n\n    /* RTL Support */\n    [dir="rtl"] .va-quiz-option:hover {\n      transform: translateX(-4px);\n    }\n\n    [dir="rtl"] .va-quiz-progress-text {\n      text-align: left;\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 480px) {\n      .va-quiz-container {\n        width: 95%;\n        max-height: 95vh;\n      }\n\n      .va-quiz-question {\n        font-size: 18px;\n      }\n\n      .va-quiz-option {\n        padding: 14px 16px;\n        font-size: 14px;\n      }\n    }\n  ',e.appendChild(n)}_initQuestions(){if(this.options.customQuestions)this.questions=this.options.customQuestions;else{const e=t[this.options.template]||t.generic;this.questions=e.questions,this.title=e.title}}_initVoiceRecognition(){if(!this.options.voiceEnabled)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;e?(this.recognition=new e,this.recognition.continuous=!1,this.recognition.interimResults=!1,this.recognition.lang=this._getSpeechLang(),this.recognition.onresult=e=>{const n=e.results[0][0].transcript.toLowerCase();this._processVoiceAnswer(n)},this.recognition.onend=()=>{this.isListening=!1,this._updateVoiceButton()},this.recognition.onerror=e=>{console.error("[VoiceQuiz] Speech error:",e.error),this.isListening=!1,this._updateVoiceButton()}):console.warn("[VoiceQuiz] Speech Recognition not supported")}_getSpeechLang(){return{fr:"fr-FR",en:"en-US",es:"es-ES",ar:"ar-SA",ary:"ar-MA"}[this.options.lang]||"fr-FR"}_t(e){return"string"==typeof e?e:e[this.options.lang]||e.fr||e.en||Object.values(e)[0]}_getLabels(){const e={fr:{back:"Retour",next:"Suivant",finish:"Voir mes recommandations",voiceHint:"Ou rÃ©pondez par la voix",listening:"Je vous Ã©coute...",speak:"Parler",stepOf:"Question {current} sur {total}",resultsTitle:"Vos recommandations sont prÃªtes !",resultsSubtitle:"Entrez vos coordonnÃ©es pour recevoir votre sÃ©lection personnalisÃ©e",namePlaceholder:"Votre nom",emailPlaceholder:"Votre email",phonePlaceholder:"Votre tÃ©lÃ©phone (optionnel)",getResults:"Recevoir mes recommandations",skip:"Voir sans email"},en:{back:"Back",next:"Next",finish:"See my recommendations",voiceHint:"Or answer by voice",listening:"I'm listening...",speak:"Speak",stepOf:"Question {current} of {total}",resultsTitle:"Your recommendations are ready!",resultsSubtitle:"Enter your details to receive your personalized selection",namePlaceholder:"Your name",emailPlaceholder:"Your email",phonePlaceholder:"Your phone (optional)",getResults:"Get my recommendations",skip:"View without email"},es:{back:"AtrÃ¡s",next:"Siguiente",finish:"Ver mis recomendaciones",voiceHint:"O responde por voz",listening:"Te escucho...",speak:"Hablar",stepOf:"Pregunta {current} de {total}",resultsTitle:"Â¡Tus recomendaciones estÃ¡n listas!",resultsSubtitle:"Ingresa tus datos para recibir tu selecciÃ³n personalizada",namePlaceholder:"Tu nombre",emailPlaceholder:"Tu email",phonePlaceholder:"Tu telÃ©fono (opcional)",getResults:"Recibir mis recomendaciones",skip:"Ver sin email"},ar:{back:"Ø±Ø¬ÙˆØ¹",next:"Ø§Ù„ØªØ§Ù„ÙŠ",finish:"Ø¹Ø±Ø¶ ØªÙˆØµÙŠØ§ØªÙŠ",voiceHint:"Ø£Ùˆ Ø£Ø¬Ø¨ Ø¨Ø§Ù„ØµÙˆØª",listening:"Ø£Ø³ØªÙ…Ø¹...",speak:"ØªÙƒÙ„Ù…",stepOf:"Ø§Ù„Ø³Ø¤Ø§Ù„ {current} Ù…Ù† {total}",resultsTitle:"ØªÙˆØµÙŠØ§ØªÙƒ Ø¬Ø§Ù‡Ø²Ø©!",resultsSubtitle:"Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØªÙ„Ù‚ÙŠ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ø§Ù„Ù…Ø®ØµØµ",namePlaceholder:"Ø§Ø³Ù…Ùƒ",emailPlaceholder:"Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",phonePlaceholder:"Ù‡Ø§ØªÙÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",getResults:"Ø§Ø³ØªÙ„Ù… ØªÙˆØµÙŠØ§ØªÙŠ",skip:"Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† Ø¨Ø±ÙŠØ¯"},ary:{back:"Ø±Ø¬Ø¹",next:"ÙƒÙ…Ù„",finish:"Ø´ÙˆÙ Ø´Ù†Ùˆ ÙŠÙ†Ø§Ø³Ø¨Ù†ÙŠ",voiceHint:"ÙˆÙ„Ø§ Ø¬Ø§ÙˆØ¨ Ø¨Ø§Ù„ØµÙˆØª",listening:"ÙƒÙ†Ø³Ù…Ø¹Ùƒ...",speak:"Ù‡Ø¶Ø±",stepOf:"Ø³Ø¤Ø§Ù„ {current} Ù…Ù† {total}",resultsTitle:"Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø¯ÙŠØ§Ù„Ùƒ Ø¬Ø§Ù‡Ø²ÙŠÙ†!",resultsSubtitle:"Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ø§Ø´ ØªÙˆØµÙ„Ùƒ Ù„Ø§Ø¦Ø­Ø© Ø®Ø§ØµØ© Ø¨ÙŠÙƒ",namePlaceholder:"Ø³Ù…ÙŠØªÙƒ",emailPlaceholder:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯ÙŠØ§Ù„Ùƒ",phonePlaceholder:"Ø§Ù„ØªÙŠÙ„ÙŠÙÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",getResults:"ØªÙˆØµÙ„Ù†ÙŠ Ø§Ù„ØªÙˆØµÙŠØ§Øª",skip:"Ø´ÙˆÙ Ø¨Ù„Ø§ Ø¥ÙŠÙ…ÙŠÙ„"}};return e[this.options.lang]||e.fr}_createQuizDOM(){const e=this._getLabels(),t="ar"===this.options.lang||"ary"===this.options.lang,i=document.createElement("div");return i.className="va-quiz-overlay",i.id="va-quiz-overlay",t&&i.setAttribute("dir","rtl"),i.innerHTML=`\n        <div class="va-quiz-container">\n          <div class="va-quiz-header">\n            <div class="va-quiz-title">\n              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />\n              </svg>\n              <span>${n(this._t(this.title||{fr:"Quiz Produit",en:"Product Quiz"}))}</span>\n            </div>\n            <button class="va-quiz-close" aria-label="${this._t({fr:"Fermer",en:"Close",es:"Cerrar",ar:"Ø¥ØºÙ„Ø§Ù‚",ary:"Ø³Ø¯"})}">\n              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n          <div class="va-quiz-progress">\n            <div class="va-quiz-progress-bar">\n              <div class="va-quiz-progress-fill" style="width: 0%"></div>\n            </div>\n            <div class="va-quiz-progress-text"></div>\n          </div>\n          <div class="va-quiz-content"></div>\n          <div class="va-quiz-footer">\n            <button class="va-quiz-btn va-quiz-btn-back" style="display: none">${e.back}</button>\n            <button class="va-quiz-btn va-quiz-btn-next" disabled>${e.next}</button>\n          </div>\n        </div>\n      `,i.querySelector(".va-quiz-close").addEventListener("click",()=>this.hide()),i.querySelector(".va-quiz-btn-back").addEventListener("click",()=>this._prevStep()),i.querySelector(".va-quiz-btn-next").addEventListener("click",()=>this._nextStep()),i.addEventListener("click",e=>{e.target===i&&this.hide()}),i}_renderQuestion(){const e=this._getLabels(),t=this.questions[this.currentStep],i=this.container.querySelector(".va-quiz-content"),a=this.container.querySelector(".va-quiz-progress-fill"),o=this.container.querySelector(".va-quiz-progress-text"),s=this.container.querySelector(".va-quiz-btn-back"),r=this.container.querySelector(".va-quiz-btn-next");a.style.width=(this.currentStep+1)/this.questions.length*100+"%",o.textContent=e.stepOf.replace("{current}",this.currentStep+1).replace("{total}",this.questions.length),s.style.display=this.currentStep>0?"block":"none",r.textContent=this.currentStep===this.questions.length-1?e.finish:e.next,r.disabled=!this.answers[t.id],i.innerHTML=`\n        <div class="va-quiz-question">${n(this._t(t.question))}</div>\n        <div class="va-quiz-options">\n          ${(t.options||[]).map(e=>{return`\n            <button class="va-quiz-option ${this.answers[t.id]===e.value?"va-quiz-selected":""}" data-value="${i=e.value,i?String(i).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}">\n              <span class="va-quiz-option-icon">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">\n                  <polyline points="20 6 9 17 4 12"></polyline>\n                </svg>\n              </span>\n              <span>${n(this._t(e.label))}</span>\n            </button>\n          `;var i}).join("")}\n        </div>\n        ${this.recognition?`\n          <div class="va-quiz-voice-section">\n            <div class="va-quiz-voice-hint">${e.voiceHint}</div>\n            <button class="va-quiz-voice-btn" id="va-quiz-voice-btn">\n              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>\n                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>\n                <line x1="12" y1="19" x2="12" y2="23"></line>\n                <line x1="8" y1="23" x2="16" y2="23"></line>\n              </svg>\n              <span>${e.speak}</span>\n            </button>\n          </div>\n        `:""}\n      `,i.querySelectorAll(".va-quiz-option").forEach(e=>{e.addEventListener("click",()=>{this._selectOption(t.id,e.dataset.value)})});const c=i.querySelector("#va-quiz-voice-btn");c&&c.addEventListener("click",()=>this._toggleVoice())}_selectOption(e,n){this.answers[e]=n,this._renderQuestion(),this._trackAnswer(e,n)}_toggleVoice(){this.recognition&&(this.isListening?this.recognition.stop():(this.isListening=!0,this._updateVoiceButton(),this.recognition.start()))}_updateVoiceButton(){const e=this._getLabels(),n=this.container?.querySelector("#va-quiz-voice-btn");n&&(this.isListening?(n.classList.add("va-quiz-listening"),n.querySelector("span").textContent=e.listening):(n.classList.remove("va-quiz-listening"),n.querySelector("span").textContent=e.speak))}_processVoiceAnswer(e){const n=this.questions[this.currentStep];if(n.options){for(const t of n.options){const i=this._t(t.label).toLowerCase();if(e.includes(i)||i.includes(e))return this._selectOption(n.id,t.value),void setTimeout(()=>this._nextStep(),800)}if(n.voiceKeywords){const t=n.voiceKeywords[this.options.lang]||[];for(const i of t)if(e.includes(i))return this.answers[n.id]=e,this._renderQuestion(),void setTimeout(()=>this._nextStep(),800)}}}_prevStep(){this.currentStep>0&&(this.currentStep--,this._renderQuestion())}_nextStep(){this.currentStep<this.questions.length-1?(this.currentStep++,this._renderQuestion()):this._showResults()}_showResults(){const e=this._getLabels(),n=this.container.querySelector(".va-quiz-content"),t=this.container.querySelector(".va-quiz-footer");this.container.querySelector(".va-quiz-progress-fill").style.width="100%",this.container.querySelector(".va-quiz-progress-text").textContent="",n.innerHTML=`\n        <div class="va-quiz-results">\n          <div class="va-quiz-results-icon">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <polyline points="20 6 9 17 4 12"></polyline>\n            </svg>\n          </div>\n          <h3 class="va-quiz-results-title">${e.resultsTitle}</h3>\n          <p class="va-quiz-results-subtitle">${e.resultsSubtitle}</p>\n          <div class="va-quiz-lead-form">\n            <input type="text" id="va-quiz-name" placeholder="${e.namePlaceholder}" required>\n            <input type="email" id="va-quiz-email" placeholder="${e.emailPlaceholder}" required>\n            <input type="tel" id="va-quiz-phone" placeholder="${e.phonePlaceholder}">\n          </div>\n        </div>\n      `,t.innerHTML=`\n        <button class="va-quiz-btn va-quiz-btn-back">${e.skip}</button>\n        <button class="va-quiz-btn va-quiz-btn-next">${e.getResults}</button>\n      `,t.querySelector(".va-quiz-btn-back").addEventListener("click",()=>{this._completeQuiz(!1)}),t.querySelector(".va-quiz-btn-next").addEventListener("click",()=>{const e=this.container.querySelector("#va-quiz-name").value.trim(),n=this.container.querySelector("#va-quiz-email").value.trim(),t=this.container.querySelector("#va-quiz-phone").value.trim();e&&n&&(this._captureLead({name:e,email:n,phone:t}),this._completeQuiz(!0))})}async _captureLead(e){if(this.options.onLeadCapture&&this.options.onLeadCapture({...e,answers:this.answers}),this._track("quiz_lead_captured",{...e,answers_count:Object.keys(this.answers).length}),this.options.tenantId)try{await fetch(`${this.options.apiBaseUrl}/api/leads`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenant_id:this.options.tenantId,source:"voice_quiz",...e,quiz_answers:this.answers})})}catch(e){console.error("[VoiceQuiz] Lead capture error:",e)}}async _completeQuiz(e){const n=[];for(const e of this.questions){const t=this.answers[e.id];t&&e.tags?.[t]&&n.push(...e.tags[t])}this._track("quiz_completed",{with_lead:e,answers:this.answers,tags:n}),this.options.onComplete&&this.options.onComplete({answers:this.answers,tags:n,withLead:e}),window.VocalIA?.getAIRecommendations?(this.hide(),await window.VocalIA.getAIRecommendations(null,[],"personalized")):this.hide()}_track(e,n={}){if(!window.VOCALIA_CONFIG||!1!==window.VOCALIA_CONFIG.analytics_consent){try{if("denied"===localStorage.getItem("va_consent"))return}catch{}"function"==typeof gtag&&gtag("event",e,{event_category:"voice_quiz",...n})}}_trackAnswer(e,n){this._track("quiz_answer",{question_id:e,answer:n,step:this.currentStep+1})}show(){return this.isVisible||(this._track("quiz_started",{template:this.options.template}),this.host=document.createElement("div"),this.host.id="va-quiz-host",this.host.style.cssText="position:fixed;inset:0;z-index:10003;pointer-events:none;",document.body.appendChild(this.host),this._shadowRoot=this.host.attachShadow({mode:"open"}),this._injectStyles(this._shadowRoot),this.container=this._createQuizDOM(),this.container.style.pointerEvents="auto",this._shadowRoot.appendChild(this.container),this._renderQuestion(),requestAnimationFrame(()=>{this.container.classList.add("va-quiz-visible")}),this.isVisible=!0),this}hide(){return this.isVisible?(this.isListening&&this.recognition&&this.recognition.stop(),this.currentStep<this.questions.length&&this._track("quiz_abandoned",{step:this.currentStep+1,total:this.questions.length}),this.container?.classList.remove("va-quiz-visible"),setTimeout(()=>{this.host?.remove(),this.host=null,this._shadowRoot=null,this.container=null},300),this.isVisible=!1,this):this}reset(){return this.currentStep=0,this.answers={},this.isVisible&&this._renderQuestion(),this}setLanguage(e){return this.options.lang=e,this.recognition&&(this.recognition.lang=this._getSpeechLang()),this}}e.VocalIAQuiz=i,e.QUIZ_TEMPLATES=t,e.VocalIA&&(e.VocalIA.Quiz=i,e.VocalIA.QuizTemplates=t)}(typeof window<"u"?window:this),function(){"use strict";function e(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}const n={fr:{title:"Tentez votre chance !",subtitle:"Tournez la roue pour gagner une surprise",ariaClose:"Fermer",spinButton:"TOURNER",spinning:"En cours...",emailPlaceholder:"Votre email pour recevoir le code",emailLabel:"Entrez votre email pour jouer",submitEmail:"Jouer maintenant",congratulations:"Felicitations !",youWon:"Vous avez gagne",discountCode:"Votre code promo",copyCode:"Copier le code",copied:"Copie !",useNow:"Utiliser maintenant",tryAgain:"Peut-etre la prochaine fois !",noLuck:"Pas de chance cette fois",alreadyPlayed:"Vous avez deja joue aujourd'hui",comeBackTomorrow:"Revenez demain pour une nouvelle chance !",voiceIntro:"Bienvenue ! Tournez la roue pour gagner des reductions exclusives.",voiceSpinning:"La roue tourne...",voiceWin:"Felicitations ! Vous avez gagne {{prize}} !",voiceLose:"Pas de chance cette fois. Revenez demain !",prizes:{discount5:"5% de reduction",discount10:"10% de reduction",discount15:"15% de reduction",discount20:"20% de reduction",discount30:"30% de reduction",freeShipping:"Livraison gratuite",tryAgain:"Reessayez"}},en:{title:"Try Your Luck!",subtitle:"Spin the wheel to win a surprise",ariaClose:"Close",spinButton:"SPIN",spinning:"Spinning...",emailPlaceholder:"Your email to receive the code",emailLabel:"Enter your email to play",submitEmail:"Play now",congratulations:"Congratulations!",youWon:"You won",discountCode:"Your promo code",copyCode:"Copy code",copied:"Copied!",useNow:"Use now",tryAgain:"Maybe next time!",noLuck:"No luck this time",alreadyPlayed:"You already played today",comeBackTomorrow:"Come back tomorrow for another chance!",voiceIntro:"Welcome! Spin the wheel to win exclusive discounts.",voiceSpinning:"The wheel is spinning...",voiceWin:"Congratulations! You won {{prize}}!",voiceLose:"No luck this time. Come back tomorrow!",prizes:{discount5:"5% off",discount10:"10% off",discount15:"15% off",discount20:"20% off",discount30:"30% off",freeShipping:"Free shipping",tryAgain:"Try again"}},es:{title:"Prueba tu suerte!",subtitle:"Gira la rueda para ganar una sorpresa",ariaClose:"Cerrar",spinButton:"GIRAR",spinning:"Girando...",emailPlaceholder:"Tu email para recibir el codigo",emailLabel:"Ingresa tu email para jugar",submitEmail:"Jugar ahora",congratulations:"Felicidades!",youWon:"Ganaste",discountCode:"Tu codigo promocional",copyCode:"Copiar codigo",copied:"Copiado!",useNow:"Usar ahora",tryAgain:"Quizas la proxima!",noLuck:"Sin suerte esta vez",alreadyPlayed:"Ya jugaste hoy",comeBackTomorrow:"Vuelve manana para otra oportunidad!",voiceIntro:"Bienvenido! Gira la rueda para ganar descuentos exclusivos.",voiceSpinning:"La rueda esta girando...",voiceWin:"Felicidades! Ganaste {{prize}}!",voiceLose:"Sin suerte esta vez. Vuelve manana!",prizes:{discount5:"5% de descuento",discount10:"10% de descuento",discount15:"15% de descuento",discount20:"20% de descuento",discount30:"30% de descuento",freeShipping:"Envio gratis",tryAgain:"Intenta de nuevo"}},ar:{title:"Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ!",subtitle:"Ø§Ø¯Ø± Ø§Ù„Ø¹Ø¬Ù„Ø© Ù„ØªØ±Ø¨Ø­ Ù…ÙØ§Ø¬Ø£Ø©",ariaClose:"Ø¥ØºÙ„Ø§Ù‚",spinButton:"Ø§Ø¯Ø±",spinning:"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†...",emailPlaceholder:"Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙƒÙˆØ¯",emailLabel:"Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ù„Ø¹Ø¨",submitEmail:"Ø§Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†",congratulations:"Ù…Ø¨Ø±ÙˆÙƒ!",youWon:"Ø±Ø¨Ø­Øª",discountCode:"ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…",copyCode:"Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯",copied:"ØªÙ… Ø§Ù„Ù†Ø³Ø®!",useNow:"Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù†",tryAgain:"Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!",noLuck:"Ù„Ø§ Ø­Ø¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©",alreadyPlayed:"Ù„Ù‚Ø¯ Ù„Ø¹Ø¨Øª Ø§Ù„ÙŠÙˆÙ…",comeBackTomorrow:"Ø¹Ø¯ ØºØ¯Ø§Ù‹ Ù„ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø©!",voiceIntro:"Ù…Ø±Ø­Ø¨Ø§! Ø§Ø¯Ø± Ø§Ù„Ø¹Ø¬Ù„Ø© Ù„ØªØ±Ø¨Ø­ Ø®ØµÙˆÙ…Ø§Øª Ø­ØµØ±ÙŠØ©.",voiceSpinning:"Ø§Ù„Ø¹Ø¬Ù„Ø© ØªØ¯ÙˆØ±...",voiceWin:"Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª {{prize}}!",voiceLose:"Ù„Ø§ Ø­Ø¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©. Ø¹Ø¯ ØºØ¯Ø§Ù‹!",prizes:{discount5:"Ø®ØµÙ… 5%",discount10:"Ø®ØµÙ… 10%",discount15:"Ø®ØµÙ… 15%",discount20:"Ø®ØµÙ… 20%",discount30:"Ø®ØµÙ… 30%",freeShipping:"Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ",tryAgain:"Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"}},ary:{title:"Ø¬Ø±Ø¨ Ø§Ù„Ø²Ù‡Ø± Ø¯ÙŠØ§Ù„Ùƒ!",subtitle:"Ø¯ÙˆØ± Ø§Ù„Ø±ÙˆØ¶Ø© Ø¨Ø§Ø´ ØªØ±Ø¨Ø­ ÙƒØ§Ø¯Ùˆ",ariaClose:"Ø³Ø¯",spinButton:"Ø¯ÙˆØ±",spinning:"ÙƒØªØ¯ÙˆØ±...",emailPlaceholder:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯ÙŠØ§Ù„Ùƒ Ø¨Ø§Ø´ ØªØ§Ø®Ø¯ Ø§Ù„ÙƒÙˆØ¯",emailLabel:"Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ø§Ø´ ØªÙ„Ø¹Ø¨",submitEmail:"Ù„Ø¹Ø¨ Ø¯Ø§Ø¨Ø§",congratulations:"Ù…Ø¨Ø±ÙˆÙƒ Ø¹Ù„ÙŠÙƒ!",youWon:"Ø±Ø¨Ø­ØªÙŠ",discountCode:"Ø§Ù„ÙƒÙˆØ¯ Ø¯ÙŠØ§Ù„ Ø§Ù„ØªØ®ÙÙŠØ¶",copyCode:"ÙƒÙˆØ¨ÙŠ Ø§Ù„ÙƒÙˆØ¯",copied:"ØªÙƒÙˆØ¨ÙŠØ§!",useNow:"Ø§Ø³ØªØ¹Ù…Ù„Ùˆ Ø¯Ø§Ø¨Ø§",tryAgain:"ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©!",noLuck:"Ù…Ø§ ÙƒØ§Ù†Ø´ Ø§Ù„Ø²Ù‡Ø± Ù‡Ø§Ø¯ Ø§Ù„Ù…Ø±Ø©",alreadyPlayed:"Ù„Ø¹Ø¨ØªÙŠ Ù‡Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø±",comeBackTomorrow:"Ø±Ø¬Ø¹ ØºØ¯Ø§ Ø¨Ø§Ø´ ØªÙ„Ø¹Ø¨!",voiceIntro:"Ù…Ø±Ø­Ø¨Ø§! Ø¯ÙˆØ± Ø§Ù„Ø±ÙˆØ¶Ø© Ø¨Ø§Ø´ ØªØ±Ø¨Ø­ ØªØ®ÙÙŠØ¶Ø§Øª Ø®Ø§ØµØ©.",voiceSpinning:"Ø§Ù„Ø±ÙˆØ¶Ø© ÙƒØªØ¯ÙˆØ±...",voiceWin:"Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­ØªÙŠ {{prize}}!",voiceLose:"Ù…Ø§ ÙƒØ§Ù†Ø´ Ø§Ù„Ø²Ù‡Ø±. Ø±Ø¬Ø¹ ØºØ¯Ø§!",prizes:{discount5:"ØªØ®ÙÙŠØ¶ 5%",discount10:"ØªØ®ÙÙŠØ¶ 10%",discount15:"ØªØ®ÙÙŠØ¶ 15%",discount20:"ØªØ®ÙÙŠØ¶ 20%",discount30:"ØªØ®ÙÙŠØ¶ 30%",freeShipping:"Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´",tryAgain:"Ø¹Ø§ÙˆØ¯"}}},t=[{id:"discount5",probability:30,color:"#5E6AD2",code:"SPIN5"},{id:"discount10",probability:25,color:"#10B981",code:"SPIN10"},{id:"discount15",probability:15,color:"#F59E0B",code:"SPIN15"},{id:"discount20",probability:10,color:"#8B5CF6",code:"SPIN20"},{id:"discount30",probability:5,color:"#EF4444",code:"SPIN30"},{id:"freeShipping",probability:5,color:"#EC4899",code:"FREESHIP"},{id:"tryAgain",probability:10,color:"#6B7280",code:null}];class i{constructor(e={}){this.config={tenantId:e.tenantId||this.detectTenantId(),lang:e.lang||this.detectLanguage(),apiUrl:e.apiUrl||this.detectApiUrl(),prizes:e.prizes||t,voiceEnabled:!1!==e.voiceEnabled,requireEmail:!1!==e.requireEmail,cooldownHours:e.cooldownHours||24,spinDuration:e.spinDuration||5e3,onSpin:e.onSpin||null,onWin:e.onWin||null,onLose:e.onLose||null,onEmailCapture:e.onEmailCapture||null},this.state={isVisible:!1,isSpinning:!1,hasPlayed:!1,selectedPrize:null,email:null,currentRotation:0},this.elements={},this.translations=n[this.config.lang]||n.fr,this.isRTL=["ar","ary"].includes(this.config.lang),this.init()}detectTenantId(){return window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.tenant_id?window.VOCALIA_CONFIG.tenant_id:document.querySelector("[data-vocalia-tenant]")?.dataset.vocaliaTenant||"default"}detectLanguage(){const e=document.querySelector("[data-vocalia-lang]");if(e)return e.dataset.vocaliaLang;const n=new URLSearchParams(window.location.search);if(n.get("lang"))return n.get("lang");const t=navigator.language?.split("-")[0];return["fr","en","es","ar","ary"].includes(t)?t:"fr"}detectApiUrl(){return window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.api_url?window.VOCALIA_CONFIG.api_url:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3013":"https://api.vocalia.ma"}init(){this.checkCooldown(),console.log("[SpinWheel] Initialized",{tenant:this.config.tenantId,lang:this.config.lang,hasPlayed:this.state.hasPlayed})}checkCooldown(){try{const e=localStorage.getItem("va_spin_wheel_last_played");e&&Date.now()-parseInt(e,10)<60*this.config.cooldownHours*60*1e3&&(this.state.hasPlayed=!0)}catch{}}createModal(){const e=document.createElement("div");e.className="va-spin-overlay",e.id="va-spin-overlay",e.innerHTML=`\n        <div class="va-spin-modal" dir="${this.isRTL?"rtl":"ltr"}" role="dialog" aria-modal="true">\n          <button class="va-spin-close" aria-label="${this.translations.ariaClose||"Close"}">\n            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n\n          <div class="va-spin-game">\n            <h2 class="va-spin-title">${this.translations.title}</h2>\n            <p class="va-spin-subtitle">${this.translations.subtitle}</p>\n\n            <div class="va-spin-wheel-container">\n              <div class="va-spin-pointer"></div>\n              <div class="va-spin-wheel" id="va-spin-wheel">\n                ${this.generateWheelSegments()}\n              </div>\n              <div class="va-spin-center">\n                <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>\n              </div>\n            </div>\n\n            ${this.config.requireEmail?`\n              <div class="va-spin-email-form">\n                <label class="va-spin-email-label">${this.translations.emailLabel}</label>\n                <input type="email" class="va-spin-email-input" placeholder="${this.translations.emailPlaceholder}" id="va-spin-email">\n                <button class="va-spin-btn primary" id="va-spin-submit">${this.translations.submitEmail}</button>\n              </div>\n            `:`\n              <button class="va-spin-btn primary" id="va-spin-btn">${this.translations.spinButton}</button>\n            `}\n          </div>\n\n          <div class="va-spin-result" id="va-spin-result">\n            <div class="va-spin-result-icon win" id="va-spin-result-icon">\n              <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>\n            </div>\n            <h3 class="va-spin-result-title" id="va-spin-result-title">${this.translations.congratulations}</h3>\n            <p class="va-spin-result-prize" id="va-spin-result-prize"></p>\n\n            <div class="va-spin-code-container" id="va-spin-code-container">\n              <div class="va-spin-code-label">${this.translations.discountCode}</div>\n              <div class="va-spin-code" id="va-spin-code"></div>\n              <button class="va-spin-copy-btn" id="va-spin-copy">${this.translations.copyCode}</button>\n            </div>\n\n            <button class="va-spin-btn primary" id="va-spin-use">${this.translations.useNow}</button>\n          </div>\n\n          <div class="va-spin-already-played" id="va-spin-already-played" style="display: none;">\n            <h3 class="va-spin-result-title">${this.translations.alreadyPlayed}</h3>\n            <p class="va-spin-subtitle">${this.translations.comeBackTomorrow}</p>\n          </div>\n        </div>\n      `,this.host=document.createElement("div"),this.host.id="va-spin-host",this.host.style.cssText="position:fixed;inset:0;z-index:10003;pointer-events:none;",document.body.appendChild(this.host),this._shadowRoot=this.host.attachShadow({mode:"open"});const n=document.createElement("style");n.id="va-spin-wheel-styles",n.textContent='\n    .va-spin-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.85);\n      backdrop-filter: blur(8px);\n      z-index: 10002;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      visibility: hidden;\n      transition: opacity 0.3s ease, visibility 0.3s ease;\n    }\n\n    .va-spin-overlay.active {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    .va-spin-modal {\n      background: linear-gradient(135deg, #0f172a 0%, #0F1225 100%);\n      border: 2px solid rgba(94, 106, 210, 0.3);\n      border-radius: 24px;\n      max-width: 440px;\n      width: 95%;\n      padding: 32px;\n      text-align: center;\n      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 60px rgba(94, 106, 210, 0.2);\n      animation: vaSpinModalIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    .va-spin-modal[dir="rtl"] {\n      text-align: right;\n    }\n\n    @keyframes vaSpinModalIn {\n      from { transform: scale(0.8) rotate(-10deg); opacity: 0; }\n      to { transform: scale(1) rotate(0deg); opacity: 1; }\n    }\n\n    .va-spin-close {\n      position: absolute;\n      top: 16px;\n      right: 16px;\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: background 0.2s ease;\n      z-index: 10;\n    }\n\n    .va-spin-close:hover {\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .va-spin-close svg {\n      width: 16px;\n      height: 16px;\n      fill: white;\n    }\n\n    [dir="rtl"] .va-spin-close {\n      right: auto;\n      left: 16px;\n    }\n\n    .va-spin-title {\n      color: #FFFFFF;\n      font-size: 28px;\n      font-weight: 700;\n      margin: 0 0 8px;\n      background: linear-gradient(135deg, #5E6AD2 0%, #10B981 100%);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n    }\n\n    .va-spin-subtitle {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 16px;\n      margin: 0 0 24px;\n    }\n\n    .va-spin-wheel-container {\n      position: relative;\n      width: 280px;\n      height: 280px;\n      margin: 0 auto 24px;\n    }\n\n    .va-spin-wheel {\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      position: relative;\n      transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);\n      box-shadow: 0 0 0 8px rgba(94, 106, 210, 0.3), 0 0 0 12px rgba(94, 106, 210, 0.15);\n    }\n\n    .va-spin-wheel.spinning {\n      animation: none;\n    }\n\n    .va-spin-segment {\n      position: absolute;\n      width: 50%;\n      height: 50%;\n      left: 50%;\n      top: 0;\n      transform-origin: 0% 100%;\n      overflow: hidden;\n    }\n\n    .va-spin-segment-inner {\n      position: absolute;\n      width: 200%;\n      height: 200%;\n      left: -100%;\n      transform-origin: 50% 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding-top: 20px;\n      box-sizing: border-box;\n    }\n\n    .va-spin-segment-text {\n      transform: rotate(90deg);\n      color: white;\n      font-size: 11px;\n      font-weight: 600;\n      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n      max-width: 70px;\n      text-align: center;\n      line-height: 1.2;\n    }\n\n    .va-spin-pointer {\n      position: absolute;\n      top: -15px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 0;\n      height: 0;\n      border-left: 15px solid transparent;\n      border-right: 15px solid transparent;\n      border-top: 30px solid #F59E0B;\n      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));\n      z-index: 10;\n    }\n\n    .va-spin-center {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      background: linear-gradient(135deg, #0f172a 0%, #0F1225 100%);\n      border: 4px solid #5E6AD2;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 5;\n      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);\n    }\n\n    .va-spin-center svg {\n      width: 24px;\n      height: 24px;\n      fill: #5E6AD2;\n    }\n\n    .va-spin-email-form {\n      margin-bottom: 20px;\n    }\n\n    .va-spin-email-label {\n      color: rgba(255, 255, 255, 0.8);\n      font-size: 14px;\n      margin-bottom: 12px;\n      display: block;\n    }\n\n    .va-spin-email-input {\n      width: 100%;\n      padding: 14px 16px;\n      background: rgba(255, 255, 255, 0.05);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-radius: 12px;\n      color: #FFFFFF;\n      font-size: 16px;\n      margin-bottom: 12px;\n      outline: none;\n      box-sizing: border-box;\n      transition: border-color 0.2s ease;\n    }\n\n    .va-spin-email-input:focus {\n      border-color: #5E6AD2;\n    }\n\n    .va-spin-email-input::placeholder {\n      color: rgba(255, 255, 255, 0.4);\n    }\n\n    .va-spin-btn {\n      width: 100%;\n      padding: 16px 24px;\n      border-radius: 12px;\n      font-size: 18px;\n      font-weight: 700;\n      cursor: pointer;\n      transition: all 0.3s ease;\n      border: none;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n    }\n\n    .va-spin-btn.primary {\n      background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);\n      color: white;\n      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);\n    }\n\n    .va-spin-btn.primary:hover:not(:disabled) {\n      transform: translateY(-2px);\n      box-shadow: 0 8px 30px rgba(245, 158, 11, 0.5);\n    }\n\n    .va-spin-btn.primary:disabled {\n      opacity: 0.6;\n      cursor: not-allowed;\n      transform: none;\n    }\n\n    .va-spin-btn.secondary {\n      background: rgba(94, 106, 210, 0.1);\n      color: #5E6AD2;\n      border: 1px solid rgba(94, 106, 210, 0.3);\n    }\n\n    .va-spin-btn.secondary:hover {\n      background: rgba(94, 106, 210, 0.2);\n    }\n\n    /* Result state */\n    .va-spin-result {\n      display: none;\n    }\n\n    .va-spin-result.active {\n      display: block;\n      animation: vaFadeIn 0.5s ease;\n    }\n\n    @keyframes vaFadeIn {\n      from { opacity: 0; transform: translateY(20px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n\n    .va-spin-result-icon {\n      width: 80px;\n      height: 80px;\n      margin: 0 auto 16px;\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .va-spin-result-icon.win {\n      background: linear-gradient(135deg, #10B981 0%, #059669 100%);\n      animation: vaPulse 1s infinite;\n    }\n\n    .va-spin-result-icon.lose {\n      background: rgba(107, 114, 128, 0.3);\n    }\n\n    @keyframes vaPulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.1); }\n    }\n\n    .va-spin-result-icon svg {\n      width: 40px;\n      height: 40px;\n      fill: white;\n    }\n\n    .va-spin-result-title {\n      color: #FFFFFF;\n      font-size: 24px;\n      font-weight: 700;\n      margin-bottom: 8px;\n    }\n\n    .va-spin-result-prize {\n      color: #10B981;\n      font-size: 20px;\n      font-weight: 600;\n      margin-bottom: 16px;\n    }\n\n    .va-spin-code-container {\n      background: rgba(94, 106, 210, 0.1);\n      border: 1px dashed #5E6AD2;\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 16px;\n    }\n\n    .va-spin-code-label {\n      color: rgba(255, 255, 255, 0.7);\n      font-size: 12px;\n      margin-bottom: 8px;\n    }\n\n    .va-spin-code {\n      color: #5E6AD2;\n      font-size: 28px;\n      font-weight: 700;\n      font-family: \'Courier New\', monospace;\n      letter-spacing: 3px;\n    }\n\n    .va-spin-copy-btn {\n      margin-top: 12px;\n      padding: 8px 16px;\n      background: transparent;\n      border: 1px solid rgba(94, 106, 210, 0.5);\n      border-radius: 8px;\n      color: #5E6AD2;\n      font-size: 14px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .va-spin-copy-btn:hover {\n      background: rgba(94, 106, 210, 0.1);\n    }\n\n    .va-spin-copy-btn.copied {\n      background: rgba(16, 185, 129, 0.2);\n      border-color: #10B981;\n      color: #10B981;\n    }\n\n    /* Confetti */\n    .va-confetti {\n      position: fixed;\n      pointer-events: none;\n      z-index: 10003;\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 480px) {\n      .va-spin-modal {\n        padding: 24px 20px;\n        border-radius: 20px 20px 0 0;\n        position: fixed;\n        bottom: 0;\n        max-height: 90vh;\n        overflow-y: auto;\n      }\n\n      .va-spin-title {\n        font-size: 24px;\n      }\n\n      .va-spin-wheel-container {\n        width: 240px;\n        height: 240px;\n      }\n\n      .va-spin-btn {\n        font-size: 16px;\n        padding: 14px 20px;\n      }\n    }\n  ',this._shadowRoot.appendChild(n),e.style.pointerEvents="auto",this._shadowRoot.appendChild(e),this.elements.overlay=e,this.elements.wheel=e.querySelector("#va-spin-wheel"),this.elements.spinBtn=e.querySelector("#va-spin-btn")||e.querySelector("#va-spin-submit"),this.elements.emailInput=e.querySelector("#va-spin-email"),this.elements.closeBtn=e.querySelector(".va-spin-close"),this.elements.result=e.querySelector("#va-spin-result"),this.elements.resultIcon=e.querySelector("#va-spin-result-icon"),this.elements.resultTitle=e.querySelector("#va-spin-result-title"),this.elements.resultPrize=e.querySelector("#va-spin-result-prize"),this.elements.codeContainer=e.querySelector("#va-spin-code-container"),this.elements.code=e.querySelector("#va-spin-code"),this.elements.copyBtn=e.querySelector("#va-spin-copy"),this.elements.useBtn=e.querySelector("#va-spin-use"),this.elements.alreadyPlayed=e.querySelector("#va-spin-already-played"),this.elements.game=e.querySelector(".va-spin-game"),this.elements.closeBtn.addEventListener("click",()=>this.hide()),this.elements.overlay.addEventListener("click",e=>{e.target===this.elements.overlay&&this.hide()}),this.elements.spinBtn&&this.elements.spinBtn.addEventListener("click",()=>this.handleSpinClick()),this.elements.copyBtn&&this.elements.copyBtn.addEventListener("click",()=>this.copyCode()),this.elements.useBtn&&this.elements.useBtn.addEventListener("click",()=>this.useCode())}generateWheelSegments(){const n=this.config.prizes,t=360/n.length;let i="";return n.forEach((n,a)=>{const o=90-t,s=this.translations.prizes[n.id]||n.id;i+=`\n          <div class="va-spin-segment" style="transform: rotate(${a*t}deg) skewY(${o}deg);">\n            <div class="va-spin-segment-inner" style="background: ${e(n.color)}; transform: skewY(${-o}deg);">\n              <span class="va-spin-segment-text">${e(s)}</span>\n            </div>\n          </div>\n        `}),i}show(){this.elements.overlay||this.createModal(),this.state.hasPlayed?(this.elements.game.style.display="none",this.elements.alreadyPlayed.style.display="block"):(this.elements.game.style.display="block",this.elements.alreadyPlayed.style.display="none"),this.state.isVisible=!0,this.elements.overlay.classList.add("active"),this.config.voiceEnabled&&!this.state.hasPlayed&&setTimeout(()=>this.speak(this.translations.voiceIntro),500),this.trackEvent("spin_wheel_shown",{has_played:this.state.hasPlayed})}hide(){this.state.isVisible=!1,this.elements.overlay?.classList.remove("active")}handleSpinClick(){if(!this.state.isSpinning){if(this.config.requireEmail&&this.elements.emailInput){const e=this.elements.emailInput.value.trim();if(!e||!this.validateEmail(e))return void(this.elements.emailInput.style.borderColor="#EF4444");this.state.email=e,this.elements.emailInput.style.borderColor="",this.config.onEmailCapture&&this.config.onEmailCapture({email:e}),this.trackEvent("spin_wheel_email_captured",{email:e})}this.spin()}}validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}spin(){if(this.state.isSpinning||this.state.hasPlayed)return;this.state.isSpinning=!0,this.elements.spinBtn.disabled=!0,this.elements.spinBtn.textContent=this.translations.spinning,this.config.voiceEnabled&&this.speak(this.translations.voiceSpinning);const e=this.selectPrize();this.state.selectedPrize=e;const n=this.config.prizes,t=n.findIndex(n=>n.id===e.id),i=360/n.length,a=360-(t*i+i/2)+1800;this.state.currentRotation=a,this.elements.wheel.style.transform=`rotate(${a}deg)`,this.config.onSpin&&this.config.onSpin({prize:e}),this.trackEvent("spin_wheel_spun",{prize_id:e.id,prize_code:e.code,email:this.state.email}),setTimeout(()=>{this.showResult(e)},this.config.spinDuration+500)}selectPrize(){const e=this.config.prizes,n=e.reduce((e,n)=>e+n.probability,0);let t=Math.random()*n;for(const n of e)if(t-=n.probability,t<=0)return n;return e[e.length-1]}async showResult(e){const n=null!==e.code;if(this.elements.game.style.display="none",this.elements.result.classList.add("active"),n){let n=e.code;const t={discount5:5,discount10:10,discount15:15,discount20:20,discount30:30,freeShipping:0}[e.id]||10;try{const i=this.config.apiUrl;if(i){const a=await fetch(`${i}/api/promo/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenant_id:this.config.tenantId,prize_id:e.id,discount_percent:t,email:this.state.email||null})});if(a.ok){const e=await a.json();e.success&&e.code&&(n=e.code)}}}catch{console.warn("[SpinWheel] Promo API unavailable, using fallback code")}if(this.elements.resultIcon.className="va-spin-result-icon win",this.elements.resultIcon.innerHTML='<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',this.elements.resultTitle.textContent=this.translations.congratulations,this.elements.resultPrize.textContent=`${this.translations.youWon} ${this.translations.prizes[e.id]}`,this.elements.code.textContent=n,this.state.activeCode=n,this.elements.codeContainer.style.display="block",this.elements.useBtn.style.display="block",this.showConfetti(),this.config.voiceEnabled){const n=this.translations.voiceWin.replace("{{prize}}",this.translations.prizes[e.id]);this.speak(n)}this.config.onWin&&this.config.onWin({prize:e,code:n,email:this.state.email}),this.trackEvent("spin_wheel_won",{prize_id:e.id,prize_code:n,email:this.state.email})}else this.elements.resultIcon.className="va-spin-result-icon lose",this.elements.resultIcon.innerHTML='<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',this.elements.resultTitle.textContent=this.translations.tryAgain,this.elements.resultPrize.textContent=this.translations.noLuck,this.elements.codeContainer.style.display="none",this.elements.useBtn.style.display="none",this.config.voiceEnabled&&this.speak(this.translations.voiceLose),this.config.onLose&&this.config.onLose({email:this.state.email}),this.trackEvent("spin_wheel_lost",{email:this.state.email});this.state.hasPlayed=!0;try{localStorage.setItem("va_spin_wheel_last_played",Date.now().toString())}catch{}}showConfetti(){const e=["#5E6AD2","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899"];for(let n=0;n<50;n++){const n=document.createElement("div");n.className="va-confetti",n.style.cssText=`\n          position: fixed;\n          width: ${10*Math.random()+5}px;\n          height: ${10*Math.random()+5}px;\n          background: ${e[Math.floor(Math.random()*e.length)]};\n          left: ${100*Math.random()}vw;\n          top: -20px;\n          border-radius: ${Math.random()>.5?"50%":"0"};\n          animation: confettiFall ${3*Math.random()+2}s linear forwards;\n          z-index: 10003;\n        `,document.body.appendChild(n),setTimeout(()=>n.remove(),5e3)}if(!document.querySelector("#va-confetti-style")){const e=document.createElement("style");e.id="va-confetti-style",e.textContent="\n          @keyframes confettiFall {\n            0% { transform: translateY(0) rotate(0deg); opacity: 1; }\n            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }\n          }\n        ",document.head.appendChild(e)}}copyCode(){const e=this.state.activeCode||this.state.selectedPrize?.code;e&&navigator.clipboard.writeText(e).then(()=>{this.elements.copyBtn.textContent=this.translations.copied,this.elements.copyBtn.classList.add("copied"),setTimeout(()=>{this.elements.copyBtn.textContent=this.translations.copyCode,this.elements.copyBtn.classList.remove("copied")},2e3),this.trackEvent("spin_wheel_code_copied",{code:e})})}useCode(){const e=this.state.activeCode||this.state.selectedPrize?.code;if(!e)return;navigator.clipboard&&navigator.clipboard.writeText(e),this.trackEvent("spin_wheel_code_used",{code:e});const n=new URL("/checkout",window.location.origin);n.searchParams.set("discount",e),window.location.href=n.toString()}speak(e){if(!window.speechSynthesis)return;const n=new SpeechSynthesisUtterance(e);n.lang={fr:"fr-FR",en:"en-US",es:"es-ES",ar:"ar-SA",ary:"ar-MA"}[this.config.lang]||"fr-FR",n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}trackEvent(e,n={}){i.hasAnalyticsConsent()&&(window.gtag&&window.gtag("event",e,{event_category:"gamification",tenant_id:this.config.tenantId,...n}),window.plausible&&window.plausible(e,{props:n}),window.VocalIA?.trackEvent&&window.VocalIA.trackEvent(e,n))}static hasAnalyticsConsent(){if(window.VOCALIA_CONFIG&&!1===window.VOCALIA_CONFIG.analytics_consent)return!1;if(window.VOCALIA_CONFIG&&!0===window.VOCALIA_CONFIG.analytics_consent)return!0;try{if("denied"===localStorage.getItem("va_consent"))return!1}catch{}return!(typeof window.CookieConsent<"u"&&!window.CookieConsent.allowedCategory?.("analytics")||(window,0))}reset(){this.state.hasPlayed=!1,this.state.isSpinning=!1,this.state.selectedPrize=null;try{localStorage.removeItem("va_spin_wheel_last_played")}catch{}this.elements.wheel&&(this.elements.wheel.style.transform="rotate(0deg)")}destroy(){this.hide(),this.host?.remove(),this.host=null,this._shadowRoot=null,this.elements.overlay=null}}let a=null;function o(e={}){return a&&a.destroy(),a=new i(e),a}function s(e={}){return a||(a=new i(e)),a.show(),a}window.VocaliaSpinWheel={init:o,show:s,getInstance:()=>a,SpinWheel:i},typeof window.VocalIA<"u"&&(window.VocalIA.SpinWheel=window.VocaliaSpinWheel,window.VocalIA.showSpinWheel=function(e={}){return s(e)},window.VocalIA.isSpinWheelAvailable=function(){try{const e=localStorage.getItem("va_spin_wheel_last_played");return!e||Date.now()-parseInt(e,10)>=864e5}catch{return!0}}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-vocalia-spin-wheel]");e&&(o({tenantId:e.dataset.vocaliaTenant,lang:e.dataset.vocaliaLang,voiceEnabled:"false"!==e.dataset.voice,requireEmail:"false"!==e.dataset.requireEmail}),"auto"===(e.dataset.trigger||"manual")&&setTimeout(()=>s(),parseInt(e.dataset.delay)||5e3))})}(),function(){"use strict";function e(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}const n={fr:{freeShipping:"Livraison GRATUITE",addMore:"Plus que {{amount}} pour la livraison gratuite !",almostThere:"Presque ! {{amount}} de plus et c'est gratuit !",unlocked:"Livraison gratuite debloquee !",voiceMilestone25:"Vous avez deja un quart du chemin pour la livraison gratuite.",voiceMilestone50:"A mi-chemin ! Continuez pour debloquer la livraison gratuite.",voiceMilestone75:"Presque la livraison gratuite ! Plus que quelques articles.",voiceMilestone100:"Felicitations ! Vous avez debloque la livraison gratuite !",threshold:"Seuil livraison gratuite",currentCart:"Panier actuel",remaining:"Restant",ariaClose:"Fermer",currency:{MAD:"DH",EUR:"â‚¬",USD:"$"}},en:{freeShipping:"FREE Shipping",addMore:"Add {{amount}} more for free shipping!",almostThere:"Almost there! {{amount}} more for free shipping!",unlocked:"Free shipping unlocked!",voiceMilestone25:"You're a quarter of the way to free shipping.",voiceMilestone50:"Halfway there! Keep going to unlock free shipping.",voiceMilestone75:"Almost at free shipping! Just a few more items.",voiceMilestone100:"Congratulations! You've unlocked free shipping!",threshold:"Free shipping threshold",currentCart:"Current cart",remaining:"Remaining",ariaClose:"Close",currency:{MAD:"MAD",EUR:"â‚¬",USD:"$"}},es:{freeShipping:"Envio GRATIS",addMore:"Anade {{amount}} mas para envio gratis!",almostThere:"Casi ahi! {{amount}} mas para envio gratis!",unlocked:"Envio gratis desbloqueado!",voiceMilestone25:"Llevas un cuarto del camino para envio gratis.",voiceMilestone50:"A mitad de camino! Sigue para desbloquear envio gratis.",voiceMilestone75:"Casi envio gratis! Solo unos articulos mas.",voiceMilestone100:"Felicidades! Has desbloqueado el envio gratis!",threshold:"Umbral envio gratis",currentCart:"Carrito actual",remaining:"Restante",ariaClose:"Cerrar",currency:{MAD:"MAD",EUR:"â‚¬",USD:"$"}},ar:{freeShipping:"Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ",addMore:"Ø§Ø¶Ù {{amount}} Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø­Ù† Ù…Ø¬Ø§Ù†ÙŠ!",almostThere:"Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§! {{amount}} ÙÙ‚Ø· Ù„Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ!",unlocked:"ØªÙ… ÙØªØ­ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ!",voiceMilestone25:"Ø§Ù†Øª ÙÙŠ Ø±Ø¨Ø¹ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.",voiceMilestone50:"ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚! Ø§Ø³ØªÙ…Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.",voiceMilestone75:"Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§ Ù…Ù† Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ! ÙÙ‚Ø· Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.",voiceMilestone100:"Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ!",threshold:"Ø­Ø¯ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ",currentCart:"Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",remaining:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ",ariaClose:"Ø¥ØºÙ„Ø§Ù‚",currency:{MAD:"Ø¯Ø±Ù‡Ù…",EUR:"â‚¬",USD:"$"}},ary:{freeShipping:"Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´",addMore:"Ø²ÙŠØ¯ {{amount}} Ø¨Ø§Ø´ ÙŠÙˆØµÙ„Ùƒ Ø¨Ù„Ø§Ø´!",almostThere:"Ù‚Ø±ÙŠØ¨! ØºÙŠØ± {{amount}} Ùˆ ÙŠÙˆØµÙ„Ùƒ Ù…Ø¬Ø§Ù†Ø§!",unlocked:"Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´!",voiceMilestone25:"ÙˆØµÙ„ØªÙŠ Ø§Ù„Ø±Ø¨Ø¹ Ø¨Ø§Ø´ ÙŠØ¬ÙŠÙƒ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´.",voiceMilestone50:"ÙØ§Ù„Ù†Øµ! ÙƒÙ…Ù„ Ø¨Ø§Ø´ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ.",voiceMilestone75:"Ù‚Ø±ÙŠØ¨ Ø¨Ø²Ø§Ù Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´! ØºÙŠØ± Ø´ÙˆÙŠØ©.",voiceMilestone100:"Ù…Ø¨Ø±ÙˆÙƒ! Ø¯Ø§Ø¨Ø§ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´!",threshold:"Ø§Ù„Ø­Ø¯ Ø¯ÙŠØ§Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù„Ø§Ø´",currentCart:"Ø§Ù„Ø¨Ø§Ù†ÙŠ Ø¯Ø§Ø¨Ø§",remaining:"Ø§Ù„Ù„ÙŠ Ø¨Ø§Ù‚ÙŠ",ariaClose:"Ø³Ø¯",currency:{MAD:"Ø¯Ø±Ù‡Ù…",EUR:"â‚¬",USD:"$"}}};class t{constructor(e={}){this.config={tenantId:e.tenantId||this.detectTenantId(),lang:e.lang||this.detectLanguage(),threshold:e.threshold||50,currency:e.currency||"EUR",position:e.position||"top",voiceEnabled:!1!==e.voiceEnabled,showMilestones:!1!==e.showMilestones,autoHide:!1!==e.autoHide,autoHideDelay:e.autoHideDelay||5e3,dismissible:!1!==e.dismissible,onUnlock:e.onUnlock||null,onMilestone:e.onMilestone||null},this.state={isVisible:!1,currentValue:0,percentage:0,isUnlocked:!1,lastMilestone:0,dismissed:!1,announcedMilestones:new Set},this.elements={},this.translations=n[this.config.lang]||n.fr,this.isRTL=["ar","ary"].includes(this.config.lang),this.init()}detectTenantId(){if(window.VOCALIA_CONFIG&&window.VOCALIA_CONFIG.tenant_id)return window.VOCALIA_CONFIG.tenant_id;const e=document.querySelector("[data-vocalia-tenant]");return e?e.dataset.vocaliaTenant:"default"}detectLanguage(){const e=document.querySelector("[data-vocalia-lang]");if(e)return e.dataset.vocaliaLang;const n=new URLSearchParams(window.location.search);if(n.get("lang"))return n.get("lang");const t=navigator.language?.split("-")[0];return["fr","en","es","ar","ary"].includes(t)?t:"fr"}init(){this.createBar(),this.loadCartValue(),this.setupCartListeners(),console.log("[FreeShippingBar] Initialized",{tenant:this.config.tenantId,threshold:this.config.threshold,currency:this.config.currency})}createBar(){const e=document.createElement("div");e.className="va-shipping-bar-container",e.id="va-shipping-bar",e.setAttribute("dir",this.isRTL?"rtl":"ltr"),e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),"bottom"===this.config.position&&(e.style.top="auto",e.style.bottom="0",e.style.borderBottom="none",e.style.borderTop="1px solid rgba(94, 106, 210, 0.3)"),e.innerHTML=this.getBarHTML(),this.host=document.createElement("div"),this.host.id="va-shipping-host",this.host.style.cssText=`position:fixed;left:0;right:0;${"bottom"===this.config.position?"bottom:0;":"top:0;"}z-index:10002;`,document.body.appendChild(this.host),this._shadowRoot=this.host.attachShadow({mode:"open"});const n=document.createElement("style");n.id="va-shipping-bar-styles",n.textContent="\n    .va-shipping-bar-container {\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      z-index: 9999;\n      background: linear-gradient(135deg, #0f172a 0%, #0F1225 100%);\n      border-bottom: 1px solid rgba(94, 106, 210, 0.3);\n      padding: 12px 20px;\n      transform: translateY(-100%);\n      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n    }\n\n    .va-shipping-bar-container.visible {\n      transform: translateY(0);\n    }\n\n    .va-shipping-bar-container.unlocked {\n      background: linear-gradient(135deg, #10B981 0%, #059669 100%);\n    }\n\n    .va-shipping-bar-container[dir=\"rtl\"] {\n      text-align: right;\n    }\n\n    .va-shipping-bar-inner {\n      max-width: 1200px;\n      margin: 0 auto;\n      display: flex;\n      align-items: center;\n      gap: 16px;\n      flex-wrap: wrap;\n    }\n\n    .va-shipping-icon {\n      width: 36px;\n      height: 36px;\n      flex-shrink: 0;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(255, 255, 255, 0.1);\n      border-radius: 50%;\n      animation: vaShippingPulse 2s infinite;\n    }\n\n    @keyframes vaShippingPulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.1); }\n    }\n\n    .va-shipping-icon svg {\n      width: 20px;\n      height: 20px;\n      fill: white;\n    }\n\n    .va-shipping-content {\n      flex: 1;\n      min-width: 200px;\n    }\n\n    .va-shipping-text {\n      color: #FFFFFF;\n      font-size: 14px;\n      font-weight: 600;\n      margin-bottom: 8px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      flex-wrap: wrap;\n      gap: 8px;\n    }\n\n    .va-shipping-message {\n      flex: 1;\n    }\n\n    .va-shipping-amount {\n      color: #5E6AD2;\n      font-size: 16px;\n      font-weight: 700;\n    }\n\n    .va-shipping-bar-container.unlocked .va-shipping-amount {\n      color: #FFFFFF;\n    }\n\n    .va-shipping-progress-wrapper {\n      position: relative;\n      height: 8px;\n      background: rgba(255, 255, 255, 0.15);\n      border-radius: 4px;\n      overflow: hidden;\n    }\n\n    .va-shipping-progress {\n      height: 100%;\n      background: linear-gradient(90deg, #5E6AD2 0%, #10B981 100%);\n      border-radius: 4px;\n      transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      position: relative;\n    }\n\n    .va-shipping-progress::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: linear-gradient(\n        90deg,\n        transparent 0%,\n        rgba(255, 255, 255, 0.3) 50%,\n        transparent 100%\n      );\n      animation: vaShimmer 2s infinite;\n    }\n\n    @keyframes vaShimmer {\n      0% { transform: translateX(-100%); }\n      100% { transform: translateX(100%); }\n    }\n\n    .va-shipping-bar-container.unlocked .va-shipping-progress {\n      background: rgba(255, 255, 255, 0.3);\n    }\n\n    .va-shipping-milestones {\n      display: flex;\n      justify-content: space-between;\n      margin-top: 4px;\n      font-size: 10px;\n      color: rgba(255, 255, 255, 0.5);\n    }\n\n    .va-shipping-milestone {\n      position: relative;\n    }\n\n    .va-shipping-milestone.reached {\n      color: #10B981;\n    }\n\n    .va-shipping-close {\n      width: 28px;\n      height: 28px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: background 0.2s ease;\n      flex-shrink: 0;\n    }\n\n    .va-shipping-close:hover {\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .va-shipping-close svg {\n      width: 14px;\n      height: 14px;\n      fill: white;\n    }\n\n    /* Confetti animation when unlocked */\n    .va-shipping-confetti {\n      position: absolute;\n      width: 10px;\n      height: 10px;\n      opacity: 0;\n    }\n\n    .va-shipping-bar-container.unlocked .va-shipping-confetti {\n      animation: vaConfetti 1s ease-out forwards;\n    }\n\n    @keyframes vaConfetti {\n      0% { opacity: 1; transform: translateY(0) rotate(0deg); }\n      100% { opacity: 0; transform: translateY(-50px) rotate(720deg); }\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 640px) {\n      .va-shipping-bar-container {\n        padding: 10px 16px;\n      }\n\n      .va-shipping-icon {\n        width: 30px;\n        height: 30px;\n      }\n\n      .va-shipping-icon svg {\n        width: 16px;\n        height: 16px;\n      }\n\n      .va-shipping-text {\n        font-size: 12px;\n      }\n\n      .va-shipping-amount {\n        font-size: 14px;\n      }\n\n      .va-shipping-milestones {\n        display: none;\n      }\n    }\n  ",this._shadowRoot.appendChild(n),this._shadowRoot.appendChild(e),this.elements.container=e,this.elements.progress=e.querySelector(".va-shipping-progress"),this.elements.message=e.querySelector(".va-shipping-message"),this.elements.amount=e.querySelector(".va-shipping-amount"),this.elements.closeBtn=e.querySelector(".va-shipping-close"),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",()=>this.dismiss())}getBarHTML(){const e=this.translations,n=e.currency[this.config.currency]||this.config.currency;return`\n        <div class="va-shipping-bar-inner">\n          <div class="va-shipping-icon">\n            <svg viewBox="0 0 24 24">\n              <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>\n            </svg>\n          </div>\n\n          <div class="va-shipping-content">\n            <div class="va-shipping-text">\n              <span class="va-shipping-message">${e.addMore.replace("{{amount}}",`<strong>${this.config.threshold} ${n}</strong>`)}</span>\n              <span class="va-shipping-amount">0 / ${this.config.threshold} ${n}</span>\n            </div>\n\n            <div class="va-shipping-progress-wrapper">\n              <div class="va-shipping-progress" style="width: 0%"></div>\n            </div>\n\n            ${this.config.showMilestones?`\n              <div class="va-shipping-milestones">\n                <span class="va-shipping-milestone" data-milestone="0">0</span>\n                <span class="va-shipping-milestone" data-milestone="25">25%</span>\n                <span class="va-shipping-milestone" data-milestone="50">50%</span>\n                <span class="va-shipping-milestone" data-milestone="75">75%</span>\n                <span class="va-shipping-milestone" data-milestone="100">${e.freeShipping}</span>\n              </div>\n            `:""}\n          </div>\n\n          ${this.config.dismissible?`\n            <button class="va-shipping-close" aria-label="${e.ariaClose}">\n              <svg viewBox="0 0 24 24">\n                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n              </svg>\n            </button>\n          `:""}\n        </div>\n      `}setupCartListeners(){window.VocalIA&&(this._originalSetCartData=window.VocalIA.setCartData||null,window.VocalIA.setCartData=e=>{this._originalSetCartData&&this._originalSetCartData.call(window.VocalIA,e),this.updateCartValue(e?.total||0)}),window.addEventListener("va:cart:updated",e=>{this.updateCartValue(e.detail?.total||0)}),window.Shopify&&document.addEventListener("cart:updated",e=>{const n=e.detail?.total||window.Shopify?.checkout?.total_price/100;n&&this.updateCartValue(n)}),window.jQuery&&window.jQuery(document.body).on("added_to_cart removed_from_cart",()=>{const e=document.querySelector(".cart-contents-count, .woocommerce-Price-amount");if(e){const n=parseFloat(e.textContent.replace(/[^\d.]/g,""));isNaN(n)||this.updateCartValue(n)}})}loadCartValue(){try{const e=localStorage.getItem("va_cart_total");if(e)return void this.updateCartValue(parseFloat(e))}catch{}window.VocalIA?.cart?.total?this.updateCartValue(window.VocalIA.cart.total):window.Shopify?.checkout?.total_price&&this.updateCartValue(window.Shopify.checkout.total_price/100)}updateCartValue(e){this.state.currentValue=e,this.state.percentage=Math.min(e/this.config.threshold*100,100),this.state.isUnlocked=e>=this.config.threshold;try{localStorage.setItem("va_cart_total",e.toString())}catch{}this.updateUI(),this.checkMilestones(),!this.state.dismissed&&e>0&&this.show(),this.trackEvent("shipping_bar_updated",{cart_value:e,threshold:this.config.threshold,percentage:this.state.percentage,unlocked:this.state.isUnlocked})}updateUI(){const n=this.translations,t=n.currency[this.config.currency]||this.config.currency,i=Math.max(this.config.threshold-this.state.currentValue,0);this.elements.progress.style.width=`${this.state.percentage}%`,this.elements.amount.textContent=`${this.state.currentValue.toFixed(0)} / ${this.config.threshold} ${t}`,this.state.isUnlocked?(this.elements.message.innerHTML=`<strong>${n.unlocked}</strong>`,this.elements.container.classList.add("unlocked"),this.elements.container.classList.add("va-celebrate"),this.config.autoHide&&setTimeout(()=>this.hide(),this.config.autoHideDelay),this.config.onUnlock&&this.config.onUnlock({value:this.state.currentValue,threshold:this.config.threshold})):this.state.percentage>=75?(this.elements.message.innerHTML=n.almostThere.replace("{{amount}}",`<strong>${e(i.toFixed(0))} ${e(t)}</strong>`),this.elements.container.classList.remove("unlocked")):(this.elements.message.innerHTML=n.addMore.replace("{{amount}}",`<strong>${e(i.toFixed(0))} ${e(t)}</strong>`),this.elements.container.classList.remove("unlocked")),this.config.showMilestones&&this.elements.container.querySelectorAll(".va-shipping-milestone").forEach(e=>{const n=parseInt(e.dataset.milestone);this.state.percentage>=n?e.classList.add("reached"):e.classList.remove("reached")})}checkMilestones(){const e=[25,50,75,100];for(const n of e)this.state.percentage>=n&&!this.state.announcedMilestones.has(n)&&(this.state.announcedMilestones.add(n),this.announceMilestone(n),this.config.onMilestone&&this.config.onMilestone({milestone:n,percentage:this.state.percentage,value:this.state.currentValue}))}announceMilestone(e){if(!this.config.voiceEnabled)return;const n=this.translations,t={25:n.voiceMilestone25,50:n.voiceMilestone50,75:n.voiceMilestone75,100:n.voiceMilestone100}[e];t&&this.speak(t),this.trackEvent("shipping_milestone_reached",{milestone:e,cart_value:this.state.currentValue,threshold:this.config.threshold})}speak(e){if(!window.speechSynthesis)return;const n=new SpeechSynthesisUtterance(e);n.lang={fr:"fr-FR",en:"en-US",es:"es-ES",ar:"ar-SA",ary:"ar-MA"}[this.config.lang]||"fr-FR",n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}show(){this.state.isVisible||this.state.dismissed||(this.state.isVisible=!0,this.elements.container.classList.add("visible"),"top"===this.config.position&&(document.body.style.paddingTop="60px"),this.trackEvent("shipping_bar_shown",{cart_value:this.state.currentValue,threshold:this.config.threshold}))}hide(){this.state.isVisible=!1,this.elements.container.classList.remove("visible"),"top"===this.config.position&&(document.body.style.paddingTop="")}dismiss(){this.state.dismissed=!0,this.hide();try{localStorage.setItem("va_shipping_bar_dismissed","true")}catch{}this.trackEvent("shipping_bar_dismissed",{cart_value:this.state.currentValue,percentage:this.state.percentage})}trackEvent(e,n={}){if(!window.VOCALIA_CONFIG||!1!==window.VOCALIA_CONFIG.analytics_consent){try{if("denied"===localStorage.getItem("va_consent"))return}catch{}window.gtag&&window.gtag("event",e,{event_category:"free_shipping",tenant_id:this.config.tenantId,...n}),window.plausible&&window.plausible(e,{props:n}),window.VocalIA?.trackEvent&&window.VocalIA.trackEvent(e,n)}}setThreshold(e){this.config.threshold=e,this.updateCartValue(this.state.currentValue)}setCurrency(e){this.config.currency=e,this.elements.container.innerHTML=this.getBarHTML(),this.elements.progress=this.elements.container.querySelector(".va-shipping-progress"),this.elements.message=this.elements.container.querySelector(".va-shipping-message"),this.elements.amount=this.elements.container.querySelector(".va-shipping-amount"),this.elements.closeBtn=this.elements.container.querySelector(".va-shipping-close"),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",()=>this.dismiss()),this.updateUI()}reset(){this.state.dismissed=!1,this.state.announcedMilestones.clear();try{localStorage.removeItem("va_shipping_bar_dismissed")}catch{}this.updateCartValue(0)}destroy(){this.hide(),window.VocalIA&&void 0!==this._originalSetCartData&&(window.VocalIA.setCartData=this._originalSetCartData),this.host?.remove(),this.host=null,this._shadowRoot=null,this.elements.container=null,document.body.style.paddingTop=""}}let i=null;function a(e={}){return"true"===(()=>{try{return localStorage.getItem("va_shipping_bar_dismissed")}catch{return null}})()&&!1!==e.respectDismissal?(console.log("[FreeShippingBar] Previously dismissed, not showing"),null):(i&&i.destroy(),i=new t(e),i)}window.VocaliaShippingBar={init:a,getInstance:()=>i,FreeShippingBar:t},typeof window.VocalIA<"u"&&(window.VocalIA.ShippingBar=window.VocaliaShippingBar,window.VocalIA.initShippingBar=function(e={}){return a(e)},window.VocalIA.updateShippingProgress=function(e){i||(i=a()),i&&i.updateCartValue(e)}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-vocalia-shipping-bar]");e&&a({tenantId:e.dataset.vocaliaTenant,lang:e.dataset.vocaliaLang,threshold:parseInt(e.dataset.threshold)||50,currency:e.dataset.currency||"EUR",voiceEnabled:"false"!==e.dataset.voice})})}(),function(e){"use strict";function n(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function t(){if(window.VOCALIA_CONFIG&&!1===window.VOCALIA_CONFIG.analytics_consent)return!1;try{if("denied"===localStorage.getItem("va_consent"))return!1}catch{}return!0}class i{constructor(e={}){this.options={containerId:"va-reco-carousel",maxItems:5,autoClose:3e4,onItemClick:null,onClose:null,lang:"fr",tenantId:e.tenantId||this._detectTenantId(),...e},this.container=null,this.isVisible=!1,this.autoCloseTimer=null,this.items=[]}_detectTenantId(){if(e.VOCALIA_CONFIG&&e.VOCALIA_CONFIG.tenant_id)return e.VOCALIA_CONFIG.tenant_id;const n=typeof document<"u"&&document.querySelector("[data-vocalia-tenant]");return n?n.dataset.vocaliaTenant:"default"}_injectStyles(e){if(e.querySelector("#va-reco-styles"))return;const n=document.createElement("style");n.id="va-reco-styles",n.textContent="\n    .va-reco-overlay {\n      position: fixed;\n      bottom: 100px;\n      right: 20px;\n      width: 380px;\n      max-height: 320px;\n      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.95));\n      border-radius: 16px;\n      border: 1px solid rgba(139, 92, 246, 0.3);\n      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(139, 92, 246, 0.1);\n      backdrop-filter: blur(20px);\n      z-index: 10002;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      opacity: 0;\n      transform: translateY(20px) scale(0.95);\n      transition: all 0.3s ease;\n      overflow: hidden;\n    }\n\n    .va-reco-overlay.va-reco-visible {\n      opacity: 1;\n      transform: translateY(0) scale(1);\n    }\n\n    .va-reco-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 12px 16px;\n      background: linear-gradient(90deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));\n      border-bottom: 1px solid rgba(139, 92, 246, 0.2);\n    }\n\n    .va-reco-title {\n      color: #e2e8f0;\n      font-size: 14px;\n      font-weight: 600;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .va-reco-title svg {\n      width: 18px;\n      height: 18px;\n      color: #8b5cf6;\n    }\n\n    .va-reco-close {\n      background: rgba(255, 255, 255, 0.1);\n      border: none;\n      color: #94a3b8;\n      cursor: pointer;\n      padding: 4px;\n      border-radius: 6px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: all 0.2s;\n    }\n\n    .va-reco-close:hover {\n      background: rgba(255, 255, 255, 0.15);\n      color: #e2e8f0;\n    }\n\n    .va-reco-content {\n      padding: 12px;\n      display: flex;\n      gap: 10px;\n      overflow-x: auto;\n      scroll-snap-type: x mandatory;\n      -webkit-overflow-scrolling: touch;\n      scrollbar-width: none;\n    }\n\n    .va-reco-content::-webkit-scrollbar {\n      display: none;\n    }\n\n    .va-reco-card {\n      flex: 0 0 140px;\n      scroll-snap-align: start;\n      background: rgba(255, 255, 255, 0.05);\n      border-radius: 12px;\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      overflow: hidden;\n      transition: all 0.2s;\n      cursor: pointer;\n    }\n\n    .va-reco-card:hover {\n      border-color: rgba(139, 92, 246, 0.4);\n      transform: translateY(-2px);\n      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);\n    }\n\n    .va-reco-image {\n      width: 100%;\n      height: 100px;\n      object-fit: cover;\n      background: linear-gradient(145deg, #1e293b, #334155);\n    }\n\n    .va-reco-image-placeholder {\n      width: 100%;\n      height: 100px;\n      background: linear-gradient(145deg, #1e293b, #334155);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: #64748b;\n    }\n\n    .va-reco-image-placeholder svg {\n      width: 32px;\n      height: 32px;\n    }\n\n    .va-reco-info {\n      padding: 10px;\n    }\n\n    .va-reco-name {\n      color: #e2e8f0;\n      font-size: 13px;\n      font-weight: 500;\n      line-height: 1.3;\n      margin-bottom: 6px;\n      display: -webkit-box;\n      -webkit-line-clamp: 2;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n    }\n\n    .va-reco-price {\n      color: #8b5cf6;\n      font-size: 14px;\n      font-weight: 600;\n    }\n\n    .va-reco-reason {\n      font-size: 10px;\n      color: #64748b;\n      margin-top: 4px;\n      display: flex;\n      align-items: center;\n      gap: 4px;\n    }\n\n    .va-reco-badge {\n      display: inline-block;\n      padding: 2px 6px;\n      background: rgba(139, 92, 246, 0.2);\n      color: #a78bfa;\n      font-size: 10px;\n      border-radius: 4px;\n      margin-top: 6px;\n    }\n\n    .va-reco-cta {\n      display: flex;\n      gap: 8px;\n      padding: 12px 16px;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n    }\n\n    .va-reco-btn {\n      flex: 1;\n      padding: 10px 16px;\n      border-radius: 8px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n      border: none;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n    }\n\n    .va-reco-btn-primary {\n      background: linear-gradient(135deg, #8b5cf6, #6366f1);\n      color: white;\n    }\n\n    .va-reco-btn-primary:hover {\n      transform: translateY(-1px);\n      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);\n    }\n\n    .va-reco-btn-secondary {\n      background: rgba(255, 255, 255, 0.1);\n      color: #94a3b8;\n    }\n\n    .va-reco-btn-secondary:hover {\n      background: rgba(255, 255, 255, 0.15);\n      color: #e2e8f0;\n    }\n\n    /* RTL Support */\n    [dir=\"rtl\"] .va-reco-overlay {\n      right: auto;\n      left: 20px;\n    }\n\n    /* Mobile responsive */\n    @media (max-width: 480px) {\n      .va-reco-overlay {\n        width: calc(100vw - 40px);\n        right: 20px;\n        bottom: 90px;\n      }\n\n      .va-reco-card {\n        flex: 0 0 120px;\n      }\n\n      .va-reco-image,\n      .va-reco-image-placeholder {\n        height: 80px;\n      }\n    }\n  ",e.appendChild(n)}_createCarouselDOM(e,t){const i=this._getLabels(),a=document.createElement("div");return a.id=this.options.containerId,a.className="va-reco-overlay",a.setAttribute("role","dialog"),a.setAttribute("aria-label",t),("ar"===this.options.lang||"ary"===this.options.lang)&&a.setAttribute("dir","rtl"),a.innerHTML=`\n        <div class="va-reco-header">\n          <div class="va-reco-title">\n            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />\n            </svg>\n            <span>${n(t)}</span>\n          </div>\n          <button class="va-reco-close" aria-label="${i.close}">\n            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <line x1="18" y1="6" x2="6" y2="18"></line>\n              <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n          </button>\n        </div>\n        <div class="va-reco-content">\n          ${e.map((e,n)=>this._renderCard(e,n)).join("")}\n        </div>\n        <div class="va-reco-cta">\n          <button class="va-reco-btn va-reco-btn-secondary" data-action="voice">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>\n              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>\n              <line x1="12" y1="19" x2="12" y2="23"></line>\n              <line x1="8" y1="23" x2="16" y2="23"></line>\n            </svg>\n            ${i.askVoice}\n          </button>\n          <button class="va-reco-btn va-reco-btn-primary" data-action="viewAll">\n            ${i.viewAll}\n          </button>\n        </div>\n      `,a.querySelector(".va-reco-close").addEventListener("click",()=>this.hide()),a.querySelectorAll(".va-reco-card").forEach((n,t)=>{n.addEventListener("click",()=>{this.options.onItemClick&&this.options.onItemClick(e[t],t),this._trackClick(e[t],t)})}),a.querySelector('[data-action="voice"]').addEventListener("click",()=>{this.hide(),window.VocalIA?.openVoiceWidget&&window.VocalIA.openVoiceWidget()}),a.querySelector('[data-action="viewAll"]').addEventListener("click",()=>{this._trackViewAll(),this.options.onViewAll&&this.options.onViewAll()}),a}_renderCard(e,t){const i=this._getLabels(),a=e.title||e.name||`Product ${t+1}`,o=e.price?this._formatPrice(e.price,e.currency):"",s=e.image||e.images?.[0]?.src,r=this._getReasonLabel(e.reason),c=n(String(e.id||e.productId||"")),l=n(a),d=s?n(s):"",p=r?n(r):"";return`\n        <div class="va-reco-card" data-product-id="${c}" tabindex="0">\n          ${d?`<img class="va-reco-image" src="${d}" alt="${l}" loading="lazy" onerror="this.style.display='none'">`:'<div class="va-reco-image-placeholder">\n                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />\n                </svg>\n              </div>'}\n          <div class="va-reco-info">\n            <div class="va-reco-name">${l}</div>\n            ${o?`<div class="va-reco-price">${o}</div>`:""}\n            ${p?`<div class="va-reco-reason">${p}</div>`:""}\n            ${e.similarity?`<span class="va-reco-badge">${parseInt(e.similarity)||0}% ${n(i.match)}</span>`:""}\n          </div>\n        </div>\n      `}_formatPrice(e,n){const t=parseFloat(e);if(isNaN(t))return e;const i=n||window.VocalIA?.cart?.currency||"EUR",a={MAD:"DH",EUR:"â‚¬",USD:"$",GBP:"Â£"}[i]||i,o=t.toFixed("MAD"===i?0:2);return"EUR"===i||"USD"===i||"GBP"===i?`${a}${o}`:`${o} ${a}`}_getReasonLabel(e){const n=this._getLabels();return{similar_product:n.similarProduct,frequently_bought_together:n.boughtTogether,based_on_viewed:n.basedOnViewed,based_on_purchases:n.basedOnPurchases,personalized:n.personalized}[e]||""}_getLabels(){const e={fr:{close:"Fermer",askVoice:"Demander",viewAll:"Voir tout",match:"match",similarProduct:"Similaire",boughtTogether:"Souvent achetÃ© avec",basedOnViewed:"Vu rÃ©cemment",basedOnPurchases:"Pour vous",personalized:"RecommandÃ©"},en:{close:"Close",askVoice:"Ask",viewAll:"View All",match:"match",similarProduct:"Similar",boughtTogether:"Often bought together",basedOnViewed:"Recently viewed",basedOnPurchases:"For you",personalized:"Recommended"},es:{close:"Cerrar",askVoice:"Preguntar",viewAll:"Ver todo",match:"coincide",similarProduct:"Similar",boughtTogether:"Comprado junto",basedOnViewed:"Visto reciente",basedOnPurchases:"Para ti",personalized:"Recomendado"},ar:{close:"Ø¥ØºÙ„Ø§Ù‚",askVoice:"Ø§Ø³Ø£Ù„",viewAll:"Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„",match:"ØªØ·Ø§Ø¨Ù‚",similarProduct:"Ù…Ø´Ø§Ø¨Ù‡",boughtTogether:"ÙŠØ´ØªØ±Ù‰ Ù…Ø¹Ù‹Ø§",basedOnViewed:"Ø´ÙˆÙ‡Ø¯ Ù…Ø¤Ø®Ø±Ù‹Ø§",basedOnPurchases:"Ù„Ùƒ",personalized:"Ù…ÙˆØµÙ‰ Ø¨Ù‡"},ary:{close:"Ø³Ø¯",askVoice:"Ø³ÙˆÙ„",viewAll:"Ø´ÙˆÙ ÙƒÙ„Ø´ÙŠ",match:"ØªØ·Ø§Ø¨Ù‚",similarProduct:"Ø¨Ø­Ø§Ù„ Ù‡Ø§Ø¯Ø§",boughtTogether:"ÙƒÙŠØªØ´Ø±Ø§ Ù…Ø¹",basedOnViewed:"Ø´ÙØªÙŠ Ù…Ø¤Ø®Ø±Ø§Ù‹",basedOnPurchases:"Ù„ÙŠÙƒ",personalized:"Ù…Ù†ØµÙˆØ­ Ø¨ÙŠÙ‡"}};return e[this.options.lang]||e.fr}show(e,n={}){const{title:t,type:i="similar"}=n,a=(this._getLabels(),{similar:{fr:"Produits similaires",en:"Similar Products",es:"Productos similares",ar:"Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©",ary:"Ù…Ù†ØªÙˆØ¬Ø§Øª Ø¨Ø­Ø§Ù„ Ù‡Ø§Ø¯Ùˆ"},bought_together:{fr:"Souvent achetÃ©s ensemble",en:"Frequently Bought Together",es:"Comprados juntos",ar:"ÙŠÙØ´ØªØ±Ù‰ Ù…Ø¹Ù‹Ø§",ary:"ÙƒÙŠØªØ´Ø±Ø§ Ù…Ø¹ Ø¨Ø¹Ø¶"},personalized:{fr:"RecommandÃ© pour vous",en:"Recommended for You",es:"Recomendado para ti",ar:"Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ùƒ",ary:"Ù…Ù†ØµÙˆØ­ Ø¨ÙŠÙ‡ Ù„ÙŠÙƒ"}}),o=t||a[i]?.[this.options.lang]||a[i]?.fr||"Recommendations";return this.items=e.slice(0,this.options.maxItems),this.hide(),this.host=document.createElement("div"),this.host.id="va-reco-host",this.host.style.cssText="position:fixed;inset:0;z-index:10003;pointer-events:none;",document.body.appendChild(this.host),this.shadowRoot=this.host.attachShadow({mode:"open"}),this._injectStyles(this.shadowRoot),this.container=this._createCarouselDOM(this.items,o),this.container.style.pointerEvents="auto",this.shadowRoot.appendChild(this.container),requestAnimationFrame(()=>{this.container.classList.add("va-reco-visible")}),this.isVisible=!0,this._trackImpression(i,this.items.length),this.options.autoClose&&(this.autoCloseTimer=setTimeout(()=>this.hide(),this.options.autoClose)),this}hide(){return this.autoCloseTimer&&(clearTimeout(this.autoCloseTimer),this.autoCloseTimer=null),this.container&&(this.container.classList.remove("va-reco-visible"),setTimeout(()=>{this.host?.remove(),this.host=null,this.shadowRoot=null,this.container=null},300)),this.isVisible=!1,this.options.onClose&&this.options.onClose(),this}_trackImpression(e,n){t()&&"function"==typeof gtag&&gtag("event","reco_carousel_impression",{event_category:"recommendations",recommendation_type:e,items_shown:n,tenant_id:this.options.tenantId})}_trackClick(e,n){t()&&"function"==typeof gtag&&gtag("event","reco_carousel_click",{event_category:"recommendations",product_id:e.id||e.productId,position:n+1,reason:e.reason,tenant_id:this.options.tenantId})}_trackViewAll(){t()&&"function"==typeof gtag&&gtag("event","reco_carousel_view_all",{event_category:"recommendations",items_shown:this.items.length,tenant_id:this.options.tenantId})}setLanguage(e){return this.options.lang=e,this}}e.VocalIARecommendations=i,e.VocalIA&&(e.VocalIA.RecommendationCarousel=i)}(typeof window<"u"?window:this);