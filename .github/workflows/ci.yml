name: VocalIA CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22.x'

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 3

      - name: Run Health Check
        run: node scripts/health-check.cjs
        timeout-minutes: 1

      - name: Verify JSON files
        run: |
          for f in package.json telephony/knowledge_base.json; do
            node -e "JSON.parse(require('fs').readFileSync('$f'))" && echo "✅ $f"
          done
        timeout-minutes: 1

      - name: Run Unit Tests with Coverage (ESM)
        run: c8 --check-coverage --lines 45 --statements 45 --branches 30 node --test 'test/**/*.test.mjs'
        timeout-minutes: 5

      - name: Run Exhaustive Multi-Tenant Tests
        run: node --test test/exhaustive-multi-tenant-test.cjs
        timeout-minutes: 3

      - name: Verify esbuild Production Bundles
        run: node esbuild.config.mjs
        timeout-minutes: 2

      - name: TypeScript Check (MCP Server)
        run: cd mcp-server && npm ci && npx tsc --noEmit
        timeout-minutes: 3

      - name: Validate Design Tokens
        run: node scripts/validate-design-tokens.cjs
        timeout-minutes: 1

      - name: Validate i18n Locales (FR as source of truth)
        run: python3 scripts/sync-locales.py --check
        timeout-minutes: 1

      - name: Validate Translation Quality & Truncations
        run: python3 scripts/translation-quality-check.py
        timeout-minutes: 1

      - name: Verify Darija Authenticity (No MSA)
        run: python3 scripts/darija-validator.py
        timeout-minutes: 1

      - name: i18n Regression Check (no FR text in non-FR locales)
        run: |
          for locale in en es ar ary; do
            file="website/src/locales/${locale}.json"
            if [ -f "$file" ]; then
              FR_FOUND=$(node -e "const d=JSON.parse(require('fs').readFileSync('$file'));const vals=JSON.stringify(Object.values(d));const fr=['Bienvenue','Découvrez','Commencer','Contactez-nous'];let c=0;fr.forEach(w=>{if(vals.includes(w))c++});if(c>2){console.log('FAIL:'+c);process.exit(1)}else{console.log('OK')}" 2>&1) || echo "⚠️ Possible FR contamination in $file"
            fi
          done
        timeout-minutes: 1

      - name: Build Summary
        run: |
          echo "## VocalIA Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ CI Passed — Unit (ESM) + Coverage + Exhaustive + esbuild + TypeScript + Design Tokens + i18n" >> $GITHUB_STEP_SUMMARY

  staging:
    name: Deploy to Staging
    needs: ci
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Docker Compose
        run: docker compose -f docker-compose.staging.yml config --quiet

      - name: Staging Summary
        run: |
          echo "## Staging Deploy" >> $GITHUB_STEP_SUMMARY
          echo "Branch: develop" >> $GITHUB_STEP_SUMMARY
          echo "Docker Compose validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy manually:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'docker-compose -f docker-compose.staging.yml up -d' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
