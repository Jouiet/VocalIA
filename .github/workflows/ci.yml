name: VocalIA CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20.x'

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Health Check
        run: node scripts/health-check.cjs

      - name: Verify Core Modules
        run: |
          echo "Testing core modules..."
          node -e "require('./core/knowledge-base-services.cjs'); console.log('✅ knowledge-base-services')"
          node -e "require('./core/voice-api-resilient.cjs'); console.log('✅ voice-api-resilient')"
          node -e "require('./personas/voice-persona-injector.cjs'); console.log('✅ voice-persona-injector')"
          echo "Core modules OK"

      - name: Verify JSON files
        run: |
          echo "Validating JSON files..."
          for f in package.json telephony/knowledge_base.json telephony/knowledge_base_ary.json; do
            node -e "JSON.parse(require('fs').readFileSync('$f'))" && echo "✅ $f"
          done

      - name: Build Summary
        run: |
          echo "## VocalIA Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node | $(node -v) |" >> $GITHUB_STEP_SUMMARY
          echo "| Files | $(find . \( -name '*.cjs' -o -name '*.js' \) ! -path './node_modules/*' ! -path './.yalc/*' | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ✅ |" >> $GITHUB_STEP_SUMMARY
