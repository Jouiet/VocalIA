name: VocalIA CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20.x'

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 3

      - name: Run Health Check
        run: node scripts/health-check.cjs
        timeout-minutes: 1

      - name: Verify JSON files
        run: |
          for f in package.json telephony/knowledge_base.json; do
            node -e "JSON.parse(require('fs').readFileSync('$f'))" && echo "✅ $f"
          done
        timeout-minutes: 1

      - name: Run Unit Tests
        run: npm test
        timeout-minutes: 5

      - name: Run Exhaustive Multi-Tenant Tests
        run: node --test test/exhaustive-multi-tenant-test.cjs
        timeout-minutes: 3

      - name: Validate i18n Locales (FR as source of truth)
        run: python3 scripts/sync-locales.py --check
        timeout-minutes: 1

      - name: Validate Translation Quality & Truncations
        run: python3 scripts/translation-quality-check.py
        timeout-minutes: 1

      - name: Verify Darija Authenticity (No MSA)
        run: python3 scripts/darija-validator.py
        timeout-minutes: 1

      - name: i18n Regression Check (no FR text in non-FR locales)
        run: |
          for locale in en es ar ary; do
            file="website/src/locales/${locale}.json"
            if [ -f "$file" ]; then
              FR_FOUND=$(node -e "const d=JSON.parse(require('fs').readFileSync('$file'));const vals=JSON.stringify(Object.values(d));const fr=['Bienvenue','Découvrez','Commencer','Contactez-nous'];let c=0;fr.forEach(w=>{if(vals.includes(w))c++});if(c>2){console.log('FAIL:'+c);process.exit(1)}else{console.log('OK')}" 2>&1) || echo "⚠️ Possible FR contamination in $file"
            fi
          done
        timeout-minutes: 1

      - name: Build Summary
        run: |
          echo "## VocalIA Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ CI Passed — Unit + Exhaustive + i18n validated" >> $GITHUB_STEP_SUMMARY
